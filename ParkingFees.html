<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Smart Park | æ­·å²æŸ¥è©¢ç‰ˆ V19</title>
    <style>
        :root { --primary: #2563eb; --success: #16a34a; --danger: #dc2626; --warning: #f59e0b; --bg: #f1f5f9; --text: #0f172a; --white: #ffffff; }
        * { box-sizing: border-box; font-family: system-ui, sans-serif; }
        body { background-color: var(--bg); color: var(--text); margin: 0; padding: 10px; }
        .container { max-width: 500px; margin: 0 auto; }
        .card { background: var(--white); border-radius: 16px; padding: 16px; box-shadow: 0 4px 12px rgba(0,0,0,0.08); margin-bottom: 12px; }
        
        /* è²»ç‡è¨­å®š */
        .config-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 8px; }
        .config-group { display: flex; flex-direction: column; background: #f8fafc; padding: 8px; border-radius: 10px; border: 1px solid #e2e8f0; }
        .config-group label { font-size: 11px; color: #64748b; margin-bottom: 4px; font-weight: bold; }
        .config-group input { padding: 5px; border: none; background: transparent; font-size: 16px; font-weight: bold; text-align: center; outline: none; color: var(--primary); }

        .stats-grid { display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 8px; margin-bottom: 12px; }
        .stat-box { background: white; padding: 10px 5px; border-radius: 12px; text-align: center; border-bottom: 4px solid var(--primary); }
        .stat-label { font-size: 11px; color: #64748b; font-weight: bold; }
        .stat-val { font-size: 15px; font-weight: 900; display: block; margin-top: 4px; color: var(--primary); }

        input[type="text"], input[type="number"] { width: 100%; padding: 12px; border: 2px solid #e2e8f0; border-radius: 12px; font-size: 16px; margin-bottom: 8px; outline: none; }
        
        /* è»Šè¼›æ¸…å–®æ¨£å¼ */
        .car-item { display: flex; justify-content: space-between; align-items: center; padding: 15px 0; border-bottom: 1px solid #f1f5f9; }
        .fee-tag { color: var(--warning); font-weight: 800; font-size: 24px; }
        
        /* æ­·å²ç´€éŒ„å°ˆç”¨ */
        .hist-item { padding: 10px; border-bottom: 1px dashed #e2e8f0; font-size: 13px; display: flex; justify-content: space-between; }
        .hist-info { color: #64748b; font-size: 11px; }
        .hist-plate { font-weight: bold; color: var(--text); font-size: 14px; }

        button { cursor: pointer; border: none; border-radius: 12px; font-weight: bold; }
        .btn-main { background: var(--primary); color: #fff; padding: 15px; width: 100%; font-size: 16px; }
        .btn-checkout { background: #fee2e2; color: var(--danger); padding: 10px 18px; }
        .btn-sub { background: #fff; border: 1px solid #e2e8f0; padding: 10px; font-size: 12px; flex: 1; }
        
        .section-title { font-size: 14px; font-weight: bold; color: var(--primary); margin: 15px 0 8px 5px; display: flex; justify-content: space-between; }
    </style>
</head>
<body>

<div class="container">
    <h2 style="text-align:center; color: var(--primary); margin: 10px 0;">ğŸ…¿ï¸ å°ˆæ¥­åœè»Šç®¡ç† V19</h2>

    <div class="stats-grid">
        <div class="stat-box"><span class="stat-label">ä»Šæ—¥</span><span id="revD" class="stat-val">$0</span></div>
        <div class="stat-box"><span class="stat-label">æœ¬æœˆ</span><span id="revM" class="stat-val">$0</span></div>
        <div class="stat-box"><span class="stat-label">æ­·å²ç¸½è¨ˆ</span><span id="revTotal" class="stat-val">$0</span></div>
    </div>

    <div class="card">
        <div class="config-grid">
            <div class="config-group"><label>åŸºæœ¬è²»($)</label><input type="number" id="rateBase" value="10" onchange="saveCfg()"></div>
            <div class="config-group"><label>çºŒåœ 30åˆ†($)</label><input type="number" id="rate30" value="20" onchange="saveCfg()"></div>
            <div class="config-group"><label>çºŒåœ 1æ™‚($)</label><input type="number" id="rate60" value="40" onchange="saveCfg()"></div>
            <div class="config-group"><label>å–®æ—¥ä¸Šé™($)</label><input type="number" id="rateMax" value="200" onchange="saveCfg()"></div>
        </div>
    </div>

    <div class="card">
        <input type="text" id="plateInput" placeholder="è¼¸å…¥è»Šç‰Œç™»è¨˜é€²å ´">
        <button class="btn-main" onclick="checkIn()">âœ… ç™»è¨˜é€²å ´</button>
    </div>

    <div class="section-title">ğŸš— å ´å…§è»Šè¼› <span id="countIn" style="color:#64748b; font-weight:normal;">0 è¼›</span></div>
    <div class="card" style="padding:0 16px;">
        <div id="parkingList"></div>
    </div>

    <div class="section-title">ğŸ” æŸ¥è©¢å·²æ”¶è²»ç´€éŒ„</div>
    <div class="card">
        <input type="text" id="histSearch" placeholder="è¼¸å…¥è»Šç‰ŒæŸ¥è©¢æ­·å²ç´€éŒ„..." oninput="renderHistory()">
        <div id="historyResults" style="max-height: 300px; overflow-y: auto;"></div>
        <div id="searchTotal" style="margin-top:10px; text-align:right; font-weight:bold; color:var(--success);"></div>
    </div>

    <div style="display:flex; gap:8px; margin-top:20px;">
        <button class="btn-sub" onclick="exportFullReport()">ğŸ“¥ åŒ¯å‡ºå ±è¡¨</button>
        <button class="btn-sub" onclick="document.getElementById('importFile').click()">ğŸ“¤ åŒ¯å…¥ç´€éŒ„</button>
        <input type="file" id="importFile" style="display:none" accept=".csv" onchange="importSmartCSV(event)">
    </div>
    <button class="btn-sub" style="width:100%; margin-top:8px; color:var(--danger); border-color:#fee2e2" onclick="clearAll()">âš ï¸ æ¸…ç©ºç³»çµ±è³‡æ–™</button>
</div>

<script>
    let pkList = JSON.parse(localStorage.getItem('pk_v19_list')) || [];
    let pkHist = JSON.parse(localStorage.getItem('pk_v19_hist')) || [];
    let config = JSON.parse(localStorage.getItem('pk_v19_cfg')) || { rBase: 10, r30: 20, r60: 40, rMax: 200 };

    function saveCfg() {
        config.rBase = parseInt(document.getElementById('rateBase').value) || 0;
        config.r30 = parseInt(document.getElementById('rate30').value) || 0;
        config.r60 = parseInt(document.getElementById('rate60').value) || 0;
        config.rMax = parseInt(document.getElementById('rateMax').value) || 0;
        localStorage.setItem('pk_v19_cfg', JSON.stringify(config));
        render();
    }

    function calculateFee(car) {
        const mins = Math.floor((Date.now() - car.time) / 60000);
        let fee = config.rBase + Math.floor(mins / 60) * config.r60;
        const rem = mins % 60;
        if (rem > 0) fee += (rem <= 30) ? config.r30 : config.r60;
        return Math.min(fee, config.rMax);
    }

    function render() {
        // å ´å…§è»Šè¼›
        const list = document.getElementById('parkingList');
        list.innerHTML = pkList.length ? '' : '<p style="text-align:center; color:#94a3b8; font-size:14px; padding:20px 0;">ç›®å‰ç„¡å ´å…§è»Šè¼›</p>';
        pkList.forEach((car, idx) => {
            list.innerHTML += `<div class="car-item"><div><b style="font-size:18px;">${car.plate}</b><div style="font-size:11px;color:#64748b;">${new Date(car.time).toLocaleString()}</div><div class="fee-tag" style="font-size:18px;">$${calculateFee(car)}</div></div><button class="btn-checkout" onclick="checkOut(${idx})">çµå¸³</button></div>`;
        });
        document.getElementById('countIn').innerText = `${pkList.length} è¼›`;
        
        updateStats();
        renderHistory();
        localStorage.setItem('pk_v19_list', JSON.stringify(pkList));
        localStorage.setItem('pk_v19_hist', JSON.stringify(pkHist));
    }

    function renderHistory() {
        const query = document.getElementById('histSearch').value.toUpperCase();
        const results = document.getElementById('historyResults');
        const filtered = pkHist.filter(h => h.plate.includes(query)).reverse(); // æœ€æ–°çš„åœ¨å‰
        
        results.innerHTML = filtered.length ? '' : '<p style="text-align:center; color:#94a3b8; padding:10px;">æŸ¥ç„¡æ­·å²ç´€éŒ„</p>';
        
        let sum = 0;
        filtered.forEach(h => {
            sum += h.fee;
            results.innerHTML += `
                <div class="hist-item">
                    <div>
                        <div class="hist-plate">${h.plate}</div>
                        <div class="hist-info">é€²: ${new Date(h.entryTime).toLocaleString()}</div>
                        <div class="hist-info">å‡º: ${new Date(h.exitTime).toLocaleString()}</div>
                    </div>
                    <div style="font-weight:bold; color:var(--success); font-size:16px;">$${h.fee}</div>
                </div>`;
        });
        
        document.getElementById('searchTotal').innerText = query ? `æœå°‹çµæœç¸½é¡ï¼š$${sum}` : "";
    }

    function updateStats() {
        const today = new Date().toDateString();
        const thisMonth = new Date().getMonth();
        const thisYear = new Date().getFullYear();

        const d = pkHist.filter(h => new Date(h.exitTime).toDateString() === today).reduce((s, h) => s + h.fee, 0);
        const m = pkHist.filter(h => {
            const dt = new Date(h.exitTime);
            return dt.getMonth() === thisMonth && dt.getFullYear() === thisYear;
        }).reduce((s, h) => s + h.fee, 0);
        const total = pkHist.reduce((s, h) => s + h.fee, 0);

        document.getElementById('revD').innerText = `$${d}`;
        document.getElementById('revM').innerText = `$${m}`;
        document.getElementById('revTotal').innerText = `$${total}`;
    }

    function checkIn() {
        const p = document.getElementById('plateInput');
        if (!p.value) return;
        pkList.push({ plate: p.value.toUpperCase(), time: Date.now() });
        p.value = ''; render();
    }

    function checkOut(idx) {
        const car = pkList[idx];
        const fee = calculateFee(car);
        if (confirm(`çµå¸³ï¼š${car.plate}\né‡‘é¡ï¼š$${fee}`)) {
            pkHist.push({ plate: car.plate, entryTime: car.time, exitTime: Date.now(), fee: fee });
            pkList.splice(idx, 1); render();
        }
    }

    function exportFullReport() {
        let csv = "\ufeffè»Šç‰Œ,é€²å ´æ™‚é–“,å‡ºå ´æ™‚é–“,é‡‘é¡\n";
        pkHist.forEach(h => csv += `${h.plate},${new Date(h.entryTime).toLocaleString()},${new Date(h.exitTime).toLocaleString()},${h.fee}\n`);
        const blob = new Blob([csv], { type: 'text/csv;charset=utf-8;' });
        const a = document.createElement("a");
        a.href = URL.createObjectURL(blob);
        a.download = `åœè»Šæ­·å²å ±è¡¨_${new Date().getTime()}.csv`;
        a.click();
    }

    function importSmartCSV(e) {
        const file = e.target.files[0];
        if (!file) return;
        const reader = new FileReader();
        reader.onload = function(ev) {
            const lines = ev.target.result.split(/\r?\n/);
            const imported = [];
            lines.forEach((line, i) => {
                if (i === 0 || !line.trim()) return; 
                const cols = line.split(',');
                if (cols.length >= 4) {
                    const plate = cols[0].trim();
                    const cleanDate = (str) => {
                        let s = str.replace(/[ä¸Šä¸‹]åˆ/g, '').replace(/[å¹´æœˆ]/g, '/').replace(/æ—¥/g, '');
                        return new Date(s).getTime();
                    };
                    const t1 = cleanDate(cols[1]);
                    const t2 = cleanDate(cols[2]);
                    const fee = parseInt(cols[3].replace(/[^0-9]/g, ''));
                    if (plate && !isNaN(t1) && !isNaN(t2)) imported.push({ plate, entryTime: t1, exitTime: t2, fee: fee || 0 });
                }
            });
            if (imported.length > 0) {
                if (confirm(`æˆåŠŸè§£æ ${imported.length} ç­†ç´€éŒ„ï¼Œæ˜¯å¦åŒ¯å…¥ï¼Ÿ`)) {
                    pkHist = [...pkHist, ...imported];
                    pkHist = Array.from(new Set(pkHist.map(JSON.stringify))).map(JSON.parse);
                    render();
                }
            } else { alert('ç„¡æ³•è§£æå…§å®¹ï¼Œè«‹æª¢æŸ¥ CSV æ ¼å¼ã€‚'); }
        };
        reader.readAsText(file);
    }

    function clearAll() { if (confirm("ç¢ºå®šæ¸…ç©ºæ‰€æœ‰è³‡æ–™ï¼Ÿ")) { localStorage.clear(); location.reload(); } }
    
    // åˆå§‹åŒ–è¨­å®šå€¼
    document.getElementById('rateBase').value = config.rBase;
    document.getElementById('rate30').value = config.r30;
    document.getElementById('rate60').value = config.r60;
    document.getElementById('rateMax').value = config.rMax;
    render();
</script>
</body>
</html>
