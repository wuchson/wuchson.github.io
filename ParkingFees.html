<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Smart Park Ultimate | V15 è¬ç”¨ç›¸å®¹ç‰ˆ</title>
    <style>
        :root { --primary: #2563eb; --success: #16a34a; --danger: #dc2626; --warning: #f59e0b; --bg: #f1f5f9; --text: #0f172a; --white: #ffffff; }
        * { box-sizing: border-box; font-family: system-ui, -apple-system, sans-serif; }
        body { background-color: var(--bg); color: var(--text); margin: 0; padding: 10px; line-height: 1.5; }
        .container { max-width: 500px; margin: 0 auto; }
        .card { background: var(--white); border-radius: 16px; padding: 16px; box-shadow: 0 4px 12px rgba(0,0,0,0.08); margin-bottom: 12px; }
        
        /* ç‡Ÿæ”¶çœ‹æ¿ */
        .stats-grid { display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 10px; margin-bottom: 15px; }
        .stat-box { background: white; padding: 12px 5px; border-radius: 12px; text-align: center; border-bottom: 4px solid var(--primary); }
        .stat-label { font-size: 11px; color: #64748b; font-weight: bold; }
        .stat-val { font-size: 16px; font-weight: 900; display: block; margin-top: 4px; color: var(--primary); }

        /* è¼¸å…¥èˆ‡åˆ—è¡¨ */
        input { width: 100%; padding: 12px; border: 2px solid #e2e8f0; border-radius: 12px; font-size: 16px; margin-bottom: 10px; outline: none; transition: 0.3s; }
        input:focus { border-color: var(--primary); }
        .car-item { display: flex; justify-content: space-between; align-items: center; padding: 12px 0; border-bottom: 1px solid #f1f5f9; }
        .car-item:last-child { border-bottom: none; }
        .fee-tag { color: var(--warning); font-weight: 800; font-size: 24px; }
        
        /* æŒ‰éˆ•æ¨£å¼ */
        button { cursor: pointer; border: none; border-radius: 12px; font-weight: bold; transition: 0.2s; active { transform: scale(0.98); } }
        .btn-main { background: var(--primary); color: #fff; padding: 15px; width: 100%; font-size: 16px; }
        .btn-checkout { background: #fee2e2; color: var(--danger); padding: 10px 18px; font-size: 14px; }
        .btn-group { display: grid; grid-template-columns: 1fr 1fr; gap: 8px; margin-top: 10px; }
        .btn-sub { background: #fff; border: 1px solid #e2e8f0; padding: 10px; font-size: 12px; }
    </style>
</head>
<body>

<div class="container">
    <h2 style="text-align:center; color: var(--primary); margin: 10px 0;">ğŸ…¿ï¸ åœè»Šç®¡ç†ç³»çµ± V15</h2>

    <div class="stats-grid">
        <div class="stat-box" style="border-color: var(--primary);"><span class="stat-label">ä»Šæ—¥</span><span id="revD" class="stat-val">$0</span></div>
        <div class="stat-box" style="border-color: var(--success);"><span class="stat-label">æœ¬æœˆ</span><span id="revM" class="stat-val">$0</span></div>
        <div class="stat-box" style="border-color: #8b5cf6;"><span class="stat-label">å¹´åº¦</span><span id="revY" class="stat-val">$0</span></div>
    </div>

    <div class="card">
        <input type="text" id="plateInput" placeholder="è¼¸å…¥è»Šç‰Œè™Ÿç¢¼ (ä¾‹: ABC-1234)">
        <button class="btn-main" onclick="checkIn()">ğŸš— ç™»è¨˜é€²å ´</button>
    </div>

    <div class="card" style="padding-top:0; padding-bottom:0;">
        <input type="text" id="searchInput" style="margin-top:15px;" placeholder="ğŸ” æœå°‹è»Šç‰Œ..." oninput="render()">
        <div id="parkingList"></div>
    </div>

    <div class="btn-group">
        <button class="btn-sub" onclick="exportFullReport()">ğŸ“¥ åŒ¯å‡ºå®Œæ•´å ±è¡¨</button>
        <button class="btn-sub" onclick="document.getElementById('importFile').click()">ğŸ“¤ åŒ¯å…¥æ­·å²è³‡æ–™</button>
        <input type="file" id="importFile" style="display:none" accept=".csv" onchange="importAnyCSV(event)">
        <button class="btn-sub" style="grid-column: span 2; color: var(--danger);" onclick="clearAll()">âš ï¸ æ¸…ç©ºç³»çµ±è³‡æ–™</button>
    </div>
</div>

<script>
    // ä½¿ç”¨æ–°çš„è³‡æ–™åº« key é¿å…è¡çª
    let pkList = JSON.parse(localStorage.getItem('pk_v15_list')) || [];
    let pkHist = JSON.parse(localStorage.getItem('pk_v15_hist')) || [];
    const cfg = { r30: 20, r60: 40, rMax: 200 };

    function calculateFee(car) {
        const mins = Math.floor((Date.now() - car.time) / 60000);
        const hrs = Math.floor(mins / 60);
        let fee = hrs * cfg.r60;
        const rem = mins % 60;
        if (rem <= 30) fee += cfg.r30;
        else fee += Math.min(cfg.r30 + (rem - 30), cfg.r60);
        return Math.min(fee, cfg.rMax);
    }

    function render() {
        const list = document.getElementById('parkingList');
        const kw = document.getElementById('searchInput').value.toUpperCase();
        list.innerHTML = '';
        
        pkList.filter(c => c.plate.includes(kw)).forEach((car, idx) => {
            const diff = Math.floor((Date.now() - car.time) / 60000);
            list.innerHTML += `
                <div class="car-item">
                    <div>
                        <b>${car.plate}</b>
                        <div style="font-size:11px; color:#64748b;">é€²å ´: ${new Date(car.time).toLocaleString()}</div>
                        <div style="font-size:12px; color:var(--primary); font-weight:bold;">å·²åœ: ${Math.floor(diff/60)}æ™‚${diff%60}åˆ†</div>
                        <div class="fee-tag">$${calculateFee(car)}</div>
                    </div>
                    <button class="btn-checkout" onclick="checkOut(${idx})">çµå¸³</button>
                </div>`;
        });
        updateStats();
        localStorage.setItem('pk_v15_list', JSON.stringify(pkList));
        localStorage.setItem('pk_v15_hist', JSON.stringify(pkHist));
    }

    function updateStats() {
        const now = new Date();
        let d=0, m=0, y=0;
        pkHist.forEach(h => {
            const dt = new Date(h.exitTime);
            if (dt.toDateString() === now.toDateString()) d += h.fee;
            if (dt.getMonth() === now.getMonth() && dt.getFullYear() === now.getFullYear()) m += h.fee;
            if (dt.getFullYear() === now.getFullYear()) y += h.fee;
        });
        document.getElementById('revD').innerText = `$${d.toLocaleString()}`;
        document.getElementById('revM').innerText = `$${m.toLocaleString()}`;
        document.getElementById('revY').innerText = `$${y.toLocaleString()}`;
    }

    function checkIn() {
        const p = document.getElementById('plateInput');
        if (!p.value) return;
        pkList.push({ plate: p.value.toUpperCase(), time: Date.now() });
        p.value = ''; render();
    }

    function checkOut(idx) {
        const car = pkList[idx];
        const fee = calculateFee(car);
        if (confirm(`è»Šç‰Œï¼š${car.plate}\næ”¶è²»é‡‘é¡ï¼š$${fee}`)) {
            pkHist.push({ plate: car.plate, entryTime: car.time, exitTime: Date.now(), fee: fee });
            pkList.splice(idx, 1);
            render();
        }
    }

    // --- è¬ç”¨åŒ¯å‡ºï¼šåŒ…å«åœ¨å ´èˆ‡æ­·å² ---
    function exportFullReport() {
        let csv = "\ufeff=== åœ¨å ´è»Šè¼›æ¸…å–® ===\nè»Šç‰Œ,é€²å ´æ™‚é–“,ç›®å‰é‡‘é¡\n";
        pkList.forEach(c => csv += `${c.plate},${new Date(c.time).toLocaleString()},${calculateFee(c)}\n`);
        
        csv += "\n=== æ­·å²çµå¸³ç´€éŒ„ ===\nè»Šç‰Œ,é€²å ´æ™‚é–“,å‡ºå ´æ™‚é–“,å¯¦æ”¶é‡‘é¡\n";
        pkHist.forEach(h => csv += `${h.plate},${new Date(h.entryTime).toLocaleString()},${new Date(h.exitTime).toLocaleString()},${h.fee}\n`);
        
        const blob = new Blob([csv], { type: 'text/csv;charset=utf-8;' });
        const a = document.createElement("a");
        a.href = URL.createObjectURL(blob);
        a.download = `åœè»Šå ´å ±è¡¨_${new Date().getTime()}.csv`;
        a.click();
    }

    // --- è¬ç”¨è§£æå™¨ï¼šæ™ºæ…§è¾¨è­˜æ•¸æ“š ---
    function importAnyCSV(e) {
        const file = e.target.files[0];
        if (!file) return;
        const reader = new FileReader();
        reader.onload = function(ev) {
            const lines = ev.target.result.split(/\r?\n/);
            const importedHist = [];
            
            lines.forEach(line => {
                const parts = line.split(',');
                // åˆ¤æ–·é€™ä¸€è¡Œæ˜¯å¦åŒ…å«ã€Œå·²çµå¸³ã€æ‰€éœ€çš„ 4 å€‹é—œéµæ¬„ä½
                if (parts.length >= 4) {
                    const plate = parts[0].trim();
                    const t1 = new Date(parts[1]).getTime();
                    const t2 = new Date(parts[2]).getTime();
                    const fee = parseInt(parts[3]);
                    
                    // åªè¦ã€Œè»Šç‰Œã€é€²å ´æ™‚é–“ã€å‡ºå ´æ™‚é–“ã€é‡‘é¡ã€é€™å››å€‹éƒ½æœ‰å€¼ï¼Œå°±è¦–ç‚ºæœ‰æ•ˆæ•¸æ“š
                    if (plate && !isNaN(t1) && !isNaN(t2) && !isNaN(fee)) {
                        importedHist.push({ plate, entryTime: t1, exitTime: t2, fee });
                    }
                }
            });

            if (importedHist.length > 0) {
                if (confirm(`åµæ¸¬åˆ° ${importedHist.length} ç­†æ­·å²ç´€éŒ„ï¼Œæ˜¯å¦åŒ¯å…¥ï¼Ÿ`)) {
                    pkHist = [...pkHist, ...importedHist];
                    // å»é™¤é‡è¤‡ç´€éŒ„
                    pkHist = Array.from(new Set(pkHist.map(JSON.stringify))).map(JSON.parse);
                    render();
                    alert('åŒ¯å…¥æˆåŠŸï¼');
                }
            } else {
                alert('åŒ¯å…¥å¤±æ•—ï¼šæ‰¾ä¸åˆ°æœ‰æ•ˆæ•¸æ“šã€‚\nè«‹ç¢ºä¿æª”æ¡ˆæ˜¯åŸç³»çµ±åŒ¯å‡ºçš„ CSVã€‚');
            }
        };
        reader.readAsText(file);
    }

    function clearAll() { if (confirm("ç¢ºå®šæ¸…ç©ºï¼Ÿ")) { localStorage.clear(); location.reload(); } }
    render();
</script>

</body>
</html>
