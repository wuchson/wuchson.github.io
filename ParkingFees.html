<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>åœè»Šæ”¶è²»ç³»çµ± V32</title>
    <style>
        :root { --primary: #2563eb; --success: #16a34a; --danger: #dc2626; --warning: #f59e0b; --bg: #f1f5f9; --text: #0f172a; --white: #ffffff; }
        * { box-sizing: border-box; font-family: system-ui, sans-serif; }
        body { background-color: var(--bg); color: var(--text); margin: 0; padding: 10px; }
        .container { max-width: 500px; margin: 0 auto; }
        .card { background: var(--white); border-radius: 16px; padding: 16px; box-shadow: 0 4px 12px rgba(0,0,0,0.08); margin-bottom: 12px; }
        
        .config-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 8px; }
        .config-group { display: flex; flex-direction: column; background: #f8fafc; padding: 8px; border-radius: 10px; border: 1px solid #e2e8f0; }
        .config-group label { font-size: 11px; color: #64748b; margin-bottom: 4px; font-weight: bold; }
        .config-group input { padding: 5px; border: none; background: transparent; font-size: 16px; font-weight: bold; text-align: center; outline: none; color: var(--primary); }

        .stats-grid { display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 8px; margin-bottom: 12px; }
        .stat-box { background: white; padding: 10px 5px; border-radius: 12px; text-align: center; border-bottom: 4px solid var(--primary); }
        .stat-label { font-size: 11px; color: #64748b; font-weight: bold; }
        .stat-val { font-size: 15px; font-weight: 900; display: block; margin-top: 4px; color: var(--primary); }

        .mode-selector { display: flex; background: #e2e8f0; border-radius: 10px; padding: 4px; margin-bottom: 12px; }
        .mode-btn { flex: 1; border: none; padding: 10px; border-radius: 8px; font-weight: bold; cursor: pointer; color: #64748b; background: transparent; }
        .mode-btn.active { background: var(--white); color: var(--primary); box-shadow: 0 2px 4px rgba(0,0,0,0.1); }

        input[type="text"], input[type="number"] { width: 100%; padding: 12px; border: 2px solid #e2e8f0; border-radius: 12px; font-size: 16px; margin-bottom: 8px; outline: none; }
        
        .car-item { display: flex; justify-content: space-between; align-items: center; padding: 15px 0; border-bottom: 1px solid #f1f5f9; }
        .fee-tag { color: var(--warning); font-weight: 800; font-size: 24px; }
        .badge { padding: 2px 6px; border-radius: 4px; font-size: 10px; margin-left: 5px; vertical-align: middle; }
        .badge-in { background: #dcfce7; color: #166534; }

        button { cursor: pointer; border: none; border-radius: 12px; font-weight: bold; transition: 0.2s; }
        .btn-main { background: var(--primary); color: #fff; padding: 15px; width: 100%; font-size: 16px; }
        .btn-checkout { background: #fee2e2; color: var(--danger); padding: 10px 18px; }
        .btn-sub { background: #fff; border: 1px solid #e2e8f0; padding: 10px; font-size: 12px; flex: 1; color: #64748b; }
        .btn-danger-sub { background: #fff; border: 1px solid #fee2e2; padding: 10px; font-size: 12px; flex: 1; color: var(--danger); }
        
        .section-title { font-size: 14px; font-weight: bold; color: var(--primary); margin: 15px 0 8px 5px; }
        .hist-item { padding: 12px; border-bottom: 1px dashed #e2e8f0; font-size: 12px; }
        .time-label { display: block; font-size: 11px; color: #64748b; margin: 2px 0; }
    </style>
</head>
<body>

<div class="container">
    <h2 style="text-align:center; color: var(--primary); margin: 10px 0;">ğŸ…¿ï¸ åœè»Šæ”¶è²»ç³»çµ± V32</h2>

    <div class="stats-grid">
        <div class="stat-box"><span class="stat-label">ä»Šæ—¥ç‡Ÿæ”¶</span><span id="revD" class="stat-val">$0</span></div>
        <div class="stat-box"><span class="stat-label">æœ¬æœˆç‡Ÿæ”¶</span><span id="revM" class="stat-val">$0</span></div>
        <div class="stat-box"><span class="stat-label">ç¸½ç´¯ç©</span><span id="revTotal" class="stat-val">$0</span></div>
    </div>

    <div class="card">
        <div class="config-grid">
            <div class="config-group"><label>åŸºæœ¬è²»($)</label><input type="number" id="rateBase" value="10" onchange="saveCfg()"></div>
            <div class="config-group"><label>30åˆ†ä¸Šé™($)</label><input type="number" id="rate30" value="20" onchange="saveCfg()"></div>
            <div class="config-group"><label>1æ™‚ä¸Šé™($)</label><input type="number" id="rate60" value="40" onchange="saveCfg()"></div>
            <div class="config-group"><label>å–®æ—¥æœ€é«˜($)</label><input type="number" id="rateMax" value="300" onchange="saveCfg()"></div>
        </div>
        <p style="font-size: 10px; color: #94a3b8; margin-top: 8px; text-align: center;">* è¨ˆè²»èªªæ˜ï¼šæ»¿ 24 å°æ™‚åŠ æ”¶ä¸€æ—¥æœ€é«˜ï¼Œé¤˜æ™‚é‡æ–°è¨ˆè²»</p>
    </div>

    <div class="card">
        <div class="mode-selector">
            <button class="mode-btn active" id="modeTimer" onclick="switchMode('timer')">â³ è¨ˆæ™‚æ¨¡å¼</button>
            <button class="mode-btn" id="modeFixed" onclick="switchMode('fixed')">ğŸ’° å–®æ¬¡å›ºå®š</button>
        </div>
        <input type="text" id="plateInput" placeholder="ç™»è¨˜é€²å ´è»Šç‰Œ">
        <input type="number" id="fixedAmountInput" placeholder="è¼¸å…¥å›ºå®šé‡‘é¡" style="display:none;">
        <button class="btn-main" onclick="checkIn()">âœ… ç™»è¨˜é€²å ´</button>
    </div>

    <div class="section-title">ğŸš— å ´å…§è»Šè¼› (<span id="countIn">0</span>)</div>
    <div class="card" style="padding:0 16px;"><div id="parkingList"></div></div>

    <div class="section-title">ğŸ” å…¨å ´æœå°‹ (å«æ­·å²ç´€éŒ„)</div>
    <div class="card">
        <input type="text" id="globalSearch" placeholder="æœå°‹è»Šç‰Œ..." oninput="renderAll()">
        <div id="searchResults" style="max-height: 300px; overflow-y: auto;"></div>
    </div>

    <div style="display:flex; flex-wrap: wrap; gap:8px;">
        <button class="btn-sub" onclick="exportFullReport()">ğŸ“¥ åŒ¯å‡ºå‚™ä»½</button>
        <button class="btn-sub" onclick="document.getElementById('importFile').click()">ğŸ“¤ åŒ¯å…¥é‚„åŸ</button>
        <button class="btn-danger-sub" onclick="clearAllData()">ğŸ—‘ï¸ æ¸…ç©ºè³‡æ–™</button>
        <input type="file" id="importFile" style="display:none" accept=".csv" onchange="importComprehensiveCSV(event)">
    </div>
</div>

<script>
    let pkList = JSON.parse(localStorage.getItem('pk_v32_list')) || [];
    let pkHist = JSON.parse(localStorage.getItem('pk_v32_hist')) || [];
    let config = JSON.parse(localStorage.getItem('pk_v32_cfg')) || { rBase: 10, r30: 20, r60: 40, rMax: 300 };
    let currentMode = 'timer';

    function switchMode(m) {
        currentMode = m;
        document.getElementById('modeTimer').classList.toggle('active', m === 'timer');
        document.getElementById('modeFixed').classList.toggle('active', m === 'fixed');
        document.getElementById('fixedAmountInput').style.display = (m === 'fixed') ? 'block' : 'none';
    }

    function saveCfg() {
        config.rBase = parseInt(document.getElementById('rateBase').value) || 0;
        config.r30 = parseInt(document.getElementById('rate30').value) || 0;
        config.r60 = parseInt(document.getElementById('rate60').value) || 0;
        config.rMax = parseInt(document.getElementById('rateMax').value) || 0;
        localStorage.setItem('pk_v32_cfg', JSON.stringify(config));
        renderAll();
    }

    // --- ç²¾ç¢ºè¨ˆè²»é‚è¼¯ V32 ---
    function calculateFee(car) {
        if (car.mode === 'fixed') return car.fixedAmount || 0;
        
        const totalMins = Math.floor((Date.now() - car.time) / 60000);
        if (totalMins <= 0) return config.rBase;

        const minsPerDay = 1440; 
        const fullDays = Math.floor(totalMins / minsPerDay); 
        const remainingMins = totalMins % minsPerDay; 

        // 1. æ»¿æ•´å¤©çš„éƒ¨åˆ†
        let totalFee = fullDays * config.rMax;

        // 2. å‰©é¤˜æ™‚æ•¸é‡æ–°è¨ˆç®— (åŒ…å«ä¸æ»¿ä¸€å¤©çš„æƒ…æ³)
        if (remainingMins > 0) {
            let currentCycleFee = config.rBase;
            const halfHours = Math.floor(remainingMins / 30);
            const minsInHalfHour = remainingMins % 30;

            for (let i = 1; i <= halfHours; i++) {
                if (i % 2 !== 0) {
                    // è©²å°æ™‚çš„å‰ 30 åˆ†
                    currentCycleFee = (Math.floor(currentCycleFee / config.r60) * config.r60) + config.r30;
                } else {
                    // è©²å°æ™‚çš„æ•´é»
                    currentCycleFee = (Math.floor((currentCycleFee - 1) / config.r60) + 1) * config.r60;
                }
            }

            if (minsInHalfHour > 0) {
                const isSecondHalf = (halfHours % 2 !== 0);
                const limit = isSecondHalf ? config.r60 : config.r30;
                const hourBase = Math.floor(currentCycleFee / config.r60) * config.r60;
                
                currentCycleFee += minsInHalfHour;
                if (currentCycleFee > (hourBase + limit)) currentCycleFee = hourBase + limit;
            }
            
            // é¤˜æ™‚æœ€é«˜ä¸å¾—éå–®æ—¥ä¸Šé™
            totalFee += Math.min(currentCycleFee, config.rMax);
        } else if (fullDays === 0 && totalMins > 0) {
            totalFee = config.rBase;
        }

        return totalFee;
    }

    function formatTime(ts) {
        const d = new Date(ts);
        return `${d.getMonth()+1}/${d.getDate()} ${d.getHours().toString().padStart(2,'0')}:${d.getMinutes().toString().padStart(2,'0')}`;
    }

    function renderAll() {
        const query = document.getElementById('globalSearch').value.toUpperCase();
        const list = document.getElementById('parkingList');
        const filteredIn = pkList.filter(car => car.plate.includes(query));
        list.innerHTML = filteredIn.length ? '' : '<p style="text-align:center; color:#94a3b8; padding:20px 0; font-size:13px;">ç„¡è»Šè¼›</p>';
        
        pkList.forEach((car, originalIdx) => {
            if (car.plate.includes(query)) {
                const diff = Math.floor((Date.now() - car.time) / 60000);
                const d = Math.floor(diff/1440), h = Math.floor((diff%1440)/60), m = diff%60;
                list.innerHTML += `
                    <div class="car-item">
                        <div>
                            <b>${car.plate}<span class="badge badge-in">å ´å…§</span></b>
                            <span class="time-label">ğŸš¦ é€²å ´: ${formatTime(car.time)}</span>
                            <div style="font-size:11px;color:var(--primary);font-weight:bold;">â±ï¸ å·²åœ: ${d > 0 ? d+'å¤© ' : ''}${h}æ™‚ ${m}åˆ†</div>
                            <div class="fee-tag">$${calculateFee(car)}</div>
                        </div>
                        <button class="btn-checkout" onclick="checkOut(${originalIdx})">çµå¸³</button>
                    </div>`;
            }
        });

        const histDisplay = document.getElementById('searchResults');
        const filteredHist = pkHist.filter(h => h.plate.includes(query)).reverse();
        histDisplay.innerHTML = filteredHist.length ? '' : '<p style="text-align:center; color:#94a3b8; padding:10px; font-size:12px;">ç„¡æ­·å²ç´€éŒ„</p>';
        
        filteredHist.forEach(h => {
            histDisplay.innerHTML += `
                <div class="hist-item" style="display:flex; justify-content:space-between; align-items:center;">
                    <div><b>${h.plate}</b><span class="time-label">ğŸ“… é€²:${formatTime(h.entryTime)} å‡º:${formatTime(h.exitTime)}</span></div>
                    <b style="color:var(--success); font-size:18px;">$${h.fee}</b>
                </div>`;
        });

        document.getElementById('countIn').innerText = pkList.length;
        updateStats();
        localStorage.setItem('pk_v32_list', JSON.stringify(pkList));
        localStorage.setItem('pk_v32_hist', JSON.stringify(pkHist));
    }

    function updateStats() {
        const dStr = new Date().toDateString();
        const d = pkHist.filter(h => new Date(h.exitTime).toDateString() === dStr).reduce((s, h) => s + h.fee, 0);
        const m = pkHist.filter(h => new Date(h.exitTime).getMonth() === new Date().getMonth()).reduce((s, h) => s + h.fee, 0);
        document.getElementById('revD').innerText = `$${d}`;
        document.getElementById('revM').innerText = `$${m}`;
        document.getElementById('revTotal').innerText = `$${pkHist.reduce((s, h) => s + h.fee, 0)}`;
    }

    function checkIn() {
        const p = document.getElementById('plateInput');
        if (!p.value) return;
        pkList.push({ plate: p.value.toUpperCase(), time: Date.now(), mode: currentMode, fixedAmount: parseInt(document.getElementById('fixedAmountInput').value) || 0 });
        p.value = ''; renderAll();
    }

    function checkOut(idx) {
        const car = pkList[idx];
        const fee = calculateFee(car);
        if (confirm(`çµå¸³ï¼š${car.plate} $${fee}`)) {
            pkHist.push({ plate: car.plate, entryTime: car.time, exitTime: Date.now(), fee: fee });
            pkList.splice(idx, 1); renderAll();
        }
    }

    function clearAllData() {
        if (confirm("âš ï¸ ç¢ºå®šè¦æ¸…ç©ºæ‰€æœ‰è³‡æ–™å—ï¼Ÿå»ºè­°å…ˆåŒ¯å‡ºå‚™ä»½ï¼")) {
            pkList = []; pkHist = []; renderAll();
            alert("è³‡æ–™å·²æ¸…ç©º");
        }
    }

    function exportFullReport() {
        const now = new Date();
        const dateStr = `${now.getFullYear()}_${now.getMonth()+1}_${now.getDate()}`;
        let csv = "\ufeffè»Šç‰Œ,é€²å ´æ™‚é–“,å‡ºå ´æ™‚é–“,é‡‘é¡,æ¨¡å¼,ç‹€æ…‹\n";
        pkList.forEach(c => { csv += `${c.plate},${new Date(c.time).toLocaleString()},--,${calculateFee(c)},${c.mode},å ´å…§\n`; });
        pkHist.forEach(h => { csv += `${h.plate},${new Date(h.entryTime).toLocaleString()},${new Date(h.exitTime).toLocaleString()},${h.fee},completed,å·²çµå¸³\n`; });
        const blob = new Blob([csv], { type: 'text/csv;charset=utf-8;' });
        const a = document.createElement("a");
        a.href = URL.createObjectURL(blob);
        a.download = `åœè»Šå ±è¡¨_${dateStr}.csv`;
        a.click();
    }

    function importComprehensiveCSV(e) {
        const file = e.target.files[0];
        if (!file) return;
        const reader = new FileReader();
        reader.onload = function(ev) {
            try {
                const lines = ev.target.result.split(/\r?\n/);
                let nL = [], nH = [];
                const parseDate = (s) => {
                    if (!s || s === "--") return NaN;
                    let clean = s.replace(/[ä¸Šä¸‹]åˆ/g, ' ').replace(/[å¹´æœˆ]/g, '/').replace(/æ—¥/g, '').trim();
                    let d = new Date(clean);
                    if (isNaN(d.getTime())) d = new Date(clean.replace(/\//g, '-'));
                    return d.getTime();
                };
                lines.forEach((line, i) => {
                    if (i === 0 || !line.trim()) return;
                    const cols = line.split(',');
                    if (cols.length >= 5) {
                        const plate = cols[0].trim();
                        const tE = parseDate(cols[1]);
                        const tX_str = cols[2].trim();
                        const f = parseInt(cols[3].replace(/[^0-9]/g, '')) || 0;
                        const m = cols[4].trim();
                        if (plate && !isNaN(tE)) {
                            if (tX_str === "--" || tX_str === "") nL.push({ plate, time: tE, mode: m, fixedAmount: (m==='fixed'?f:0) });
                            else {
                                const tX = parseDate(tX_str);
                                if (!isNaN(tX)) nH.push({ plate, entryTime: tE, exitTime: tX, fee: f });
                            }
                        }
                    }
                });
                pkList = nL; pkHist = nH; renderAll();
                alert("åŒ¯å…¥å®Œæˆ");
            } catch (err) { alert("è®€å–éŒ¯èª¤"); }
            e.target.value = '';
        };
        reader.readAsText(file);
    }

    document.getElementById('rateBase').value = config.rBase;
    document.getElementById('rate30').value = config.r30;
    document.getElementById('rate60').value = config.r60;
    document.getElementById('rateMax').value = config.rMax;
    setInterval(renderAll, 60000);
    renderAll();
</script>
</body>
</html>
