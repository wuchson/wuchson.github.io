<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>åœè»Šæ”¶è²»ç³»çµ±</title>
    <style>
        :root {
            --primary: #2563eb; --success: #16a34a; --danger: #dc2626; --warning: #f59e0b;
            --bg: #f1f5f9; --text: #0f172a; --white: #ffffff;
        }
        * { box-sizing: border-box; }
        body { font-family: system-ui, sans-serif; background-color: var(--bg); color: var(--text); margin: 0; padding: 10px; }
        .container { max-width: 600px; margin: 0 auto; }
        .card { background: var(--white); border-radius: 12px; padding: 16px; box-shadow: 0 2px 8px rgba(0,0,0,0.1); margin-bottom: 12px; }

        /* ç‡Ÿæ”¶çœ‹æ¿ */
        .stats-grid { display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 8px; margin-bottom: 12px; }
        .stat-box { background: white; padding: 10px 5px; border-radius: 12px; text-align: center; border-bottom: 4px solid var(--primary); }
        .stat-label { font-size: 11px; color: #64748b; font-weight: bold; }
        .stat-val { font-size: 15px; font-weight: bold; display: block; margin-top: 4px; }

        /* è²»ç‡è¨­å®š */
        .config-grid { display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 8px; }
        .config-group { display: flex; flex-direction: column; }
        .config-group label { font-size: 10px; color: #475569; margin-bottom: 4px; font-weight: bold; }
        .config-group input { padding: 8px; border: 1px solid #cbd5e1; border-radius: 8px; font-size: 14px; text-align: center; color: #000; outline: none; }

        /* åˆ—è¡¨èˆ‡é¡¯ç¤º */
        .car-item { display: flex; justify-content: space-between; align-items: center; padding: 15px; border-bottom: 1px solid #f1f5f9; }
        .car-info b { font-size: 18px; color: #000; display: block; }
        .entry-stamp { font-size: 11px; color: #64748b; margin: 4px 0; background: #f8fafc; display: inline-block; padding: 2px 5px; border-radius: 4px; }
        .duration-text { font-size: 13px; color: var(--primary); font-weight: 600; }
        .fee-tag { color: var(--warning); font-weight: bold; font-size: 22px; margin-top: 2px; }
        
        /* è¼¸å…¥æ§åˆ¶ */
        input[type="text"], input[type="number"] { width: 100%; padding: 12px; border: 2px solid #e2e8f0; border-radius: 10px; font-size: 16px; margin-bottom: 8px; outline: none; }
        .mode-selector { display: flex; background: #e2e8f0; border-radius: 8px; padding: 4px; margin-bottom: 12px; }
        .mode-btn { flex: 1; border: none; padding: 8px; border-radius: 6px; font-weight: bold; cursor: pointer; color: #64748b; background: transparent; }
        .mode-btn.active { background: var(--white); color: var(--primary); box-shadow: 0 2px 4px rgba(0,0,0,0.1); }
        
        button { cursor: pointer; border: none; border-radius: 10px; font-weight: bold; }
        .btn-main { background: var(--primary); color: #fff; padding: 14px; width: 100%; font-size: 16px; }
        .btn-checkout { background: #fee2e2; color: var(--danger); padding: 10px 15px; }
        .btn-sm { padding: 8px 12px; font-size: 12px; background: #f8fafc; border: 1px solid #e2e8f0; color: var(--text); }
        .badge { padding: 2px 6px; border-radius: 4px; font-size: 10px; margin-left: 5px; vertical-align: middle; }
        .badge-timer { background: #dbeafe; color: #1e40af; }
        .badge-fixed { background: #fef3c7; color: #92400e; }
    </style>
</head>
<body>

<div class="container">
    <h2 style="text-align:center; color: var(--primary); margin: 10px 0;">ğŸ…¿ï¸ åœè»Šæ”¶è²»ç³»çµ±</h2>

    <div class="stats-grid">
        <div class="stat-box" style="border-color: var(--primary);"><span class="stat-label">ä»Šæ—¥ç‡Ÿæ”¶</span><span id="revD" class="stat-val">$0</span></div>
        <div class="stat-box" style="border-color: var(--success);"><span class="stat-label">æœ¬æœˆç‡Ÿæ”¶</span><span id="revM" class="stat-val">$0</span></div>
        <div class="stat-box" style="border-color: #8b5cf6;"><span class="stat-label">å¹´åº¦ç‡Ÿæ”¶</span><span id="revY" class="stat-val">$0</span></div>
    </div>

    <div class="card">
        <div class="config-grid">
            <div class="config-group"><label>30åˆ†åŸºåº•($)</label><input type="number" id="rate30" value="20" onchange="saveCfg()"></div>
            <div class="config-group"><label>1å°æ™‚é«˜($)</label><input type="number" id="rate60" value="40" onchange="saveCfg()"></div>
            <div class="config-group"><label>å–®æ—¥ä¸Šé™($)</label><input type="number" id="rateMax" value="200" onchange="saveCfg()"></div>
        </div>
    </div>

    <div class="card">
        <div class="mode-selector">
            <button class="mode-btn active" id="modeTimer" onclick="switchMode('timer')">â³ è¨ˆæ™‚æ¨¡å¼</button>
            <button class="mode-btn" id="modeFixed" onclick="switchMode('fixed')">ğŸ’° å›ºå®šé‡‘é¡</button>
        </div>
        <input type="text" id="plateInput" placeholder="è¼¸å…¥è»Šç‰Œè™Ÿç¢¼">
        <input type="number" id="fixedAmountInput" placeholder="è¼¸å…¥å–®æ¬¡æ”¶è²»é‡‘é¡" style="display:none;">
        <button class="btn-main" onclick="checkIn()">ç™»è¨˜é€²å ´</button>
    </div>

    <div class="card" style="padding:0; overflow:hidden;">
        <div style="padding:10px; background:#f8fafc; border-bottom:1px solid #eee;">
            <input type="text" id="searchInput" style="margin-bottom:0; padding:8px; font-size:14px;" placeholder="ğŸ” æœå°‹è»Šç‰Œ..." oninput="render()">
        </div>
        <div id="parkingList"></div>
    </div>

    <div class="card" style="display: flex; flex-wrap: wrap; gap: 8px; justify-content: center;">
        <button class="btn-sm" onclick="exportExcel()">ğŸ“¥ åŒ¯å‡ºå®Œæ•´å ±è¡¨ (Excel)</button>
        <button class="btn-sm" onclick="document.getElementById('importFile').click()">ğŸ“¤ åŒ¯å…¥æ­·å²è³‡æ–™</button>
        <input type="file" id="importFile" style="display:none" accept=".csv" onchange="importCSV(event)">
        <button class="btn-sm" style="color:var(--danger)" onclick="clearData()">âš ï¸ æ¸…ç©ºç³»çµ±</button>
    </div>
</div>

<script>
    let parkingData = JSON.parse(localStorage.getItem('v11_list')) || [];
    let historyData = JSON.parse(localStorage.getItem('v11_hist')) || [];
    let config = JSON.parse(localStorage.getItem('v11_cfg')) || { r30: 20, r60: 40, rMax: 200 };
    let currentMode = 'timer';

    function switchMode(mode) {
        currentMode = mode;
        document.getElementById('modeTimer').classList.toggle('active', mode === 'timer');
        document.getElementById('modeFixed').classList.toggle('active', mode === 'fixed');
        document.getElementById('fixedAmountInput').style.display = (mode === 'fixed') ? 'block' : 'none';
    }

    function saveCfg() {
        config.r30 = parseInt(document.getElementById('rate30').value) || 0;
        config.r60 = parseInt(document.getElementById('rate60').value) || 0;
        config.rMax = parseInt(document.getElementById('rateMax').value) || 0;
        localStorage.setItem('v11_cfg', JSON.stringify(config));
        render();
    }

    function calculateFee(car) {
        if (car.mode === 'fixed') return car.fixedAmount;
        const totalMins = Math.floor((Date.now() - car.time) / 60000); 
        const hours = Math.floor(totalMins / 60);
        let fee = hours * config.r60;
        const minsInCurrentHour = totalMins % 60;
        if (minsInCurrentHour <= 30) fee += config.r30;
        else fee += Math.min(config.r30 + (minsInCurrentHour - 30), config.r60);
        return Math.min(fee, config.rMax);
    }

    function formatTime(ts) {
        const d = new Date(ts);
        return `${d.getMonth()+1}/${d.getDate()} ${d.toLocaleTimeString([], {hour:'2-digit', minute:'2-digit', hour12:false})}`;
    }

    function render() {
        const list = document.getElementById('parkingList');
        const kw = document.getElementById('searchInput').value.toUpperCase();
        list.innerHTML = '';
        
        parkingData.filter(c => c.plate.includes(kw)).forEach((car) => {
            const idx = parkingData.indexOf(car);
            const diff = Math.floor((Date.now() - car.time) / 60000);
            list.innerHTML += `
                <div class="car-item">
                    <div style="flex: 1;">
                        <b>${car.plate}<span class="badge ${car.mode==='fixed'?'badge-fixed':'badge-timer'}">${car.mode==='fixed'?'å›ºå®š':'è¨ˆæ™‚'}</span></b>
                        <div class="entry-stamp">ğŸ“… é€²ï¼š${formatTime(car.time)}</div>
                        <div class="duration-text">ğŸ•’ åœï¼š${Math.floor(diff/60)}æ™‚${diff%60}åˆ†</div>
                        <div class="fee-tag">$${calculateFee(car)}</div>
                    </div>
                    <button class="btn-checkout" onclick="checkOut(${idx})">çµå¸³</button>
                </div>`;
        });
        updateRevenue();
        localStorage.setItem('v11_list', JSON.stringify(parkingData));
        localStorage.setItem('v11_hist', JSON.stringify(historyData));
    }

    function updateRevenue() {
        const now = new Date();
        let d=0, m=0, y=0;
        historyData.forEach(h => {
            const date = new Date(h.exitTime);
            if (date.toDateString() === now.toDateString()) d += h.fee;
            if (date.getMonth() === now.getMonth() && date.getFullYear() === now.getFullYear()) m += h.fee;
            if (date.getFullYear() === now.getFullYear()) y += h.fee;
        });
        document.getElementById('revD').innerText = `$${d.toLocaleString()}`;
        document.getElementById('revM').innerText = `$${m.toLocaleString()}`;
        document.getElementById('revY').innerText = `$${y.toLocaleString()}`;
    }

    function checkIn() {
        const p = document.getElementById('plateInput');
        const f = document.getElementById('fixedAmountInput');
        if (!p.value) return alert('è«‹è¼¸å…¥è»Šç‰Œ');
        parkingData.push({ plate: p.value.toUpperCase(), time: Date.now(), mode: currentMode, fixedAmount: parseInt(f.value)||0 });
        p.value = ''; f.value = ''; render();
    }

    function checkOut(idx) {
        const car = parkingData[idx];
        const fee = calculateFee(car);
        if (confirm(`è»Šç‰Œï¼š${car.plate}\næ‡‰ä»˜é‡‘é¡ï¼š$${fee}`)) {
            historyData.push({ plate: car.plate, entryTime: car.time, exitTime: Date.now(), fee: fee });
            parkingData.splice(idx, 1);
            render();
        }
    }

    // --- å¼·åŒ–ç‰ˆåŒ¯å‡ºï¼šåŒ…å«æœªçµæ¸…èˆ‡å·²æ”¶è²» ---
    function exportExcel() {
        if (historyData.length === 0 && parkingData.length === 0) return alert('ç„¡è³‡æ–™å¯åŒ¯å‡º');
        
        let csv = "\ufeff=== å€å¡Šä¸€ï¼šå ´å…§æœªçµæ¸…è»Šè¼› ===\n";
        csv += "è»Šç‰Œ,é€²å ´æ™‚é–“,åœæ”¾æ™‚é•·,ç›®å‰é ä¼°é‡‘é¡,ç‹€æ…‹\n";
        parkingData.forEach(c => {
            const diff = Math.floor((Date.now() - c.time) / 60000);
            csv += `${c.plate},${new Date(c.time).toLocaleString()},${Math.floor(diff/60)}æ™‚${diff%60}åˆ†,${calculateFee(c)},åœ¨å ´æœªçµ\n`;
        });

        csv += "\n=== å€å¡ŠäºŒï¼šå·²æ”¶è²»æ­·å²ç´€éŒ„ ===\n";
        csv += "è»Šç‰Œ,é€²å ´æ™‚é–“,å‡ºå ´æ™‚é–“,å¯¦æ”¶é‡‘é¡,ç‹€æ…‹\n";
        historyData.forEach(h => {
            csv += `${h.plate},${new Date(h.entryTime).toLocaleString()},${new Date(h.exitTime).toLocaleString()},${h.fee},å·²çµå¸³\n`;
        });

        const blob = new Blob([csv], { type: 'text/csv;charset=utf-8;' });
        const a = document.createElement("a");
        a.href = URL.createObjectURL(blob);
        a.download = `åœè»Šå ´å®Œæ•´å ±è¡¨_${new Date().toLocaleDateString()}.csv`;
        a.click();
    }

    function importCSV(e) {
        const file = e.target.files[0];
        const reader = new FileReader();
        reader.onload = function(ev) {
            const lines = ev.target.result.split('\n');
            const newHist = [];
            lines.forEach(line => {
                const cols = line.split(',');
                if (cols.length >= 5 && cols[4].includes("å·²çµå¸³")) {
                    newHist.push({ plate: cols[0], entryTime: new Date(cols[1]).getTime(), exitTime: new Date(cols[2]).getTime(), fee: parseInt(cols[3]) });
                }
            });
            if (newHist.length > 0) { historyData = newHist; render(); alert('å·²æ”¶è²»ç´€éŒ„åŒ¯å…¥æˆåŠŸï¼'); }
        };
        reader.readAsText(file);
    }

    function clearData() { if (confirm("ç¢ºå®šæ¸…ç©ºæ‰€æœ‰è³‡æ–™ï¼Ÿ")) { localStorage.clear(); location.reload(); } }

    setInterval(render, 15000); 
    render();
</script>

</body>
</html>
