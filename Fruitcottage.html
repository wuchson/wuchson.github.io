<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>SmartFarm Elite - 2026 é«˜ç«¯è¾²æ¥­ç®¡ç†</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/jsqr@1.4.0/dist/jsQR.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/qrious/4.0.2/qrious.min.js"></script>
    
    <style>
        :root { 
            --primary: #1b4332; 
            --primary-light: #2d6a4f;
            --accent: #D4AF37; /* é¦™æª³é‡‘ */
            --bg: #f8f9fa; 
            --white: #ffffff; 
            --glass: rgba(255, 255, 255, 0.8);
            --shadow: 0 8px 32px rgba(0,0,0,0.1);
        }

        body { 
            margin: 0; 
            background: var(--bg); 
            font-family: 'PingFang TC', 'Microsoft JhengHei', sans-serif; 
            color: #333;
            line-height: 1.6;
        }

        /* æ¡Œé¢ç«¯å„ªåŒ–ä½ˆå±€ */
        .container {
            max-width: 1000px;
            margin: 0 auto;
            padding-bottom: 100px;
        }

        /* ç™»å…¥ç•«é¢å„ªåŒ– */
        #login-screen { 
            position: fixed; top: 0; left: 0; width: 100%; height: 100%; 
            background: linear-gradient(135deg, var(--primary), var(--primary-light)); 
            z-index: 5000; display: flex; align-items: center; justify-content: center; 
        }
        .login-box { 
            background: var(--white); padding: 40px; border-radius: 24px; 
            width: 85%; max-width: 350px; text-align: center; box-shadow: var(--shadow);
        }

        /* æ™‚å°šé ‚éƒ¨ */
        header { 
            background: var(--primary); color: white; padding: 30px 20px; 
            border-radius: 0 0 30px 30px; box-shadow: var(--shadow);
            text-align: center;
        }
        .summary-grid { 
            display: grid; grid-template-columns: 1fr 1fr; gap: 15px; margin-top: 20px; 
        }
        .summary-item { 
            background: rgba(255,255,255,0.1); backdrop-filter: blur(5px);
            padding: 15px; border-radius: 18px; border: 1px solid rgba(255,255,255,0.2);
        }

        /* å¡ç‰‡è¨­è¨ˆ */
        .content-view { display: none; padding: 20px; }
        .active-view { display: block; animation: fadeIn 0.4s ease; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }

        .card { 
            background: var(--white); border-radius: 20px; padding: 20px; 
            margin-bottom: 20px; box-shadow: var(--shadow); border: 1px solid rgba(0,0,0,0.03);
        }

        /* è¼¸å…¥æ¡†ç¾åŒ– */
        label { font-size: 14px; font-weight: 600; color: var(--primary); margin-bottom: 8px; display: block; }
        input, select, textarea { 
            width: 100%; padding: 14px; border: 1.5px solid #eee; border-radius: 12px; 
            margin-bottom: 20px; font-size: 16px; transition: 0.3s; background: #fafafa;
        }
        input:focus { border-color: var(--accent); outline: none; background: white; box-shadow: 0 0 0 4px rgba(212, 175, 55, 0.1); }

        /* æŒ‰éˆ•ç¾åŒ– */
        .btn { 
            border: none; padding: 15px; border-radius: 12px; cursor: pointer; 
            font-weight: 700; width: 100%; font-size: 16px; transition: 0.3s;
            display: flex; align-items: center; justify-content: center; gap: 8px;
        }
        .btn-primary { background: var(--primary); color: white; box-shadow: 0 4px 15px rgba(27, 67, 50, 0.3); }
        .btn-primary:active { transform: scale(0.98); }
        .btn-outline { background: transparent; border: 1.5px solid #ddd; color: #666; margin-top: 10px; }

        /* æ’è¡Œæ¦œèˆ‡ç‰¹æ®Šå€å¡Š */
        .rank-badge {
            background: var(--accent); color: var(--primary); padding: 2px 10px; border-radius: 20px; font-size: 12px; font-weight: bold;
        }
        .status-tag {
            padding: 4px 12px; border-radius: 8px; font-size: 12px; background: #f0f0f0;
        }

        /* å°èˆªåˆ—å„ªåŒ– (æ‰‹æ©Ÿåº•éƒ¨å›ºå®šï¼Œæ¡Œé¢å¯¬å±) */
        nav { 
            position: fixed; bottom: 0; left: 50%; transform: translateX(-50%);
            width: 100%; max-width: 1000px; background: var(--glass); backdrop-filter: blur(15px);
            display: flex; height: 75px; box-shadow: 0 -5px 25px rgba(0,0,0,0.05); z-index: 100;
            border-radius: 20px 20px 0 0;
        }
        .nav-item { 
            flex: 1; text-align: center; display: flex; flex-direction: column; 
            justify-content: center; align-items: center; color: #aaa; font-size: 11px; cursor: pointer; transition: 0.3s;
        }
        .nav-item.active { color: var(--primary); font-weight: bold; }
        .nav-item svg { width: 24px; height: 24px; margin-bottom: 4px; }

        /* æ¡Œé¢é©é…ï¼šéš±è—æ²è»¸èˆ‡èª¿æ•´é–“éš” */
        @media (min-width: 768px) {
            body { background: #e9ecef; }
            .container { margin-top: 20px; }
            header { border-radius: 30px; }
        }
    </style>
</head>
<body>

<div id="login-screen">
    <div class="login-box">
        <div style="font-size: 40px; margin-bottom: 10px;">ğŸƒ</div>
        <h2 style="color: var(--primary); margin:0; letter-spacing: 2px;">SMART FARM</h2>
        <p style="color: #888; font-size: 14px; margin-bottom: 30px;">Elite Management System</p>
        <input type="password" id="login-pass" placeholder="è«‹è¼¸å…¥è¨ªå•å¯†ç¢¼" style="text-align: center; border-radius: 30px;">
        <button class="btn btn-primary" onclick="checkAuth()" style="border-radius: 30px;">ENTER SYSTEM</button>
    </div>
</div>

<div class="container">
    <header>
        <div style="font-size: 14px; text-transform: uppercase; letter-spacing: 2px; opacity: 0.8;">Today's Harvest</div>
        <div class="summary-grid">
            <div class="summary-item">
                <div style="font-size: 11px; opacity: 0.7;">ç¸½æ•¸é‡</div>
                <div style="font-size: 24px; font-weight: 800; color: var(--accent);"><span id="today-qty">0</span> <small style="font-size:12px;">pcs</small></div>
            </div>
            <div class="summary-item">
                <div style="font-size: 11px; opacity: 0.7;">ç¸½é‡é‡</div>
                <div style="font-size: 24px; font-weight: 800; color: #fff;"><span id="today-weight">0</span> <small style="font-size:12px;">kg</small></div>
            </div>
        </div>
    </header>

    <div id="view-home" class="content-view active-view">
        <div class="card" style="background: linear-gradient(135deg, #1b4332, #081c15); color: white; border:none; position: relative; overflow: hidden;">
            <div style="position: absolute; right: -20px; top: -20px; font-size: 100px; opacity: 0.1;">ğŸ†</div>
            <h3 style="margin: 0 0 15px 0; font-size: 16px; color: var(--accent); display: flex; align-items: center; gap: 8px;">
                Top Quality Ranking
            </h3>
            <div id="display-rank-list">
                <div style="text-align:center; opacity:0.5; font-size:13px; padding: 20px 0;">å°šç„¡æ’è¡Œç´€éŒ„</div>
            </div>
        </div>

        <div style="position: sticky; top: 10px; z-index: 10;">
            <input type="text" id="search" placeholder="ğŸ” æœå°‹æœæ¨¹ç·¨è™Ÿæˆ–åç¨±..." oninput="renderHome()" style="box-shadow: var(--shadow); border: none;">
        </div>
        <div id="tree-list-container"></div>
    </div>

    <div id="view-edit" class="content-view">
        <div class="card">
            <h3 style="margin-top:0; border-bottom: 2px solid var(--bg); padding-bottom: 15px;">æ•¸æ“šç™»éŒ„</h3>
            
            <label>æœæ¨¹åŸºæœ¬è³‡è¨Š</label>
            <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 10px;">
                <input type="text" id="f-name" placeholder="åç¨±">
                <input type="text" id="f-code" placeholder="ç·¨è™Ÿ (ä¾‹å¦‚: A-01)">
            </div>

            <label>ç”Ÿé•·éšæ®µæ¨™è¨˜</label>
            <div style="display: flex; gap: 10px; margin-bottom: 20px;">
                <div style="flex:1; background: #fff5f5; padding: 12px; border-radius: 12px; border: 1px solid #ffe3e3; text-align: center;">
                    <input type="checkbox" id="f-isBlooming" onchange="toggleFlowerLevel()" style="width: 20px; height: 20px; margin: 0 auto 5px;">
                    <div style="font-size: 12px; color: #e03131;">èŠ±æœŸä¸­</div>
                </div>
                <div style="flex:1; background: #f3f0ff; padding: 12px; border-radius: 12px; border: 1px solid #e5dbff; text-align: center;">
                    <input type="checkbox" id="f-isBagged" onchange="toggleBagQty()" style="width: 20px; height: 20px; margin: 0 auto 5px;">
                    <div style="font-size: 12px; color: #5f3dc4;">å·²å¥—è¢‹</div>
                </div>
            </div>

            <div id="flower-level-section" style="display:none; margin-bottom: 20px;">
                <label>èŠ±é‡è©•ä¼°</label>
                <div style="display: flex; gap: 10px;">
                    <label style="flex:1; background: #eee; padding: 10px; border-radius: 10px; text-align: center;"><input type="radio" name="flowerLevel" value="å°‘é‡" style="margin:0;"> å°‘é‡</label>
                    <label style="flex:1; background: #eee; padding: 10px; border-radius: 10px; text-align: center;"><input type="radio" name="flowerLevel" value="ä¸­é‡" style="margin:0;"> ä¸­é‡</label>
                    <label style="flex:1; background: #eee; padding: 10px; border-radius: 10px; text-align: center;"><input type="radio" name="flowerLevel" value="å¤§é‡" style="margin:0;"> å¤§é‡</label>
                </div>
            </div>

            <div id="bag-qty-section" style="display:none;">
                <label>æœ¬æ¬¡å¥—è¢‹æ•¸é‡</label>
                <input type="number" id="f-bagQty" placeholder="0">
            </div>

            <label>æ¡æ”¶æ•¸æ“š</label>
            <div style="background: var(--bg); padding: 15px; border-radius: 15px; margin-bottom: 20px;">
                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 10px;">
                    <div>
                        <span style="font-size: 12px; color: #888;">ç²’æ•¸</span>
                        <input type="number" id="f-harvestQty" placeholder="0" style="margin-bottom: 0;">
                    </div>
                    <div>
                        <span style="font-size: 12px; color: #888;">ç¸½é‡</span>
                        <div style="display: flex; gap: 5px;">
                            <input type="number" id="f-weightVal" placeholder="0" style="margin-bottom: 0;">
                            <select id="f-weightUnit" style="width: 80px; margin-bottom: 0; padding: 10px 5px;">
                                <option value="å…¬æ–¤">kg</option>
                                <option value="å°æ–¤">å°æ–¤</option>
                                <option value="å…¬å…‹">g</option>
                            </select>
                        </div>
                    </div>
                </div>
            </div>

            <label>ğŸ† è¨­å®šä»Šæ—¥å“è³ªæ’è¡Œ</label>
            <div style="background: #fff9db; padding: 15px; border-radius: 15px; border: 1px solid #ffe066;">
                <div style="display: grid; grid-template-columns: 40px 1fr 1fr; gap: 8px; margin-bottom: 5px; opacity: 0.5; font-size: 12px;">
                    <span>åæ¬¡</span><span>å–®é¡†é‡é‡</span><span>ç”œåº¦Brix</span>
                </div>
                <div style="display: flex; flex-direction: column; gap: 8px;">
                    <div style="display: grid; grid-template-columns: 40px 1fr 1fr; gap: 8px; align-items: center;">
                        <span class="rank-badge">1st</span><input type="text" id="rank1-w" placeholder="é‡" style="margin:0;"><input type="number" id="rank1-b" placeholder="åº¦" style="margin:0;">
                    </div>
                    <div style="display: grid; grid-template-columns: 40px 1fr 1fr; gap: 8px; align-items: center;">
                        <span class="rank-badge" style="background:#dee2e6;">2nd</span><input type="text" id="rank2-w" placeholder="é‡" style="margin:0;"><input type="number" id="rank2-b" placeholder="åº¦" style="margin:0;">
                    </div>
                </div>
            </div>

            <label style="margin-top: 20px;">ç®¡ç†ç´€éŒ„</label>
            <input type="text" id="f-fertilizer" placeholder="æ–½è‚¥é …ç›®">
            <select id="f-health">
                <option value="è‰¯å¥½">å¥åº·ç‹€æ³ï¼šè‰¯å¥½</option>
                <option value="æ³¨æ„">å¥åº·ç‹€æ³ï¼šæ³¨æ„</option>
                <option value="ç—…èŸ²å®³">å¥åº·ç‹€æ³ï¼šç—…èŸ²å®³</option>
            </select>
            <textarea id="f-pest" rows="2" placeholder="å…¶ä»–å‚™è¨»..."></textarea>

            <div style="text-align:center; margin: 20px 0;"><canvas id="qr-gen"></canvas></div>
            <button class="btn btn-primary" onclick="handleSave()">ğŸ’¾ å„²å­˜ä¸¦åŒæ­¥æ•¸æ“š</button>
            <button class="btn btn-outline" onclick="showView('home')">å–æ¶ˆè¿”å›</button>
        </div>
    </div>

    <div id="view-tools" class="content-view">
        <div class="card">
            <h3>æ•¸æ“šä¸­å¿ƒ</h3>
            <button class="btn btn-primary" onclick="exportExcel()">ğŸ“¤ åŒ¯å‡ºå¹´åº¦å ±è¡¨ (Excel)</button>
            <div style="margin-top:30px;">
                <label>æ‰¹æ¬¡åŒ¯å…¥æœåœ’æ•¸æ“š</label>
                <input type="file" id="import-file" accept=".xlsx" onchange="handleImport(event)">
            </div>
            <button class="btn btn-outline" onclick="location.reload()" style="margin-top:50px; color:#e03131; border-color: #ffc9c9;">ç™»å‡ºç³»çµ±</button>
        </div>
    </div>
</div>

<div id="scanner-ui">
    <video id="video" playsinline></video>
    <button onclick="stopScan()" style="position:absolute; bottom:40px; left:50%; transform:translateX(-50%); padding:15px 40px; background:rgba(255,0,0,0.8); color:white; border:none; border-radius:30px; backdrop-filter:blur(10px);">é—œé–‰æƒæå™¨å™¨</button>
</div>

<nav>
    <div class="nav-item active" id="nav-home" onclick="showView('home')">
        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M3 9l9-7 9 7v11a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2z"></path></svg>
        é¦–é åˆ—è¡¨
    </div>
    <div class="nav-item" id="nav-scan" onclick="startScan()">
        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><rect x="3" y="3" width="18" height="18" rx="2" ry="2"></rect><line x1="12" y1="8" x2="12" y2="16"></line><line x1="8" y1="12" x2="16" y2="12"></line></svg>
        æ¢ç¢¼æƒæ
    </div>
    <div class="nav-item" id="nav-add" onclick="prepareAdd()">
        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M12 20v-8m0 0V4m0 4h8m-8 0H4"></path></svg>
        æ–°å¢æ•¸æ“š
    </div>
    <div class="nav-item" id="nav-tools" onclick="showView('tools')">
        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><circle cx="12" cy="12" r="3"></circle><path d="M19.4 15a1.65 1.65 0 0 0 .33 1.82l.06.06a2 2 0 0 1 0 2.83 2 2 0 0 1-2.83 0l-.06-.06a1.65 1.65 0 0 0-1.82-.33 1.65 1.65 0 0 0-1 1.51V21a2 2 0 0 1-2 2 2 2 0 0 1-2-2v-.09A1.65 1.65 0 0 0 9 19.4a1.65 1.65 0 0 0-1.82.33l-.06.06a2 2 0 0 1-2.83 0 2 2 0 0 1 0-2.83l.06-.06a1.65 1.65 0 0 0 .33-1.82 1.65 1.65 0 0 0-1.51-1H3a2 2 0 0 1-2-2 2 2 0 0 1 2-2h.09A1.65 1.65 0 0 0 4.6 9a1.65 1.65 0 0 0-.33-1.82l-.06-.06a2 2 0 0 1 0-2.83 2 2 0 0 1 2.83 0l.06.06a1.65 1.65 0 0 0 1.82.33H9a1.65 1.65 0 0 0 1-1.51V3a2 2 0 0 1 2-2 2 2 0 0 1 2 2v.09a1.65 1.65 0 0 0 1 1.51 1.65 1.65 0 0 0 1.82-.33l.06-.06a2 2 0 0 1 2.83 0 2 2 0 0 1 0 2.83l-.06.06a1.65 1.65 0 0 0-.33 1.82V9a1.65 1.65 0 0 0 1.51 1H21a2 2 0 0 1 2 2 2 2 0 0 1-2 2h-.09a1.65 1.65 0 0 0-1.51 1z"></path></svg>
        ç³»çµ±è¨­å®š
    </div>
</nav>

<script>
    let db = JSON.parse(localStorage.getItem('farm_pro_v12')) || [];
    let rankStore = JSON.parse(localStorage.getItem('farm_rank_v12')) || {};

    function checkAuth() {
        const input = document.getElementById('login-pass').value;
        if (input === "admin" || input === "123") {
            document.getElementById('login-screen').style.opacity = '0';
            setTimeout(() => { document.getElementById('login-screen').style.display = 'none'; }, 300);
            renderHome();
        } else { alert("å¯†ç¢¼éŒ¯èª¤"); }
    }

    function getTodayStr() { return new Date().toISOString().split('T')[0]; }
    function toKG(val, unit) {
        const v = parseFloat(val) || 0;
        if(unit === 'å…¬å…‹') return v / 1000;
        if(unit === 'å°æ–¤') return v * 0.6;
        return v;
    }

    function toggleFlowerLevel() {
        document.getElementById('flower-level-section').style.display = document.getElementById('f-isBlooming').checked ? 'block' : 'none';
    }
    function toggleBagQty() {
        document.getElementById('bag-qty-section').style.display = document.getElementById('f-isBagged').checked ? 'block' : 'none';
    }

    function renderHome() {
        const today = getTodayStr();
        const todayData = db.filter(t => t.lastUpdate === today);

        document.getElementById('today-qty').innerText = todayData.reduce((sum, t) => sum + (parseInt(t.harvestQty) || 0), 0).toLocaleString();
        document.getElementById('today-weight').innerText = todayData.reduce((sum, t) => sum + toKG(t.weightVal, t.weightUnit), 0).toFixed(2);

        const tr = rankStore[today];
        const rDiv = document.getElementById('display-rank-list');
        if(tr && (tr.r1b || tr.r2b)) {
            let h = '';
            for(let i=1; i<=2; i++) if(tr[`r${i}b`]) h += `<div style="display:flex; justify-content:space-between; padding:8px 0; border-bottom:1px solid rgba(255,255,255,0.1);"><span>${i===1?'ğŸ¥‡':'ğŸ¥ˆ'} ${tr[`r${i}w`]}</span><span style="color:var(--accent);">${tr[`r${i}b`]} Brix</span></div>`;
            rDiv.innerHTML = h;
        } else { rDiv.innerHTML = '<div style="text-align:center; opacity:0.5; font-size:13px; padding:10px 0;">å°šæœªéŒ„å…¥å“è³ªæ’è¡Œæ•¸æ“š</div>'; }

        const query = document.getElementById('search').value.toLowerCase();
        const filtered = db.filter(t => (t.code||'').toLowerCase().includes(query) || (t.name||'').toLowerCase().includes(query));
        
        document.getElementById('tree-list-container').innerHTML = filtered.map(t => `
            <div class="card" onclick="editTree('${t.code}')">
                <div style="display:flex; justify-content:space-between; align-items:center;">
                    <div>
                        <div style="font-weight:800; font-size:16px;">${t.name || 'æœªå‘½å'}</div>
                        <div style="font-size:12px; color:#aaa; margin-bottom:5px;">#${t.code}</div>
                        <div style="display:flex; gap:5px;">
                            ${t.isBlooming ? '<span class="status-tag" style="background:#fff5f5; color:#e03131;">ğŸŒ¸ èŠ±æœŸ</span>' : ''}
                            ${t.isBagged ? '<span class="status-tag" style="background:#f3f0ff; color:#5f3dc4;">ğŸ›ï¸ å¥—è¢‹</span>' : ''}
                        </div>
                    </div>
                    <div style="text-align:right;">
                        <div style="font-size:18px; font-weight:800; color:var(--primary);">${t.harvestQty || 0} <small style="font-size:10px;">pcs</small></div>
                        <div style="font-size:12px; color:#888;">${t.weightVal || 0} ${t.weightUnit}</div>
                    </div>
                </div>
                ${t.lastUpdate === today ? '<div style="margin-top:10px; border-top:1px solid #eee; padding-top:10px; font-size:11px; color:var(--accent);">â— ä»Šæ—¥å·²åŒæ­¥æ•¸æ“š</div>' : ''}
            </div>
        `).join('');
    }

    function showView(vId) {
        document.querySelectorAll('.content-view').forEach(v => v.classList.remove('active-view'));
        document.querySelectorAll('.nav-item').forEach(n => n.classList.remove('active'));
        document.getElementById('view-'+vId).classList.add('active-view');
        document.getElementById('nav-'+vId).classList.add('active');
        if(vId === 'home') renderHome();
    }

    function prepareAdd() {
        document.querySelectorAll('#view-edit input, #view-edit textarea').forEach(el => {
            if(el.type === 'checkbox' || el.type === 'radio') el.checked = false; else el.value = '';
        });
        const today = getTodayStr();
        if(rankStore[today]) for(let i=1; i<=2; i++) { 
            document.getElementById(`rank${i}-w`).value = rankStore[today][`r${i}w`] || '';
            document.getElementById(`rank${i}-b`).value = rankStore[today][`r${i}b`] || '';
        }
        toggleFlowerLevel(); toggleBagQty();
        showView('edit');
    }

    function editTree(code) {
        const t = db.find(x => x.code === code);
        if(!t) return;
        document.getElementById('f-name').value = t.name || '';
        document.getElementById('f-code').value = t.code || '';
        document.getElementById('f-fertilizer').value = t.fertilizer || '';
        document.getElementById('f-harvestQty').value = t.harvestQty || '';
        document.getElementById('f-weightVal').value = t.weightVal || '';
        document.getElementById('f-weightUnit').value = t.weightUnit || 'å…¬æ–¤';
        document.getElementById('f-health').value = t.health || 'è‰¯å¥½';
        document.getElementById('f-pest').value = t.pest || '';
        document.getElementById('f-bagQty').value = t.bagQty || '';
        document.getElementById('f-isBlooming').checked = t.isBlooming;
        document.getElementById('f-isBagged').checked = t.isBagged;
        if(t.flowerLevel) { const r = document.querySelector(`input[name="flowerLevel"][value="${t.flowerLevel}"]`); if(r) r.checked = true; }
        const today = getTodayStr();
        if(rankStore[today]) for(let i=1; i<=2; i++) { 
            document.getElementById(`rank${i}-w`).value = rankStore[today][`r${i}w`] || '';
            document.getElementById(`rank${i}-b`).value = rankStore[today][`r${i}b`] || '';
        }
        toggleFlowerLevel(); toggleBagQty();
        new QRious({ element: document.getElementById('qr-gen'), value: t.code, size: 100 });
        showView('edit');
    }

    function handleSave() {
        const code = document.getElementById('f-code').value;
        if(!code) return alert("è«‹è¼¸å…¥ç·¨è™Ÿ");
        const today = getTodayStr();
        const flowerR = document.querySelector('input[name="flowerLevel"]:checked');
        const data = {
            lastUpdate: today,
            isBlooming: document.getElementById('f-isBlooming').checked,
            flowerLevel: (document.getElementById('f-isBlooming').checked && flowerR) ? flowerR.value : '',
            isBagged: document.getElementById('f-isBagged').checked,
            bagQty: document.getElementById('f-bagQty').value || 0,
            name: document.getElementById('f-name').value,
            code: code,
            fertilizer: document.getElementById('f-fertilizer').value,
            harvestQty: document.getElementById('f-harvestQty').value,
            weightVal: document.getElementById('f-weightVal').value,
            weightUnit: document.getElementById('f-weightUnit').value,
            health: document.getElementById('f-health').value,
            pest: document.getElementById('f-pest').value
        };
        const idx = db.findIndex(x => x.code === code);
        if(idx > -1) db[idx] = data; else db.push(data);
        localStorage.setItem('farm_pro_v12', JSON.stringify(db));

        rankStore[today] = {
            r1w: document.getElementById('rank1-w').value, r1b: document.getElementById('rank1-b').value,
            r2w: document.getElementById('rank2-w').value, r2b: document.getElementById('rank2-b').value
        };
        localStorage.setItem('farm_rank_v12', JSON.stringify(rankStore));
        alert("ğŸ‰ æ•¸æ“šå·²æˆåŠŸé›²ç«¯åŒ–å„²å­˜ (æœ¬åœ°å¿«å–)");
        showView('home');
    }

    function exportExcel() { 
        const ws = XLSX.utils.json_to_sheet(db);
        const wb = XLSX.utils.book_new();
        XLSX.utils.book_append_sheet(wb, ws, "æœåœ’å¹´åº¦æ•¸æ“š");
        XLSX.writeFile(wb, `Farm_Elite_Report_${getTodayStr()}.xlsx`); 
    }

    function handleImport(e) {
        const reader = new FileReader();
        reader.onload = (evt) => {
            const data = new Uint8Array(evt.target.result);
            const workbook = XLSX.read(data, {type: 'array'});
            const json = XLSX.utils.sheet_to_json(workbook.Sheets[workbook.SheetNames[0]]);
            json.forEach(item => { const idx = db.findIndex(x => x.code == item.code); if(idx > -1) db[idx] = item; else db.push(item); });
            localStorage.setItem('farm_pro_v12', JSON.stringify(db));
            renderHome(); alert("æ‰¹æ¬¡æ•¸æ“šåŒ¯å…¥æˆåŠŸï¼");
        };
        reader.readAsArrayBuffer(e.target.files[0]);
    }
    
    let streamPtr;
    function startScan() {
        document.getElementById('scanner-ui').style.display = 'block';
        navigator.mediaDevices.getUserMedia({ video: { facingMode: "environment" } }).then(s => {
            streamPtr = s; const v = document.getElementById('video'); v.srcObject = s; v.play();
            requestAnimationFrame(scanTick);
        }).catch(err => { alert("é¡é ­é–‹å•Ÿå¤±æ•—"); stopScan(); });
    }
    function scanTick() {
        const v = document.getElementById('video');
        if(v.readyState === v.HAVE_ENOUGH_DATA) {
            const c = document.createElement("canvas"); c.width=v.videoWidth; c.height=v.videoHeight;
            const ctx=c.getContext("2d"); ctx.drawImage(v,0,0,c.width,c.height);
            const code = jsQR(ctx.getImageData(0,0,c.width,c.height).data, c.width, c.height);
            if(code) { stopScan(); editTree(code.data); return; }
        }
        if(document.getElementById('scanner-ui').style.display === 'block') requestAnimationFrame(scanTick);
    }
    function stopScan() { if(streamPtr) streamPtr.getTracks().forEach(t => t.stop()); document.getElementById('scanner-ui').style.display = 'none'; }
</script>
</body>
</html>
