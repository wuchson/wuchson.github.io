<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>SmartFarm Pro - 2026 æ¡æ”¶å„ªåŒ–ç‰ˆ</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/jsqr@1.4.0/dist/jsQR.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/qrious/4.0.2/qrious.min.js"></script>
    
    <style>
        :root { --primary: #1b4332; --accent: #40916c; --bg: #f0f2f1; --white: #ffffff; --danger: #d00; --gold: #FFD700; --blue: #0077b6; }
        body { margin: 0; background: var(--bg); font-family: -apple-system, sans-serif; padding-bottom: 80px; }
        
        #login-screen { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: var(--primary); z-index: 5000; display: flex; align-items: center; justify-content: center; }
        .login-box { background: white; padding: 30px; border-radius: 20px; width: 85%; max-width: 320px; text-align: center; }

        header { background: var(--primary); color: white; padding: 20px; border-radius: 0 0 20px 20px; }
        .summary-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 10px; margin-top: 10px; }
        .summary-item { background: rgba(255,255,255,0.15); padding: 10px; border-radius: 12px; text-align: center; }

        .content-view { display: none; padding: 10px; }
        .active-view { display: block; }
        .card { background: var(--white); border-radius: 15px; padding: 15px; margin-bottom: 12px; box-shadow: 0 2px 8px rgba(0,0,0,0.05); }
        
        .btn { border: none; padding: 12px; border-radius: 10px; cursor: pointer; font-weight: bold; width: 100%; margin-top: 10px; font-size: 16px; }
        .btn-primary { background: var(--primary); color: white; }
        .btn-outline { background: white; border: 1px solid #ddd; color: #666; }
        
        input, select, textarea { width: 100%; padding: 10px; border: 1px solid #ddd; border-radius: 8px; margin: 5px 0 15px 0; box-sizing: border-box; font-size: 16px; }
        label { font-size: 13px; font-weight: bold; color: #555; display: block; }

        .check-group { display: flex; align-items: center; gap: 10px; background: #fdf2f4; padding: 15px; border-radius: 10px; margin-bottom: 5px; border: 1px solid #ffdae0; }
        .check-group.blue { background: #eef6fb; border-color: #caf0f8; margin-top: 15px; }
        .check-group input[type="checkbox"] { width: 22px !important; height: 22px !important; margin: 0 !important; }

        .flower-level-box { display: flex; justify-content: space-around; background: #fff; padding: 10px; border-radius: 10px; border: 1px dashed #ff85a1; margin: 10px 0; }
        .flower-level-box label { display: flex; align-items: center; gap: 5px; font-size: 14px; color: #d81b60; }
        .flower-level-box input[type="radio"] { width: auto; margin: 0; }

        .weight-group { display: flex; gap: 5px; }
        .weight-group input { flex: 2; }
        .weight-group select { flex: 1; background: #eee; }

        nav { position: fixed; bottom: 0; width: 100%; background: white; display: flex; height: 70px; box-shadow: 0 -2px 10px rgba(0,0,0,0.1); z-index: 100; }
        .nav-item { flex: 1; text-align: center; padding: 12px 0; color: #888; font-size: 12px; cursor: pointer; }
        .nav-item.active { color: var(--primary); font-weight: bold; }

        #scanner-ui { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: black; z-index: 2000; }
        #video { width: 100%; height: 100%; object-fit: cover; }
    </style>
</head>
<body>

<div id="login-screen">
    <div class="login-box">
        <h2 style="color: var(--primary); margin:0;">æœåœ’ç®¡ç†ç³»çµ±</h2>
        <input type="password" id="login-pass" placeholder="è¼¸å…¥å¯†ç¢¼" style="text-align: center;">
        <button class="btn btn-primary" onclick="checkAuth()">é€²å…¥ç³»çµ±</button>
    </div>
</div>

<header>
    <div style="font-size: 18px; font-weight: bold; text-align: center;">ğŸ ä»Šæ—¥æ¡æ”¶ç°¡å ±</div>
    <div class="summary-grid">
        <div class="summary-item">
            <div style="font-size: 11px; opacity: 0.8;">ä»Šæ—¥ç¸½æ•¸é‡</div>
            <div style="font-size: 20px; font-weight: bold; color: var(--gold);"><span id="today-qty">0</span> <small style="font-size:12px;">ç²’</small></div>
        </div>
        <div class="summary-item">
            <div style="font-size: 11px; opacity: 0.8;">ä»Šæ—¥ç¸½é‡é‡</div>
            <div style="font-size: 20px; font-weight: bold; color: #80ffdb;"><span id="today-weight">0</span> <small style="font-size:12px;">kg</small></div>
        </div>
    </div>
</header>

<div id="view-home" class="content-view active-view">
    <div class="card" style="background: linear-gradient(135deg, #1b4332, #2d6a4f); color: white; border:none;">
        <h3 style="margin: 0 0 10px 0; font-size: 15px; display: flex; align-items: center; gap: 5px;">
            ğŸ† ä»Šæ—¥ç”œåº¦ Top 3 (Brix)
        </h3>
        <div id="today-top-rank">
            <div style="text-align:center; opacity:0.6; font-size:13px;">ä»Šæ—¥å°šç„¡æ¡æ”¶ç´€éŒ„</div>
        </div>
    </div>

    <input type="text" id="search" placeholder="ğŸ” æœå°‹æœæ¨¹ç·¨è™Ÿæˆ–åç¨±..." oninput="renderHome()" style="margin: 10px 0; border: none; box-shadow: 0 2px 5px rgba(0,0,0,0.05);">
    <div id="tree-list-container"></div>
</div>

<div id="view-edit" class="content-view">
    <div class="card">
        <h3 style="margin-top:0;">æœæ¨¹æ•¸æ“šç·¨è¼¯</h3>
        
        <label>æœæ¨¹åç¨±</label><input type="text" id="f-name">
        <label>æœæ¨¹ç·¨è™Ÿ</label><input type="text" id="f-code">

        <div style="background: #fff9db; padding: 15px; border-radius: 12px; border: 1px solid #ffe066; margin-bottom: 15px;">
            <label style="color: #e67e22; font-size: 15px;">ğŸ“Š æœ¬æ¬¡æ¡æ”¶æ•¸æ“š</label>
            <div style="display: flex; gap: 8px; margin-top:10px;">
                <div style="flex:1;">
                    <label>æ¡æ”¶é‡(ç²’)</label>
                    <input type="number" id="f-harvestQty" placeholder="0">
                </div>
                <div style="flex:1;">
                    <label>ç”œåº¦(Brix)</label>
                    <input type="number" id="f-brix" step="0.1" placeholder="0.0">
                </div>
            </div>
            
            <label>é‡é‡æ•¸å€¼</label>
            <div class="weight-group">
                <input type="number" id="f-weightVal" step="0.01" placeholder="è¼¸å…¥æ•¸å€¼">
                <select id="f-weightUnit">
                    <option value="å…¬å…‹">å…¬å…‹ (g)</option>
                    <option value="å…¬æ–¤">å…¬æ–¤ (kg)</option>
                    <option value="å°æ–¤">å°æ–¤</option>
                </select>
            </div>
        </div>

        <div class="check-group">
            <input type="checkbox" id="f-isBlooming" onchange="toggleFlowerLevel()">
            <label for="f-isBlooming">ğŸŒ¸ ç›®å‰æ­£å€¼èŠ±æœŸ</label>
        </div>
        <div id="flower-level-section" style="display:none;">
            <div class="flower-level-box">
                <label><input type="radio" name="flowerLevel" value="å°‘é‡"> å°‘é‡</label>
                <label><input type="radio" name="flowerLevel" value="ä¸­é‡"> ä¸­é‡</label>
                <label><input type="radio" name="flowerLevel" value="å¤§é‡"> å¤§é‡</label>
            </div>
        </div>

        <div class="check-group blue">
            <input type="checkbox" id="f-isBagged" onchange="toggleBagQty()">
            <label for="f-isBagged">ğŸ›ï¸ å·²ç¶“å®Œæˆå¥—è¢‹</label>
        </div>
        <div id="bag-qty-section" style="display:none; padding: 0 10px;">
            <label>å¥—è¢‹ç¸½æ•¸é‡ (å€‹)</label>
            <input type="number" id="f-bagQty" placeholder="è¼¸å…¥æœ¬æ¬¡å¥—è¢‹æ•¸é‡">
        </div>

        <label style="margin-top:10px;">ğŸ§ª ç®¡ç†ç´€éŒ„</label>
        <input type="text" id="f-fertilizer" placeholder="æ–½è‚¥é …ç›®/åŠ‘é‡">
        <select id="f-health">
            <option value="è‰¯å¥½">å¥åº·ç‹€æ³ï¼šè‰¯å¥½</option>
            <option value="æ³¨æ„">å¥åº·ç‹€æ³ï¼šæ³¨æ„</option>
            <option value="ç—…èŸ²å®³">å¥åº·ç‹€æ³ï¼šç—…èŸ²å®³</option>
        </select>
        <textarea id="f-pest" rows="2" placeholder="å‚™è¨»èªªæ˜..."></textarea>

        <div style="text-align:center; margin: 15px 0;"><canvas id="qr-gen"></canvas></div>
        <button class="btn btn-primary" onclick="handleSave()">ğŸ’¾ å„²å­˜æ•¸æ“š</button>
        <button class="btn btn-outline" onclick="showView('home')">è¿”å›åˆ—è¡¨</button>
    </div>
</div>

<div id="view-tools" class="content-view">
    <div class="card">
        <h3>âš™ï¸ ç³»çµ±ç®¡ç†</h3>
        <button class="btn btn-primary" onclick="exportExcel()">ğŸ“¤ åŒ¯å‡ºå®Œæ•´ Excel å ±è¡¨</button>
        <div style="margin-top:20px;">
            <label>åŒ¯å…¥è³‡æ–™ (Excel)</label>
            <input type="file" id="import-file" accept=".xlsx" onchange="handleImport(event)">
        </div>
        <button class="btn btn-outline" onclick="location.reload()" style="margin-top:30px; color:red;">ç™»å‡ºç³»çµ±</button>
    </div>
</div>

<div id="scanner-ui">
    <video id="video" playsinline></video>
    <button onclick="stopScan()" style="position:absolute; top:20px; right:20px; padding:10px 20px; background:red; color:white; border:none; border-radius:5px;">é—œé–‰</button>
</div>

<nav>
    <div class="nav-item active" id="nav-home" onclick="showView('home')">ğŸ¡ é¦–é æ¸…å–®</div>
    <div class="nav-item" id="nav-scan" onclick="startScan()">ğŸ“· æƒææ¢ç¢¼</div>
    <div class="nav-item" id="nav-add" onclick="prepareAdd()">â• æ–°å¢ç´€éŒ„</div>
    <div class="nav-item" id="nav-tools" onclick="showView('tools')">âš™ï¸ è¨­å®š</div>
</nav>

<script>
    let db = JSON.parse(localStorage.getItem('farm_pro_v12')) || [];

    function checkAuth() {
        const input = document.getElementById('login-pass').value;
        if (input === "admin" || input === "123") {
            document.getElementById('login-screen').style.display = 'none';
            renderHome();
        } else { alert("å¯†ç¢¼éŒ¯èª¤"); }
    }

    function getTodayStr() { return new Date().toISOString().split('T')[0]; }

    function toKG(val, unit) {
        const v = parseFloat(val) || 0;
        if(unit === 'å…¬å…‹') return v / 1000;
        if(unit === 'å°æ–¤') return v * 0.6;
        return v;
    }

    function toggleFlowerLevel() {
        document.getElementById('flower-level-section').style.display = 
            document.getElementById('f-isBlooming').checked ? 'block' : 'none';
    }

    // åˆ‡æ›å¥—è¢‹æ•¸é‡é¡¯ç¤º
    function toggleBagQty() {
        document.getElementById('bag-qty-section').style.display = 
            document.getElementById('f-isBagged').checked ? 'block' : 'none';
    }

    function renderHome() {
        const today = getTodayStr();
        const todayData = db.filter(t => t.lastUpdate === today);

        const totalQty = todayData.reduce((sum, t) => sum + (parseInt(t.harvestQty) || 0), 0);
        const totalWeight = todayData.reduce((sum, t) => sum + toKG(t.weightVal, t.weightUnit), 0);
        document.getElementById('today-qty').innerText = totalQty.toLocaleString();
        document.getElementById('today-weight').innerText = totalWeight.toFixed(2);

        const top3 = [...todayData]
            .filter(t => (parseFloat(t.brix) || 0) > 0)
            .sort((a, b) => (parseFloat(b.brix) || 0) - (parseFloat(a.brix) || 0))
            .slice(0, 3);

        const rankContainer = document.getElementById('today-top-rank');
        if(top3.length > 0) {
            rankContainer.innerHTML = top3.map((t, i) => `
                <div style="display:flex; justify-content:space-between; padding:8px 0; border-bottom:1px solid rgba(255,255,255,0.1); font-size:14px;">
                    <span>${i+1}. ${t.name} <small>(${t.code})</small></span>
                    <span style="color:var(--gold); font-weight:bold;">${t.brix} Brix</span>
                </div>
            `).join('');
        } else {
            rankContainer.innerHTML = `<div style="text-align:center; opacity:0.6; font-size:13px; padding:10px;">ä»Šæ—¥å°šç„¡æ¡æ”¶æ•¸æ“š</div>`;
        }

        const query = document.getElementById('search').value.toLowerCase();
        const filtered = db.filter(t => (t.code||'').toLowerCase().includes(query) || (t.name||'').toLowerCase().includes(query));
        
        document.getElementById('tree-list-container').innerHTML = filtered.map(t => `
            <div class="card" onclick="editTree('${t.code}')">
                <div style="display:flex; justify-content:space-between; align-items:center;">
                    <div>
                        <strong>${t.name || 'æœªå‘½å'}</strong> <small style="color:#888;">#${t.code}</small><br>
                        <span style="font-size:12px; color:${t.lastUpdate === today ? 'var(--accent)' : '#999'}">
                            ${t.isBlooming ? 'ğŸŒ¸'+(t.flowerLevel||'') : ''} 
                            ${t.isBagged ? 'ğŸ›ï¸'+(t.bagQty||0) : ''}
                            ${t.lastUpdate === today ? 'â— ä»Šæ—¥æ›´æ–°' : ''}
                        </span>
                    </div>
                    <div style="text-align:right;">
                        <span style="font-size:16px; font-weight:bold; color:var(--primary);">${t.brix || 0} <small>Brix</small></span><br>
                        <small style="color:#666;">${t.harvestQty || 0} ç²’ / ${t.weightVal || 0}${t.weightUnit}</small>
                    </div>
                </div>
            </div>
        `).join('');
    }

    function showView(vId) {
        document.querySelectorAll('.content-view').forEach(v => v.classList.remove('active-view'));
        document.querySelectorAll('.nav-item').forEach(n => n.classList.remove('active'));
        document.getElementById('view-'+vId).classList.add('active-view');
        document.getElementById('nav-'+vId).classList.add('active');
        if(vId === 'home') renderHome();
    }

    function prepareAdd() {
        document.querySelectorAll('#view-edit input, #view-edit textarea').forEach(el => {
            if(el.type === 'checkbox' || el.type === 'radio') el.checked = false; else el.value = '';
        });
        document.getElementById('f-weightUnit').value = 'å…¬å…‹';
        document.getElementById('flower-level-section').style.display = 'none';
        document.getElementById('bag-qty-section').style.display = 'none';
        showView('edit');
    }

    function editTree(code) {
        const t = db.find(x => x.code === code);
        if(!t) return;
        const fields = ['name','code','fertilizer','brix','harvestQty','weightVal','weightUnit','health','pest','bagQty'];
        fields.forEach(f => { if(document.getElementById('f-'+f)) document.getElementById('f-'+f).value = t[f] || (f==='weightUnit'?'å…¬å…‹':''); });
        
        document.getElementById('f-isBlooming').checked = t.isBlooming || false;
        document.getElementById('f-isBagged').checked = t.isBagged || false;
        
        if(t.flowerLevel) {
            const r = document.querySelector(`input[name="flowerLevel"][value="${t.flowerLevel}"]`);
            if(r) r.checked = true;
        }
        toggleFlowerLevel();
        toggleBagQty();
        
        new QRious({ element: document.getElementById('qr-gen'), value: t.code, size: 100 });
        showView('edit');
    }

    function handleSave() {
        const code = document.getElementById('f-code').value;
        if(!code) return alert("è«‹è¼¸å…¥ç·¨è™Ÿ");
        
        const flowerR = document.querySelector('input[name="flowerLevel"]:checked');
        const data = {
            lastUpdate: getTodayStr(),
            isBlooming: document.getElementById('f-isBlooming').checked,
            flowerLevel: (document.getElementById('f-isBlooming').checked && flowerR) ? flowerR.value : '',
            isBagged: document.getElementById('f-isBagged').checked,
            bagQty: document.getElementById('f-bagQty').value || 0
        };
        
        const fields = ['name','code','fertilizer','brix','harvestQty','weightVal','weightUnit','health','pest'];
        fields.forEach(f => { data[f] = document.getElementById('f-'+f).value; });

        const idx = db.findIndex(x => x.code === code);
        if(idx > -1) db[idx] = data; else db.push(data);
        
        localStorage.setItem('farm_pro_v12', JSON.stringify(db));
        alert("å„²å­˜æˆåŠŸï¼");
        showView('home');
    }

    function exportExcel() { 
        const ws = XLSX.utils.json_to_sheet(db);
        const wb = XLSX.utils.book_new();
        XLSX.utils.book_append_sheet(wb, ws, "æœåœ’æ¸…å–®");
        XLSX.writeFile(wb, `FarmReport_${getTodayStr()}.xlsx`); 
    }

    function handleImport(e) {
        const reader = new FileReader();
        reader.onload = (evt) => {
            const data = new Uint8Array(evt.target.result);
            const workbook = XLSX.read(data, {type: 'array'});
            const json = XLSX.utils.sheet_to_json(workbook.Sheets[workbook.SheetNames[0]]);
            json.forEach(item => { 
                const idx = db.findIndex(x => x.code == item.code); 
                if(idx > -1) db[idx] = item; else db.push(item); 
            });
            localStorage.setItem('farm_pro_v12', JSON.stringify(db));
            renderHome(); 
            alert("åŒ¯å…¥æˆåŠŸï¼");
        };
        reader.readAsArrayBuffer(e.target.files[0]);
    }
    
    let streamPtr;
    function startScan() {
        document.getElementById('scanner-ui').style.display = 'block';
        navigator.mediaDevices.getUserMedia({ video: { facingMode: "environment" } }).then(s => {
            streamPtr = s; const v = document.getElementById('video'); v.srcObject = s; v.play();
            requestAnimationFrame(scanTick);
        }).catch(err => { alert("é¡é ­é–‹å•Ÿå¤±æ•—"); stopScan(); });
    }

    function scanTick() {
        const v = document.getElementById('video');
        if(v.readyState === v.HAVE_ENOUGH_DATA) {
            const c = document.createElement("canvas"); c.width=v.videoWidth; c.height=v.videoHeight;
            const ctx=c.getContext("2d"); ctx.drawImage(v,0,0,c.width,c.height);
            const code = jsQR(ctx.getImageData(0,0,c.width,c.height).data, c.width, c.height);
            if(code) { stopScan(); editTree(code.data); return; }
        }
        if(document.getElementById('scanner-ui').style.display === 'block') requestAnimationFrame(scanTick);
    }

    function stopScan() { 
        if(streamPtr) streamPtr.getTracks().forEach(t => t.stop()); 
        document.getElementById('scanner-ui').style.display = 'none'; 
    }
</script>
</body>
</html>
