<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>SmartFarm Pro - æ¦®è­½æœå¯¶ç‰ˆ</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/jsqr@1.4.0/dist/jsQR.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/qrious/4.0.2/qrious.min.js"></script>
    
    <style>
        :root { --primary: #1b4332; --accent: #40916c; --bg: #f0f2f1; --white: #ffffff; --danger: #d00; --gold: #FFD700; }
        body { margin: 0; background: var(--bg); font-family: -apple-system, sans-serif; padding-bottom: 80px; }
        
        /* ç™»å…¥ä»‹é¢ */
        #login-screen { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: var(--primary); z-index: 5000; display: flex; align-items: center; justify-content: center; }
        .login-box { background: white; padding: 30px; border-radius: 20px; width: 85%; max-width: 320px; text-align: center; }

        header { background: var(--primary); color: white; padding: 20px; border-radius: 0 0 20px 20px; text-align: center; }
        .content-view { display: none; padding: 10px; }
        .active-view { display: block; }
        .card { background: var(--white); border-radius: 15px; padding: 15px; margin-bottom: 12px; box-shadow: 0 2px 8px rgba(0,0,0,0.05); }
        
        .btn { border: none; padding: 12px; border-radius: 10px; cursor: pointer; font-weight: bold; width: 100%; margin-top: 10px; font-size: 16px; }
        .btn-primary { background: var(--primary); color: white; }
        .btn-outline { background: white; border: 1px solid var(--primary); color: var(--primary); }
        input, select, textarea { width: 100%; padding: 10px; border: 1px solid #ddd; border-radius: 8px; margin: 5px 0 15px 0; box-sizing: border-box; }
        label { font-size: 13px; font-weight: bold; color: #555; }

        nav { position: fixed; bottom: 0; width: 100%; background: white; display: flex; height: 75px; box-shadow: 0 -2px 10px rgba(0,0,0,0.1); z-index: 100; }
        .nav-item { flex: 1; text-align: center; padding: 12px 0; color: #888; font-size: 12px; }
        .nav-item.active { color: var(--primary); font-weight: bold; }
        .nav-icon { font-size: 22px; display: block; }

        /* æ’è¡Œæ¦œæ¨£å¼ */
        .rank-item { display: flex; align-items: center; padding: 10px; border-bottom: 1px solid #eee; }
        .rank-num { font-size: 20px; font-weight: bold; width: 35px; color: var(--accent); }
        .rank-1 { color: #FFD700; font-size: 24px; }
        .rank-2 { color: #C0C0C0; }
        .rank-3 { color: #CD7F32; }

        #scanner-ui { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: black; z-index: 2000; }
        #video { width: 100%; height: 100%; object-fit: cover; }
        .admin-only { display: none; border: 2px solid var(--gold); padding: 10px; border-radius: 10px; background: #fffdf0; margin-top: 15px; }
    </style>
</head>
<body>

<div id="login-screen">
    <div class="login-box">
        <h2 style="color: var(--primary);">æ™ºæ…§æœåœ’ç™»å…¥</h2>
        <input type="password" id="login-pass" placeholder="è«‹è¼¸å…¥å¯†ç¢¼" style="text-align: center; font-size: 18px; letter-spacing: 5px;">
        <button class="btn btn-primary" onclick="checkAuth()">é€²å…¥ç³»çµ±</button>
        <p id="err-msg" style="color: var(--danger); font-size: 12px; margin-top: 10px;"></p>
    </div>
</div>

<header>
    <div style="font-size: 22px; font-weight: bold;">SmartFarm Pro</div>
    <div id="user-tag" style="font-size: 11px; opacity: 0.8;"></div>
</header>

<div id="view-home" class="content-view active-view">
    <div class="card" style="background: var(--primary); color: white;">
        <h3 style="margin: 0 0 10px 0;">ğŸ† å„ªè‰¯æœå¯¶æ’è¡Œæ¦œ (å‰3å)</h3>
        <div id="top-rank-list"></div>
    </div>
    <input type="text" id="search" placeholder="ğŸ” æœå°‹ç·¨è™Ÿã€å“ç¨®æˆ–å•é¡Œ..." oninput="renderHome()" style="background: white; border: none; border-radius: 12px; margin: 10px 0;">
    <div id="tree-list-container"></div>
</div>

<div id="view-edit" class="content-view">
    <div class="card">
        <h3 id="edit-title">æœæ¨¹æ¡æ”¶èˆ‡è©³ç´°ç´€éŒ„</h3>
        <div style="display: flex; gap: 10px;">
            <div style="flex:2;"><label>åç¨±</label><input type="text" id="f-name"></div>
            <div style="flex:1;"><label>ç·¨è™Ÿ</label><input type="text" id="f-code"></div>
        </div>
        
        <label style="color: var(--accent);">ğŸ“Š æ¡æ”¶èˆ‡å“è³ªæ•¸æ“š</label>
        <div style="display: flex; gap: 10px; background: #f9f9f9; padding: 10px; border-radius: 10px;">
            <div style="flex:1;"><label>ç¸½é‡é‡(kg)</label><input type="number" id="f-dailyCount" step="0.1"></div>
            <div style="flex:1;"><label>ç”œåº¦(Brix)</label><input type="number" id="f-brix" step="0.1"></div>
        </div>

        <label>ğŸ“… é—œéµæ—¥æœŸ</label>
        <div style="display: flex; gap: 10px;">
            <div style="flex:1;"><label>æ ½ç¨®æ—¥</label><input type="date" id="f-plantDate"></div>
            <div style="flex:1;"><label>å¥—è¢‹æ—¥</label><input type="date" id="f-bag"></div>
        </div>

        <label>ğŸ’§ æ¾†æ°´èˆ‡ ğŸ§ª æ–½è‚¥</label>
        <input type="text" id="f-water" placeholder="æ¾†æ°´èªªæ˜">
        <input type="text" id="f-fertilizer" placeholder="è‚¥æ–™åç¨±èˆ‡æ—¥æœŸ">

        <label>âœ‚ ä¿®å‰ªç´€éŒ„ (å¤§/å°)</label>
        <div style="display: flex; gap: 10px;">
            <input type="text" id="f-pruneBig" placeholder="å¤§ä¿®å‰ª">
            <input type="text" id="f-pruneSmall" placeholder="å°ä¿®å‰ª">
        </div>

        <label>ğŸ¥ å¥åº·ç‹€æ³èˆ‡é†«æ²»</label>
        <select id="f-health"><option>è‰¯å¥½</option><option>æ³¨æ„</option><option>ç—…èŸ²å®³</option></select>
        <textarea id="f-pest" rows="2" placeholder="ç—…èŸ²å®³å•é¡Œèªªæ˜..."></textarea>
        <div style="display: flex; gap: 10px;">
            <input type="date" id="f-treatDate">
            <input type="text" id="f-medicine" placeholder="è—¥ç‰©èˆ‡åŠ‘é‡">
        </div>

        <div style="text-align:center; margin-top:15px;"><canvas id="qr-gen"></canvas></div>
        <button class="btn btn-primary" onclick="handleSave()">ğŸ’¾ å„²å­˜æ›´æ–°</button>
        <button class="btn btn-outline" onclick="showView('home')">å–æ¶ˆ</button>
    </div>
</div>

<div id="view-tools" class="content-view">
    <div class="card">
        <h3>ğŸ“Š æ•¸æ“šèˆ‡æ¬Šé™ç®¡ç†</h3>
        <button class="btn btn-primary" onclick="exportExcel()">ğŸ“¤ åŒ¯å‡º Excel å…¨ç´€éŒ„</button>
        <input type="file" id="import-file" accept=".xlsx" onchange="handleImport(event)" style="margin-top:15px;">
        
        <div id="admin-panel" class="admin-only">
            <h4 style="margin:0; color:var(--primary);">ğŸ”‘ ç®¡ç†å“¡å·¥å…·ï¼šä¿®æ”¹å¯†ç¢¼</h4>
            <input type="text" id="new-user-pwd" placeholder="æ–°ä½¿ç”¨è€…å¯†ç¢¼">
            <button class="btn btn-primary" onclick="updateUserPwd()">å„²å­˜æ–°å¯†ç¢¼</button>
        </div>

        <button class="btn" style="background:#ffeded; color:var(--danger); margin-top: 30px;" onclick="clearAll()">âš ï¸ é‡ç½®æ‰€æœ‰è³‡æ–™</button>
        <button class="btn btn-outline" onclick="location.reload()">ğŸ”’ å®‰å…¨ç™»å‡º</button>
    </div>
</div>

<div id="scanner-ui">
    <video id="video" playsinline></video>
    <button onclick="stopScan()" style="position:fixed; bottom:30px; left:50%; transform:translateX(-50%); padding:12px 25px; border-radius:20px;">é—œé–‰ç›¸æ©Ÿ</button>
</div>

<nav>
    <div class="nav-item active" id="nav-home" onclick="showView('home')"><span class="nav-icon">ğŸŒ³</span>æ¸…å–®</div>
    <div class="nav-item" id="nav-scan" onclick="startScan()"><span class="nav-icon">ğŸ“·</span>æƒæ</div>
    <div class="nav-item" id="nav-add" onclick="prepareAdd()"><span class="nav-icon">â•</span>æ–°å¢</div>
    <div class="nav-item" id="nav-tools" onclick="showView('tools')"><span class="nav-icon">âš™ï¸</span>æ•¸æ“š</div>
</nav>

<script>
    const ADMIN_PWD = "admin";
    let currentUserRole = ""; 
    let db = JSON.parse(localStorage.getItem('farm_pro_v6')) || [];

    function checkAuth() {
        const input = document.getElementById('login-pass').value;
        const storedUserPwd = localStorage.getItem('app_user_pwd') || "123";
        if (input === ADMIN_PWD) {
            currentUserRole = "admin";
            document.getElementById('login-screen').style.display = 'none';
            document.getElementById('admin-panel').style.display = 'block';
            document.getElementById('user-tag').innerText = "æ¬Šé™ï¼šç®¡ç†å“¡";
        } else if (input === storedUserPwd) {
            currentUserRole = "user";
            document.getElementById('login-screen').style.display = 'none';
            document.getElementById('user-tag').innerText = "æ¬Šé™ï¼šä¸€èˆ¬ä½¿ç”¨è€…";
        } else {
            document.getElementById('err-msg').innerText = "å¯†ç¢¼éŒ¯èª¤ï¼";
        }
        renderHome();
    }

    function showView(viewId) {
        document.querySelectorAll('.content-view').forEach(v => v.classList.remove('active-view'));
        document.querySelectorAll('.nav-item').forEach(n => n.classList.remove('active'));
        document.getElementById('view-' + viewId).classList.add('active-view');
        document.getElementById('nav-' + viewId).classList.add('active');
        if(viewId === 'home') renderHome();
    }

    function renderHome() {
        // æ›´æ–°æ’è¡Œæ¦œ (ä¾ç”œåº¦æ’åº)
        const sortedDb = [...db].sort((a, b) => (parseFloat(b.brix) || 0) - (parseFloat(a.brix) || 0)).slice(0, 3);
        const rankList = document.getElementById('top-rank-list');
        rankList.innerHTML = sortedDb.length ? sortedDb.map((t, i) => `
            <div class="rank-item">
                <span class="rank-num rank-${i+1}">${i+1}</span>
                <div style="flex:1"><strong>${t.name}</strong> (${t.code})</div>
                <div style="text-align:right"><span style="color:var(--gold)">Brix: ${t.brix || 0}</span><br><small>${t.dailyCount || 0}kg</small></div>
            </div>
        `).join('') : '<div style="font-size:12px; opacity:0.7">å°šç„¡æ¡æ”¶æ•¸æ“š</div>';

        // æ›´æ–°æ¸…å–®
        const query = document.getElementById('search').value.toLowerCase();
        const container = document.getElementById('tree-list-container');
        const filtered = db.filter(t => (t.code||'').toLowerCase().includes(query) || (t.name||'').toLowerCase().includes(query));
        container.innerHTML = filtered.map(t => `
            <div class="card" onclick="editTree('${t.code}')" style="display:flex; justify-content:space-between; align-items:center;">
                <div><strong>${t.code} - ${t.name}</strong><br><span style="font-size:12px; color:#666;">ç”œåº¦: ${t.brix||0} | é‡é‡: ${t.dailyCount||0}kg</span></div>
                <span style="color:var(--accent)">â¯</span>
            </div>
        `).join('');
    }

    function prepareAdd() {
        document.querySelectorAll('#view-edit input, #view-edit textarea').forEach(el => el.value = '');
        document.getElementById('qr-gen').style.display = 'none';
        showView('edit');
    }

    function editTree(code) {
        const t = db.find(x => x.code === code);
        if(!t) return;
        const fields = ['name','code','plantDate','water','pruneBig','pruneSmall','fertilizer','bloom','bag','harvestEnd','dailyCount','brix','health','pest','treatDate','medicine'];
        fields.forEach(f => { if(document.getElementById('f-'+f)) document.getElementById('f-'+f).value = t[f] || ''; });
        new QRious({ element: document.getElementById('qr-gen'), value: t.code, size: 120 });
        document.getElementById('qr-gen').style.display = 'inline-block';
        showView('edit');
    }

    function handleSave() {
        const code = document.getElementById('f-code').value;
        if(!code) return alert("ç·¨è™Ÿå¿…å¡«");
        const data = {};
        const fields = ['name','code','plantDate','water','pruneBig','pruneSmall','fertilizer','bloom','bag','harvestEnd','dailyCount','brix','health','pest','treatDate','medicine'];
        fields.forEach(f => { data[f] = document.getElementById('f-'+f).value; });
        const idx = db.findIndex(x => x.code === code);
        if(idx > -1) db[idx] = data; else db.push(data);
        localStorage.setItem('farm_pro_v6', JSON.stringify(db));
        showView('home');
    }

    function exportExcel() {
        const ws = XLSX.utils.json_to_sheet(db);
        const wb = XLSX.utils.book_new();
        XLSX.utils.book_append_sheet(wb, ws, "æœåœ’ç´€éŒ„");
        XLSX.writeFile(wb, "SmartFarm_Report.xlsx");
    }

    function handleImport(e) {
        const reader = new FileReader();
        reader.onload = (evt) => {
            const jsonData = XLSX.utils.sheet_to_json(XLSX.read(new Uint8Array(evt.target.result), {type: 'array'}).Sheets[0]);
            jsonData.forEach(item => {
                const idx = db.findIndex(x => x.code == item.code);
                if(idx > -1) db[idx] = item; else db.push(item);
            });
            localStorage.setItem('farm_pro_v6', JSON.stringify(db));
            renderHome(); showView('home'); alert("åŒ¯å…¥å®Œæˆ");
        };
        reader.readAsArrayBuffer(e.target.files[0]);
    }

    function updateUserPwd() {
        const newPwd = document.getElementById('new-user-pwd').value;
        if(newPwd) { localStorage.setItem('app_user_pwd', newPwd); alert("å¯†ç¢¼å·²æ›´æ–°"); }
    }

    let streamPtr;
    function startScan() {
        document.getElementById('scanner-ui').style.display = 'block';
        navigator.mediaDevices.getUserMedia({ video: { facingMode: "environment" } }).then(s => {
            streamPtr = s; const v = document.getElementById('video'); v.srcObject = s; v.play();
            requestAnimationFrame(scanTick);
        });
    }
    function scanTick() {
        const v = document.getElementById('video');
        if(v.readyState === v.HAVE_ENOUGH_DATA) {
            const canvas = document.createElement("canvas"); canvas.width = v.videoWidth; canvas.height = v.videoHeight;
            const ctx = canvas.getContext("2d"); ctx.drawImage(v, 0, 0, canvas.width, canvas.height);
            const img = ctx.getImageData(0, 0, canvas.width, canvas.height);
            const code = jsQR(img.data, img.width, img.height);
            if(code) { stopScan(); editTree(code.data); return; }
        }
        if(document.getElementById('scanner-ui').style.display === 'block') requestAnimationFrame(scanTick);
    }
    function stopScan() { if(streamPtr) streamPtr.getTracks().forEach(t => t.stop()); document.getElementById('scanner-ui').style.display = 'none'; }
    function clearAll() { if(confirm("ç¢ºå®šæ°¸ä¹…åˆªé™¤æ‰€æœ‰è³‡æ–™ï¼Ÿ")) { db = []; localStorage.clear(); location.reload(); } }

</script>
</body>
</html>
