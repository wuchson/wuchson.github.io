<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>SmartFarm Pro - å¤šå–®ä½ç‰ˆ</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/jsqr@1.4.0/dist/jsQR.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/qrious/4.0.2/qrious.min.js"></script>
    
    <style>
        :root { --primary: #1b4332; --accent: #40916c; --bg: #f0f2f1; --white: #ffffff; --danger: #d00; --gold: #FFD700; --blue: #0077b6; --pink: #ff85a1; }
        body { margin: 0; background: var(--bg); font-family: -apple-system, sans-serif; padding-bottom: 80px; }
        
        #login-screen { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: var(--primary); z-index: 5000; display: flex; align-items: center; justify-content: center; }
        .login-box { background: white; padding: 30px; border-radius: 20px; width: 85%; max-width: 320px; text-align: center; }

        header { background: var(--primary); color: white; padding: 20px; border-radius: 0 0 20px 20px; text-align: center; }
        .content-view { display: none; padding: 10px; }
        .active-view { display: block; }
        .card { background: var(--white); border-radius: 15px; padding: 15px; margin-bottom: 12px; box-shadow: 0 2px 8px rgba(0,0,0,0.05); }
        
        .btn { border: none; padding: 12px; border-radius: 10px; cursor: pointer; font-weight: bold; width: 100%; margin-top: 10px; font-size: 16px; }
        .btn-primary { background: var(--primary); color: white; }
        .btn-outline { background: white; border: 1px solid var(--primary); color: var(--primary); }
        input, select, textarea { width: 100%; padding: 10px; border: 1px solid #ddd; border-radius: 8px; margin: 5px 0 15px 0; box-sizing: border-box; }
        label { font-size: 13px; font-weight: bold; color: #555; display: block; }

        .check-group { display: flex; align-items: center; gap: 12px; background: #fdf2f4; padding: 12px; border-radius: 10px; margin-bottom: 5px; border: 1px solid #ffdae0; }
        .check-group.blue { background: #eef6fb; border-color: #caf0f8; margin-top: 15px; }
        .flower-level-box { display: flex; justify-content: space-around; background: #fff; padding: 10px; border-radius: 10px; border: 1px dashed #ff85a1; margin-bottom: 15px; }
        
        /* å–®ä½é¸æ“‡ä½ˆå±€ */
        .weight-group { display: flex; gap: 5px; }
        .weight-group input { flex: 2; }
        .weight-group select { flex: 1; background: #f0f0f0; }

        nav { position: fixed; bottom: 0; width: 100%; background: white; display: flex; height: 75px; box-shadow: 0 -2px 10px rgba(0,0,0,0.1); z-index: 100; }
        .nav-item { flex: 1; text-align: center; padding: 12px 0; color: #888; font-size: 12px; }
        .nav-item.active { color: var(--primary); font-weight: bold; }

        #scanner-ui { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: black; z-index: 2000; }
        #video { width: 100%; height: 100%; object-fit: cover; }
    </style>
</head>
<body>

<div id="login-screen">
    <div class="login-box">
        <h2 style="color: var(--primary); margin:0;">æœåœ’ç®¡ç†ç³»çµ±</h2>
        <input type="password" id="login-pass" placeholder="è¼¸å…¥å¯†ç¢¼" style="text-align: center; font-size: 18px;">
        <button class="btn btn-primary" onclick="checkAuth()">é€²å…¥</button>
    </div>
</div>

<header>
    <div style="font-size: 18px; font-weight: bold;">SmartFarm æ•¸æ“šä¸­å¿ƒ</div>
    <div style="font-size: 13px; margin-top: 8px; background: rgba(0,0,0,0.2); padding: 10px; border-radius: 10px;">
        ğŸ å¹´åº¦æ¡æ”¶ï¼š<span id="total-harvest-count" style="font-size: 18px; color: var(--gold); font-weight: bold;">0</span> ç²’
    </div>
</header>

<div id="view-home" class="content-view active-view">
    <div class="card" style="background: var(--primary); color: white;">
        <h3 style="margin: 0 0 5px 0; font-size: 14px;">ğŸ† ç”œåº¦å‰3å</h3>
        <div id="top-rank-list"></div>
    </div>
    <input type="text" id="search" placeholder="ğŸ” æœå°‹ç·¨è™Ÿã€åç¨±..." oninput="renderHome()" style="background: white; border: none; border-radius: 12px; margin: 10px 0;">
    <div id="tree-list-container"></div>
</div>

<div id="view-edit" class="content-view">
    <div class="card">
        <h3 style="margin-top:0;">æœæ¨¹æª”æ¡ˆç·¨è¼¯</h3>
        
        <label>åç¨±</label><input type="text" id="f-name">
        <label>ğŸ“… æ ½ç¨®æ—¥æœŸ</label><input type="date" id="f-plantDate">
        <label>ç·¨è™Ÿ</label><input type="text" id="f-code">

        <hr style="border: 0.5px solid #eee; margin: 15px 0;">

        <div class="check-group">
            <input type="checkbox" id="f-isBlooming" onchange="toggleFlowerLevel()">
            <label style="margin:0; font-size: 16px; color: #d81b60;">ğŸŒ¸ ç›®å‰æ˜¯å¦é–‹èŠ±ï¼Ÿ</label>
        </div>
        <div id="flower-level-section" style="display:none;">
            <div class="flower-level-box">
                <label><input type="radio" name="flowerLevel" value="å°‘é‡"> å°‘é‡</label>
                <label><input type="radio" name="flowerLevel" value="ä¸­é‡"> ä¸­é‡</label>
                <label><input type="radio" name="flowerLevel" value="å¤§é‡"> å¤§é‡</label>
            </div>
        </div>

        <div class="check-group blue">
            <input type="checkbox" id="f-isBagged">
            <label style="margin:0; font-size: 16px; color: var(--blue);">ğŸ›ï¸ æ˜¯å¦å·²å¥—è¢‹ï¼Ÿ</label>
        </div>
        <label>å¥—è¢‹æ•¸é‡ (å€‹)</label>
        <input type="number" id="f-bagQty">

        <label style="color: var(--accent); font-weight: bold; margin-top:15px;">ğŸ“Š æ¡æ”¶èˆ‡å“è³ªæ•¸æ“š</label>
        <div style="background: #f9f9f9; padding: 12px; border-radius: 10px;">
            <div style="display: flex; gap: 8px; margin-bottom: 10px;">
                <div style="flex:1;"><label>æ¡æ”¶(ç²’)</label><input type="number" id="f-harvestQty"></div>
                <div style="flex:1;"><label>ç”œåº¦(Brix)</label><input type="number" id="f-brix" step="0.1"></div>
            </div>
            <label>ç¸½é‡é‡ (å¯é¸æ“‡å–®ä½)</label>
            <div class="weight-group">
                <input type="number" id="f-weightVal" step="0.01" placeholder="è¼¸å…¥æ•¸å€¼">
                <select id="f-weightUnit">
                    <option value="å…¬æ–¤">å…¬æ–¤</option>
                    <option value="å°æ–¤">å°æ–¤</option>
                    <option value="å…¬å…‹">å…¬å…‹</option>
                </select>
            </div>
        </div>

        <label style="margin-top:10px;">ğŸ§ª æ–½è‚¥/âœ‚ ä¿®å‰ª/ğŸ¥ å¥åº·</label>
        <input type="text" id="f-fertilizer" placeholder="æ–½è‚¥ç´€éŒ„">
        <input type="text" id="f-prune" placeholder="ä¿®å‰ªç´€éŒ„">
        <select id="f-health"><option>è‰¯å¥½</option><option>æ³¨æ„</option><option>ç—…èŸ²å®³</option></select>
        <textarea id="f-pest" rows="2" placeholder="å‚™è¨»/ç—…èŸ²å®³èªªæ˜..."></textarea>

        <div style="text-align:center; margin-top:15px;"><canvas id="qr-gen"></canvas></div>
        <button class="btn btn-primary" onclick="handleSave()">ğŸ’¾ å„²å­˜</button>
        <button class="btn btn-outline" onclick="showView('home')">å–æ¶ˆ</button>
    </div>
</div>

<div id="view-tools" class="content-view">
    <div class="card">
        <h3>âš™ï¸ ç®¡ç†</h3>
        <button class="btn btn-primary" onclick="exportExcel()">ğŸ“¤ åŒ¯å‡º Excel</button>
        <input type="file" id="import-file" accept=".xlsx" onchange="handleImport(event)" style="margin-top:10px;">
        <button class="btn btn-outline" onclick="location.reload()">ç™»å‡º</button>
    </div>
</div>

<div id="scanner-ui"><video id="video" playsinline></video><button onclick="stopScan()">é—œé–‰</button></div>

<nav>
    <div class="nav-item active" id="nav-home" onclick="showView('home')">æ¸…å–®</div>
    <div class="nav-item" id="nav-scan" onclick="startScan()">æƒæ</div>
    <div class="nav-item" id="nav-add" onclick="prepareAdd()">æ–°å¢</div>
    <div class="nav-item" id="nav-tools" onclick="showView('tools')">è¨­å®š</div>
</nav>

<script>
    let db = JSON.parse(localStorage.getItem('farm_pro_v11')) || [];

    function checkAuth() {
        const input = document.getElementById('login-pass').value;
        const storedUserPwd = localStorage.getItem('app_user_pwd') || "123";
        if (input === "admin" || input === storedUserPwd) {
            document.getElementById('login-screen').style.display = 'none';
            renderHome();
        } else { alert("å¯†ç¢¼éŒ¯èª¤"); }
    }

    function toggleFlowerLevel() {
        document.getElementById('flower-level-section').style.display = document.getElementById('f-isBlooming').checked ? 'block' : 'none';
    }

    function renderHome() {
        const totalQty = db.reduce((sum, t) => sum + (parseInt(t.harvestQty) || 0), 0);
        document.getElementById('total-harvest-count').innerText = totalQty.toLocaleString();

        const sortedDb = [...db].sort((a, b) => (parseFloat(b.brix) || 0) - (parseFloat(a.brix) || 0)).slice(0, 3);
        document.getElementById('top-rank-list').innerHTML = sortedDb.map((t, i) => `
            <div style="font-size:12px; display:flex; justify-content:space-between; padding:2px 0;">
                <span>#${i+1} ${t.name}</span><span>${t.brix||0} Brix</span>
            </div>
        `).join('');

        const query = document.getElementById('search').value.toLowerCase();
        const filtered = db.filter(t => (t.code||'').toLowerCase().includes(query) || (t.name||'').toLowerCase().includes(query));
        document.getElementById('tree-list-container').innerHTML = filtered.map(t => `
            <div class="card" onclick="editTree('${t.code}')">
                <div style="display:flex; justify-content:space-between; align-items:center;">
                    <div>
                        <strong>${t.name}</strong> <small>(${t.code})</small><br>
                        <span style="font-size:12px; color:#666;">
                            ${t.isBlooming ? 'ğŸŒ¸'+(t.flowerLevel||'') : ''} ${t.isBagged ? 'ğŸ›ï¸å¥—è¢‹('+(t.bagQty||0)+')' : ''}
                        </span>
                    </div>
                    <div style="text-align:right;">
                        <span style="color:var(--accent); font-weight:bold;">${t.harvestQty||0} ç²’</span><br>
                        <small style="color:#999;">${t.weightVal || 0} ${t.weightUnit || 'å…¬æ–¤'}</small>
                    </div>
                </div>
            </div>
        `).join('');
    }

    function showView(vId) {
        document.querySelectorAll('.content-view').forEach(v => v.classList.remove('active-view'));
        document.querySelectorAll('.nav-item').forEach(n => n.classList.remove('active'));
        document.getElementById('view-'+vId).classList.add('active-view');
        document.getElementById('nav-'+vId).classList.add('active');
        if(vId === 'home') renderHome();
    }

    function prepareAdd() {
        document.querySelectorAll('#view-edit input, #view-edit textarea').forEach(el => {
            if(el.type === 'checkbox' || el.type === 'radio') el.checked = false; else el.value = '';
        });
        document.getElementById('f-weightUnit').value = 'å…¬æ–¤';
        document.getElementById('flower-level-section').style.display = 'none';
        showView('edit');
    }

    function editTree(code) {
        const t = db.find(x => x.code === code);
        if(!t) return;
        const fields = ['name','code','plantDate','fertilizer','prune','brix','harvestQty','bagQty','weightVal','weightUnit','health','pest'];
        fields.forEach(f => { if(document.getElementById('f-'+f)) document.getElementById('f-'+f).value = t[f] || (f==='weightUnit'?'å…¬æ–¤':''); });
        document.getElementById('f-isBlooming').checked = t.isBlooming || false;
        document.getElementById('f-isBagged').checked = t.isBagged || false;
        if(t.flowerLevel) {
            const r = document.querySelector(`input[name="flowerLevel"][value="${t.flowerLevel}"]`);
            if(r) r.checked = true;
        }
        toggleFlowerLevel();
        new QRious({ element: document.getElementById('qr-gen'), value: t.code, size: 120 });
        showView('edit');
    }

    function handleSave() {
        const code = document.getElementById('f-code').value;
        if(!code) return alert("ç·¨è™Ÿå¿…å¡«");
        const flowerR = document.querySelector('input[name="flowerLevel"]:checked');
        const data = { 
            isBlooming: document.getElementById('f-isBlooming').checked,
            flowerLevel: flowerR ? flowerR.value : '',
            isBagged: document.getElementById('f-isBagged').checked 
        };
        const fields = ['name','code','plantDate','fertilizer','prune','brix','harvestQty','bagQty','weightVal','weightUnit','health','pest'];
        fields.forEach(f => { data[f] = document.getElementById('f-'+f).value; });
        const idx = db.findIndex(x => x.code === code);
        if(idx > -1) db[idx] = data; else db.push(data);
        localStorage.setItem('farm_pro_v11', JSON.stringify(db));
        showView('home');
    }

    function exportExcel() { XLSX.writeFile(XLSX.utils.book_append_sheet(XLSX.utils.book_new(), XLSX.utils.json_to_sheet(db), "æœåœ’"), "FarmData.xlsx"); }
    function handleImport(e) {
        const reader = new FileReader();
        reader.onload = (evt) => {
            const json = XLSX.utils.sheet_to_json(XLSX.read(new Uint8Array(evt.target.result), {type: 'array'}).Sheets[0]);
            json.forEach(item => { const idx = db.findIndex(x => x.code == item.code); if(idx > -1) db[idx] = item; else db.push(item); });
            localStorage.setItem('farm_pro_v11', JSON.stringify(db));
            renderHome(); alert("æˆåŠŸ");
        };
        reader.readAsArrayBuffer(e.target.files[0]);
    }
    
    let streamPtr;
    function startScan() {
        document.getElementById('scanner-ui').style.display = 'block';
        navigator.mediaDevices.getUserMedia({ video: { facingMode: "environment" } }).then(s => {
            streamPtr = s; const v = document.getElementById('video'); v.srcObject = s; v.play();
            requestAnimationFrame(scanTick);
        });
    }
    function scanTick() {
        const v = document.getElementById('video');
        if(v.readyState === v.HAVE_ENOUGH_DATA) {
            const c = document.createElement("canvas"); c.width=v.videoWidth; c.height=v.videoHeight;
            const ctx=c.getContext("2d"); ctx.drawImage(v,0,0,c.width,c.height);
            const code = jsQR(ctx.getImageData(0,0,c.width,c.height).data, c.width, c.height);
            if(code) { stopScan(); editTree(code.data); return; }
        }
        if(document.getElementById('scanner-ui').style.display === 'block') requestAnimationFrame(scanTick);
    }
    function stopScan() { if(streamPtr) streamPtr.getTracks().forEach(t => t.stop()); document.getElementById('scanner-ui').style.display = 'none'; }
</script>
</body>
</html>
