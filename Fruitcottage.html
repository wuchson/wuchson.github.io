<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>SmartFarm Pro - ç”¢é‡çµ±è¨ˆç‰ˆ</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/jsqr@1.4.0/dist/jsQR.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/qrious/4.0.2/qrious.min.js"></script>
    
    <style>
        :root { --primary: #1b4332; --accent: #40916c; --bg: #f0f2f1; --white: #ffffff; --danger: #d00; --gold: #FFD700; }
        body { margin: 0; background: var(--bg); font-family: -apple-system, sans-serif; padding-bottom: 80px; }
        
        /* ç™»å…¥ä»‹é¢ */
        #login-screen { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: var(--primary); z-index: 5000; display: flex; align-items: center; justify-content: center; }
        .login-box { background: white; padding: 30px; border-radius: 20px; width: 85%; max-width: 320px; text-align: center; }

        header { background: var(--primary); color: white; padding: 20px; border-radius: 0 0 20px 20px; text-align: center; }
        .content-view { display: none; padding: 10px; }
        .active-view { display: block; }
        .card { background: var(--white); border-radius: 15px; padding: 15px; margin-bottom: 12px; box-shadow: 0 2px 8px rgba(0,0,0,0.05); }
        
        .btn { border: none; padding: 12px; border-radius: 10px; cursor: pointer; font-weight: bold; width: 100%; margin-top: 10px; font-size: 16px; }
        .btn-primary { background: var(--primary); color: white; }
        .btn-outline { background: white; border: 1px solid var(--primary); color: var(--primary); }
        input, select, textarea { width: 100%; padding: 10px; border: 1px solid #ddd; border-radius: 8px; margin: 5px 0 15px 0; box-sizing: border-box; }
        label { font-size: 13px; font-weight: bold; color: #555; display: block; }

        /* å‹¾é¸æ¡†ç‰¹æ®Šæ¨£å¼ */
        .check-group { display: flex; align-items: center; gap: 10px; background: #eef7f2; padding: 10px; border-radius: 8px; margin-bottom: 15px; }
        .check-group input[type="checkbox"] { width: 25px; height: 25px; margin: 0; }

        nav { position: fixed; bottom: 0; width: 100%; background: white; display: flex; height: 75px; box-shadow: 0 -2px 10px rgba(0,0,0,0.1); z-index: 100; }
        .nav-item { flex: 1; text-align: center; padding: 12px 0; color: #888; font-size: 12px; }
        .nav-item.active { color: var(--primary); font-weight: bold; }

        .rank-item { display: flex; align-items: center; padding: 10px; border-bottom: 1px solid rgba(255,255,255,0.1); }
        .rank-num { font-size: 18px; font-weight: bold; width: 30px; }
        
        #scanner-ui { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: black; z-index: 2000; }
        #video { width: 100%; height: 100%; object-fit: cover; }
        .admin-only { display: none; border: 2px solid var(--gold); padding: 10px; border-radius: 10px; background: #fffdf0; margin-top: 15px; }
    </style>
</head>
<body>

<div id="login-screen">
    <div class="login-box">
        <h2 style="color: var(--primary);">æœåœ’ç®¡ç†ç³»çµ±</h2>
        <input type="password" id="login-pass" placeholder="è«‹è¼¸å…¥å¯†ç¢¼" style="text-align: center; font-size: 18px;">
        <button class="btn btn-primary" onclick="checkAuth()">é€²å…¥ç³»çµ±</button>
        <p id="err-msg" style="color: var(--danger); font-size: 12px;"></p>
    </div>
</div>

<header>
    <div style="font-size: 20px; font-weight: bold;">SmartFarm æ•¸æ“šçœ‹æ¿</div>
    <div style="font-size: 13px; margin-top: 8px; background: rgba(0,0,0,0.2); padding: 10px; border-radius: 10px;">
        ğŸ å¹´åº¦æ¡æ”¶ç¸½è¨ˆï¼š<span id="total-harvest-count" style="font-size: 18px; color: var(--gold); font-weight: bold;">0</span> ç²’
    </div>
</header>

<div id="view-home" class="content-view active-view">
    <div class="card" style="background: var(--primary); color: white;">
        <h3 style="margin: 0 0 10px 0; font-size: 16px;">ğŸ† å„ªè³ªæ’è¡Œæ¦œå‰3ç²’ (ä¾ç”œåº¦)</h3>
        <div id="top-rank-list"></div>
    </div>
    <input type="text" id="search" placeholder="ğŸ” æœå°‹ç·¨è™Ÿã€å“ç¨®..." oninput="renderHome()" style="background: white; border: none; border-radius: 12px; margin: 10px 0;">
    <div id="tree-list-container"></div>
</div>

<div id="view-edit" class="content-view">
    <div class="card">
        <h3 id="edit-title">æœæ¨¹æª”æ¡ˆç·¨è¼¯</h3>
        
        <label>åç¨±</label>
        <input type="text" id="f-name">
        <label>ğŸ“… æ ½ç¨®æ—¥æœŸ</label>
        <input type="date" id="f-plantDate">
        <label>ç·¨è™Ÿ</label>
        <input type="text" id="f-code">

        <hr style="border: 0.5px solid #eee; margin: 20px 0;">

        <div class="check-group">
            <input type="checkbox" id="f-isBlooming">
            <label style="margin:0; font-size: 16px;">ğŸŒ¸ ç›®å‰æ˜¯å¦é–‹èŠ±ï¼Ÿ</label>
        </div>
        <label>é–‹èŠ±æœŸè©³ç´°èªªæ˜</label>
        <textarea id="f-bloomDesc" rows="2" placeholder="èªªæ˜é–‹èŠ±ç‹€æ³..."></textarea>

        <label style="color: var(--accent); font-weight: bold;">ğŸ“Š æ¡æ”¶èˆ‡å“è³ªæ•¸æ“š</label>
        <div style="display: flex; gap: 10px; background: #f9f9f9; padding: 10px; border-radius: 10px;">
            <div style="flex:1;"><label>æ•¸é‡ (ç²’)</label><input type="number" id="f-harvestQty"></div>
            <div style="flex:1;"><label>ç¸½é‡ (kg)</label><input type="number" id="f-dailyCount" step="0.1"></div>
            <div style="flex:1;"><label>ç”œåº¦ (Brix)</label><input type="number" id="f-brix" step="0.1"></div>
        </div>

        <label>ğŸ’§ æ¾†æ°´èªªæ˜</label><input type="text" id="f-water">
        <label>ğŸ§ª æ–½è‚¥ç´€éŒ„</label><input type="text" id="f-fertilizer">
        <div style="display: flex; gap: 10px;">
            <div style="flex:1;"><label>å¤§ä¿®å‰ª</label><input type="text" id="f-pruneBig"></div>
            <div style="flex:1;"><label>å°ä¿®å‰ª</label><input type="text" id="f-pruneSmall"></div>
        </div>
        
        <label>ğŸ›ï¸ å¥—è¢‹æ—¥</label><input type="date" id="f-bag">
        <label>ğŸ¥ å¥åº·ç‹€æ³</label>
        <select id="f-health"><option>è‰¯å¥½</option><option>æ³¨æ„</option><option>ç—…èŸ²å®³</option></select>
        <textarea id="f-pest" rows="2" placeholder="ç—…èŸ²å®³/è—¥åŠ‘åŠ‘é‡èªªæ˜..."></textarea>

        <div style="text-align:center; margin-top:15px;"><canvas id="qr-gen"></canvas></div>
        <button class="btn btn-primary" onclick="handleSave()">ğŸ’¾ å„²å­˜è³‡æ–™</button>
        <button class="btn btn-outline" onclick="showView('home')">å–æ¶ˆ</button>
    </div>
</div>

<div id="view-tools" class="content-view">
    <div class="card">
        <h3>âš™ï¸ ç³»çµ±ç®¡ç†</h3>
        <button class="btn btn-primary" onclick="exportExcel()">ğŸ“¤ åŒ¯å‡º Excel å ±è¡¨</button>
        <input type="file" id="import-file" accept=".xlsx" onchange="handleImport(event)" style="margin-top:15px;">
        <div id="admin-panel" class="admin-only">
            <h4 style="margin:10px 0; color:var(--primary);">ğŸ”’ æ›´æ”¹ä½¿ç”¨è€…å¯†ç¢¼</h4>
            <input type="text" id="new-user-pwd" placeholder="æ–°å¯†ç¢¼">
            <button class="btn btn-primary" onclick="updateUserPwd()">ç¢ºèªä¿®æ”¹</button>
        </div>
        <button class="btn" style="background:#ffeded; color:var(--danger); margin-top: 30px;" onclick="clearAll()">âš ï¸ åˆªé™¤æ‰€æœ‰è³‡æ–™</button>
        <button class="btn btn-outline" onclick="location.reload()">ğŸ”’ ç™»å‡º</button>
    </div>
</div>

<div id="scanner-ui">
    <video id="video" playsinline></video>
    <button onclick="stopScan()" style="position:fixed; bottom:30px; left:50%; transform:translateX(-50%); padding:12px 25px; border-radius:20px;">é—œé–‰ç›¸æ©Ÿ</button>
</div>

<nav>
    <div class="nav-item active" id="nav-home" onclick="showView('home')">æ¸…å–®</div>
    <div class="nav-item" id="nav-scan" onclick="startScan()">æƒæ</div>
    <div class="nav-item" id="nav-add" onclick="prepareAdd()">æ–°å¢</div>
    <div class="nav-item" id="nav-tools" onclick="showView('tools')">è¨­å®š</div>
</nav>

<script>
    const ADMIN_PWD = "admin";
    let db = JSON.parse(localStorage.getItem('farm_pro_v7')) || [];

    function checkAuth() {
        const input = document.getElementById('login-pass').value;
        const storedUserPwd = localStorage.getItem('app_user_pwd') || "123";
        if (input === ADMIN_PWD || input === storedUserPwd) {
            document.getElementById('login-screen').style.display = 'none';
            if(input === ADMIN_PWD) document.getElementById('admin-panel').style.display = 'block';
            renderHome();
        } else {
            document.getElementById('err-msg').innerText = "å¯†ç¢¼éŒ¯èª¤";
        }
    }

    function renderHome() {
        // è¨ˆç®—å¹´åº¦ç¸½ç”¢é‡ (ç²’)
        const totalQty = db.reduce((sum, t) => sum + (parseInt(t.harvestQty) || 0), 0);
        document.getElementById('total-harvest-count').innerText = totalQty.toLocaleString();

        // ä¾ç”œåº¦æ’åå‰3ç²’
        const sortedDb = [...db].sort((a, b) => (parseFloat(b.brix) || 0) - (parseFloat(a.brix) || 0)).slice(0, 3);
        const rankList = document.getElementById('top-rank-list');
        rankList.innerHTML = sortedDb.map((t, i) => `
            <div class="rank-item">
                <span class="rank-num">${i+1}</span>
                <div style="flex:1"><strong>${t.name}</strong> <small>(${t.code})</small></div>
                <div style="text-align:right">
                    <span style="color:var(--gold)">Brix: ${t.brix || 0}</span><br>
                    <small>${t.harvestQty || 0}ç²’ / ${t.dailyCount || 0}kg</small>
                </div>
            </div>
        `).join('');

        const query = document.getElementById('search').value.toLowerCase();
        const container = document.getElementById('tree-list-container');
        const filtered = db.filter(t => (t.code||'').toLowerCase().includes(query) || (t.name||'').toLowerCase().includes(query));
        container.innerHTML = filtered.map(t => `
            <div class="card" onclick="editTree('${t.code}')" style="display:flex; justify-content:space-between; align-items:center;">
                <div>
                    <strong>${t.name}</strong> <small>(${t.code})</small><br>
                    <span style="font-size:12px; color:#666;">
                        ${t.isBlooming ? 'ğŸŒ¸ é–‹èŠ±ä¸­' : 'ğŸŒ¿ ç”Ÿé•·æœŸ'} | ç”¢é‡: ${t.harvestQty||0}ç²’
                    </span>
                </div>
                <span>â¯</span>
            </div>
        `).join('');
    }

    function showView(viewId) {
        document.querySelectorAll('.content-view').forEach(v => v.classList.remove('active-view'));
        document.querySelectorAll('.nav-item').forEach(n => n.classList.remove('active'));
        document.getElementById('view-' + viewId).classList.add('active-view');
        document.getElementById('nav-' + viewId).classList.add('active');
        if(viewId === 'home') renderHome();
    }

    function prepareAdd() {
        document.querySelectorAll('#view-edit input, #view-edit textarea').forEach(el => {
            if(el.type === 'checkbox') el.checked = false; else el.value = '';
        });
        document.getElementById('qr-gen').style.display = 'none';
        showView('edit');
    }

    function editTree(code) {
        const t = db.find(x => x.code === code);
        if(!t) return;
        const fields = ['name','code','plantDate','water','pruneBig','pruneSmall','fertilizer','bloomDesc','bag','dailyCount','brix','harvestQty','health','pest'];
        fields.forEach(f => { if(document.getElementById('f-'+f)) document.getElementById('f-'+f).value = t[f] || ''; });
        document.getElementById('f-isBlooming').checked = t.isBlooming || false;
        new QRious({ element: document.getElementById('qr-gen'), value: t.code, size: 120 });
        document.getElementById('qr-gen').style.display = 'inline-block';
        showView('edit');
    }

    function handleSave() {
        const code = document.getElementById('f-code').value;
        if(!code) return alert("ç·¨è™Ÿå¿…å¡«");
        const data = { isBlooming: document.getElementById('f-isBlooming').checked };
        const fields = ['name','code','plantDate','water','pruneBig','pruneSmall','fertilizer','bloomDesc','bag','dailyCount','brix','harvestQty','health','pest'];
        fields.forEach(f => { data[f] = document.getElementById('f-'+f).value; });
        const idx = db.findIndex(x => x.code === code);
        if(idx > -1) db[idx] = data; else db.push(data);
        localStorage.setItem('farm_pro_v7', JSON.stringify(db));
        showView('home');
    }

    function exportExcel() {
        XLSX.writeFile(XLSX.utils.book_append_sheet(XLSX.utils.book_new(), XLSX.utils.json_to_sheet(db), "æœåœ’"), "Farm_Data.xlsx");
    }

    function handleImport(e) {
        const reader = new FileReader();
        reader.onload = (evt) => {
            const json = XLSX.utils.sheet_to_json(XLSX.read(new Uint8Array(evt.target.result), {type: 'array'}).Sheets[0]);
            json.forEach(item => { const idx = db.findIndex(x => x.code == item.code); if(idx > -1) db[idx] = item; else db.push(item); });
            localStorage.setItem('farm_pro_v7', JSON.stringify(db));
            renderHome(); alert("åŒ¯å…¥æˆåŠŸ");
        };
        reader.readAsArrayBuffer(e.target.files[0]);
    }

    function updateUserPwd() {
        const p = document.getElementById('new-user-pwd').value;
        if(p) { localStorage.setItem('app_user_pwd', p); alert("å¯†ç¢¼å·²æ”¹"); }
    }

    let streamPtr;
    function startScan() {
        document.getElementById('scanner-ui').style.display = 'block';
        navigator.mediaDevices.getUserMedia({ video: { facingMode: "environment" } }).then(s => {
            streamPtr = s; const v = document.getElementById('video'); v.srcObject = s; v.play();
            requestAnimationFrame(scanTick);
        });
    }
    function scanTick() {
        const v = document.getElementById('video');
        if(v.readyState === v.HAVE_ENOUGH_DATA) {
            const code = jsQR(v.getContext ? v.getContext("2d").getImageData(0,0,v.width,v.height).data : 
            (() => { const c = document.createElement("canvas"); c.width=v.videoWidth; c.height=v.videoHeight; const ctx=c.getContext("2d"); ctx.drawImage(v,0,0); return ctx.getImageData(0,0,c.width,c.height); })().data, v.videoWidth, v.videoHeight);
            if(code) { stopScan(); editTree(code.data); return; }
        }
        if(document.getElementById('scanner-ui').style.display === 'block') requestAnimationFrame(scanTick);
    }
    function stopScan() { if(streamPtr) streamPtr.getTracks().forEach(t => t.stop()); document.getElementById('scanner-ui').style.display = 'none'; }
    function clearAll() { if(confirm("æ¸…é™¤ï¼Ÿ")) { localStorage.clear(); location.reload(); } }
</script>
</body>
</html>
