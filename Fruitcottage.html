<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>å°ˆæ¥­æœæ¨¹ç®¡ç†ç³»çµ± v3.5 çµ±è¨ˆå¢å¼·ç‰ˆ</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    
    <style>
        :root {
            --primary: #2d6a4f;
            --primary-dark: #1b4332;
            --accent: #d4a373;
            --bg: #f4f6f5;
            --white: #ffffff;
            --text-dark: #1b4332;
            --radius: 16px;
            --danger: #e63946;
            --warning: #ffb703;
            --money: #2a9d8f;
            --info: #457b9d;
        }

        * { -webkit-tap-highlight-color: transparent; outline: none; color: var(--text-dark); box-sizing: border-box; }
        html, body { height: 100%; margin: 0; background: #222; display: flex; justify-content: center; align-items: center; font-family: -apple-system, sans-serif; overflow: hidden; }
        
        .container { width: 100vw; max-width: 500px; height: 100vh; height: -webkit-fill-available; background: var(--bg); display: flex; flex-direction: column; position: relative; }

        /* é ‚éƒ¨æ©«å¹… */
        #backup-banner { background: var(--warning); padding: 10px 15px; display: none; align-items: center; justify-content: space-between; font-size: 14px; font-weight: bold; z-index: 10001; }
        
        /* ç™»å…¥ç•«é¢ */
        #login-screen { position: absolute; top: 0; left: 0; width: 100%; height: 100%; background: var(--primary-dark); z-index: 9999; display: flex; align-items: center; justify-content: center; }
        .login-box { background: var(--white); padding: 40px 30px; border-radius: 30px; width: 85%; text-align: center; }

        header { background: var(--primary); padding: 15px 20px 20px 20px; text-align: center; border-radius: 0 0 35px 35px; flex-shrink: 0; z-index: 10; position: relative; }
        header * { color: var(--white) !important; }
        .logout-text-btn { position: absolute; right: 15px; top: 12px; background: rgba(255,255,255,0.2); padding: 4px 12px; border-radius: 20px; font-size: 13px; cursor: pointer; }

        /* å…§å®¹å€åŸŸ */
        .content-area { flex: 1; overflow-y: auto; padding: 15px; -webkit-overflow-scrolling: touch; }
        .content-view { display: none; }
        .active-view { display: block; }

        .card { background: var(--white); border-radius: var(--radius); padding: 18px; margin-bottom: 15px; box-shadow: 0 4px 15px rgba(0,0,0,0.05); }
        
        /* è¡¨å–®å…ƒç´  */
        input, select, textarea { width: 100%; padding: 12px; border: 1.5px solid #dcdcdc; border-radius: 12px; font-size: 16px; margin-bottom: 5px; background: #fff !important; }
        
        /* çµ±è¨ˆè¡¨æ ¼å°ˆç”¨æ¨£å¼ */
        .stats-table { width: 100%; border-collapse: collapse; margin-top: 10px; font-size: 14px; }
        .stats-table th { background: #f8f9f8; padding: 10px; text-align: left; border-bottom: 2px solid var(--primary); }
        .stats-table td { padding: 10px; border-bottom: 1px solid #eee; }
        .stats-row-month { font-weight: bold; background: #f0f7f4; }
        
        /* æŒ‰éˆ•æ¨£å¼ */
        .btn { border: none; padding: 16px; border-radius: 14px; cursor: pointer; font-weight: bold; width: 100%; font-size: 16px; margin-top: 10px; display: flex; align-items: center; justify-content: center; gap: 8px; }
        .btn-primary { background: var(--primary); color: white !important; }
        .btn-info { background: var(--info); color: white !important; }
        .btn-warning { background: var(--warning); color: #000 !important; }
        .btn-danger { background: var(--danger); color: white !important; }
        .btn-outline { background: #e0e0e0; color: #333 !important; }

        .section-title { color: var(--primary); border-left: 4px solid var(--primary); padding-left: 8px; margin: 20px 0 10px 0; font-weight: bold; }
        
        /* å°è¦½åˆ— */
        nav { flex-shrink: 0; width: 100%; height: 80px; background: var(--white); display: flex; border-top: 1px solid #eee; padding-bottom: env(safe-area-inset-bottom); }
        .nav-item { flex: 1; display: flex; flex-direction: column; align-items: center; justify-content: center; font-size: 12px; cursor: pointer; }
        .nav-item div { color: #888; margin-top: 4px; }
        .nav-item.active div { color: var(--primary); font-weight: bold; }
        .nav-add-btn { background: var(--primary); color: white !important; width: 50px; height: 50px; border-radius: 50%; display: flex; align-items: center; justify-content: center; font-size: 28px; }

        .admin-only { display: none; }
        .sub-field { display: none; margin-top: 5px; padding: 10px; background: #f8f9f8; border-radius: 12px; border: 1px dashed #ccc; }
        .user-tag { display: inline-flex; align-items: center; background: #e8f5e9; padding: 5px 12px; border-radius: 20px; margin: 5px; font-size: 14px; border: 1px solid var(--primary); }
    </style>
</head>
<body>

<div class="container">
    <div id="backup-banner">
        [cite_start]<div class="banner-content" onclick="handleBackupNow()">âš ï¸ å»ºè­°ç«‹å³é€²è¡Œ Excel å‚™ä»½åŒ¯å‡º [cite: 161, 162]</div>
        [cite_start]<div onclick="closeBackupBanner()" style="padding: 5px; cursor: pointer; opacity: 0.7;">âœ• [cite: 163]</div>
    </div>

    <div id="login-screen">
        <div class="login-box">
            <h2 style="color: var(--primary); margin-top: 0;">æœæ¨¹ç®¡ç†ç³»çµ± v3.5</h2>
            [cite_start]<p style="font-size: 12px; color: #666;">è«‹è¼¸å…¥äººå“¡å§“åæˆ–ç®¡ç†å“¡å¯†ç¢¼ [cite: 58]</p>
            [cite_start]<input type="text" id="login-pass" placeholder="äººå“¡å§“åæˆ–å¯†ç¢¼" style="text-align: center;"> [cite: 58]
            [cite_start]<button class="btn btn-primary" onclick="checkAuth()">ç™»å…¥ç³»çµ±</button> [cite: 58]
        </div>
    </div>

    <header>
        [cite_start]<div class="logout-text-btn" onclick="logout()">ç™»å‡º</div> [cite: 16, 17]
        <div style="font-size: 13px; opacity: 0.9;">
            [cite_start]<span id="user-icon">ğŸ‘¤</span> <span id="user-role-display"></span> | [cite: 59]
            [cite_start]<span id="display-today"></span> [cite: 59]
        </div>
        <div style="margin: 10px 0;">
            <select id="header-area-filter" onchange="renderHome(); refreshStats();" style="width: auto; padding: 5px 15px; border-radius: 20px; font-size: 14px; background: rgba(255,255,255,0.2) !important; color: white !important; border: 1px solid white; cursor: pointer;">
                [cite_start]<option value="å…¨éƒ¨">å…¨å ´æ•¸æ“šåŠ ç¸½</option> [cite: 60]
                [cite_start]<option value="Aå€">Aå€</option> [cite: 60]
                [cite_start]<option value="Bå€">Bå€</option> [cite: 60]
                [cite_start]<option value="Cå€">Cå€</option> [cite: 60]
            </select>
        </div>
        <div style="display: flex; justify-content: space-around; gap: 5px;">
            [cite_start]<div>ä»Šæ—¥æ¡æ”¶<br><b id="today-qty" style="font-size:20px;">0</b> <small>ç²’</small></div> [cite: 60]
            [cite_start]<div>ä»Šæ—¥é‡é‡<br><b id="today-weight" style="font-size:20px;">0.0</b> <small>KG</small></div> [cite: 60]
            [cite_start]<div>ä»Šæ—¥æ”¶å…¥<br><b id="today-income" style="font-size:20px; color:#ffb703 !important;">0</b> <small>å…ƒ</small></div> [cite: 61]
        </div>
    </header>

    <div class="content-area">
        <div id="view-home" class="content-view active-view">
            [cite_start]<div class="card" style="background: linear-gradient(135deg, #2d6a4f, #1b4332); color: white; margin-bottom: 10px;"> [cite: 61, 62]
                [cite_start]<h4 style="margin:0 0 8px 0; color: #d4a373;">ğŸ† ä»Šæ—¥å“è³ªæ’è¡Œ (ç”œåº¦)</h4> [cite: 63]
                [cite_start]<div id="display-rank-list" style="font-size:14px; color: white !important;"></div> [cite: 63, 64]
            </div>

            [cite_start]<div class="card" style="background: #2d6a4f; color: white;"> [cite: 64, 65]
                [cite_start]<h4 style="margin:0 0 5px 0; color: #d4a373;">ğŸ“ˆ æœ¬é€±æ¡æ”¶è¶¨å‹¢ (è¿‘7æ—¥)</h4> [cite: 66]
                [cite_start]<div id="weekly-trend-chart" class="trend-container" style="display: flex; align-items: flex-end; gap: 8px; height: 80px; margin-top: 20px;"></div> [cite: 37, 66]
                <div style="margin-top: 22px; font-size: 12px; text-align: center; opacity: 0.9;">
                    æœ¬é€±ç´¯è¨ˆ: <span id="weekly-total-qty" style="font-weight: bold; color: #d4a373 !important;">0</span> ç²’ / 
                    [cite_start]æ”¶å…¥: <span id="weekly-total-income" style="font-weight: bold; color: #ffb703 !important;">0</span> å…ƒ [cite: 67, 68, 69]
                </div>
            </div>

            [cite_start]<input type="text" id="search" placeholder="ğŸ” æœå°‹ç·¨è™Ÿæˆ–åç¨±..." oninput="renderHome()" style="margin-top: 10px;"> [cite: 69]
            [cite_start]<div id="tree-list-container"></div> [cite: 69]
        </div>

        <div id="view-stats" class="content-view">
            <div class="card">
                <h3 style="color:var(--primary); margin:0 0 15px 0;">ğŸ“Š æ•¸æ“šçµ±è¨ˆä¸­å¿ƒ</h3>
                <label>é¸æ“‡å¹´åº¦</label>
                <select id="stats-year-select" onchange="renderStats()"></select>
                
                <div class="section-title">å¹´åº¦ç¸½è¨ˆ</div>
                <div class="grid-3" style="text-align:center; background:#f9f9f9; padding:15px; border-radius:12px;">
                    <div><small>ç¸½æ¡æ”¶</small><br><b id="stat-year-qty">0</b></div>
                    <div><small>ç¸½é‡é‡</small><br><b id="stat-year-weight">0</b></div>
                    <div><small>ç¸½æ”¶å…¥</small><br><b id="stat-year-income" style="color:var(--money)">0</b></div>
                </div>

                <div class="section-title">å„æœˆæ˜ç´°æ‘˜è¦</div>
                <div style="overflow-x: auto;">
                    <table class="stats-table" id="month-stats-table">
                        <thead>
                            <tr>
                                <th>æœˆä»½</th>
                                <th>æ•¸é‡</th>
                                <th>é‡é‡</th>
                                <th>æ”¶å…¥</th>
                                <th>æ“ä½œ</th>
                            </tr>
                        </thead>
                        <tbody id="month-stats-body"></tbody>
                    </table>
                </div>
            </div>
            
            <div id="month-detail-card" class="card" style="display:none;">
                <h4 id="month-detail-title" style="color:var(--info);"></h4>
                <div id="month-detail-list" style="font-size: 13px;"></div>
                <button class="btn btn-outline" onclick="document.getElementById('month-detail-card').style.display='none'">é—œé–‰æ˜ç´°</button>
            </div>
        </div>

        <div id="view-edit" class="content-view">
            <div class="card">
                [cite_start]<h3 style="margin:0 0 15px 0; color:var(--primary);">ğŸ“ ç´€éŒ„å¡«å ±</h3> [cite: 71]
                <div class="grid-2">
                    [cite_start]<div><label>ğŸ“… æ—¥æœŸ</label><input type="date" id="f-date"></div> [cite: 71]
                    [cite_start]<div><label>ğŸ‘¤ å¡«å¯«äºº</label><input type="text" id="f-user-static" readonly style="background:#f0f0f0 !important;"></div> [cite: 71]
                </div>
                [cite_start]<div class="section-title">ğŸ“ åŸºæœ¬è³‡è¨Š</div> [cite: 72]
                [cite_start]<select id="f-area"><option value="Aå€">Aå€</option><option value="Bå€">Bå€</option><option value="Cå€">Cå€</option></select> [cite: 72]
                [cite_start]<div class="grid-2"><input type="text" id="f-name" placeholder="åç¨±"><input type="text" id="f-code" placeholder="ç·¨è™Ÿ"></div> [cite: 72]
                
                [cite_start]<button class="btn btn-primary" onclick="handleSave()" style="margin-top: 20px;">ğŸ’¾ å„²å­˜ç´€éŒ„</button> [cite: 89]
                [cite_start]<button id="delete-btn" class="btn btn-danger admin-only" onclick="deleteCurrentRecord()">ğŸ—‘ï¸ åˆªé™¤</button> [cite: 90]
                [cite_start]<button class="btn btn-outline" onclick="showView('home')">å–æ¶ˆ</button> [cite: 90]
            </div>
        </div>

        <div id="view-tools" class="content-view admin-only">
            </div>
    </div>

    <nav>
        [cite_start]<div class="nav-item active" id="n-home" onclick="showView('home')"><span>ğŸ“‹</span><div>æ¸…å–®</div></div> [cite: 97]
        <div class="nav-item" id="n-stats" onclick="showView('stats')"><span>ğŸ“Š</span><div>çµ±è¨ˆ</div></div>
        [cite_start]<div class="nav-item" onclick="prepareAdd()"><div class="nav-add-btn">ï¼‹</div></div> [cite: 97]
        [cite_start]<div class="nav-item admin-only" id="n-tools" onclick="showView('tools')"><span>âš™ï¸</span><div>è¨­å®š</div></div> [cite: 97]
    </nav>
</div>
<script>
    // --- åŸºç¤è³‡æ–™åˆå§‹åŒ– ---
    let db = JSON.parse(localStorage.getItem('farm_v31')) || [];
    let rankStore = JSON.parse(localStorage.getItem('rank_v31')) || {};
    let userList = JSON.parse(localStorage.getItem('user_list_v31')) || [];
    let lastBackup = localStorage.getItem('last_backup_time') || "";
    let currentUser = "";
    let isAdmin = false;

    const ADMIN_PASS = "admin123";
    const getToday = () => new Date().toISOString().split('T')[0];

    window.onload = function() {
        checkBackupStatus();
        initYearSelector();
    };

    // --- çµ±è¨ˆæ ¸å¿ƒåŠŸèƒ½ ---

    // åˆå§‹åŒ–å¹´ä»½ä¸‹æ‹‰é¸å–®
    function initYearSelector() {
        const yearSelect = document.getElementById('stats-year-select');
        if (!yearSelect) return;
        
        const years = [...new Set(db.map(item => item.date.split('-')[0]))];
        const currentYear = new Date().getFullYear().toString();
        if (!years.includes(currentYear)) years.push(currentYear);
        
        years.sort((a, b) => b - a);
        yearSelect.innerHTML = years.map(y => `<option value="${y}">${y} å¹´</option>`).join('');
    }

    // æ¸²æŸ“çµ±è¨ˆé é¢
    function renderStats() {
        const targetYear = document.getElementById('stats-year-select').value;
        const area = document.getElementById('header-area-filter').value;
        
        // 1. ç¯©é¸è³‡æ–™ (å¹´ä»½ + å€åŸŸ)
        let filtered = db.filter(t => t.date.startsWith(targetYear));
        if (area !== "å…¨éƒ¨") {
            filtered = filtered.filter(t => t.area === area);
        }

        // 2. è¨ˆç®—å¹´åº¦ç¸½è¨ˆ
        const yQty = filtered.reduce((s, t) => s + (parseInt(t.harvestQty) || 0), 0);
        const yWeight = filtered.reduce((s, t) => s + (parseFloat(t.weightVal) || 0), 0).toFixed(1);
        const yIncome = filtered.reduce((s, t) => s + (parseInt(t.income) || 0), 0);

        document.getElementById('stat-year-qty').innerText = yQty.toLocaleString();
        document.getElementById('stat-year-weight').innerText = yWeight;
        document.getElementById('stat-year-income').innerText = yIncome.toLocaleString();

        // 3. è¨ˆç®—å„æœˆæ‘˜è¦
        const monthBody = document.getElementById('month-stats-body');
        monthBody.innerHTML = "";

        for (let m = 1; m <= 12; m++) {
            const monthStr = `${targetYear}-${m.toString().padStart(2, '0')}`;
            const mData = filtered.filter(t => t.date.startsWith(monthStr));
            
            if (mData.length > 0) {
                const mQty = mData.reduce((s, t) => s + (parseInt(t.harvestQty) || 0), 0);
                const mWeight = mData.reduce((s, t) => s + (parseFloat(t.weightVal) || 0), 0).toFixed(1);
                const mIncome = mData.reduce((s, t) => s + (parseInt(t.income) || 0), 0);

                const row = document.createElement('tr');
                row.innerHTML = `
                    <td>${m}æœˆ</td>
                    <td>${mQty}</td>
                    <td>${mWeight}</td>
                    <td style="color:var(--money)">$${mIncome.toLocaleString()}</td>
                    <td><button class="btn-info" style="padding:4px 8px; font-size:12px; margin:0;" onclick="showMonthDetail('${monthStr}')">æ˜ç´°</button></td>
                `;
                monthBody.appendChild(row);
            }
        }
    }

    // é¡¯ç¤ºæœˆä»½æ˜ç´°åˆ—è¡¨
    function showMonthDetail(monthStr) {
        const area = document.getElementById('header-area-filter').value;
        let mData = db.filter(t => t.date.startsWith(monthStr));
        if (area !== "å…¨éƒ¨") mData = mData.filter(t => t.area === area);

        const container = document.getElementById('month-detail-list');
        const card = document.getElementById('month-detail-card');
        document.getElementById('month-detail-title').innerText = `ğŸ“… ${monthStr} æ˜ç´°åˆ—è¡¨`;

        if (mData.length === 0) {
            container.innerHTML = "ç„¡ç´€éŒ„";
        } else {
            // æŒ‰æ—¥æœŸæ’åº
            mData.sort((a, b) => b.date.localeCompare(a.date));
            container.innerHTML = mData.map(t => `
                <div style="padding:10px; border-bottom:1px solid #eee; display:flex; justify-content:space-between; align-items:center;">
                    <div>
                        <b>${t.date.slice(8)}æ—¥</b> | ${t.name} <small>(#${t.code})</small><br>
                        <span style="color:#666;">${t.harvestQty || 0}ç²’ / ${t.weightVal || 0}kg</span>
                    </div>
                    <div style="text-align:right; color:var(--money); font-weight:bold;">
                        $${(parseInt(t.income) || 0).toLocaleString()}
                    </div>
                </div>
            `).join('');
        }
        card.style.display = 'block';
        card.scrollIntoView({ behavior: 'smooth' });
    }

    // åˆ‡æ›è¦–åœ–æ™‚é‡æ–°æ•´ç†çµ±è¨ˆè³‡æ–™
    function refreshStats() {
        if (document.getElementById('view-stats').classList.contains('active-view')) {
            renderStats();
        }
    }

    // --- ç™»å…¥é©—è­‰ (å»¶ç”¨ä¸¦å¢å¼·) ---
    function checkAuth() {
        const input = document.getElementById('login-pass').value.trim();
        if (!input) return alert("è«‹è¼¸å…¥å§“åæˆ–å¯†ç¢¼");
        
        if (input === ADMIN_PASS) { 
            isAdmin = true;
            currentUser = "ç®¡ç†å“¡"; 
        } else if (userList.includes(input)) { 
            isAdmin = false;
            currentUser = input; 
        } else {
            return alert("å§“åä¸åœ¨æˆæ¬Šåå–®ä¸­ï¼Œè«‹è¯ç¹«ç®¡ç†å“¡");
        }

        if(isAdmin) {
            document.querySelectorAll('.admin-only').forEach(el => {
                el.style.display = (el.classList.contains('nav-item') ? 'flex' : 'block');
            });
        }
        document.getElementById('login-screen').style.display = 'none';
        document.getElementById('user-role-display').innerText = currentUser;
        document.getElementById('display-today').innerText = getToday();
        renderHome();
        initYearSelector();
    }
</script>
// --- ä»‹é¢åˆ‡æ›èˆ‡ UI é‚è¼¯ ---
    function showView(vId) {
        // éš±è—æ‰€æœ‰è¦–åœ–ä¸¦ç§»é™¤å°è¦½åˆ—å•Ÿç”¨ç‹€æ…‹
        document.querySelectorAll('.content-view').forEach(v => v.classList.remove('active-view'));
        document.querySelectorAll('.nav-item').forEach(n => n.classList.remove('active'));

        // é¡¯ç¤ºç›®æ¨™è¦–åœ–
        const targetView = document.getElementById('view-' + vId);
        if (targetView) targetView.classList.add('active-view');

        [cite_start]// è¨­å®šå°è¦½åˆ—åœ–ç¤ºå•Ÿç”¨ç‹€æ…‹ [cite: 142]
        const navItem = document.getElementById('n-' + vId);
        if (navItem) navItem.classList.add('active');

        // æ ¹æ“šè¦–åœ–åŸ·è¡Œç‰¹å®šæ¸²æŸ“
        if (vId === 'home') renderHome();
        if (vId === 'stats') {
            initYearSelector();
            renderStats();
        }
        if (vId === 'tools') {
            [cite_start]renderUserList(); [cite: 144]
            [cite_start]updateBackupDisplay(); [cite: 144]
        }
    }

    [cite_start]// è¡¨å–®å­æ¬„ä½åˆ‡æ›é‚è¼¯ [cite: 165]
    function toggleSubField(checkboxId, boxId) {
        const box = document.getElementById(boxId);
        const isChecked = document.getElementById(checkboxId).checked;
        box.style.display = isChecked ? 'block' : 'none';
    }

    // --- è³‡æ–™ç®¡ç†åŠŸèƒ½ ---

    [cite_start]// åŒ¯å‡º Excel ä¸¦æ›´æ–°å‚™ä»½æ™‚é–“ [cite: 145, 146]
    function exportExcel() {
        if (db.length === 0) return alert("ç›®å‰æ²’æœ‰è³‡æ–™å¯ä»¥åŒ¯å‡º");
        
        [cite_start]const ws = XLSX.utils.json_to_sheet(db); [cite: 145]
        [cite_start]const wb = XLSX.utils.book_new(); [cite: 145]
        [cite_start]XLSX.utils.book_append_sheet(wb, ws, "æœåœ’ç´€éŒ„"); [cite: 145]
        
        [cite_start]const fileName = `æœåœ’ç®¡ç†ç´€éŒ„_${getToday()}.xlsx`; [cite: 145]
        [cite_start]XLSX.writeFile(wb, fileName); [cite: 145]

        [cite_start]const now = new Date().toLocaleString(); [cite: 146]
        [cite_start]localStorage.setItem('last_backup_time', now); [cite: 146]
        [cite_start]updateBackupDisplay(); [cite: 146]
        [cite_start]closeBackupBanner(); [cite: 146]
    }

    [cite_start]// åŒ¯å…¥ Excel é‚è¼¯ [cite: 148-154]
    function importExcel(input) {
        [cite_start]const file = input.files[0]; [cite: 148]
        if (!file) return;

        const reader = new FileReader();
        reader.onload = function(e) {
            try {
                [cite_start]const data = new Uint8Array(e.target.result); [cite: 149]
                [cite_start]const workbook = XLSX.read(data, { type: 'array' }); [cite: 149]
                [cite_start]const worksheet = workbook.Sheets[workbook.SheetNames[0]]; [cite: 149]
                [cite_start]const importedData = XLSX.utils.sheet_to_json(worksheet); [cite: 149]

                [cite_start]if (importedData.length === 0) return alert("æª”æ¡ˆå…§æ²’æœ‰è³‡æ–™"); [cite: 150]

                if (confirm(`è®€å–åˆ° ${importedData.length} ç­†è³‡æ–™ã€‚è¦è¦†è“‹ç¾æœ‰è³‡æ–™å—ï¼Ÿ\n(æŒ‰å–æ¶ˆå‰‡ç‚ºã€Œæ–°å¢ã€è‡³ç¾æœ‰è³‡æ–™å¾Œæ–¹)`)) {
                    [cite_start]db = importedData; [cite: 151]
                } else {
                    [cite_start]db = db.concat(importedData); [cite: 152]
                }

                [cite_start]localStorage.setItem('farm_v31', JSON.stringify(db)); [cite: 152]
                alert("åŒ¯å…¥æˆåŠŸï¼");
                renderHome();
                [cite_start]input.value = ''; [cite: 153]
            } catch (err) {
                [cite_start]alert("åŒ¯å…¥å¤±æ•—ï¼Œè«‹æª¢æŸ¥ Excel æ ¼å¼ã€‚"); [cite: 154]
            }
        };
        [cite_start]reader.readAsArrayBuffer(file); [cite: 155]
    }

    [cite_start]// å‚™ä»½æª¢æŸ¥æ©Ÿåˆ¶ [cite: 157-161]
    function checkBackupStatus() {
        [cite_start]const last = localStorage.getItem('last_backup_time'); [cite: 157]
        if (!last) {
            [cite_start]document.getElementById('backup-banner').style.display = 'flex'; [cite: 157]
            return;
        }
        [cite_start]const diffDays = (new Date() - new Date(last)) / (1000 * 60 * 60 * 24); [cite: 159, 160]
        if (diffDays > 7) {
            [cite_start]document.getElementById('backup-banner').style.display = 'flex'; [cite: 160]
        }
    }

    function handleBackupNow() { exportExcel(); [cite_start]} [cite: 162]
    function closeBackupBanner() { document.getElementById('backup-banner').style.display = 'none'; [cite_start]} [cite: 163]
    function updateBackupDisplay() {
        [cite_start]const last = localStorage.getItem('last_backup_time'); [cite: 164]
        document.getElementById('last-backup-display').innerText = last || [cite_start]"å°šæœªæœ‰å‚™ä»½ç´€éŒ„"; [cite: 164]
    }

    [cite_start]// ç™»å‡ºåŠŸèƒ½ [cite: 165]
    function logout() { 
        if(confirm("ç¢ºå®šè¦ç™»å‡ºä¸¦é‡æ–°è¼‰å…¥ç³»çµ±å—ï¼Ÿ")) {
            location.reload(); 
        }
    }
</script>
</body>
</html>
