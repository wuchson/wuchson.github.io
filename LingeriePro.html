<!DOCTYPE html>
<html lang="zh-Hant">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Lingerie Pro - æ™ºæ…§åº«å­˜ç®¡ç†ç³»çµ±</title>
    <script src="https://unpkg.com/html5-qrcode"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/qrious/4.0.2/qrious.min.js"></script>
    <style>
        :root {
            --primary: #8da399;
            --accent: #d4a373; --bg: #f9f7f2; --card-bg: #ffffff; --border: #e0dcd0; --danger: #e53e3e; --success: #48bb78;
            --a4-mt: 15.5mm; --a4-ml: 6.5mm; --a4-gx: 2.5mm; --a4-gy: 0mm;
            --s-mt: 0mm; --s-ml: 0mm;
        }
        body { font-family: -apple-system, "Noto Sans TC", sans-serif;
            background: var(--bg); margin: 0; padding: 10px; color: #444; }
        .container { max-width: 600px;
            margin: auto; }
        .card { background: var(--card-bg); border-radius: 12px; padding: 15px; margin-bottom: 15px;
            border: 1px solid var(--border); box-shadow: 0 2px 4px rgba(0,0,0,0.05); }
        h3 { color: #6b7e75;
            border-left: 4px solid var(--accent); padding-left: 10px; margin: 0 0 15px 0; font-size: 1rem;
        }
        
        #login-overlay { position: fixed;
            top: 0; left: 0; width: 100%; height: 100%; background: var(--bg); z-index: 9999; display: flex; align-items: center; justify-content: center;
        }
        .login-card { width: 90%; max-width: 350px; background: white; padding: 30px; border-radius: 15px;
            box-shadow: 0 10px 25px rgba(0,0,0,0.1); }
        
        .admin-only { display: none;
        }
        body.is-admin .admin-only { display: block;
        }
        body.is-admin .admin-inline { display: inline-block;
        }
        .staff-hidden { display: none;
        }
        body.is-admin .staff-hidden { display: block;
        }

        .config-card { background: #f4f6f5; border: 1px solid #d1d5db; border-radius: 8px; padding: 12px;
            margin: 10px 0; }
        .config-group { margin-bottom: 12px;
        }
        .config-group label { display: block; font-size: 11px; font-weight: bold; color: #6b7e75;
            margin-bottom: 5px; }
        .config-input-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(120px, 1fr)); gap: 10px;
        }
        .config-input-grid input { height: 40px !important; border: 1px solid #ccc; border-radius: 6px;
            text-align: center; font-size: 14px !important; width: 100% !important; box-sizing: border-box !important;
        }
        .dir-hint { font-size: 10px; color: #888; text-align: center; margin-top: 3px; line-height: 1.2;
        }
.field { display: flex; flex-direction: column; gap: 5px; margin-bottom: 12px; width: 100%;
        }
        .row-inputs { display: flex; gap: 8px; margin-bottom: 10px; flex-wrap: wrap;
        }
        input, select { flex: 1; min-width: 80px; padding: 12px; font-size: 16px;
            border: 1px solid var(--border); border-radius: 8px; box-sizing: border-box; background: #fff; height: 48px;
        }
        button { width: 100%; padding: 14px; font-size: 16px; border: none; border-radius: 8px;
            background: var(--primary); color: white; font-weight: bold; cursor: pointer; }
        .btn-accent { background: var(--accent);
        }
        .btn-success { background: var(--success);
        }
        .btn-danger { background: var(--danger);
        }
        #scanner-container { display: none; margin-bottom: 15px; background: #000; border-radius: 12px; overflow: hidden;
            position: relative; }
        #scan-feedback { position: absolute; top: 10px; left: 50%; transform: translateX(-50%);
            background: rgba(72, 187, 120, 0.9); color: white; padding: 5px 25px; border-radius: 20px; font-weight: bold; z-index: 10; display: none;
        }
        #print-preview-zone { margin-top: 15px; padding: 15px; border: 2px dashed var(--accent); border-radius: 8px;
            display: none; background: white; }
        .table-wrapper { overflow-x: auto; border-radius: 8px;
            border: 1px solid #eee; margin-top: 10px; }
        table { width: 100%; border-collapse: collapse;
            background: #fff; min-width: 450px; font-size: 0.85rem; }
        th, td { padding: 10px;
            text-align: left; border-bottom: 1px solid #f9f9f9; }
        .tag { background: #f0f2f1;
            padding: 6px 10px; border-radius: 6px; font-size: 0.8rem; border: 1px solid #e0e5e3; display: flex; align-items: center;
        }
        #print-label-page, #print-invoice-page { display: none;
        }
        .qty-btn { padding: 2px 8px; width: auto; background: #edf2f7; color: black;
            border: 1px solid #ccc; border-radius: 4px; cursor: pointer; font-weight: bold;
        }
        
        @media print {
            .no-print { display: none !important;
            }
            body { background: white; margin: 0; padding: 0;
            }
            body.print-mode-a4 #print-label-page { display: grid !important;
                grid-template-columns: repeat(5, 38mm); grid-template-rows: repeat(7, 38mm); padding-top: var(--a4-mt) !important; padding-left: var(--a4-ml) !important; column-gap: var(--a4-gx) !important; row-gap: var(--a4-gy) !important; box-sizing: border-box;
                page-break-after: always; }
            body.print-mode-a4 .label-item { width: 38mm;
                height: 38mm; display: flex; flex-direction: column; align-items: center; justify-content: center; text-align: center;
            }
            body.print-mode-a4 .label-item canvas { width: 22mm !important;
                height: 22mm !important; }
            body.print-mode-a4 .label-item .txt { font-size: 7.5pt;
                font-weight: bold; margin-top: 1mm; }
            body.print-mode-single #print-label-page { display: flex !important;
                align-items: center; justify-content: center; width: 100vw; height: 100vh; padding-top: var(--s-mt) !important; padding-left: var(--s-ml) !important;
            }
            body.print-mode-single .label-item { width: 50mm; height: 30mm;
                display: flex; flex-direction: row; align-items: center; justify-content: center; gap: 5mm;
            }
            body.print-mode-single .label-item canvas { width: 25mm !important;
                height: 25mm !important; }
            body.print-mode-single .label-item .txt { font-size: 9pt;
                font-weight: bold; }
            #print-invoice-page { display: block !important;
                padding: 10mm; }
            .inv-table { width: 100%; border-collapse: collapse;
                margin-top: 10px; }
            .inv-table th, .inv-table td { border: 1px solid black;
                padding: 8px; font-size: 10pt; }
            .total-area { margin-top: 10px;
                text-align: right; font-size: 10pt; line-height: 1.6; }
            .total-area .grand-total { font-size: 13pt;
                font-weight: bold; border-top: 1px double #000; display: inline-block; padding-top: 5px;
            }
        }
    </style>
</head>
<body>

<div id="login-overlay">
    <div class="login-card">
        <h2 style="text-align:center; color:var(--primary); margin-top:0;">ç³»çµ±ç™»å…¥</h2>
        <div class="field"><label>å¸³è™Ÿ</label><input type="text" id="loginUser"></div>
        <div class="field"><label>å¯†ç¢¼</label><input type="password" id="loginPass"></div>
        <button onclick="login()">ç™»å…¥ç³»çµ±</button>
    </div>
</div>
<div class="container no-print">
    <div style="display:flex; justify-content: space-between; align-items: center; margin-bottom: 10px;">
        <span id="userStatus" style="font-size: 14px; color: #666;"></span>
        <button onclick="logout()" style="width: auto; padding: 5px 15px; font-size: 12px; background: #666;">ç™»å‡º</button>
    </div>

    <div class="card admin-only">
        <h3>0. ç³»çµ±ç’°å¢ƒè¨­å®š</h3>
        <div class="row-inputs">
            <div class="field" style="flex:2;"><label>å…¬å¸åç¨±</label><input type="text" id="compNameInp" onchange="updateSysConfig()"></div>
            <div class="field" style="flex:1;"><label>ç¨…ç‡ (%)</label><input type="number" id="taxRateInp" value="5" onchange="updateSysConfig()"></div>
        </div>
        <div class="config-card">
            <label style="font-size: 11px; font-weight: bold; color: #6b7e75;">ğŸ‘¥ ä½¿ç”¨è€…å¸³è™Ÿç®¡ç†</label>
            <div class="row-inputs" style="margin-top:5px;">
                <input type="text" id="newUName" placeholder="å¸³è™Ÿ" style="height:35px; font-size:13px;">
                <input type="text" id="newUPass" placeholder="å¯†ç¢¼" style="height:35px; font-size:13px;">
                <select id="newURole" style="height:35px; font-size:13px; flex:0.6">
                    <option value="staff">å“¡å·¥</option>
                    <option value="admin">ç®¡ç†å“¡</option>
                </select>
            </div>
            <button onclick="addUser()" class="btn-success" style="padding: 8px; font-size: 13px;">æ–°å¢ä½¿ç”¨è€…</button>
            <div id="userList" style="margin-top:10px; display: flex; flex-wrap: wrap; gap: 5px;"></div>
        </div>
    </div>
<div class="config-card">
            <div class="config-group">
                <label>ğŸ·ï¸ A4 æ¨™ç±¤é‚Šè·å¾®èª¿ (3.8x3.8cm - 5x7 æ ¼å¼)</label>
                <div class="config-input-grid">
                    <div><input type="number" id="a4mt" step="0.1" onchange="updateA4Config()"><div class="dir-hint">ä¸Šé‚Šè·(mm)</div></div>
                    <div><input type="number" id="a4ml" step="0.1" onchange="updateA4Config()"><div class="dir-hint">å·¦é‚Šè·(mm)</div></div>
                    <div><input type="number" id="a4gx" step="0.1" onchange="updateA4Config()"><div class="dir-hint">å·¦å³é–“è·(mm)</div></div>
                    <div><input type="number" id="a4gy" step="0.1" onchange="updateA4Config()"><div class="dir-hint">ä¸Šä¸‹é–“è·(mm)</div></div>
                </div>
            </div>
            <div class="config-group" style="margin-top:10px; border-top:1px solid #ddd; pt:10px;">
                <label>ğŸ·ï¸ å–®å¼µæ²è»¸é‚Šè·å¾®èª¿ (5x3cm æ ¼å¼)</label>
                <div class="config-input-grid">
                    <div><input type="number" id="smt" step="0.1" onchange="updateSConfig()"><div class="dir-hint">ä¸Šé‚Šè·(mm)</div></div>
                    <div><input type="number" id="sml" step="0.1" onchange="updateSConfig()"><div class="dir-hint">å·¦é‚Šè·(mm)</div></div>
                </div>
            </div>
        </div>
    </div>

    <div class="card admin-only">
        <h3>1. åŸºç¤è³‡æ–™ç¶­è­·</h3>
        <div class="row-inputs">
            <input type="text" id="vName" placeholder="å» å•†">
            <input type="text" id="mName" placeholder="å‹è™Ÿ">
            <select id="iType"></select>
        </div>
        <div class="row-inputs">
            <input type="text" id="cNames" placeholder="é¡è‰² (é€—é»éš”é–‹)">
        </div>
        <button onclick="addBaseData()">æ–°å¢å“é …</button>
    </div>

    <div class="card">
        <h3>2. é€²å‡ºè²¨æ“ä½œ</h3>
        <div style="margin-bottom: 10px; display: flex; gap: 10px;">
            <button onclick="startScan()" style="background:#4a5568; flex:1;">ğŸ“· é–‹å•Ÿç›¸æ©Ÿæƒæ</button>
            <button onclick="stopScan()" id="stopBtn" style="background:#a0aec0; flex:1; display:none;">é—œé–‰ç›¸æ©Ÿ</button>
        </div>
        <div id="scanner-container">
            <div id="scan-feedback">æƒææˆåŠŸï¼</div>
            <div id="reader"></div>
        </div>
        
        <div class="field"><label>å•†å“æ¢ç¢¼</label><input type="text" id="opCode" placeholder="æ‰‹å‹•è¼¸å…¥æˆ–æƒæ" oninput="autoFillByCode()"></div>
        <div id="auto-info" style="font-size:12px; color:#666; margin-bottom:10px; display:none;"></div>
        
        <div class="row-inputs">
            <div class="field"><label>æ•¸é‡</label><input type="number" id="opQty" value="1"></div>
            <div class="field"><label>å–®åƒ¹</label><input type="number" id="opPrice" placeholder="éŠ·å”®æ™‚å¡«å¯«"></div>
        </div>
        
        <div style="display:flex; gap:10px;">
            <button onclick="processOp('in')" class="btn-success">é€²è²¨</button>
            <button onclick="processOp('out')">åŠ å…¥å‡ºè²¨æ¸…å–®</button>
        </div>
    </div>

    <div class="card">
        <h3>3. æœ¬æ¬¡å‡ºè²¨æ¸…å–® (è³¼ç‰©è»Š)</h3>
        <div class="table-wrapper">
            <table>
                <thead><tr><th>å•†å“</th><th>æ•¸é‡</th><th>å–®åƒ¹</th><th>æ“ä½œ</th></tr></thead>
                <tbody id="cartBody"></tbody>
            </table>
        </div>
        <div style="margin-top:15px; text-align:right; font-weight:bold; font-size:1.1rem; color: var(--danger);">
            ç¸½è¨ˆï¼š$<span id="cartTotal">0</span>
        </div>
        <div class="row-inputs" style="margin-top:10px;">
            <button onclick="checkout('print')" class="btn-accent" style="flex:1;">çµå¸³ä¸¦åˆ—å°éŠ·è²¨å–®</button>
            <button onclick="checkout('only')" style="flex:1; background:#718096;">åƒ…çµå¸³ä¸åˆ—å°</button>
        </div>
    </div>
<div class="card">
        <h3>4. åº«å­˜æŸ¥è©¢èˆ‡æ¢ç¢¼æ¨™ç±¤</h3>
        <div class="row-inputs">
            <input type="text" id="qVendor" placeholder="å» å•†" oninput="renderInv()">
            <input type="text" id="qModel" placeholder="å‹è™Ÿ" oninput="renderInv()">
        </div>
        <div class="table-wrapper">
            <table>
                <thead><tr><th>å» å•†/å‹è™Ÿ</th><th>é¡è‰²/å°ºå¯¸</th><th>åº«å­˜</th><th>æ¨™ç±¤</th></tr></thead>
                <tbody id="invBody"></tbody>
            </table>
        </div>
        <div id="print-preview-zone" class="no-print">
            <p style="margin-top:0; font-weight:bold; color:var(--accent);">å·²é¸å–å¾…åˆ—å°æ¢ç¢¼ (<span id="queueCount">0</span>)</p>
            <div style="display:flex; gap:10px;">
                <button onclick="printLabels('a4')" class="btn-accent" style="font-size:13px; padding:8px;">A4 æ¨™ç±¤åˆ—å°</button>
                <button onclick="printLabels('single')" style="font-size:13px; padding:8px; background:#6b7280;">å–®å¼µæ²è»¸åˆ—å°</button>
                <button onclick="clearQueue()" style="font-size:13px; padding:8px; background:#e5e7eb; color:#444;">æ¸…ç©º</button>
            </div>
        </div>
    </div>

    <div class="card admin-only">
        <h3>5. éŠ·å”®æ—¥å ±è¡¨</h3>
        <input type="date" id="reportDate" onchange="renderReport()" style="margin-bottom:10px;">
        <div id="reportSummary" style="font-size:14px; margin-bottom:10px; line-height:1.6; color:#444;"></div>
        <div class="table-wrapper">
            <table>
                <thead><tr><th>æ™‚é–“</th><th>å•†å“/é‡‘é¡</th><th>æ“ä½œ</th></tr></thead>
                <tbody id="reportBody"></tbody>
            </table>
        </div>
    </div>

    <div class="card admin-only" style="background: #fdf2f2; border: 1px solid #fecaca;">
        <h3>6. ç³»çµ±ç¶­è­·</h3>
        <div style="display:flex; gap:10px; flex-direction:column;">
            <button onclick="exportData()" style="background:#4a5568;">åŒ¯å‡ºå®Œæ•´è³‡æ–™å‚™ä»½ (JSON)</button>
            <button onclick="triggerImport()" style="background:#718096;">åŒ¯å…¥è³‡æ–™å‚™ä»½</button>
            <input type="file" id="importFile" style="display:none" onchange="importData(event)">
            <button onclick="clearAllData()" class="btn-danger" style="margin-top:10px;">âš ï¸ æ¸…é™¤ç³»çµ±æ‰€æœ‰è³‡æ–™</button>
        </div>
    </div>
</div>

<div id="print-label-page"></div>
<div id="print-invoice-page"></div>

<script>
    let vendors = [], models = [], inventory = [], colors = [], itemTypes = ["å…§è¡£", "å¡‘èº«è¡£", "å…§è¤²"];
    let salesHistory = [], printQueue = [], currentUser = null, users = [];
    let compName = "å…§è¡£åº—", taxRate = 5;
    let a4Config = { mt: 15.5, ml: 6.5, gx: 2.5, gy: 0 };
    let sConfig = { mt: 0, ml: 0 };

    function save() {
        localStorage.setItem('lingerie_db', JSON.stringify({
            v: vendors, m: models, i: inventory, c: colors, t: itemTypes,
            sh: salesHistory, u: users, cn: compName, tr: taxRate,
            a4c: a4Config, sc: sConfig
        }));
    }

    function load() {
        const d = JSON.parse(localStorage.getItem('lingerie_db') || '{}');
        vendors = d.v || []; models = d.m || []; inventory = d.i || [];
        colors = d.c || []; itemTypes = d.t || ["å…§è¡£", "å¡‘èº«è¡£", "å…§è¤²"];
        salesHistory = d.sh || []; users = d.u || [];
        compName = d.cn || "å…§è¡£åº—"; taxRate = d.tr || 5;
        a4Config = d.a4c || { mt: 15.5, ml: 6.5, gx: 2.5, gy: 0 };
        sConfig = d.sc || { mt: 0, ml: 0 };
        
        document.getElementById('compNameInp').value = compName;
        document.getElementById('taxRateInp').value = taxRate;
        document.getElementById('a4mt').value = a4Config.mt;
        document.getElementById('a4ml').value = a4Config.ml;
        document.getElementById('a4gx').value = a4Config.gx;
        document.getElementById('a4gy').value = a4Config.gy;
        document.getElementById('smt').value = sConfig.mt;
        document.getElementById('sml').value = sConfig.ml;
        
        updateStyles();
        renderTypeSelect();
        renderUserList();
    }
function updateA4Config() {
        a4Config.mt = parseFloat(document.getElementById('a4mt').value) || 0;
        a4Config.ml = parseFloat(document.getElementById('a4ml').value) || 0;
        a4Config.gx = parseFloat(document.getElementById('a4gx').value) || 0;
        a4Config.gy = parseFloat(document.getElementById('a4gy').value) || 0;
        updateStyles(); save();
    }
    function updateSConfig() {
        sConfig.mt = parseFloat(document.getElementById('smt').value) || 0;
        sConfig.ml = parseFloat(document.getElementById('sml').value) || 0;
        updateStyles(); save();
    }
    function updateStyles() {
        const r = document.documentElement.style;
        r.setProperty('--a4-mt', a4Config.mt + 'mm');
        r.setProperty('--a4-ml', a4Config.ml + 'mm');
        r.setProperty('--a4-gx', a4Config.gx + 'mm');
        r.setProperty('--a4-gy', a4Config.gy + 'mm');
        r.setProperty('--s-mt', sConfig.mt + 'mm');
        r.setProperty('--s-ml', sConfig.ml + 'mm');
    }

    function login() {
        const u = document.getElementById('loginUser').value;
        const p = document.getElementById('loginPass').value;
        if(u==='admin' && p==='888') currentUser = {n:'Admin', r:'admin'};
        else {
            const found = users.find(x => x.n === u && x.p === p);
            if(found) currentUser = found;
        }
        if(currentUser) {
            document.getElementById('login-overlay').style.display = 'none';
            document.body.className = currentUser.r === 'admin' ? 'is-admin' : '';
            document.getElementById('userStatus').innerText = `ç™»å…¥ä¸­: ${currentUser.n} (${currentUser.r})`;
            renderInv(); renderReport();
        } else alert("å¸³è™Ÿæˆ–å¯†ç¢¼éŒ¯èª¤");
    }
    function logout() { location.reload(); }

    function renderTypeSelect() {
        const s = document.getElementById('iType');
        s.innerHTML = itemTypes.map(t => `<option value="${t}">${t}</option>`).join('');
    }

    function addBaseData() {
        const v = document.getElementById('vName').value.trim();
        const m = document.getElementById('mName').value.trim();
        const t = document.getElementById('iType').value;
        const cs = document.getElementById('cNames').value.split(',').map(x=>x.trim()).filter(x=>x);
        if(!v || !m || cs.length===0) return alert("è«‹å¡«å¯«å®Œæ•´è³‡è¨Š");
        cs.forEach(c => {
            const code = `${v}-${m}-${c}`;
            if(!inventory.find(x => x.code === code)) {
                inventory.push({ v, m, t, c, code, q: 0 });
            }
        });
        save(); renderInv(); alert("å“é …å·²å»ºç«‹");
    }

    function renderInv() {
        const qV = document.getElementById('qVendor').value.toLowerCase();
        const qM = document.getElementById('qModel').value.toLowerCase();
        const b = document.getElementById('invBody');
        b.innerHTML = inventory.filter(x => x.v.toLowerCase().includes(qV) && x.m.toLowerCase().includes(qM))
            .map(x => `<tr>
                <td>${x.v}<br><small>${x.m} (${x.t})</small></td>
                <td><span class="tag">${x.c}</span><div style="font-size:10px; color:#999; margin-top:4px;">${x.code}</div></td>
                <td><b style="color:var(--primary)">${x.q}</b></td>
                <td><button onclick="addToQueue('${x.code}')" class="qty-btn" style="background:var(--accent); color:white; border:none;">+ æ¨™ç±¤</button></td>
            </tr>`).join('');
    }

    let html5QrCode = null;
    function startScan() {
        document.getElementById('scanner-container').style.display = 'block';
        document.getElementById('stopBtn').style.display = 'inline-block';
        html5QrCode = new Html5Qrcode("reader");
        html5QrCode.start({ facingMode: "environment" }, { fps: 10, qrbox: 250 }, (txt) => {
            document.getElementById('opCode').value = txt;
            document.getElementById('scan-feedback').style.display = 'block';
            autoFillByCode();
            setTimeout(() => { document.getElementById('scan-feedback').style.display = 'none'; }, 1000);
        });
    }
    function stopScan() {
        if(html5QrCode) html5QrCode.stop().then(() => {
            document.getElementById('scanner-container').style.display = 'none';
            document.getElementById('stopBtn').style.display = 'none';
        });
    }

    function autoFillByCode() {
        const code = document.getElementById('opCode').value.trim();
        const item = inventory.find(x => x.code === code);
        const info = document.getElementById('auto-info');
        if(item) {
            info.style.display = 'block';
            info.innerText = `ç›®å‰å•†å“ï¼š${item.v} / ${item.m} / ${item.c} (ç¾å­˜: ${item.q})`;
        } else info.style.display = 'none';
    }

    let cart = [];
    function processOp(type) {
        const code = document.getElementById('opCode').value.trim();
        const qty = parseInt(document.getElementById('opQty').value);
        const price = parseInt(document.getElementById('opPrice').value) || 0;
        const item = inventory.find(x => x.code === code);
        if(!item || !qty) return alert("æŸ¥ç„¡æ­¤å•†å“æ¢ç¢¼æˆ–æ•¸é‡éŒ¯èª¤");

        if(type === 'in') {
            item.q += qty;
            salesHistory.push({ t: new Date().toLocaleString(), type: 'é€²è²¨', code: item.code, q: qty, p: 0, user: currentUser.n });
            alert("é€²è²¨æˆåŠŸ");
            save(); renderInv(); renderReport();
        } else {
            if(item.q < qty) return alert("åº«å­˜ä¸è¶³");
            cart.push({ ...item, qty, price });
            renderCart();
        }
        document.getElementById('opCode').value = '';
        document.getElementById('auto-info').style.display = 'none';
    }

    function renderCart() {
        const b = document.getElementById('cartBody');
        let total = 0;
        b.innerHTML = cart.map((x, i) => {
            total += x.qty * x.price;
            return `<tr>
                <td>${x.m}-${x.c}</td>
                <td>${x.qty}</td>
                <td>$${x.price}</td>
                <td><button onclick="cart.splice(${i},1);renderCart()" class="qty-btn">åˆªé™¤</button></td>
            </tr>`;
        }).join('');
        document.getElementById('cartTotal').innerText = total;
    }

    function checkout(mode) {
        if(cart.length === 0) return;
        const total = cart.reduce((a, b) => a + (b.qty * b.price), 0);
        cart.forEach(c => {
            const item = inventory.find(x => x.code === c.code);
            item.q -= c.qty;
            salesHistory.push({ t: new Date().toLocaleString(), type: 'éŠ·å”®', code: c.code, q: c.qty, p: c.price, user: currentUser.n });
        });
        if(mode === 'print') {
            const invPage = document.getElementById('print-invoice-page');
            const sub = Math.round(total / (1 + taxRate/100));
            const tax = total - sub;
            invPage.innerHTML = `
                <div style="text-align:center;"><h2>${compName} éŠ·è²¨å–®</h2></div>
                <p>æ—¥æœŸ: ${new Date().toLocaleString()} | ç¶“æ‰‹äºº: ${currentUser.n}</p>
                <table class="inv-table">
                    <thead><tr><th>å“åè¦æ ¼</th><th>æ•¸é‡</th><th>å–®åƒ¹</th><th>å°è¨ˆ</th></tr></thead>
                    <tbody>${cart.map(x=>`<tr><td>${x.v} ${x.m}-${x.c}</td><td>${x.qty}</td><td>${x.price}</td><td>${x.qty*x.price}</td></tr>`).join('')}</tbody>
                </table>
                <div class="total-area">
                    éŠ·å”®é¡(æœªç¨…): $${sub}<br>ç¨…é¡(${taxRate}%): $${tax}<br>
                    <div class="grand-total">ç¸½è¨ˆé‡‘é¡: $${total}</div>
                </div>`;
            window.print();
        }
        cart = []; renderCart(); renderInv(); renderReport(); save();
        alert("çµå¸³å®Œæˆ");
    }

    function addToQueue(code) {
        printQueue.push(code);
        document.getElementById('print-preview-zone').style.display = 'block';
        document.getElementById('queueCount').innerText = printQueue.length;
    }
    function clearQueue() {
        printQueue = [];
        document.getElementById('print-preview-zone').style.display = 'none';
    }

    function printLabels(mode) {
        const container = document.getElementById('print-label-page');
        container.innerHTML = '';
        document.body.classList.remove('print-mode-a4', 'print-mode-single');
        document.body.classList.add('print-mode-' + mode);
        
        printQueue.forEach(code => {
            const item = inventory.find(x => x.code === code);
            const div = document.createElement('div');
            div.className = 'label-item';
            div.innerHTML = `<canvas id="q-${Math.random().toString(36).substr(2,9)}"></canvas>
                             <div class="txt">${item.m}<br>${item.c}</div>`;
            container.appendChild(div);
            new QRious({ element: div.querySelector('canvas'), value: code, size: 150 });
        });
        setTimeout(() => { window.print(); clearQueue(); }, 500);
    }

    function renderReport() {
        const d = document.getElementById('reportDate').value || new Date().toISOString().split('T')[0];
        const rows = salesHistory.filter(x => x.t.includes(d));
        const b = document.getElementById('reportBody');
        let totalVal = 0;
        b.innerHTML = rows.map((x, i) => {
            if(x.type === 'éŠ·å”®') totalVal += (x.q * x.p);
            return `<tr>
                <td>${x.t.split(' ')[1]}</td>
                <td>${x.code}<br><small>${x.type} ${x.q}pcs @$${x.p}</small></td>
                <td><button onclick="delHistory(${i})" class="qty-btn admin-only">åˆª</button></td>
            </tr>`;
        }).join('');
        document.getElementById('reportSummary').innerHTML = `æœ¬æ—¥éŠ·å”®ç¸½é¡ï¼š<b style="color:var(--danger)">$${totalVal}</b>`;
    }
    function delHistory(idx) {
        if(confirm("ç¢ºå®šåˆªé™¤æ­¤ç´€éŒ„ï¼Ÿåº«å­˜ä¸æœƒè‡ªå‹•å›è£œ")) {
            salesHistory.splice(idx, 1); save(); renderReport();
        }
    }

    function renderUserList() {
        const l = document.getElementById('userList');
        l.innerHTML = users.map((u, i) => `<span class="tag">${u.n}(${u.r}) <span onclick="users.splice(${i},1);save();renderUserList()" style="cursor:pointer;margin-left:5px;color:red">Ã—</span></span>`).join('');
    }
    function addUser() {
        const n = document.getElementById('newUName').value;
        const p = document.getElementById('newUPass').value;
        const r = document.getElementById('newURole').value;
        if(n && p) {
            users.push({n, p, r}); save(); renderUserList();
            document.getElementById('newUName').value=''; document.getElementById('newUPass').value='';
        }
    }

    function exportData() {
        const blob = new Blob([localStorage.getItem('lingerie_db')], {type:'application/json'});
        const a = document.createElement('a');
        const today = new Date().toISOString().split('T')[0];
        a.href = URL.createObjectURL(blob);
        a.download = `Lingerie_Backup_${today}.json`;
        a.click();
    }
    function triggerImport() { document.getElementById('importFile').click(); }
    function importData(e) {
        const f = e.target.files[0];
        if(!f) return;
        const r = new FileReader();
        r.onload = (ev) => {
            try {
                const d = JSON.parse(ev.target.result);
                vendors=d.v||[]; models=d.m||[]; inventory=d.i||[]; colors=d.c||[];
                itemTypes=d.t||["å…§è¡£","å¡‘èº«è¡£","å…§è¤²"]; salesHistory=d.sh||[]; users=d.u||[];
                compName=d.cn||"å…§è¡£åº—"; taxRate=d.tr||5;
                save(); alert("åŒ¯å…¥æˆåŠŸï¼"); location.reload();
            } catch(err) { alert("æª”æ¡ˆæ ¼å¼éŒ¯èª¤"); }
        };
        r.readAsText(f);
    }
    function updateSysConfig() {
        compName = document.getElementById('compNameInp').value;
        taxRate = parseFloat(document.getElementById('taxRateInp').value);
        save();
    }
    function clearAllData() {
        if(confirm("ç¢ºå®šè¦æ¸…é™¤æ‰€æœ‰è³‡æ–™å—ï¼Ÿæ­¤å‹•ä½œç„¡æ³•å¾©åŸï¼")) {
            localStorage.removeItem('lingerie_db');
            location.reload();
        }
    }

    window.onload = load;
</script>
</body>
</html>
