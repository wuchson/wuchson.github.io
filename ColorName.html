<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>é¡è‰²åç¨±åˆ¤å®šå™¨</title>
    <style>
        :root { --ink: #020617; --gold: #78350f; --accent: #b45309; --bg: #f8fafc; }
        body { background: var(--bg); font-family: "PingFang TC", "STHeiti", serif; margin: 0; display: flex; flex-direction: column; align-items: center; color: var(--ink); }
        .viewer-wrap { width: 100%; max-width: 500px; aspect-ratio: 1; position: relative; background: #000; box-shadow: 0 20px 40px rgba(0,0,0,0.15); }
        #v, #photo-canvas { width: 100%; height: 100%; object-fit: cover; position: absolute; }
        #photo-canvas { display: none; z-index: 5; }
        .aimer { position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); width: 14px; height: 14px; border: 1.5px solid #fff; border-radius: 50%; mix-blend-mode: difference; z-index: 10; pointer-events: none; }
        
        .card { width: 94%; max-width: 500px; background: white; border-radius: 40px; padding: 30px; margin-top: -60px; box-shadow: 0 30px 70px rgba(0,0,0,0.1); z-index: 20; box-sizing: border-box; text-align: center; }
        #preview { width: 120px; height: 120px; border-radius: 50%; margin: 0 auto 15px; border: 8px solid #fff; box-shadow: 0 10px 30px rgba(0,0,0,0.08); }
        
        .name-main { font-size: 38px; font-weight: 900; color: #000; letter-spacing: -2px; margin-bottom: 5px; }
        .name-sub { font-size: 15px; color: var(--accent); letter-spacing: 3px; font-weight: 600; text-transform: uppercase; margin-bottom: 10px; }
        #hex { font-family: "Courier New", monospace; font-size: 14px; color: #cbd5e1; }

        .sliders { background: #f1f5f9; padding: 25px; border-radius: 30px; margin-top: 25px; border: 1px solid rgba(0,0,0,0.05); }
        .s-info { display: flex; justify-content: space-between; font-size: 11px; color: #64748b; font-weight: 800; margin-bottom: 6px; }
        input[type=range] { width: 100%; height: 5px; appearance: none; background: #cbd5e1; border-radius: 5px; margin-bottom: 15px; }
        input[type=range]::-webkit-slider-thumb { appearance: none; width: 24px; height: 24px; background: white; border: 2.5px solid var(--accent); border-radius: 50%; }

        .btn-box { display: grid; grid-template-columns: 1fr 1fr; gap: 12px; width: 94%; max-width: 500px; margin: 20px 0; }
        button { padding: 20px; border-radius: 20px; border: none; font-weight: 800; cursor: pointer; transition: 0.2s; font-size: 15px; }
        .btn-main { background: var(--ink); color: white; grid-column: span 2; }
        .btn-alt { background: white; color: #475569; border: 1px solid #e2e8f0; }
        .mo-active { background: #fef3c7; color: #92400e; border-color: #f59e0b; }
    </style>
</head>
<body>

<div class="viewer-wrap" onclick="pickColor(event)">
    <video id="v" autoplay playsinline></video>
    <canvas id="photo-canvas"></canvas>
    <div class="aimer" id="aim"></div>
</div>

<div class="btn-box">
    <button class="btn-main" onclick="detect()">ğŸ“¸ æ“·å–æ¥µé™é‘‘å®š</button>
    <button class="btn-alt" onclick="document.getElementById('file-in').click()">ğŸ“ ç›¸ç°¿æ·±åº¦æƒæ</button>
    <button class="btn-alt" id="mo-btn" onclick="toggleMorandi()">âœ¨ è«è˜­è¿ªåŒ–</button>
    <input type="file" id="file-in" hidden accept="image/*" onchange="handleFile(event)">
</div>

<div class="card" id="res" style="display:none;">
    <div id="preview"></div>
    <div class="name-main" id="lv3">-</div>
    <div class="name-sub" id="lv2">-</div>
    <div id="hex">#FFFFFF</div>
    
    <div class="sliders">
        <div class="s-info"><span>å¾®å…‰åº¦ (L)</span><span id="lv">50%</span></div>
        <input type="range" id="ls" min="0" max="100" oninput="ui()">
        <div class="s-info"><span>ç´”ç²¹åº¦ (S)</span><span id="sv">50%</span></div>
        <input type="range" id="ss" min="0" max="100" oninput="ui()">
    </div>
</div>

<canvas id="proc" style="display:none;"></canvas>

<script>
let cH=0, cS=50, cL=50, backupS=50, isPhoto=false;
const v=document.getElementById('v'), pCanvas=document.getElementById('photo-canvas'), pCtx=pCanvas.getContext('2d');
const procCanvas=document.getElementById('proc'), procCtx=procCanvas.getContext('2d');

navigator.mediaDevices.getUserMedia({video:{facingMode:"environment"}}).then(s=>v.srcObject=s);

// æ¥µé™è‰²è­œçŸ©é™£ (45 å€‹ç¯€é»ï¼Œè¦†è“‹å…¨çƒå·¥æ¥­èˆ‡è—è¡“è‰²åº«)
const ULTIMATE_DB = [
    {h:0,   n:"ç´…",   items:["ç¡ƒç ‚","ç·‹ç´…","èƒ­è„‚","çµ³ç´…","å‹ƒè‰®ç¬¬"]},
    {h:8,   n:"èµ¤",   items:["èŒœè‰²","è“æœ","ç«é¶´","é¶´èµ¤","ç«ç‚¬"]},
    {h:15,  n:"çŠç‘š", items:["å¤•é™½","æŸ¿ç´…","è‚‰æ¡‚","çŠç‘šç´…","éµé½"]},
    {h:25,  n:"ç²‰è†š", items:["æ«»èŠ±","é€ç²‰","æ´—æŸ¿","è‚‰ç²‰","æ¡ƒç´…"]},
    {h:32,  n:"è£¸ç´—", items:["èœœç²‰","è£¸ç´—","è±¡ç‰™","ç±³è‰²","é§è‰²"]},
    {h:40,  n:"å¥¶èŒ¶", items:["æ‹¿éµ","ç‡•éº¥","æä»","è‡ªç„¶è†š","æ³•å¼è£¸"]},
    {h:48,  n:"å¤§åœ°", items:["å¡å…¶","ç„¦ç³–","èƒ¡æ¡ƒ","æ‘©å¡","å’–å•¡"]},
    {h:55,  n:"ç¥ç€", items:["åœŸèµ­","é‡‘èŒ¶","ç³ç‘","ç¥ç€","è¸è‰"]},
    {h:62,  n:"é¦™æª³", items:["å¥¶æ²¹","é¦™æª³é‡‘","å«ç¾è‰","è—¤é»ƒ","é‡‘ç›"]},
    {h:70,  n:"æ˜é»ƒ", items:["è—¤é»ƒ","å‘æ—¥è‘µ","èŠ¥æœ«","éˆ¦é‡‘","ç§‹è‘µ"]},
    {h:85,  n:"å«©ç¶ ", items:["è‹¥ç«¹","èŠ½ç¶ ","é’è˜‹æœ","èŒ¶ç¶ ","é¶¯è‰²"]},
    {h:105, n:"è‰æœ¬", items:["èŠå§†","è‹”è˜š","é’è”¥","è‰¾è‰","å¸¸ç£"]},
    {h:125, n:"ç¿ è‰²", items:["ç¿¡ç¿ ","è–„è·","ç¢§è‰²","å­”é›€ç¶ ","é’ä¸¹"]},
    {h:145, n:"æ£®ç¶ ", items:["æ£®æ—","æŠ¹èŒ¶","é’ç“·","å¢¨ç¶ ","æ¾æŸ"]},
    {h:165, n:"é’ç¢§", items:["æ¹–ç¶ ","é´¨è›‹é’","è’‚èŠ¬å¦®","ç¢§ç‰","æµ·ç»"]},
    {h:185, n:"è”šè—", items:["æ°´è‰²","åƒè‰","å¤©è—","æ¹›è—","æ„›ç´æµ·"]},
    {h:205, n:"æ²‰è—", items:["å¯¶è—","å‹¿å¿˜è‰","éœ§éœ¾è—","é›è—","ç‰ç’ƒ"]},
    {h:225, n:"ç´ºé’", items:["è—é’","æ™®é­¯å£«è—","åˆå¤œè—","å‹è‰²","éµç´º"]},
    {h:245, n:"è–°ç´«", items:["é³¶å°¾","è–°è¡£è‰","è¿·å¹»è—","è—¤è‰²","ç´«ç¾…è˜­"]},
    {h:265, n:"æ­£ç´«", items:["ç´«è—¤","ä¸é¦™","çµ³ç´«","æ¡”æ¢—","è‘¡è„"]},
    {h:285, n:"æ¡‘è‘š", items:["å¢¨ç´«","èŒ„ç´«","å¤ç´«","æš—é¦™","é³¶å°¾ç´«"]},
    {h:315, n:"æ´‹ç´…", items:["è¦†ç›†å­","é‡è“","ç«ç‘°ç´…","ç‰¡ä¸¹","æ´‹ç´…"]},
    {h:345, n:"å°‘å¥³", items:["æ«»ç²‰","é›ªç²‰","æ´—æŸ¿","æœéµ‘","çŸ³æ¦´"]}
];

function handleFile(e) {
    const reader = new FileReader();
    reader.onload = (ev) => {
        const img = new Image();
        img.onload = () => {
            pCanvas.style.display = 'block';
            pCanvas.width = img.width; pCanvas.height = img.height;
            pCtx.drawImage(img, 0, 0);
            isPhoto = true; document.getElementById('aim').style.display='none';
        };
        img.src = ev.target.result;
    };
    reader.readAsDataURL(e.target.files[0]);
}

function pickColor(e) {
    if(!isPhoto) return;
    const rect = pCanvas.getBoundingClientRect();
    const x = (e.clientX - rect.left) * (pCanvas.width / rect.width);
    const y = (e.clientY - rect.top) * (pCanvas.height / rect.height);
    const d = pCtx.getImageData(x, y, 1, 1).data;
    update(d[0], d[1], d[2]);
}

function detect() {
    isPhoto = false; pCanvas.style.display='none';
    document.getElementById('aim').style.display='block';
    procCanvas.width=v.videoWidth; procCanvas.height=v.videoHeight;
    procCtx.drawImage(v,0,0);
    const d=procCtx.getImageData(procCanvas.width/2,procCanvas.height/2,1,1).data;
    update(d[0], d[1], d[2]);
}

function update(r, g, b) {
    const hsl = rgbToHsl(r, g, b);
    cH=hsl[0]*360; cS=hsl[1]*100; cL=hsl[2]*100; backupS=cS;
    document.getElementById('ls').value=cL; document.getElementById('ss').value=cS;
    ui();
}

function toggleMorandi() {
    const b = document.getElementById('mo-btn');
    if(!b.classList.contains('mo-active')){
        backupS=cS; cS=25; b.classList.add('mo-active'); b.innerText="âª åŸè‰²å°æ¯”";
    } else {
        cS=backupS; b.classList.remove('mo-active'); b.innerText="âœ¨ è«è˜­è¿ªåŒ–";
    }
    document.getElementById('ss').value=cS; ui();
}

function ui() {
    cL=parseInt(document.getElementById('ls').value);
    cS=parseInt(document.getElementById('ss').value);
    const hex=hslToHex(cH,cS,cL);
    document.getElementById('res').style.display='block';
    document.getElementById('preview').style.backgroundColor=hex;
    document.getElementById('hex').innerText=hex;
    document.getElementById('lv').innerText=cL+"%";
    document.getElementById('sv').innerText=cS+"%";

    const n = getUltimateName(cH, cS, cL);
    document.getElementById('lv3').innerText = n.v3;
    document.getElementById('lv2').innerText = n.v2;
}

function getUltimateName(h, s, l) {
    if (l > 97) return {v3:"çš“æœˆé›ªç´¡", v2:"Extreme Pure White"};
    if (l < 5) return {v3:"æš—ç‰©è³ªé»‘", v2:"Extreme Deep Black"};
    if (s < 6) return {v3: (l>80?"æ™¨éœ§":l>50?"è«è˜­è¿ª":"ç„æ­¦")+"ä¸­æ€§ç°", v2:"Neutral Aesthetics"};

    // å°‹æ‰¾ç²¾ç¢ºè‰²ç›¸ç¯€é»
    let target = ULTIMATE_DB.find(x => h < x.h) || ULTIMATE_DB[ULTIMATE_DB.length-1];
    
    // äº”ç¶­èªæ„åç§»
    let pre = "";
    if (s < 28) pre = "è«è˜­è¿ªÂ·";
    else if (s > 88) pre = "é«˜å½©Â·";
    else if (l > 85) pre = "æ¸…é€Â·";
    else if (l < 30) pre = "å¹½é‚ƒÂ·";
    else pre = "é«˜ç´šÂ·";

    // è³ªæ„Ÿè¯æƒ³
    let tex = (l > 75) ? "çµ²çµ¨" : (s < 40) ? "éœ§é¢" : (l < 40) ? "çš®é©" : "ç·é¢";

    // è†šè‰²èˆ‡å…§è¡£å°ˆç”¨æ¥µé™è©åº« (H:20-50, S<55)
    if (h > 15 && h < 55 && s < 55) {
        const skins = ["é€ç²‰è£¸ç´—","èœœç²‰ææ¡ƒ","æº«æ½¤æ‹¿éµ","æ³•å¼å¯å¯","å†·èƒæ­è•¾"];
        const skinBase = skins[Math.min(Math.floor(l / 20), 4)];
        return {v3: pre + skinBase, v2: `å°ˆæ¥­ Lingerie è†šè‰²é‘‘å®š Â· ${tex}è³ªæ„Ÿ`};
    }

    let item = target.items[Math.min(Math.floor(l / 20), 4)];
    return { v3: pre + item, v2: `ç™¾ç§‘ç´š${target.n}è‰²è­œ Â· ${tex}è³ªæ„Ÿè¾¨è­˜` };
}

function rgbToHsl(r,g,b){r/=255,g/=255,b/=255;let max=Math.max(r,g,b),min=Math.min(r,g,b),h,s,l=(max+min)/2;if(max==min)h=s=0;else{let d=max-min;s=l>0.5?d/(2-max-min):d/(max+min);switch(max){case r:h=(g-b)/d+(g<b?6:0);break;case g:h=(b-r)/d+2;break;case b:h=(r-g)/d+4;break;}h/=6;}return [h,s,l];}
function hslToHex(h,s,l){l/=100;const a=s*Math.min(l,1-l)/100;const f=n=>{const k=(n+h/30)%12;const color=l-a*Math.max(Math.min(k-3,9-k,1),-1);return Math.round(255*color).toString(16).padStart(2,'0');};return `#${f(0)}${f(8)}${f(4)}`.toUpperCase();}
</script>
</body>
</html>
