<!DOCTYPE html>
<html lang="zh-TW">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>ç§äººè²¡å‹™ç®¡ç†-é›²ç«¯ç‰ˆ</title>
  <script src="https://www.gstatic.com/charts/loader.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
  <style>
    :root {
      --bg-color: #f8f9fb; --card-bg: #ffffff; --primary: #5856D6;
      --success: #34C759; --danger: #FF3B30; --warning: #FF9500;
      --text-main: #1c1c1e; --text-sub: #8e8e93; --border: #efeff4;
    }
    * { box-sizing: border-box; }
    body { font-family: -apple-system, sans-serif; background: var(--bg-color); margin: 0; padding: 16px; display: flex; justify-content: center; }
    .container { width: 100%; max-width: 480px; }
    .card { background: var(--card-bg); padding: 20px; border-radius: 24px; box-shadow: 0 10px 25px rgba(0,0,0,0.05); margin-bottom: 16px; border: 1px solid var(--border); }
    .hero-stat { background: linear-gradient(135deg, #5856D6 0%, #3534a5 100%); color: white; padding: 24px; border-radius: 24px; margin-bottom: 16px; box-shadow: 0 15px 30px rgba(88, 86, 214, 0.3); }
    .hero-stat div.total { font-size: 32px; font-weight: 800; margin-top: 5px; }
    .stats-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 10px; }
    .mini-stat { padding: 14px; border-radius: 18px; background: var(--bg-color); border: 1px solid var(--border); }
    .mini-stat small { color: var(--text-sub); font-size: 11px; }
    input, select { width: 100%; padding: 12px; border: 1px solid var(--border); border-radius: 14px; margin-bottom: 10px; font-size: 16px; }
    .btn { width: 100%; padding: 14px; border-radius: 14px; border: none; font-size: 16px; font-weight: 600; cursor: pointer; }
    .btn-primary { background: var(--primary); color: white; }
    .btn-outline { background: transparent; border: 1px solid var(--border); color: var(--text-sub); font-size: 12px; padding: 8px 12px; width: auto; border-radius: 10px; }
    .item-row { display: flex; justify-content: space-between; align-items: center; padding: 14px 0; border-bottom: 1px solid var(--border); }
    #piechart { width: 100%; height: 220px; }
    #loading-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(255,255,255,0.9); display: none; flex-direction: column; align-items: center; justify-content: center; z-index: 2000; }
    .hidden { display: none !important; }
  </style>
</head>
<body>

  <div id="loading-overlay">
    <div style="font-size: 40px;">â³</div>
    <div id="loading-text" style="margin-top:10px; font-weight:600;">é›²ç«¯åŒæ­¥ä¸­...</div>
  </div>

  <div id="auth-overlay">
    <div class="card" style="max-width: 320px; text-align: center; margin-top: 100px;">
      <div style="font-size: 40px; margin-bottom: 12px;">ğŸ’°</div>
      <h2>ç§äººè²¡å‹™ç®¡ç†</h2>
      <p id="auth-hint" style="color:var(--text-sub); font-size:13px; margin-bottom:20px;">è«‹è¼¸å…¥è§£é–å¯†ç¢¼</p>
      <input type="password" id="password-input" placeholder="è¼¸å…¥å¯†ç¢¼" style="text-align:center;">
      <button class="btn btn-primary" onclick="checkPassword()">è§£é–ç³»çµ±</button>
    </div>
  </div>

  <div id="main-app" class="container hidden">
    <div class="hero-stat">
      <small>ğŸ’ æ­·å¹´ç¸½è³‡ç”¢ç´¯è¨ˆ</small>
      <div id="tAll" class="total">$0</div>
      <div style="display:flex; justify-content:space-between; margin-top:16px; opacity:0.9;">
        <small>å¹´åº¦æ”¶æ”¯çµé¤˜</small>
        <span id="yBal" style="font-weight:600; font-size: 15px;">$0</span>
      </div>
    </div>

    <div class="card">
      <div style="display:flex; gap:8px; margin-bottom:16px;">
        <select id="viewYear" style="margin:0; flex:2;"></select>
        <select id="viewMonth" style="margin:0; flex:2;"></select>
        <button onclick="refreshData()" style="flex:1; background:var(--text-main); color:white; border-radius:14px; border:none; cursor:pointer;">ğŸ”„</button>
      </div>
      <div class="stats-grid">
        <div class="mini-stat"><small>æœ¬æœˆæ”¶å…¥</small><div id="mInc" style="color:var(--success)">$0</div></div>
        <div class="mini-stat"><small>æœ¬æœˆæ”¯å‡º</small><div id="mExp" style="color:var(--danger)">$0</div></div>
        <div class="mini-stat" style="grid-column: span 2;"><small>æœ¬æœˆçµé¤˜</small><div id="mBal">$0</div></div>
      </div>
    </div>

    <div class="card"><h3>ğŸ“Š æ”¯å‡ºåˆ†å¸ƒ</h3><div id="piechart"></div></div>

    <div class="card">
      <h3>âœï¸ æ–°å¢å¸³ç›®</h3>
      <div style="display:flex; gap:8px;">
        <select id="type" onchange="updateCategories()" style="flex:1">
          <option value="æ”¯å‡º">ğŸ”´ æ”¯å‡º</option>
          <option value="æ”¶å…¥">ğŸŸ¢ æ”¶å…¥</option>
        </select>
        <input type="date" id="date" style="flex:1.5">
      </div>
      <select id="category"></select>
      <input type="text" id="item" placeholder="é …ç›®èªªæ˜">
      <input type="number" id="amount" placeholder="é‡‘é¡" inputmode="numeric">
      <button class="btn btn-primary" onclick="addRecord()">å­˜å…¥ Google é›²ç«¯</button>
    </div>

    <div class="card"><h3>ğŸ“‹ ç•¶æœˆæ˜ç´°</h3><div id="list"></div></div>

    <div style="text-align:center; padding-bottom: 40px;">
      <div style="display: flex; gap: 8px; justify-content: center; margin-bottom: 20px; flex-wrap: wrap;">
        <button class="btn-outline" onclick="window.open('ä½ çš„è©¦ç®—è¡¨ç¶²å€', '_blank')">ğŸ“¤ é–‹å•Ÿè©¦ç®—è¡¨</button>
        <button class="btn-outline" onclick="document.getElementById('importFile').click()">ğŸ“¥ åŒ¯å…¥èˆŠæª”</button>
        <button class="btn-outline" onclick="exportToExcel()">ğŸ’¾ åŒ¯å‡º Excel</button>
      </div>
      <input type="file" id="importFile" class="hidden" accept=".xlsx, .xls" onchange="importFromExcel(event)">
      <span style="font-size:12px; color:var(--text-sub); cursor:pointer; text-decoration: underline;" onclick="resetPassword()">ğŸ”’ é‡è¨­è§£é–å¯†ç¢¼</span>
    </div>
  </div>

  <script>
    const API_URL = "https://script.google.com/macros/s/AKfycbyMU9hxCbZW6Citb7TpVZspsM6pak5NFE9LOv-W7N3Qk0CXx-LGeEWgBUV0UVK2gaDf/exec";

    let db = [];
    const categories = {
      "æ”¯å‡º": ["ğŸ” é¤é£²", "ğŸš— äº¤é€š", "â›½ æ²¹è²»", "ğŸ”§ ç¶­ä¿®è²»", "ğŸ’§ æ°´é›»è²»", "ğŸ“ å­¸è²»", "ğŸ›¡ï¸ ä¿éšª", "ğŸ¥ é†«ç™‚", "ğŸ  æˆ¿ç§Ÿ", "ğŸ§» æ—¥ç”¨å“", "âœï¸ æ–‡å…·", "ğŸ›ï¸ è³¼ç‰©", "âœˆï¸ æ—…éŠ", "ğŸ“ˆ æŠ•è³‡", "â“ å…¶ä»–"],
      "æ”¶å…¥": ["ğŸ’° è–ªè³‡", "ğŸ§§ çé‡‘", "ğŸ’¹ æŠ•è³‡ç²åˆ©", "ğŸ› ï¸ å…¼è·", "ğŸª™ é›¶ç”¨éŒ¢", "âœ¨ å…¶ä»–"]
    };

    function checkPassword() {
      const input = document.getElementById('password-input').value;
      const savedPwd = localStorage.getItem('money_pwd');
      const defaultPwd = "0000";
      if (input === defaultPwd || (savedPwd && btoa(input) === savedPwd)) {
        if (!savedPwd && input !== defaultPwd) localStorage.setItem('money_pwd', btoa(input));
        document.getElementById('auth-overlay').classList.add('hidden');
        document.getElementById('main-app').classList.remove('hidden');
        initApp();
      } else { alert('å¯†ç¢¼éŒ¯èª¤'); }
    }

    function resetPassword() {
      if(confirm('é‡è¨­å¯†ç¢¼å°‡ç™»å‡ºï¼Œç¢ºå®šå—ï¼Ÿ')) {
        localStorage.removeItem('money_pwd');
        location.reload();
      }
    }

    async function initApp() {
      google.charts.load('current', {'packages':['corechart']});
      const now = new Date();
      const ys = document.getElementById('viewYear');
      for(let i=now.getFullYear()-10; i<=now.getFullYear()+10; i++){
        let o=document.createElement('option'); o.value=i; o.text=i+'å¹´'; if(i===now.getFullYear())o.selected=true; ys.add(o);
      }
      const ms = document.getElementById('viewMonth');
      for(let i=0; i<12; i++){
        let o=document.createElement('option'); o.value=i; o.text=(i+1)+'æœˆ'; if(i===now.getMonth())o.selected=true; ms.add(o);
      }
      document.getElementById('date').valueAsDate = now;
      updateCategories();
      await refreshData();
    }

    function updateCategories() {
      const type = document.getElementById('type').value;
      document.getElementById('category').innerHTML = categories[type].map(c => `<option value="${c}">${c}</option>`).join('');
    }

    async function refreshData() {
      toggleLoading(true, "è®€å–é›²ç«¯è³‡æ–™...");
      try {
        const response = await fetch(API_URL);
        db = await response.json();
        renderAll();
      } catch (e) { alert('åŒæ­¥å¤±æ•—ï¼Œè«‹ç¢ºèª API URL'); }
      toggleLoading(false);
    }

    function renderAll() {
      const targetYear = parseInt(document.getElementById('viewYear').value);
      const targetMonth = parseInt(document.getElementById('viewMonth').value);
      let mInc = 0, mExp = 0, yBal = 0, tAll = 0;
      let categoryMap = {};
      let filteredList = [];

      db.forEach((r, index) => {
        const d = new Date(r.date);
        const amt = parseFloat(r.amount);
        if(r.type === 'æ”¶å…¥') tAll += amt; else tAll -= amt;
        
        if(d.getFullYear() === targetYear) {
          if(r.type === 'æ”¶å…¥') yBal += amt; else yBal -= amt;
          if(d.getMonth() === targetMonth) {
            if(r.type === 'æ”¶å…¥') mInc += amt; 
            else { mExp += amt; categoryMap[r.category] = (categoryMap[r.category] || 0) + amt; }
            filteredList.push({...r, id: index});
          }
        }
      });

      document.getElementById('tAll').innerText = '$' + tAll.toLocaleString();
      document.getElementById('yBal').innerText = '$' + yBal.toLocaleString();
      document.getElementById('mInc').innerText = '$' + mInc.toLocaleString();
      document.getElementById('mExp').innerText = '$' + mExp.toLocaleString();
      document.getElementById('mBal').innerText = '$' + (mInc - mExp).toLocaleString();

      drawChart(Object.entries(categoryMap).map(([k, v]) => [k, v]));
      
      document.getElementById('list').innerHTML = filteredList.reverse().map(r => `
        <div class="item-row">
          <div><b>${r.item}</b><br><small>${r.category} Â· ${r.date}</small></div>
          <div style="text-align:right">
            <div style="color:${r.type === 'æ”¶å…¥' ? 'var(--success)' : 'var(--text-main)'}; font-weight:700">
              ${r.type === 'æ”¶å…¥' ? '+' : '-'}$${r.amount.toLocaleString()}
            </div>
            <button onclick="deleteRecord(${r.id})" style="border:none; background:none; color:var(--danger); font-size:11px; cursor:pointer">åˆªé™¤</button>
          </div>
        </div>
      `).join('') || '<p style="text-align:center; color:var(--text-sub); font-size:14px;">å°šç„¡ç´€éŒ„</p>';
    }

    function drawChart(chartDataArr) {
      if (chartDataArr.length === 0) {
        document.getElementById('piechart').innerHTML = '<div style="text-align:center;color:var(--text-sub);padding-top:100px;font-size:14px;">æš«ç„¡æ”¯å‡ºè³‡æ–™</div>';
        return;
      }
      const data = google.visualization.arrayToDataTable([['Category', 'Amount'], ...chartDataArr]);
      new google.visualization.PieChart(document.getElementById('piechart')).draw(data, {
        pieHole: 0.5, chartArea: {width: '95%', height: '80%'}, legend: {position: 'bottom'},
        colors: ['#5856D6', '#FF9500', '#FF2D55', '#AF52DE', '#34C759', '#5AC8FA']
      });
    }

    async function addRecord() {
      const amt = document.getElementById('amount').value;
      const item = document.getElementById('item').value;
      if(!amt || !item) return alert('è«‹å¡«å¯«å®Œæ•´');
      const data = { action: 'add', date: document.getElementById('date').value, category: document.getElementById('category').value, item, amount: parseFloat(amt), type: document.getElementById('type').value };
      toggleLoading(true, "å­˜å…¥é›²ç«¯...");
      await fetch(API_URL, { method: 'POST', body: JSON.stringify(data) });
      document.getElementById('item').value = '';
      document.getElementById('amount').value = '';
      await refreshData();
    }

    async function deleteRecord(id) {
      if(!confirm('ç¢ºå®šåˆªé™¤ï¼Ÿ')) return;
      const target = db[id];
      toggleLoading(true, "åˆªé™¤ä¸­...");
      await fetch(API_URL, { method: 'POST', body: JSON.stringify({ action: 'delete', date: target.date, item: target.item, amount: target.amount }) });
      await refreshData();
    }

    // --- åŒ¯å‡ºåŠŸèƒ½ ---
    function exportToExcel() {
      if (db.length === 0) return alert("ç›®å‰ç„¡è³‡æ–™å¯åŒ¯å‡º");
      
      const ws = XLSX.utils.json_to_sheet(db);
      const wb = XLSX.utils.book_new();
      XLSX.utils.book_append_sheet(wb, ws, "å¸³ç›®æ˜ç´°");
      
      const now = new Date();
      const dateStr = now.getFullYear() + String(now.getMonth() + 1).padStart(2, '0') + String(now.getDate()).padStart(2, '0');
      
      // æª”åä¿®æ”¹ç‚º: å®¶åº­æ”¶æ”¯ + æ—¥æœŸ
      XLSX.writeFile(wb, `å®¶åº­æ”¶æ”¯${dateStr}.xlsx`);
    }

    async function importFromExcel(e) {
      const file = e.target.files[0];
      const reader = new FileReader();
      reader.onload = async function(event) {
        try {
          const workbook = XLSX.read(new Uint8Array(event.target.result), {type: 'array'});
          const imported = XLSX.utils.sheet_to_json(workbook.Sheets[workbook.SheetNames[0]]);
          if(confirm(`åŒ¯å…¥ ${imported.length} ç­†è³‡æ–™ï¼Ÿ`)) {
            for(let [i, item] of imported.entries()) {
              toggleLoading(true, `åŒ¯å…¥é€²åº¦ ${i+1}/${imported.length}`);
              await fetch(API_URL, { method: 'POST', body: JSON.stringify({ action: 'add', ...item }) });
            }
            alert('åŒ¯å…¥å®Œæˆ'); await refreshData();
          }
        } catch(e) { alert('æ ¼å¼éŒ¯èª¤'); }
      };
      reader.readAsArrayBuffer(file);
    }

    function toggleLoading(show, text="") {
      const loader = document.getElementById('loading-overlay');
      document.getElementById('loading-text').innerText = text;
      loader.style.display = show ? 'flex' : 'none';
    }
  </script>
</body>
</html>
