<!DOCTYPE html>
<html lang="zh-TW">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>é›²ç«¯ç§äººè²¡å‹™ç®¡ç† V2</title>
  <script src="https://www.gstatic.com/charts/loader.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
  <style>
    :root {
      --bg-color: #f8f9fb; --card-bg: #ffffff; --primary: #5856D6;
      --success: #34C759; --danger: #FF3B30; --text-main: #1c1c1e;
      --text-sub: #8e8e93; --border: #efeff4;
    }
    body { font-family: -apple-system, sans-serif; background: var(--bg-color); margin: 0; padding: 16px; display: flex; justify-content: center; }
    .container { width: 100%; max-width: 480px; }
    .card { background: var(--card-bg); padding: 20px; border-radius: 24px; box-shadow: 0 10px 25px rgba(0,0,0,0.05); margin-bottom: 16px; border: 1px solid var(--border); }
    .hero-stat { background: linear-gradient(135deg, #5856D6 0%, #3534a5 100%); color: white; padding: 24px; border-radius: 24px; margin-bottom: 16px; }
    .hero-stat div { font-size: 32px; font-weight: 800; margin-top: 5px; }
    .stats-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 10px; }
    .mini-stat { padding: 14px; border-radius: 18px; background: var(--bg-color); border: 1px solid var(--border); }
    input, select { width: 100%; padding: 12px; border: 1px solid var(--border); border-radius: 14px; margin-bottom: 10px; font-size: 16px; box-sizing: border-box;}
    .btn { width: 100%; padding: 14px; border-radius: 14px; border: none; font-size: 16px; font-weight: 600; cursor: pointer; transition: 0.3s; }
    .btn-primary { background: var(--primary); color: white; }
    .btn-outline { background: transparent; border: 1px solid var(--border); color: var(--text-sub); font-size: 13px; padding: 10px 16px; width: auto; }
    .item-row { display: flex; justify-content: space-between; padding: 14px 0; border-bottom: 1px solid var(--border); }
    #loading-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(255,255,255,0.9); display: none; flex-direction: column; align-items: center; justify-content: center; z-index: 2000; }
    .hidden { display: none !important; }
  </style>
</head>
<body>

  <div id="loading-overlay">
    <div style="font-size: 40px; margin-bottom: 10px;">â˜ï¸</div>
    <div id="loading-text">æ­£åœ¨åŒæ­¥é›²ç«¯è³‡æ–™...</div>
  </div>

  <div id="auth-overlay" style="position:fixed; top:0; left:0; width:100%; height:100%; background:var(--bg-color); display:flex; align-items:center; justify-content:center; z-index:1000;">
    <div class="card" style="max-width:320px; text-align:center;">
      <div style="font-size: 40px; margin-bottom: 12px;">ğŸ’°</div>
      <h2>é›²ç«¯è²¡å‹™ç®¡ç†</h2>
      <input type="password" id="password-input" placeholder="è¼¸å…¥è§£é–å¯†ç¢¼" style="text-align:center;">
      <button class="btn btn-primary" onclick="checkPassword()">è§£é–ä¸¦åŒæ­¥</button>
    </div>
  </div>

  <div id="main-app" class="container hidden">
    <div class="hero-stat">
      <small>ğŸ’ é›²ç«¯ç¸½è³‡ç”¢ (Google Sheets)</small>
      <div id="tAll">$0</div>
    </div>

    <div class="card">
      <div style="display:flex; gap:8px; margin-bottom:16px;">
        <select id="viewYear" style="margin:0"></select>
        <select id="viewMonth" style="margin:0"></select>
        <button onclick="refreshData()" style="padding:0 15px; background:var(--text-main); color:white; border-radius:14px; border:none; cursor:pointer;">ğŸ”„</button>
      </div>
      <div class="stats-grid">
        <div class="mini-stat"><small>æœˆæ”¶å…¥</small><div id="mInc" style="color:var(--success)">$0</div></div>
        <div class="mini-stat"><small>æœˆæ”¯å‡º</small><div id="mExp" style="color:var(--danger)">$0</div></div>
      </div>
    </div>

    <div class="card">
      <h3>âœï¸ æ–°å¢å¸³ç›®</h3>
      <select id="type" onchange="updateCategories()">
        <option value="æ”¯å‡º">ğŸ”´ æ”¯å‡º</option>
        <option value="æ”¶å…¥">ğŸŸ¢ æ”¶å…¥</option>
      </select>
      <input type="date" id="date">
      <select id="category"></select>
      <input type="text" id="item" placeholder="é …ç›®èªªæ˜">
      <input type="number" id="amount" placeholder="é‡‘é¡" inputmode="numeric">
      <button class="btn btn-primary" onclick="addRecord()">å­˜å…¥é›²ç«¯</button>
    </div>

    <div class="card">
      <h3>ğŸ“‹ ç•¶æœˆæ˜ç´°</h3>
      <div id="list"></div>
    </div>

    <div style="text-align:center; padding: 20px 0 40px 0;">
      <div style="display: flex; gap: 8px; justify-content: center; margin-bottom: 20px;">
        <button class="btn-outline" onclick="window.open('ä½ çš„è©¦ç®—è¡¨ç¶²å€', '_blank')">ğŸ“‘ æ‰“é–‹è©¦ç®—è¡¨</button>
        <button class="btn-outline" onclick="document.getElementById('importFile').click()">ğŸ“¥ åŒ¯å…¥èˆŠæª”</button>
      </div>
      <input type="file" id="importFile" class="hidden" accept=".xlsx, .xls" onchange="importFromExcel(event)">
      <p style="font-size:12px; color:var(--text-sub);">æç¤ºï¼šåŒ¯å…¥åŠŸèƒ½æœƒå°‡ Excel è³‡æ–™æ‰¹æ¬¡ä¸Šå‚³è‡³ Google è©¦ç®—è¡¨</p>
    </div>
  </div>

  <script>
    // --------------------------------------------------
    const API_URL = "https://script.google.com/macros/s/AKfycbyMU9hxCbZW6Citb7TpVZspsM6pak5NFE9LOv-W7N3Qk0CXx-LGeEWgBUV0UVK2gaDf/exec";
    // --------------------------------------------------

    let db = [];
    const categories = {
      "æ”¯å‡º": ["ğŸ” é¤é£²", "ğŸš— äº¤é€š", "â›½ æ²¹è²»", "ğŸ”§ ç¶­ä¿®è²»", "ğŸ’§ æ°´é›»è²»", "ğŸ  æˆ¿ç§Ÿ", "ğŸ›ï¸ è³¼ç‰©", "ğŸ“ˆ æŠ•è³‡", "â“ å…¶ä»–"],
      "æ”¶å…¥": ["ğŸ’° è–ªè³‡", "ğŸ§§ çé‡‘", "ğŸ’¹ æŠ•è³‡ç²åˆ©", "ğŸ› ï¸ å…¼è·", "âœ¨ å…¶ä»–"]
    };

    function checkPassword() {
      if (document.getElementById('password-input').value === "0000") {
        document.getElementById('auth-overlay').classList.add('hidden');
        document.getElementById('main-app').classList.remove('hidden');
        initApp();
      } else { alert('å¯†ç¢¼éŒ¯èª¤'); }
    }

    async function initApp() {
      google.charts.load('current', {'packages':['corechart']});
      const now = new Date();
      setupSelectors(now);
      document.getElementById('date').valueAsDate = now;
      updateCategories();
      await refreshData();
    }

    function setupSelectors(now) {
      const ys = document.getElementById('viewYear');
      for(let i=now.getFullYear()-2; i<=now.getFullYear()+2; i++){
        let o=document.createElement('option'); o.value=i; o.text=i+'å¹´'; if(i===now.getFullYear())o.selected=true; ys.add(o);
      }
      const ms = document.getElementById('viewMonth');
      for(let i=0; i<12; i++){
        let o=document.createElement('option'); o.value=i; o.text=(i+1)+'æœˆ'; if(i===now.getMonth())o.selected=true; ms.add(o);
      }
    }

    function updateCategories() {
      const type = document.getElementById('type').value;
      document.getElementById('category').innerHTML = categories[type].map(c => `<option value="${c}">${c}</option>`).join('');
    }

    async function refreshData() {
      toggleLoading(true, "æ­£åœ¨è®€å–é›²ç«¯è³‡æ–™...");
      try {
        const response = await fetch(API_URL);
        db = await response.json();
        renderAll();
      } catch (e) { alert('åŒæ­¥å¤±æ•—ï¼Œè«‹æª¢æŸ¥ç¶²è·¯æˆ– API URL'); }
      toggleLoading(false);
    }

    async function addRecord() {
      const amt = document.getElementById('amount').value;
      const item = document.getElementById('item').value;
      if(!amt || !item) return alert('è«‹å®Œæ•´å¡«å¯«');

      const data = {
        action: 'add',
        date: document.getElementById('date').value,
        category: document.getElementById('category').value,
        item: item,
        amount: parseFloat(amt),
        type: document.getElementById('type').value
      };

      toggleLoading(true, "æ­£åœ¨å­˜å…¥é›²ç«¯...");
      await fetch(API_URL, { method: 'POST', body: JSON.stringify(data) });
      document.getElementById('item').value = '';
      document.getElementById('amount').value = '';
      await refreshData();
    }

    async function deleteRecord(id) {
      if(!confirm('ç¢ºå®šå¾é›²ç«¯åˆªé™¤ï¼Ÿ')) return;
      const target = db[id];
      toggleLoading(true, "æ­£åœ¨å¾é›²ç«¯åˆªé™¤...");
      await fetch(API_URL, { 
        method: 'POST', 
        body: JSON.stringify({ action: 'delete', date: target.date, item: target.item, amount: target.amount }) 
      });
      await refreshData();
    }

    async function importFromExcel(e) {
      const file = e.target.files[0];
      const reader = new FileReader();
      reader.onload = async function(event) {
        try {
          const data = new Uint8Array(event.target.result);
          const workbook = XLSX.read(data, {type: 'array'});
          const imported = XLSX.utils.sheet_to_json(workbook.Sheets[workbook.SheetNames[0]]);
          
          if(confirm(`åµæ¸¬åˆ° ${imported.length} ç­†è³‡æ–™ï¼Œè¦åŒ¯å…¥è‡³é›²ç«¯å—ï¼Ÿ`)) {
            for(let [index, item] of imported.entries()) {
              toggleLoading(true, `æ­£åœ¨åŒ¯å…¥ç¬¬ ${index+1}/${imported.length} ç­†...`);
              await fetch(API_URL, {
                method: 'POST',
                body: JSON.stringify({ action: 'add', ...item, amount: parseFloat(item.amount) })
              });
            }
            alert('åŒ¯å…¥å®Œæˆï¼');
            await refreshData();
          }
        } catch(e) { alert('æª”æ¡ˆæ ¼å¼ä¸ç›¸ç¬¦'); }
      };
      reader.readAsArrayBuffer(file);
    }

    function toggleLoading(show, text="") {
      const loader = document.getElementById('loading-overlay');
      document.getElementById('loading-text').innerText = text;
      loader.style.display = show ? 'flex' : 'none';
    }

    function renderAll() {
      const targetYear = parseInt(document.getElementById('viewYear').value);
      const targetMonth = parseInt(document.getElementById('viewMonth').value);
      let mInc = 0, mExp = 0, tAll = 0;
      let filteredList = [];

      db.forEach((r, index) => {
        const d = new Date(r.date);
        const amt = parseFloat(r.amount);
        if(r.type === 'æ”¶å…¥') tAll += amt; else tAll -= amt;
        if(d.getFullYear() === targetYear && d.getMonth() === targetMonth) {
          if(r.type === 'æ”¶å…¥') mInc += amt; else mExp += amt;
          filteredList.push({...r, id: index});
        }
      });

      document.getElementById('tAll').innerText = '$' + tAll.toLocaleString();
      document.getElementById('mInc').innerText = '$' + mInc.toLocaleString();
      document.getElementById('mExp').innerText = '$' + mExp.toLocaleString();
      document.getElementById('list').innerHTML = filteredList.reverse().map(r => `
        <div class="item-row">
          <div><b>${r.item}</b><br><small>${r.category} Â· ${r.date}</small></div>
          <div style="text-align:right">
            <div style="color:${r.type === 'æ”¶å…¥' ? 'var(--success)' : 'var(--text-main)'}; font-weight:700">
              ${r.type === 'æ”¶å…¥' ? '+' : '-'}$${r.amount.toLocaleString()}
            </div>
            <button onclick="deleteRecord(${r.id})" style="border:none; background:none; color:var(--danger); font-size:11px; cursor:pointer">åˆªé™¤</button>
          </div>
        </div>
      `).join('') || '<p style="text-align:center; color:var(--text-sub); font-size:14px;">æœ¬æœˆå°šç„¡ç´€éŒ„</p>';
    }
  </script>
</body>
</html>
