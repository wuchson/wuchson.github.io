<!DOCTYPE html>
<html lang="zh-Hant">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>å€‰å„²å®šä½åŠ©æ‰‹-é›²ç«¯ç‰ˆ</title>
    <script src="https://cdn.sheetjs.com/xlsx-latest/package/dist/xlsx.full.min.js"></script>
    <style>
        :root { --primary: #4361ee; --accent: #4cc9f0; --danger: #f72585; --warning: #ffb703; --bg: #f8f9fc; --card: #ffffff; --text: #2b2d42; }
        * { box-sizing: border-box; font-family: 'PingFang TC', sans-serif; }
        body { background-color: var(--bg); color: var(--text); margin: 0; padding: 0; }
        header { background: linear-gradient(135deg, var(--primary), var(--accent)); color: white; padding: 20px; text-align: center; }
        .container { width: 100%; padding: 15px; max-width: 600px; margin: 0 auto; }
        
        .admin-bar { background: #eaedf7; padding: 12px; border-radius: 10px; margin-bottom: 15px; display: flex; align-items: center; justify-content: space-between; }
        .admin-bar input { padding: 8px; border: 1px solid #ccd; border-radius: 6px; width: 130px; }

        .tool-bar { display: none; gap: 10px; margin-bottom: 20px; }
        .btn-tool { flex: 1; padding: 10px; background: #fff; border: 1px solid var(--primary); color: var(--primary); border-radius: 8px; cursor: pointer; font-weight: bold; font-size: 13px; }

        .input-card { background: var(--card); padding: 20px; border-radius: 12px; box-shadow: 0 4px 12px rgba(0,0,0,0.08); margin-top: -30px; border: 2px solid transparent; }
        .input-card.edit-mode { border-color: var(--warning); background: #fffdf5; }
        .grid-row { display: grid; grid-template-columns: 1fr 1fr; gap: 12px; margin-bottom: 12px; }
        @media (max-width: 480px) { .grid-row { grid-template-columns: 1fr; } }
        
        .input-group label { font-size: 12px; font-weight: bold; color: #8d99ae; }
        .input-group input { padding: 12px; border: 2px solid #edf2f4; border-radius: 8px; font-size: 16px; width: 100%; margin-top: 4px; }
        
        .btn-main { width: 100%; padding: 14px; background: var(--primary); color: white; border: none; border-radius: 8px; font-size: 16px; font-weight: bold; cursor: pointer; margin-top: 10px; }
        .btn-main.update { background: var(--warning); color: #000; }

        .search-bar { margin: 25px 0 15px 0; }
        .search-bar input { width: 100%; padding: 15px; border-radius: 10px; border: 2px solid var(--primary); font-size: 16px; }

        .item-card { background: white; border-radius: 12px; padding: 15px; margin-bottom: 12px; border-left: 6px solid var(--primary); box-shadow: 0 2px 8px rgba(0,0,0,0.05); display: flex; justify-content: space-between; align-items: center; }
        .item-sku { font-size: 18px; font-weight: 800; color: var(--primary); }
        .item-loc { background: #fff0f3; color: var(--danger); display: inline-block; padding: 4px 8px; border-radius: 4px; font-weight: bold; margin-top: 5px; font-size: 14px; }
        
        .action-btns { display: none; flex-direction: column; gap: 8px; }
        .btn-edit { background: #e9ecef; border: none; padding: 6px 12px; border-radius: 6px; cursor: pointer; font-size: 12px; }
        .btn-del { background: #fff5f5; color: var(--danger); border: none; padding: 6px 12px; border-radius: 6px; cursor: pointer; font-size: 12px; }
        
        #status { text-align: center; color: #888; padding: 10px; font-size: 14px; }
    </style>
</head>
<body>

<header><h2 style="margin:0;">ğŸ“¦ å€‰å„²é›²ç«¯åŠ©æ‰‹ Pro</h2></header>

<div class="container">
    <div class="admin-bar">
        <span style="font-size: 13px; color: var(--primary); font-weight: bold;">ğŸ”‘ ç®¡ç†æ¨¡å¼</span>
        <input type="password" id="adminPwd" placeholder="è¼¸å…¥å¯†ç¢¼è§£é–" oninput="toggleAdminMode()">
    </div>

    <div class="tool-bar" id="toolBar">
        <button class="btn-tool" onclick="document.getElementById('fileImport').click()">ğŸ“¥ åŒ¯å…¥ Excel</button>
        <button class="btn-tool" onclick="exportToExcel()">ğŸ“¤ åŒ¯å‡ºå‚™ä»½</button>
        <input type="file" id="fileImport" accept=".xlsx, .xls" style="display:none" onchange="importFromExcel(event)">
    </div>

    <div class="input-card" id="inputCard">
        <input type="hidden" id="editId">
        <div class="grid-row">
            <div class="input-group"><label>å» å•†</label><input type="text" id="vendor"></div>
            <div class="input-group"><label>å‹è™Ÿ (A1234)</label><input type="text" id="sku"></div>
        </div>
        <div class="grid-row">
            <div class="input-group"><label>å“å(å…§è¡£/å…§è¤²)</label><input type="text" id="itemName"></div>
            <div class="input-group"><label>å„²ä½ä½ç½®(ä¾‹å¦‚: Aæ£Ÿ-1F-Bå€-B2Fæ¶ä¸Š-èªªæ˜)</label><input type="text" id="location"></div>
        </div>
        <button id="submitBtn" class="btn-main" onclick="handleSave()">ä¿å­˜è³‡æ–™</button>
    </div>

    <div class="search-bar">
        <input type="text" id="searchInput" placeholder="ğŸ” å¿«é€Ÿæœå°‹..." onkeyup="render()">
    </div>

    <div id="status">é›²ç«¯è³‡æ–™è¼‰å…¥ä¸­...</div>
    <div id="list"></div>
</div>

<script>
    // --- âš ï¸ é‡è¦ï¼šè«‹è²¼ä¸Šä½ çš„ Google Apps Script URL ---
    const API_URL = "https://script.google.com/macros/s/AKfycbyvVtwur7SG6FQxtp_pW7DIJiOn0hkU85ic23g7HGPqixm7W4vKygC1SeYjF5-EX-8L/exec";

    let db = [];

    // åˆå§‹åŒ–è®€å–
    async function loadData() {
        try {
            const resp = await fetch(API_URL, { method: 'POST', body: JSON.stringify({ action: 'read' }) });
            db = await resp.json();
            document.getElementById('status').innerText = `å…± ${db.length} ç­†è³‡æ–™`;
            render();
        } catch (e) { document.getElementById('status').innerText = "é€£ç·šå¤±æ•—"; }
    }

    // æ¬Šé™åˆ‡æ›
    function toggleAdminMode() {
        const pwd = document.getElementById('adminPwd').value;
        const show = pwd.length > 0;
        document.getElementById('toolBar').style.display = show ? 'flex' : 'none';
        render();
    }

    // ä¿å­˜
    async function handleSave() {
        const item = {
            id: document.getElementById('editId').value,
            vendor: document.getElementById('vendor').value,
            sku: document.getElementById('sku').value,
            name: document.getElementById('itemName').value,
            loc: document.getElementById('location').value
        };
        if(!item.sku || !item.loc) return alert("å‹è™Ÿèˆ‡ä½ç½®å¿…å¡«");

        document.getElementById('status').innerText = "ä¸Šå‚³ä¸­...";
        const resp = await fetch(API_URL, {
            method: 'POST',
            body: JSON.stringify({ action: 'save', data: item, password: document.getElementById('adminPwd').value })
        });
        const result = await resp.text();
        if(result.includes("Error")) alert(result);
        else { clearInputs(); resetMode(); await loadData(); }
    }

    // åŒ¯å‡º Excel
    function exportToExcel() {
        const exportData = db.map(i => ({ "å» å•†": i.vendor, "å‹è™Ÿ": i.sku, "å“å": i.name, "å„²ä½": i.loc }));
        const worksheet = XLSX.utils.json_to_sheet(exportData);
        const workbook = XLSX.utils.book_new();
        XLSX.utils.book_append_sheet(workbook, worksheet, "å€‰å„²è³‡æ–™");
        XLSX.writeFile(workbook, `å€‰å„²å‚™ä»½_${new Date().toLocaleDateString()}.xlsx`);
    }

    // åŒ¯å…¥ Excel
    async function importFromExcel(event) {
        const file = event.target.files[0];
        const pwd = document.getElementById('adminPwd').value;
        const reader = new FileReader();
        reader.onload = async function(e) {
            const data = new Uint8Array(e.target.result);
            const workbook = XLSX.read(data, { type: 'array' });
            const json = XLSX.utils.sheet_to_json(workbook.Sheets[workbook.SheetNames[0]]);
            const newItems = json.map(row => ({
                vendor: row['å» å•†'] || '',
                sku: String(row['å‹è™Ÿ'] || row['SKU'] || ''),
                name: row['å“å'] || '',
                loc: String(row['å„²ä½'] || row['ä½ç½®'] || '')
            })).filter(i => i.sku && i.loc);

            if (confirm(`è®€å–åˆ° ${newItems.length} ç­†ï¼Œç¢ºå®šåŒ¯å…¥ï¼Ÿ`)) {
                document.getElementById('status').innerText = "æ‰¹æ¬¡ä¸Šå‚³ä¸­...";
                await fetch(API_URL, { method: 'POST', body: JSON.stringify({ action: 'batchSave', data: newItems, password: pwd }) });
                location.reload();
            }
        };
        reader.readAsArrayBuffer(file);
    }

    // åˆªé™¤
    async function deleteItem(id) {
        if(!confirm('ç¢ºå®šåˆªé™¤ï¼Ÿ')) return;
        await fetch(API_URL, { method: 'POST', body: JSON.stringify({ action: 'delete', id: id, password: document.getElementById('adminPwd').value }) });
        await loadData();
    }

    function startEdit(id) {
        const item = db.find(i => i.id == id);
        document.getElementById('editId').value = item.id;
        document.getElementById('vendor').value = item.vendor;
        document.getElementById('sku').value = item.sku;
        document.getElementById('itemName').value = item.name;
        document.getElementById('location').value = item.loc;
        document.getElementById('submitBtn').innerText = "ğŸ’¾ æ›´æ–°æ­¤è³‡æ–™";
        document.getElementById('submitBtn').classList.add('update');
        document.getElementById('inputCard').classList.add('edit-mode');
        window.scrollTo({ top: 0, behavior: 'smooth' });
    }

    function resetMode() {
        document.getElementById('editId').value = "";
        document.getElementById('submitBtn').innerText = "ä¿å­˜è³‡æ–™";
        document.getElementById('submitBtn').classList.remove('update');
        document.getElementById('inputCard').classList.remove('edit-mode');
    }

    function clearInputs() { document.querySelectorAll('.input-group input').forEach(i => i.value = ''); }

    function render() {
        const query = document.getElementById('searchInput').value.toLowerCase();
        const isAdmin = document.getElementById('adminPwd').value.length > 0;
        const listDiv = document.getElementById('list');
        listDiv.innerHTML = '';
        db.filter(i => String(i.sku).toLowerCase().includes(query) || String(i.vendor).toLowerCase().includes(query) || String(i.loc).toLowerCase().includes(query))
          .forEach(i => {
            listDiv.innerHTML += `
                <div class="item-card">
                    <div class="item-info">
                        <div class="item-sku">${i.sku}</div>
                        <div style="font-size:13px; color:#666;">${i.vendor} | ${i.name}</div>
                        <div class="item-loc">ğŸ“ ${i.loc}</div>
                    </div>
                    <div class="action-btns" style="display: ${isAdmin ? 'flex' : 'none'}">
                        <button class="btn-edit" onclick="startEdit('${i.id}')">ä¿®æ”¹</button>
                        <button class="btn-del" onclick="deleteItem('${i.id}')">åˆªé™¤</button>
                    </div>
                </div>`;
          });
    }

    window.onload = loadData;
</script>
</body>
</html>
