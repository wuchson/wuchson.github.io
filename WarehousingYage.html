<!DOCTYPE html>
<html lang="zh-Hant">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>å€‰å„²å®šä½åŠ©æ‰‹-é›²ç«¯ç‰ˆ</title>
    <script src="https://cdn.sheetjs.com/xlsx-latest/package/dist/xlsx.full.min.js"></script>
    <style>
        :root { --primary: #4361ee; --accent: #4cc9f0; --danger: #f72585; --warning: #ffb703; --bg: #f8f9fc; --card: #ffffff; --text: #2b2d42; }
        * { box-sizing: border-box; font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", Arial, sans-serif; }
        body { background-color: var(--bg); color: var(--text); margin: 0; padding: 0; }
        header { background: linear-gradient(135deg, var(--primary), var(--accent)); color: white; padding: 20px; text-align: center; box-shadow: 0 2px 10px rgba(0,0,0,0.1); }
        .container { width: 100%; padding: 15px; max-width: 600px; margin: 0 auto; }
        
        .admin-bar { background: #eaedf7; padding: 12px; border-radius: 10px; margin-bottom: 15px; display: flex; align-items: center; justify-content: space-between; border: 1px solid #d1d9e6; }
        .admin-bar input { padding: 8px 12px; border: 1px solid #ccd; border-radius: 6px; width: 140px; font-size: 14px; }

        .tool-bar { display: none; gap: 10px; margin-bottom: 20px; }
        .btn-tool { flex: 1; padding: 10px; background: #fff; border: 1px solid var(--primary); color: var(--primary); border-radius: 8px; cursor: pointer; font-weight: bold; font-size: 13px; transition: 0.2s; }
        .btn-tool:hover { background: var(--primary); color: #fff; }

        .input-card { background: var(--card); padding: 20px; border-radius: 12px; box-shadow: 0 4px 12px rgba(0,0,0,0.08); margin-top: -30px; border: 2px solid transparent; }
        .input-card.edit-mode { border-color: var(--warning); background: #fffdf5; }
        .grid-row { display: grid; grid-template-columns: 1fr 1fr; gap: 12px; margin-bottom: 12px; }
        @media (max-width: 480px) { .grid-row { grid-template-columns: 1fr; } }
        
        .input-group label { font-size: 12px; font-weight: bold; color: #8d99ae; }
        .input-group input { padding: 12px; border: 2px solid #edf2f4; border-radius: 8px; font-size: 16px; width: 100%; margin-top: 4px; outline: none; }
        .input-group input:focus { border-color: var(--primary); }
        
        .btn-main { width: 100%; padding: 14px; background: var(--primary); color: white; border: none; border-radius: 8px; font-size: 16px; font-weight: bold; cursor: pointer; margin-top: 10px; }
        .btn-main:active { transform: scale(0.98); }
        .btn-main.update { background: var(--warning); color: #000; }

        .search-bar { margin: 25px 0 15px 0; }
        .search-bar input { width: 100%; padding: 15px; border-radius: 10px; border: 2px solid var(--primary); font-size: 16px; outline: none; }

        .item-card { background: white; border-radius: 12px; padding: 15px; margin-bottom: 12px; border-left: 6px solid var(--primary); box-shadow: 0 2px 8px rgba(0,0,0,0.05); display: flex; justify-content: space-between; align-items: center; }
        .item-sku { font-size: 18px; font-weight: 800; color: var(--primary); }
        .item-loc { background: #fff0f3; color: var(--danger); display: inline-block; padding: 4px 8px; border-radius: 4px; font-weight: bold; margin-top: 5px; font-size: 14px; }
        
        .action-btns { display: none; flex-direction: column; gap: 8px; }
        .btn-edit { background: #e9ecef; border: none; padding: 6px 12px; border-radius: 6px; cursor: pointer; font-size: 12px; font-weight: 600; }
        .btn-del { background: #fff5f5; color: var(--danger); border: none; padding: 6px 12px; border-radius: 6px; cursor: pointer; font-size: 12px; font-weight: 600; }
        
        #status { text-align: center; color: #888; padding: 10px; font-size: 14px; }
    </style>
</head>
<body>

<header><h2 style="margin:0;">ğŸ“¦ å€‰å„²é›²ç«¯åŠ©æ‰‹-é›²ç«¯ç‰ˆ</h2></header>

<div class="container">
    <div class="admin-bar">
        <span style="font-size: 13px; color: var(--primary); font-weight: bold;">ğŸ”‘ ç®¡ç†æ¨¡å¼</span>
        <input type="password" id="adminPwd" placeholder="è¼¸å…¥æ­£ç¢ºå¯†ç¢¼" oninput="checkPassword()">
    </div>

    <div class="tool-bar" id="toolBar">
        <button class="btn-tool" onclick="document.getElementById('fileImport').click()">ğŸ“¥ åŒ¯å…¥ Excel</button>
        <button class="btn-tool" onclick="exportToExcel()">ğŸ“¤ åŒ¯å‡ºå‚™ä»½</button>
        <input type="file" id="fileImport" accept=".xlsx, .xls" style="display:none" onchange="importFromExcel(event)">
    </div>

    <div class="input-card" id="inputCard">
        <input type="hidden" id="editId">
        <div class="grid-row">
            <div class="input-group"><label>å» å•†</label><input type="text" id="vendor" autocomplete="off"></div>
            <div class="input-group"><label>å‹è™Ÿ (A1234)</label><input type="text" id="sku" autocomplete="off"></div>
        </div>
        <div class="grid-row">
            <div class="input-group"><label>å“å(å…§è¡£/å…§è¤²)</label><input type="text" id="itemName" autocomplete="off"></div>
            <div class="input-group"><label>å„²ä½ä½ç½®(ä¾‹å¦‚: Aæ£Ÿ-1F-Bå€-B2Fæ¶ä¸Š-èªªæ˜)</label><input type="text" id="location" autocomplete="off"></div>
        </div>
        <button id="submitBtn" class="btn-main" onclick="handleSave()">ä¿å­˜å–®ç­†è³‡æ–™</button>
    </div>

    <div class="search-bar">
        <input type="text" id="searchInput" placeholder="ğŸ” å¿«é€Ÿæœå°‹ç”¢å“ã€å» å•†ã€ä½ç½®..." onkeyup="render()">
    </div>

    <div id="status">é›²ç«¯è³‡æ–™åŒæ­¥ä¸­...</div>
    <div id="list"></div>
</div>

<script>
    // --- âš ï¸ é—œéµè¨­å®šå€ ---
    const API_URL = "https://script.google.com/macros/s/AKfycbyvVtwur7SG6FQxtp_pW7DIJiOn0hkU85ic23g7HGPqixm7W4vKygC1SeYjF5-EX-8L/exec"; // è«‹å¡«å…¥ Google éƒ¨ç½²ç¶²å€
    const LOCAL_ADMIN_PWD = "0000"; // è«‹å¡«å…¥è·Ÿå¾Œç«¯ä¸€æ¨£çš„å¯†ç¢¼

    let db = [];

    // å¯†ç¢¼å³æ™‚æª¢æŸ¥
    function checkPassword() {
        const inputPwd = document.getElementById('adminPwd').value;
        const toolBar = document.getElementById('toolBar');
        
        // åªæœ‰å¯†ç¢¼å®Œå…¨ä¸€æ¨£æ‰é–‹å•ŸæŒ‰éˆ•
        if (inputPwd === LOCAL_ADMIN_PWD) {
            toolBar.style.display = 'flex';
        } else {
            toolBar.style.display = 'none';
        }
        render(); // é‡æ–°æ¸²æŸ“åˆ—è¡¨ä»¥æ›´æ–°ã€Œä¿®æ”¹/åˆªé™¤ã€æŒ‰éˆ•
    }

    async function loadData() {
        try {
            const resp = await fetch(API_URL, { method: 'POST', body: JSON.stringify({ action: 'read' }) });
            db = await resp.json();
            document.getElementById('status').innerText = `ç›®å‰åº«å­˜ï¼š${db.length} ç­†`;
            render();
        } catch (e) { document.getElementById('status').innerText = "âŒ ç„¡æ³•é€£ç·šè‡³é›²ç«¯"; }
    }

    async function handleSave() {
        const pwd = document.getElementById('adminPwd').value;
        const item = {
            id: document.getElementById('editId').value,
            vendor: document.getElementById('vendor').value,
            sku: document.getElementById('sku').value,
            name: document.getElementById('itemName').value,
            loc: document.getElementById('location').value
        };
        if(!item.sku || !item.loc) return alert("å‹è™Ÿèˆ‡å„²ä½æ˜¯å¿…å¡«é …ç›®ï¼");

        document.getElementById('status').innerText = "è³‡æ–™å‚³é€ä¸­...";
        const resp = await fetch(API_URL, {
            method: 'POST',
            body: JSON.stringify({ action: 'save', data: item, password: pwd })
        });
        const result = await resp.text();
        if(result.includes("Error")) {
            alert("âŒ " + result);
            document.getElementById('status').innerText = "å­˜å–é­æ‹’";
        } else {
            clearInputs();
            resetMode();
            await loadData();
        }
    }

    function exportToExcel() {
        const exportData = db.map(i => ({ "å» å•†": i.vendor, "å‹è™Ÿ": i.sku, "å“å": i.name, "å„²ä½": i.loc }));
        const worksheet = XLSX.utils.json_to_sheet(exportData);
        const workbook = XLSX.utils.book_new();
        XLSX.utils.book_append_sheet(workbook, worksheet, "WarehouseData");
        XLSX.writeFile(workbook, `åº«å­˜å‚™ä»½_${new Date().toISOString().slice(0,10)}.xlsx`);
    }

    async function importFromExcel(event) {
        const file = event.target.files[0];
        const pwd = document.getElementById('adminPwd').value;
        const reader = new FileReader();
        reader.onload = async function(e) {
            const data = new Uint8Array(e.target.result);
            const workbook = XLSX.read(data, { type: 'array' });
            const json = XLSX.utils.sheet_to_json(workbook.Sheets[workbook.SheetNames[0]]);
            const newItems = json.map(row => ({
                vendor: row['å» å•†'] || '',
                sku: String(row['å‹è™Ÿ'] || row['SKU'] || ''),
                name: row['å“å'] || '',
                loc: String(row['å„²ä½'] || row['ä½ç½®'] || '')
            })).filter(i => i.sku && i.loc);

            if (confirm(`è®€å–åˆ° ${newItems.length} ç­†è³‡æ–™ï¼Œç¢ºèªåŒ¯å…¥é›²ç«¯ï¼Ÿ`)) {
                document.getElementById('status').innerText = "æ‰¹æ¬¡åŒ¯å…¥ä¸­...";
                await fetch(API_URL, { method: 'POST', body: JSON.stringify({ action: 'batchSave', data: newItems, password: pwd }) });
                location.reload();
            }
        };
        reader.readAsArrayBuffer(file);
    }

    async function deleteItem(id) {
        if(!confirm('è­¦å‘Šï¼šç¢ºå®šè¦åˆªé™¤é€™ç­†è³‡æ–™å—ï¼Ÿ')) return;
        const pwd = document.getElementById('adminPwd').value;
        const resp = await fetch(API_URL, { method: 'POST', body: JSON.stringify({ action: 'delete', id: id, password: pwd }) });
        const result = await resp.text();
        if(result.includes("Error")) alert(result);
        await loadData();
    }

    function startEdit(id) {
        const item = db.find(i => i.id == id);
        document.getElementById('editId').value = item.id;
        document.getElementById('vendor').value = item.vendor;
        document.getElementById('sku').value = item.sku;
        document.getElementById('itemName').value = item.name;
        document.getElementById('location').value = item.loc;
        document.getElementById('submitBtn').innerText = "ğŸ’¾ ç¢ºèªæ›´æ–°ä½ç½®";
        document.getElementById('submitBtn').classList.add('update');
        document.getElementById('inputCard').classList.add('edit-mode');
        window.scrollTo({ top: 0, behavior: 'smooth' });
    }

    function resetMode() {
        document.getElementById('editId').value = "";
        document.getElementById('submitBtn').innerText = "ä¿å­˜å–®ç­†è³‡æ–™";
        document.getElementById('submitBtn').classList.remove('update');
        document.getElementById('inputCard').classList.remove('edit-mode');
    }

    function clearInputs() { document.querySelectorAll('.input-card input').forEach(i => i.value = ''); }

    function render() {
        const query = document.getElementById('searchInput').value.toLowerCase();
        const isAdmin = document.getElementById('adminPwd').value === LOCAL_ADMIN_PWD;
        const listDiv = document.getElementById('list');
        listDiv.innerHTML = '';

        db.filter(i => 
            String(i.sku).toLowerCase().includes(query) || 
            String(i.vendor).toLowerCase().includes(query) || 
            String(i.loc).toLowerCase().includes(query) ||
            String(i.name).toLowerCase().includes(query)
        ).forEach(i => {
            listDiv.innerHTML += `
                <div class="item-card">
                    <div class="item-info">
                        <div class="item-sku">${i.sku}</div>
                        <div style="font-size:13px; color:#666; margin: 4px 0;">${i.vendor} | ${i.name}</div>
                        <div class="item-loc">ğŸ“ ${i.loc}</div>
                    </div>
                    <div class="action-btns" style="display: ${isAdmin ? 'flex' : 'none'}">
                        <button class="btn-edit" onclick="startEdit('${i.id}')">ä¿®æ”¹</button>
                        <button class="btn-del" onclick="deleteItem('${i.id}')">åˆªé™¤</button>
                    </div>
                </div>`;
        });
    }

    window.onload = loadData;
</script>
</body>
</html>
