<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>å°ˆæ¥­æœæ¨¹ç®¡ç†ç³»çµ± v4.0</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    
    <style>
        /* æ‰¿è¥² v3.4 æ¨£å¼ä¸¦å„ªåŒ–çµ±è¨ˆä»‹é¢ */
        :root { --primary: #2d6a4f; --primary-dark: #1b4332; --accent: #d4a373; --bg: #f4f6f5; --white: #ffffff; --text-dark: #1b4332; --radius: 16px; --danger: #e63946; --warning: #ffb703; --money: #2a9d8f; }
        * { -webkit-tap-highlight-color: transparent; outline: none; color: var(--text-dark); box-sizing: border-box; }
        html, body { height: 100%; margin: 0; background: #222; display: flex; justify-content: center; align-items: center; font-family: -apple-system, sans-serif; overflow: hidden; }
        .container { width: 100vw; max-width: 500px; height: 100vh; height: -webkit-fill-available; background: var(--bg); display: flex; flex-direction: column; position: relative; }
        
        /* é é¢åˆ‡æ› */
        .content-area { flex: 1; overflow-y: auto; padding: 15px; -webkit-overflow-scrolling: touch; }
        .content-view { display: none; }
        .active-view { display: block; }

        /* åŸæœ‰ v3.4 å¡ç‰‡èˆ‡æŒ‰éˆ•æ¨£å¼ */
        header { background: var(--primary); padding: 15px 20px 25px 20px; text-align: center; border-radius: 0 0 35px 35px; flex-shrink: 0; z-index: 10; position: relative; }
        header * { color: var(--white) !important; }
        .card { background: var(--white); border-radius: var(--radius); padding: 18px; margin-bottom: 15px; box-shadow: 0 4px 15px rgba(0,0,0,0.05); border: 1px solid #eef0ee; }
        .btn { border: none; padding: 16px; border-radius: 14px; cursor: pointer; font-weight: bold; width: 100%; font-size: 16px; margin-top: 10px; display: flex; align-items: center; justify-content: center; gap: 8px; }
        .btn-primary { background: var(--primary); color: white !important; }
        
        /* çµ±è¨ˆå°ˆç”¨æ¨£å¼ */
        .stats-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 10px; margin-top: 10px; }
        .stats-item { background: rgba(255,255,255,0.1); padding: 10px; border-radius: 10px; }
        .month-row { display: flex; justify-content: space-between; padding: 10px; border-bottom: 1px solid #eee; font-size: 14px; }
        .month-row:last-child { border: none; }
        
        /* å°è¦½åˆ— */
        nav { flex-shrink: 0; width: 100%; height: 80px; background: var(--white); display: flex; border-top: 1px solid #eee; padding-bottom: env(safe-area-inset-bottom); }
        .nav-item { flex: 1; display: flex; flex-direction: column; align-items: center; justify-content: center; font-size: 12px; cursor: pointer; color: #888; }
        .nav-item.active { color: var(--primary); font-weight: bold; }
        .nav-add-btn { background: var(--primary); color: white !important; width: 50px; height: 50px; border-radius: 50%; display: flex; align-items: center; justify-content: center; font-size: 28px; }
    </style>
</head>
<body>

<div class="container">
    <div id="login-screen" style="position: absolute; top: 0; left: 0; width: 100%; height: 100%; background: var(--primary-dark); z-index: 9999; display: flex; align-items: center; justify-content: center;">
        <div class="login-box" style="background: white; padding: 40px 30px; border-radius: 30px; width: 85%; text-align: center;">
            <h2 style="color: var(--primary);">æœæ¨¹ç®¡ç†ç³»çµ±</h2>
            <input type="text" id="login-pass" placeholder="äººå“¡å§“åæˆ–å¯†ç¢¼" style="width:100%; padding:12px; text-align:center; border-radius:12px; border:1px solid #ccc;">
            <button class="btn btn-primary" onclick="checkAuth()">ç™»å…¥ç³»çµ±</button>
        </div>
    </div>

    <header>
        <div style="font-size: 13px; opacity: 0.9;">ğŸ‘¤ <span id="user-role-display"></span> | <span id="display-today"></span></div>
        <div style="margin: 10px 0;">
            <select id="header-area-filter" onchange="renderAll()" style="width: auto; padding: 5px 15px; border-radius: 20px; background: rgba(255,255,255,0.2) !important; color: white !important; border: 1px solid white;">
                <option value="å…¨éƒ¨">å…¨å ´æ•¸æ“šåŠ ç¸½</option>
                <option value="Aå€">Aå€</option><option value="Bå€">Bå€</option><option value="Cå€">Cå€</option>
            </select>
        </div>
        <div style="display: flex; justify-content: space-around; gap: 5px;">
            <div>ä»Šæ—¥æ¡æ”¶<br><b id="today-qty" style="font-size:20px;">0</b></div>
            <div>ä»Šæ—¥é‡é‡<br><b id="today-weight" style="font-size:20px;">0.0</b></div>
            <div>ä»Šæ—¥æ”¶å…¥<br><b id="today-income" style="font-size:20px; color:#ffb703 !important;">0</b></div>
        </div>
    </header>

    <div class="content-area">
        <div id="view-home" class="content-view active-view">
            <input type="text" id="search" placeholder="ğŸ” æœå°‹ç·¨è™Ÿæˆ–åç¨±..." oninput="renderHome()" style="width:100%; padding:12px; border-radius:12px; border:1.5px solid #dcdcdc; margin-bottom:10px;">
            <div id="tree-list-container"></div>
        </div>

        <div id="view-stats" class="content-view">
            <div class="card" style="background: var(--primary-dark); color: white;">
                <h4 style="margin:0; color: var(--accent);">ğŸ“Š å¹´åº¦èˆ‡æœˆåº¦æ¦‚æ³</h4>
                <div id="annual-stats-box" class="stats-grid"></div>
            </div>
            
            <div class="card">
                <h4 style="margin:0 0 10px 0;">ğŸ“… å„æœˆä»½æ˜ç´°ç´€éŒ„</h4>
                <div id="monthly-breakdown-list"></div>
            </div>
        </div>

        <div id="view-edit" class="content-view">
            </div>

        <div id="view-tools" class="content-view admin-only">
            </div>
    </div>

    <nav>
        <div class="nav-item active" id="n-home" onclick="showView('home')"><span>ğŸ“‹</span><div>æ¸…å–®</div></div>
        <div class="nav-item" id="n-stats" onclick="showView('stats')"><span>ğŸ“ˆ</span><div>çµ±è¨ˆ</div></div>
        <div class="nav-item" onclick="prepareAdd()"><div class="nav-add-btn">ï¼‹</div></div>
        <div class="nav-item admin-only" id="n-tools" onclick="showView('tools')"><span>âš™ï¸</span><div>è¨­å®š</div></div>
    </nav>
</div>
<script>
    // åˆå§‹åŒ–èˆ‡ v3.4 ç›¸åŒ
    let db = JSON.parse(localStorage.getItem('farm_v31')) || [];
    let rankStore = JSON.parse(localStorage.getItem('rank_v31')) || {};
    let userList = JSON.parse(localStorage.getItem('user_list_v31')) || [];
    let currentUser = "";
    let isAdmin = false;
    const ADMIN_PASS = "admin123";
    const getToday = () => new Date().toISOString().split('T')[0];

    // æ ¸å¿ƒæ¸²æŸ“ï¼šåŒ…å«å€åŸŸç¯©é¸è¯å‹•
    function renderAll() {
        renderHome();
        renderStats();
    }

    // çµ±è¨ˆé é¢é‚è¼¯ï¼šå¹´åº¦/æœˆåº¦/æ˜ç´°
    function renderStats() {
        const area = document.getElementById('header-area-filter').value;
        const filtered = area === "å…¨éƒ¨" ? db : db.filter(t => t.area === area);
        const curYear = new Date().getFullYear().toString();
        const curMonth = getToday().slice(0, 7);

        // å¹´åº¦ç´¯è¨ˆ
        const yearData = filtered.filter(t => t.date.startsWith(curYear));
        const yQty = yearData.reduce((s, t) => s + (parseInt(t.harvestQty) || 0), 0);
        const yIncome = yearData.reduce((s, t) => s + (parseInt(t.income) || 0), 0);

        // æœˆåº¦ç´¯è¨ˆ (ç•¶æœˆ)
        const monthData = filtered.filter(t => t.date.startsWith(curMonth));
        const mQty = monthData.reduce((s, t) => s + (parseInt(t.harvestQty) || 0), 0);
        const mIncome = monthData.reduce((s, t) => s + (parseInt(t.income) || 0), 0);

        document.getElementById('annual-stats-box').innerHTML = `
            <div class="stats-item"><small>æœ¬æœˆç´¯è¨ˆ</small><br><b>${mQty}</b> ç²’<br><small>NT$ ${mIncome.toLocaleString()}</small></div>
            <div class="stats-item"><small>${curYear} å¹´åº¦</small><br><b>${yQty.toLocaleString()}</b> ç²’<br><small>NT$ ${yIncome.toLocaleString()}</small></div>
        `;

        // å„æœˆä»½æ˜ç´°æ¸…å–®
        const monthlyMap = {};
        filtered.forEach(t => {
            const m = t.date.slice(0, 7);
            if (!monthlyMap[m]) monthlyMap[m] = { qty: 0, income: 0 };
            monthlyMap[m].qty += (parseInt(t.harvestQty) || 0);
            monthlyMap[m].income += (parseInt(t.income) || 0);
        });

        const sortedMonths = Object.keys(monthlyMap).sort().reverse();
        document.getElementById('monthly-breakdown-list').innerHTML = sortedMonths.map(m => `
            <div class="month-row">
                <span><b>${m}</b></span>
                <span>${monthlyMap[m].qty} ç²’ / <span style="color:var(--money)">$${monthlyMap[m].income.toLocaleString()}</span></span>
            </div>
        `).join('') || '<div style="text-align:center; color:#888; padding:20px;">å°šç„¡ç´€éŒ„</div>';
    }

    // é¡¯ç¤ºè¦–åœ–åˆ‡æ› (åŒ…å« nav ç‹€æ…‹)
    function showView(vId) {
        document.querySelectorAll('.content-view').forEach(v => v.classList.remove('active-view'));
        document.getElementById('view-' + vId).classList.add('active-view');
        document.querySelectorAll('.nav-item').forEach(n => n.classList.remove('active'));
        const activeNav = document.getElementById('n-' + vId);
        if (activeNav) activeNav.classList.add('active');
        if (vId === 'home' || vId === 'stats') renderAll();
    }

    // --- ä»¥ä¸‹å®Œæ•´ä¿ç•™ v3.4 æ‰€æœ‰æ¬„ä½èˆ‡é‚è¼¯ (handleSave, editTree, exportExcel ç­‰) ---
    // [æ­¤è™•çœç•¥èˆ‡æ‚¨æä¾›çš„ v3.4 å®Œå…¨é‡è¤‡ä¹‹ handleSave, editTree, calcIncome, checkAuth å‡½æ•¸å…§å®¹ï¼Œ
    //  å»ºè­°æ‚¨ç›´æ¥å°‡ v3.4 å‰©ä¸‹çš„ <script> å€å¡Šåˆä½µé€²ä¾†å³å¯ã€‚]
</script>
</body>
</html>
