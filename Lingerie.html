<!DOCTYPE html>
<html lang="zh-Hant">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Lingerie Pro - æ™ºæ…§åº«å­˜ç®¡ç†</title>
    <script src="https://unpkg.com/html5-qrcode"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/qrious/4.0.2/qrious.min.js"></script>
    <style>
        :root { 
            --primary: #60a5fa; 
            --success: #66bb6a; 
            --accent: #d4a373; 
            --bg: #fdfaf5; 
            --card-bg: #ffffff; 
            --border: #e2e8f0; 
            --danger: #ef4444;
            --manual-in: #94a3b8; /* æ‰‹å‹•å…¥åº«é¡è‰² */
            --manual-out: #66bb6a; /* æ‰‹å‹•å‡ºè²¨é¡è‰² */
        }

        body { font-family: -apple-system, "Noto Sans TC", sans-serif; background: var(--bg); margin: 0; padding: 12px; color: #4a5568; }
        .container { max-width: 600px; margin: auto; }
        .card { background: var(--card-bg); border-radius: 16px; padding: 20px; margin-bottom: 20px; border: 1px solid var(--border); box-shadow: 0 4px 6px -1px rgba(0,0,0,0.05); }
        
        h3 { color: #555; border-left: 5px solid var(--accent); padding-left: 12px; margin: 0 0 20px 0; font-size: 1.1rem; }

        .field { display: flex; flex-direction: column; gap: 8px; margin-bottom: 15px; width: 100%; }
        .row-inputs { display: flex; gap: 10px; margin-bottom: 12px; flex-wrap: wrap; }
        
        input, select { flex: 1; min-width: 80px; padding: 12px; font-size: 16px; border: 1px solid var(--border); border-radius: 10px; background: #fff; height: 50px; }

        button { width: 100%; padding: 14px; font-size: 16px; border: none; border-radius: 10px; color: white; font-weight: bold; cursor: pointer; transition: 0.2s; }
        
        /* æŒ‰éˆ•é¡è‰² */
        .btn-auto-in { background-color: #60a5fa; }
        .btn-auto-out { background-color: #66bb6a; }
        .btn-manual-in { background-color: #9ca3af; } /* ç°ç¶ è‰² */
        .btn-manual-out { background-color: #52c41a; } /* æ˜äº®ç¶  */
        .btn-accent { background: var(--accent); }
        .btn-dark { background: #4a5568; }

        .scan-mode-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 12px; margin-bottom: 15px; }
        .manual-section { border-top: 2px dashed #eee; padding-top: 20px; margin-top: 10px; }

        #scanner-container { display: none; margin-bottom: 15px; background: #000; border-radius: 12px; overflow: hidden; position: relative; }
        #scan-feedback { position: absolute; top: 10px; left: 50%; transform: translateX(-50%); background: rgba(72, 187, 120, 0.9); color: white; padding: 5px 25px; border-radius: 20px; font-weight: bold; z-index: 10; display: none; }
        
        .tag { background: #f1f5f9; padding: 8px 12px; border-radius: 8px; font-size: 0.85rem; border: 1px solid #e2e8f0; display: flex; align-items: center; }
        .tag span { margin-left: 8px; color: var(--danger); font-weight: bold; cursor: pointer; }

        table { width: 100%; border-collapse: collapse; margin-top: 10px; }
        th { background: #f8fafc; padding: 12px 8px; text-align: left; font-size: 13px; color: #64748b; border-bottom: 2px solid #edf2f7; }
        td { padding: 12px 8px; border-bottom: 1px solid #f1f5f9; font-size: 14px; }

        @media print { .no-print { display: none !important; } }
    </style>
</head>
<body>

<div class="container no-print">
    <div class="card">
        <h3>1. åŸºç¤è¨­å®š</h3>
        <div class="field"><label>åº—é‹ªåç¨±</label><input type="text" id="compNameInp" onchange="updateCompName()"></div>
        <div class="row-inputs">
            <input type="text" id="vCodeInp" placeholder="å» å•†ä»£ç¢¼">
            <input type="text" id="vNameInp" placeholder="å» å•†åç¨±">
            <button onclick="addVendor()" class="btn-dark" style="flex:0.5">+ å» å•†</button>
        </div>
        <div id="vendorTags" style="display:flex; flex-wrap:wrap; gap:6px; margin-bottom: 10px;"></div>
        
        <div class="row-inputs">
            <input type="text" id="colorInp" placeholder="æ–°å¢é¡è‰² (å¦‚: é»‘è‰²)">
            <button class="btn-accent" style="flex:0.5" onclick="addColor()">+ é¡è‰²</button>
        </div>
        <div id="colorTags" style="display:flex; flex-wrap:wrap; gap:6px; margin-bottom: 10px;"></div>

        <div class="field">
            <select id="setVendorRel"></select>
            <input type="text" id="setBraId" placeholder="è¼¸å…¥å‹è™Ÿ/è²¨è™Ÿ">
            <button class="btn-accent" onclick="addModel()">å„²å­˜æ­¤æ¬¾å¼</button>
        </div>
    </div>

    <div class="card">
        <h3>2. é€²å‡ºè²¨æ“ä½œ</h3>
        
        <div class="scan-mode-grid">
            <button class="btn-auto-in" onclick="startScan('IN_AUTO')">ğŸ“¥ é€£çºŒå…¥åº« 1</button>
            <button class="btn-auto-in" style="background:#4299e1" onclick="triggerManual(1)">ğŸ“¥ å…¥åº«(å¡«é‡)</button>
            <button class="btn-auto-out" onclick="startScan('OUT_AUTO')">ğŸ“¤ é€£çºŒå‡ºåº« 1</button>
            <button class="btn-auto-out" style="background:#48bb78" onclick="triggerManual(-1)">ğŸ“¤ å‡ºè²¨(å¡«é‡)</button>
        </div>

        <div id="scanner-container">
            <div id="scan-feedback">æƒææˆåŠŸ</div>
            <div id="reader"></div>
            <button style="background:var(--danger)" onclick="stopScan()">âŒ é—œé–‰ç›¸æ©Ÿ</button>
        </div>

        <div class="field">
            <label>å» å•†å“ç‰Œèˆ‡æ¬¾å¼</label>
            <select id="selectVendor" onchange="updateModelSelect()"></select>
            <select id="selectModel" style="margin-top:5px;"></select>
        </div>

        <div class="row-inputs">
            <select id="selectColor"></select>
            <select id="braBand"><option value="-">ä¸‹åœ</option><script>for(let i=30; i<=52; i+=2) document.write(`<option value="${i}">${i}</option>`);</script></select>
            <select id="braCup"><option value="-">ç½©æ¯</option><script>["AA","A","B","C","D","E","F","G","H","I","J","K"].forEach(c => document.write(`<option value="${c}">${c}</option>`));</script></select>
            <select id="braSize"><option value="-">å°ºç¢¼</option><script>["SS","S","M","L","XL","XXL","3XL","4XL","Free"].forEach(s => document.write(`<option value="${s}">${s}</option>`));</script></select>
        </div>

        <div class="manual-section">
            <button class="btn-manual-in" style="margin-bottom:12px;" onclick="quickManualAction(1)">ğŸ“¥ æ‰‹å‹•å…¥åº« (ä¾ä¸Šæ–¹é¸å–è¦æ ¼)</button>
            <button class="btn-manual-out" onclick="quickManualAction(-1)">ğŸ“¤ æ‰‹å‹•å‡ºè²¨ (ä¾ä¸Šæ–¹é¸å–è¦æ ¼)</button>
        </div>

        <div class="row-inputs" style="margin-top:20px;">
            <button class="btn-accent" onclick="generateTag()">ğŸ–¨ï¸ ç”¢ç”Ÿ QR æ¨™ç±¤</button>
            <button class="btn-dark" onclick="generateInvoice()">ğŸ“„ åŠ å…¥å‡ºè²¨å–®</button>
        </div>
    </div>

    <div class="card">
        <h3>3. åº«å­˜æ¸…å–®</h3>
        <div style="overflow-x:auto;">
            <table>
                <thead><tr><th>å‹è™Ÿ</th><th>ç´°ç¯€</th><th>æ•¸é‡</th><th>ç®¡ç†</th></tr></thead>
                <tbody id="stockTableBody"></tbody>
            </table>
        </div>
    </div>
</div>

<script>
    let compName = localStorage.getItem('L_C_N') || "æˆ‘çš„åº—é‹ª";
    let vendors = JSON.parse(localStorage.getItem('L_V_D')) || [];
    let models = JSON.parse(localStorage.getItem('L_M_D')) || [];
    let inventory = JSON.parse(localStorage.getItem('L_I_D')) || [];
    let colors = JSON.parse(localStorage.getItem('L_C_D')) || ["é»‘è‰²", "è†šè‰²", "ç´…è‰²"];
    let html5QrCode = null;

    function save() {
        localStorage.setItem('L_C_N', compName);
        localStorage.setItem('L_V_D', JSON.stringify(vendors));
        localStorage.setItem('L_M_D', JSON.stringify(models));
        localStorage.setItem('L_I_D', JSON.stringify(inventory));
        localStorage.setItem('L_C_D', JSON.stringify(colors));
        render();
    }

    // æ ¸å¿ƒåŠŸèƒ½ï¼šæ›´æ–°åº«å­˜
    function updateStock(vCode, braId, c, bb, bc, bz, qty) {
        let item = inventory.find(i => i.vCode===vCode && i.braId===braId && i.c===c && i.bb===bb && i.bc===bc && i.bz===bz);
        if(item) {
            item.bq += qty;
            if(item.bq < 0) item.bq = 0;
        } else {
            if(qty > 0) inventory.push({vCode, braId, c, bb, bc, bz, bq: qty});
        }
        save();
    }

    // è™•ç†æ‰‹å‹•æŒ‰éˆ•å‹•ä½œ
    function quickManualAction(direction) {
        const modelVal = document.getElementById('selectModel').value;
        if(!modelVal || modelVal.includes("ç„¡")) {
            alert("è«‹å…ˆé¸æ“‡æ­£ç¢ºçš„æ¬¾å¼ï¼");
            return;
        }
        const m = JSON.parse(modelVal);
        const qty = parseInt(prompt(`è«‹è¼¸å…¥è¦${direction > 0 ? 'å…¥åº«' : 'å‡ºè²¨'}çš„æ•¸é‡:`, "1"));
        
        if(isNaN(qty) || qty <= 0) return;

        const c = document.getElementById('selectColor').value;
        const bb = document.getElementById('braBand').value;
        const bc = document.getElementById('braCup').value;
        const bz = document.getElementById('braSize').value;

        updateStock(m.vCode, m.braId, c, bb, bc, bz, qty * direction);
        alert(`å·²æˆåŠŸ${direction > 0 ? 'æ‰‹å‹•å…¥åº«' : 'æ‰‹å‹•å‡ºè²¨'} ${qty} ä»¶`);
    }

    // æƒæå™¨
    async function startScan(mode) {
        document.getElementById('scanner-container').style.display = 'block';
        html5QrCode = new Html5Qrcode("reader");
        await html5QrCode.start({ facingMode: "environment" }, { fps: 10, qrbox: 250 }, (txt) => {
            const p = txt.split(',');
            if(p.length < 4) return;
            updateStock(p[0], p[1], p[3], p[4], p[5], p[6]||'-', mode.includes('IN')?1:-1);
            document.getElementById('scan-feedback').style.display = 'block';
            setTimeout(() => document.getElementById('scan-feedback').style.display='none', 800);
        });
    }

    function stopScan() { if(html5QrCode) html5QrCode.stop().then(() => { document.getElementById('scanner-container').style.display = 'none'; }); }

    function render() {
        document.getElementById('compNameInp').value = compName;
        document.getElementById('vendorTags').innerHTML = vendors.map((v,idx) => `<div class="tag">${v.code} <span onclick="vendors.splice(${idx},1);save()">Ã—</span></div>`).join('');
        document.getElementById('colorTags').innerHTML = colors.map((c,idx) => `<div class="tag">${c} <span onclick="colors.splice(${idx},1);save()">Ã—</span></div>`).join('');
        
        const vOps = vendors.map(v => `<option value="${v.code}">${v.code}-${v.name}</option>`).join('');
        document.getElementById('setVendorRel').innerHTML = vOps;
        document.getElementById('selectVendor').innerHTML = vOps;
        document.getElementById('selectColor').innerHTML = colors.map(c => `<option value="${c}">${c}</option>`).join('');
        
        updateModelSelect();

        document.getElementById('stockTableBody').innerHTML = inventory.slice().reverse().map((i,idx) => `
            <tr>
                <td><b>${i.braId}</b></td>
                <td>${i.c} ${i.bb}${i.bc} ${i.bz==='-'?'':i.bz}</td>
                <td style="color:var(--primary); font-weight:bold;">${i.bq}</td>
                <td><button onclick="deleteItem(${inventory.length-1-idx})" style="background:var(--danger); padding:4px 8px; width:auto;">åˆª</button></td>
            </tr>
        `).join('');
    }

    function updateModelSelect() {
        const vCode = document.getElementById('selectVendor').value;
        const filtered = models.filter(m => m.vCode === vCode);
        document.getElementById('selectModel').innerHTML = filtered.length ? 
            filtered.map(m => `<option value='${JSON.stringify(m)}'>${m.braId}</option>`).join('') : 
            '<option>æ­¤å» å•†ç„¡æ¬¾å¼</option>';
    }

    function addVendor() {
        const c = document.getElementById('vCodeInp').value.toUpperCase();
        const n = document.getElementById('vNameInp').value;
        if(c && n) { vendors.push({code:c, name:n}); save(); }
    }

    function addColor() {
        const c = document.getElementById('colorInp').value;
        if(c) { colors.push(c); save(); }
    }

    function addModel() {
        const v = document.getElementById('setVendorRel').value;
        const b = document.getElementById('setBraId').value;
        if(v && b) { models.push({vCode:v, braId:b}); save(); }
    }

    function deleteItem(idx) { if(confirm("ç¢ºå®šåˆªé™¤æ­¤é …åº«å­˜ç´€éŒ„ï¼Ÿ")) { inventory.splice(idx,1); save(); } }
    function updateCompName() { compName = document.getElementById('compNameInp').value; save(); }

    render();
</script>
</body>
</html>
