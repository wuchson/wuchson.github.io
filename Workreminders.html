<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>å·¥ä½œæé†’</title>
    <style>
        :root {
            --bg: #ffffff; --text: #1a1a1a; --accent: #000000; --border: #e5e5e5; --secondary: #888888;
        }
        [data-theme="dark"] {
            --bg: #121212; --text: #ffffff; --accent: #ffffff; --border: #2a2a2a; --secondary: #a0a0a0;
        }
        body {
            font-family: "PingFang TC", "Noto Sans TC", sans-serif;
            background-color: var(--bg); color: var(--text);
            margin: 0; display: flex; justify-content: center; min-height: 100vh; transition: 0.4s;
        }
        .wrapper { width: 100%; max-width: 480px; padding: 60px 24px; }
        header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 30px; }
        h1 { font-size: 24px; font-weight: 600; letter-spacing: 2px; margin: 0; }
        .today-info { font-size: 13px; color: var(--secondary); margin-top: 5px; }

        /* æœå°‹èˆ‡ç¯©é¸å€ */
        .filter-section { margin-bottom: 30px; }
        #searchInput {
            width: 100%; border: none; background: rgba(0,0,0,0.03);
            padding: 12px 15px; border-radius: 10px; font-size: 14px;
            color: var(--text); outline: none; box-sizing: border-box;
        }
        [data-theme="dark"] #searchInput { background: rgba(255,255,255,0.05); }
        .filter-tabs { display: flex; gap: 10px; margin-top: 12px; }
        .tab { 
            font-size: 11px; padding: 4px 12px; border: 1px solid var(--border); 
            border-radius: 15px; cursor: pointer; color: var(--secondary); transition: 0.2s;
        }
        .tab.active { background: var(--accent); color: var(--bg); border-color: var(--accent); }

        /* é€²åº¦æ¢ */
        .progress-section { margin-bottom: 40px; }
        .progress-label { display: flex; justify-content: space-between; font-size: 11px; margin-bottom: 10px; color: var(--secondary); }
        .progress-track { height: 1.5px; background: var(--border); position: relative; }
        #progress-fill { height: 1.5px; background: var(--accent); width: 0%; transition: 0.7s ease; position: absolute; top: 0; left: 0; }

        /* è¼¸å…¥å€ */
        .input-area { margin-bottom: 40px; border: 1px solid var(--border); padding: 20px; border-radius: 12px; }
        input[type="text"]#taskName {
            width: 100%; border: none; border-bottom: 1px solid var(--border);
            padding: 10px 0; font-size: 16px; outline: none; background: transparent; color: var(--text); margin-bottom: 15px;
        }
        .options-row { display: flex; gap: 10px; }
        select, input[type="datetime-local"] {
            flex: 1; border: 1px solid var(--border); background: transparent; padding: 8px; font-size: 12px; color: var(--secondary); border-radius: 6px;
        }
        #add-btn {
            margin-top: 20px; width: 100%; padding: 12px; background: var(--accent);
            color: var(--bg); border: none; font-size: 13px; letter-spacing: 4px; cursor: pointer; border-radius: 6px;
        }

        /* åˆ—è¡¨ */
        ul { list-style: none; padding: 0; }
        li { padding: 18px 0; border-bottom: 1px solid var(--border); display: flex; justify-content: space-between; align-items: center; }
        .task-info { flex-grow: 1; cursor: pointer; }
        .task-title { font-size: 16px; margin-bottom: 6px; font-weight: 500; }
        .task-meta { font-size: 11px; color: var(--secondary); }
        .dot { display: inline-block; width: 6px; height: 6px; border-radius: 50%; margin-right: 12px; }
        .high { background: #ff4d4f; } .mid { background: #faad14; } .low { background: #52c41a; }
        .completed { opacity: 0.35; filter: grayscale(1); }
        .completed .task-title { text-decoration: line-through; }
        .del-link { background: none; border: none; color: #ccc; cursor: pointer; font-size: 18px; }
    </style>
</head>
<body data-theme="light">

<div class="wrapper">
    <header>
        <div>
            <h1>ä»»å‹™æ¸…å–®</h1>
            <div class="today-info" id="current-date">è¼‰å…¥ä¸­...</div>
        </div>
        <button class="nav-btn" onclick="toggleTheme()" style="background:none; border:none; cursor:pointer; color:var(--secondary); font-size:11px;">åˆ‡æ›æ¨¡å¼</button>
    </header>

    <div class="filter-section">
        <input type="text" id="searchInput" placeholder="æœå°‹é—œéµå­—..." oninput="render()">
        <div class="filter-tabs">
            <div class="tab active" onclick="setFilter('all', this)">å…¨éƒ¨ä»»å‹™</div>
            <div class="tab" onclick="setFilter('today', this)">ä»Šå¤©</div>
            <div class="tab" onclick="setFilter('week', this)">æœ¬é€±</div>
        </div>
    </div>

    <div class="progress-section">
        <div class="progress-label"><span>å®Œæˆç‡</span><span id="stat-text">0%</span></div>
        <div class="progress-track"><div id="progress-fill"></div></div>
    </div>

    <div class="input-area">
        <input type="text" id="taskName" placeholder="è¼¸å…¥æ–°ä»»å‹™...">
        <div class="options-row">
            <select id="taskPrio">
                <option value="3">ç·Šæ€¥</option><option value="2" selected>æ™®é€š</option><option value="1">ç¨å¾Œ</option>
            </select>
            <input type="datetime-local" id="taskTime">
        </div>
        <button id="add-btn">æ–°å¢ä»»å‹™</button>
    </div>

    <ul id="taskList"></ul>

    <div style="margin-top: 30px; display: flex; gap: 15px;">
        <button class="nav-btn" onclick="exportCSV()" style="background:none; border:none; color:var(--secondary); font-size:11px; cursor:pointer;">ğŸ“¥ åŒ¯å‡º EXCEL</button>
        <button class="nav-btn" onclick="document.getElementById('csv-file').click()" style="background:none; border:none; color:var(--secondary); font-size:11px; cursor:pointer;">ğŸ“¤ åŒ¯å…¥ EXCEL</button>
        <input type="file" id="csv-file" style="display:none" accept=".csv" onchange="importCSV(event)">
    </div>
</div>

<script>
    let tasks = JSON.parse(localStorage.getItem('minimalTasksSearchV2')) || [];
    let currentFilter = 'all';
    const dayNames = ["é€±æ—¥", "é€±ä¸€", "é€±äºŒ", "é€±ä¸‰", "é€±å››", "é€±äº”", "é€±å…­"];

    function showToday() {
        const now = new Date();
        document.getElementById('current-date').innerText = `${now.getFullYear()}å¹´${now.getMonth()+1}æœˆ${now.getDate()}æ—¥ Â· ${dayNames[now.getDay()]}`;
    }

    function toggleTheme() {
        const body = document.body;
        body.setAttribute('data-theme', body.getAttribute('data-theme') === 'dark' ? 'light' : 'dark');
    }

    function setFilter(filter, el) {
        currentFilter = filter;
        document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
        el.classList.add('active');
        render();
    }

    function isThisWeek(date) {
        const now = new Date();
        const startOfWeek = new Date(now.setDate(now.getDate() - now.getDay()));
        const endOfWeek = new Date(now.setDate(now.getDate() - now.getDay() + 6));
        const target = new Date(date);
        return target >= startOfWeek && target <= endOfWeek;
    }

    function render() {
        const list = document.getElementById('taskList');
        const query = document.getElementById('searchInput').value.toLowerCase();
        list.innerHTML = '';

        const now = new Date().toISOString().split('T')[0];

        const filtered = tasks.filter(t => {
            const matchesText = t.text.toLowerCase().includes(query);
            const taskDate = t.time ? t.time.split('T')[0] : '';
            
            let matchesDate = true;
            if (currentFilter === 'today') matchesDate = (taskDate === now);
            if (currentFilter === 'week') matchesDate = t.time && isThisWeek(t.time);

            return matchesText && matchesDate;
        });

        const done = tasks.filter(t => t.completed).length;
        document.getElementById('progress-fill').style.width = (tasks.length ? (done/tasks.length)*100 : 0) + '%';
        document.getElementById('stat-text').innerText = `${tasks.length ? Math.round((done/tasks.length)*100) : 0}% (${done}/${tasks.length})`;

        filtered.forEach(t => {
            const li = document.createElement('li');
            if (t.completed) li.classList.add('completed');
            const d = t.time ? new Date(t.time) : null;
            const timeInfo = d ? `${d.getFullYear()}/${d.getMonth()+1}/${d.getDate()} (${dayNames[d.getDay()]}) ${d.getHours().toString().padStart(2,'0')}:${d.getMinutes().toString().padStart(2,'0')}` : 'å°šæœªè¨­å®šæ™‚é–“';

            li.innerHTML = `
                <div class="task-info" onclick="toggleTask(${t.id})">
                    <div class="task-title"><span class="dot ${t.priority==3?'high':t.priority==2?'mid':'low'}"></span>${t.text}</div>
                    <div class="task-meta">${timeInfo}</div>
                </div>
                <button class="del-link" onclick="delTask(${t.id})">Ã—</button>
            `;
            list.appendChild(li);
        });
    }

    document.getElementById('add-btn').addEventListener('click', () => {
        const text = document.getElementById('taskName').value.trim();
        if(!text) return;
        tasks.push({ id: Date.now(), text, priority: document.getElementById('taskPrio').value, time: document.getElementById('taskTime').value, completed: false });
        document.getElementById('taskName').value = '';
        save();
    });

    function save() {
        tasks.sort((a, b) => b.priority - a.priority);
        localStorage.setItem('minimalTasksSearchV2', JSON.stringify(tasks));
        render();
    }

    window.toggleTask = (id) => { tasks = tasks.map(t => t.id === id ? {...t, completed: !t.completed} : t); save(); };
    window.delTask = (id) => { if(confirm('ç¢ºå®šç§»é™¤ï¼Ÿ')) { tasks = tasks.filter(t => t.id !== id); save(); } };

    function exportCSV() {
        const date = new Date().toISOString().split('T')[0];
        let csv = "\ufeffä»»å‹™åç¨±,å„ªå…ˆåº¦,æ™‚é–“,ç‹€æ…‹\n";
        tasks.forEach(t => csv += `"${t.text}",${t.priority},"${t.time}",${t.completed ? "å·²å®Œæˆ" : "åŸ·è¡Œä¸­"}\n`);
        const blob = new Blob([csv], {type: 'text/csv;charset=utf-8;'});
        const link = document.createElement('a');
        link.href = URL.createObjectURL(blob);
        link.download = `å¾…è¾¦äº‹é …_${date}.csv`;
        link.click();
    }

    function importCSV(e) {
        const reader = new FileReader();
        reader.onload = (f) => {
            const lines = f.target.result.split('\n').slice(1);
            const imported = lines.filter(l => l.trim()).map(line => {
                const p = line.match(/(".*?"|[^",\s]+)(?=\s*,|\s*$)/g);
                return { id: Date.now()+Math.random(), text: p[0].replace(/"/g,''), priority: p[1], time: p[2].replace(/"/g,''), completed: p[3].includes('å·²å®Œæˆ') };
            });
            tasks = [...tasks, ...imported];
            save();
        };
        reader.readAsText(e.target.files[0]);
    }

    showToday();
    render();
</script>
</body>
</html>
