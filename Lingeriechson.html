<!DOCTYPE html>
<html lang="zh-Hant">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Lingerie Pro - 智慧庫存管理系統 (雲端同步版)</title>
    <script src="https://unpkg.com/html5-qrcode"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/qrious/4.0.2/qrious.min.js"></script>
    <style>
        :root {
            --primary: #8da399; --accent: #d4a373; --bg: #f9f7f2; --card-bg: #ffffff; --border: #e0dcd0; --danger: #e53e3e; --success: #48bb78;
            --a4-mt: 15.5mm; --a4-ml: 6.5mm; --a4-gx: 2.5mm; --a4-gy: 0mm; --s-mt: 0mm; --s-ml: 0mm;
        }
        body { font-family: -apple-system, "Noto Sans TC", sans-serif; background: var(--bg); margin: 0; padding: 10px; color: #444; }
        .container { max-width: 600px; margin: auto; padding-bottom: 80px; }
        .card { background: var(--card-bg); border-radius: 12px; padding: 15px; margin-bottom: 15px; box-shadow: 0 2px 8px rgba(0,0,0,0.03); border: 1px solid var(--border); }
        .nav-tabs { display: flex; overflow-x: auto; gap: 8px; margin-bottom: 15px; padding-bottom: 5px; scrollbar-width: none; }
        .nav-tabs::-webkit-scrollbar { display: none; }
        .tab { padding: 8px 16px; background: #e0dcd0; border-radius: 20px; white-space: nowrap; font-size: 14px; cursor: pointer; transition: 0.3s; }
        .tab.active { background: var(--primary); color: white; }
        input, select { width: 100%; padding: 12px; margin: 8px 0; border: 1px solid var(--border); border-radius: 8px; font-size: 16px; outline: none; }
        .btn { width: 100%; padding: 12px; border: none; border-radius: 8px; font-size: 16px; font-weight: bold; cursor: pointer; transition: 0.2s; }
        .btn-primary { background: var(--primary); color: white; }
        #login-overlay { position: fixed; top:0; left:0; width:100%; height:100%; background: var(--bg); z-index: 9999; display: flex; flex-direction: column; align-items: center; justify-content: center; }
        /* 標籤列印相關樣式 */
        @media print {
            body { background: white; padding: 0; }
            .container, .no-print { display: none !important; }
            #print-area { display: block !important; }
        }
    </style>
    <script>
        // --- 雲端 API 設定 ---
        const GAS_URL = "https://script.google.com/macros/s/AKfycbx1IBTg28rNwdoZbAkKV48eDEc7ZQ5ZVMQWXrhEvxWg5WwLkZk0qqSpNJch5wESMrAqKg/exec";
        
        // --- 全域變數 (繼承自 0129-3) ---
        let currentUser = JSON.parse(sessionStorage.getItem('L_USER')) || null;
        let vendors = [], models = [], inventory = [], colors = [], salesHistory = [];
        let compName = "智慧庫存管理系統", taxRate = 5;
        let pCfg = { a4mt:15.5, a4ml:6.5, a4gx:2.5, a4gy:0, smt:0, sml:0 };
        let html5QrCode = null;

        // --- 雲端資料抓取 ---
        async function loadCloudData() {
            try {
                const response = await fetch(`${GAS_URL}?action=loadAll`);
                const data = await response.json();
                
                // 同步雲端分頁資料
                vendors = data.vendors || [];
                models = data.models || [];
                colors = data.colors || [];
                salesHistory = data.sales || [];
                
                // 處理庫存邏輯：將流水帳彙整為目前剩餘量
                processStock(data.inventory || []);
                
                if(data.config && data.config.length > 0) {
                    compName = data.config[0].compName || compName;
                    taxRate = data.config[0].taxRate || 5;
                }
                
                render(); // 此函式將在後續部分定義
                updateUI();
            } catch (err) {
                console.error("雲端同步失敗:", err);
            }
        }

        function processStock(logs) {
            const map = {};
            logs.forEach(log => {
                const key = `${log.vCode}|${log.braId}|${log.c}|${log.bb}|${log.bc}|${log.bz}`;
                if (!map[key]) map[key] = { ...log, bq: 0 };
                const q = parseInt(log.qty) || 0;
                map[key].bq += (log.type === 'OUT' ? -q : q);
            });
            inventory = Object.values(map);
        }

        function checkAuth() {
            if(!currentUser) {
                document.getElementById('login-overlay').style.display = 'flex';
            } else {
                document.getElementById('login-overlay').style.display = 'none';
                loadCloudData();
            }
        }

        function login() {
            const u = document.getElementById('u').value;
            const p = document.getElementById('p').value;
            if(u === 'admin' && p === '1234') { // 預設密碼，可於 GAS USERS 表擴充
                currentUser = { u: u };
                sessionStorage.setItem('L_USER', JSON.stringify(currentUser));
                checkAuth();
            } else { alert("帳號密碼錯誤"); }
        }
    </script>
</head>
<body onload="checkAuth()">
<div id="login-overlay">
    <div class="card" style="width: 85%; max-width: 350px; text-align: center;">
        <h2 style="color:var(--primary); margin-bottom: 20px;">Lingerie Pro Cloud</h2>
        <input type="text" id="u" placeholder="管理員帳號">
        <input type="password" id="p" placeholder="管理員密碼">
        <button class="btn btn-primary" onclick="login()">登入系統</button>
        <p style="font-size: 12px; color: #999; margin-top: 15px;">※ 雲端同步模式已啟動</p>
    </div>
</div>

<div class="container" id="app-main" style="display:none;">
    <header style="display:flex; justify-content:space-between; align-items:center; margin-bottom: 10px;">
        <h2 id="display-comp-name" style="margin:0; font-size: 1.2em;">載入中...</h2>
        <span id="display-user" style="font-size:12px; background:#e0dcd0; padding:2px 10px; border-radius:15px;"></span>
    </header>

    <nav class="nav-tabs" id="main-nav">
        <div class="tab active" onclick="switchTab('stock', this)">庫存查詢</div>
        <div class="tab" onclick="switchTab('in', this)">入庫/標籤</div>
        <div class="tab" onclick="switchTab('out', this)">出貨結帳</div>
        <div class="tab" onclick="switchTab('history', this)">銷售紀錄</div>
        <div class="tab" onclick="switchTab('settings', this)">系統設定</div>
    </nav>

    <div id="tab-stock" class="tab-section">
        <div class="card">
            <input type="text" id="stockSearch" placeholder="搜尋型號、廠商或細節..." oninput="renderStockList()">
            <div id="stock-list-container">
                <p style="text-align:center; padding:20px; color:#999;">正在連線雲端資料庫...</p>
            </div>
        </div>
    </div>

    <div id="tab-in" class="tab-section" style="display:none;"></div>
    <div id="tab-out" class="tab-section" style="display:none;"></div>
    <div id="tab-history" class="tab-section" style="display:none;"></div>
    <div id="tab-settings" class="tab-section" style="display:none;"></div>
</div>

<script>
    // --- UI 渲染與連動邏輯 ---
    
    function updateUI() {
        document.getElementById('app-main').style.display = 'block';
        document.getElementById('display-comp-name').innerText = compName;
        document.getElementById('display-user').innerText = `管理員: ${currentUser.u}`;
        renderStockList();
    }

    function switchTab(tabId, el) {
        // 隱藏所有分頁
        document.querySelectorAll('.tab-section').forEach(s => s.style.display = 'none');
        // 取消所有標籤 active
        document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
        
        // 顯示目標分頁
        document.getElementById('tab-' + tabId).style.display = 'block';
        el.classList.add('active');

        // 觸發分頁初始化
        if(tabId === 'stock') renderStockList();
        if(tabId === 'in') initInboundPage();
        if(tabId === 'out') initOutboundPage();
        if(tabId === 'history') renderHistoryPage();
        if(tabId === 'settings') initSettingsPage();
    }

    function renderStockList() {
        const search = document.getElementById('stockSearch').value.toLowerCase();
        const container = document.getElementById('stock-list-container');
        let html = '';

        // 過濾並顯示庫存列表 (繼承 0129-3 的顯示風格)
        const filtered = inventory.filter(i => 
            (i.vCode + i.braId + (i.c||'')).toLowerCase().includes(search)
        );

        if (filtered.length === 0) {
            container.innerHTML = '<p style="text-align:center; padding:20px;">無匹配資料</p>';
            return;
        }

        filtered.forEach(item => {
            html += `
                <div class="stock-item" style="display: grid; grid-template-columns: 2fr 1fr auto; align-items: center; padding: 12px 0; border-bottom: 1px solid #eee;">
                    <div>
                        <b style="font-size:1.1em;">${item.braId}</b><br>
                        <small style="color:#666;">${item.vCode} | ${item.c || '無顏色'} | ${item.bz || 'F'}</small>
                    </div>
                    <div style="text-align:center; font-weight:bold; color:${item.bq <= 0 ? 'var(--danger)' : 'var(--primary)'};">
                        ${item.bq}
                    </div>
                    <button class="btn" style="width:auto; padding:5px 12px; font-size:12px; background:#f0f0f0;" 
                        onclick="printQuickLabel('${item.vCode}','${item.braId}','${item.c}','${item.bz}')">標籤</button>
                </div>
            `;
        });
        container.innerHTML = html;
    }
</script>
<script>
    // --- 1. 初始化入庫頁面 UI (完整保留 0129-3 下拉選單結構) ---
    function initInboundPage() {
        const h = `
            <div class="card">
                <h3>掃描 / 手動入庫</h3>
                <div id="reader" style="width: 100%; background: #000; border-radius: 8px; overflow: hidden;"></div>
                <div style="display: flex; gap: 5px; margin-top: 10px;">
                    <button class="btn btn-primary" onclick="startScanner()">開啟相機</button>
                    <button class="btn btn-danger" onclick="stopScanner()">關閉相機</button>
                </div>
                <hr>
                <div id="inbound-fields">
                    <select id="in-vCode" onchange="updateInModel()"><option value="">選擇廠商</option></select>
                    <select id="in-braId"><option value="">選擇型號</option></select>
                    <select id="in-color"><option value="">選擇顏色</option></select>
                    <div style="display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 5px;">
                        <select id="in-bb"><option value="-">下圍</option></select>
                        <select id="in-bc"><option value="-">罩杯</option></select>
                        <select id="in-bz"><option value="-">尺寸</option></select>
                    </div>
                    <input type="number" id="in-qty" placeholder="入庫數量" value="1">
                    <button id="in-submit-btn" class="btn btn-primary" onclick="submitToCloud('IN')">確認入庫並同步雲端</button>
                </div>
            </div>
            <div class="card" id="label-preview-card" style="display:none;">
                <h3>標籤預覽</h3>
                <div id="label-result" style="text-align:center; padding:10px; border:1px solid #eee;"></div>
                <button class="btn btn-accent" style="margin-top:10px;" onclick="printInboundLabel()">列印此標籤</button>
            </div>
        `;
        document.getElementById('tab-in').innerHTML = h;
        populateInboundOptions();
    }

    // --- 2. 下拉選單填充邏輯 ---
    function populateInboundOptions() {
        const vS = document.getElementById('in-vCode');
        const cS = document.getElementById('in-color');
        const bbS = document.getElementById('in-bb');
        const bcS = document.getElementById('in-bc');
        const bzS = document.getElementById('in-bz');

        vendors.forEach(v => vS.add(new Option(v.vName || v.vCode, v.vCode)));
        colors.forEach(c => cS.add(new Option(c.cName, c.cCode)));
        
        // 填充 0129-3 定義的尺寸範圍
        ['65','70','75','80','85','90','95','100'].forEach(v => bbS.add(new Option(v, v)));
        ['A','B','C','D','E','F','G','H'].forEach(v => bcS.add(new Option(v, v)));
        ['S','M','L','XL','XXL','XXXL','Free'].forEach(v => bzS.add(new Option(v, v)));
    }

    function updateInModel() {
        const v = document.getElementById('in-vCode').value;
        const mS = document.getElementById('in-braId');
        mS.innerHTML = '<option value="">選擇型號</option>';
        models.filter(m => m.vCode === v).forEach(m => mS.add(new Option(m.braId, m.braId)));
    }

    // --- 3. 相機控制邏輯 ---
    function startScanner() {
        html5QrCode = new Html5Qrcode("reader");
        html5QrCode.start({ facingMode: "environment" }, { fps: 10, qrbox: 250 }, (txt) => {
            stopScanner();
            playBeep();
            const p = txt.split(',');
            if(p.length >= 2) {
                document.getElementById('in-vCode').value = p[0];
                updateInModel();
                document.getElementById('in-braId').value = p[1];
                if(p[3]) document.getElementById('in-color').value = p[3];
                if(p[4]) document.getElementById('in-bb').value = p[4];
                if(p[5]) document.getElementById('in-bc').value = p[5];
                if(p[6]) document.getElementById('in-bz').value = p[6];
                alert("掃描讀取成功！");
            }
        });
    }

    function stopScanner() {
        if(html5QrCode) { html5QrCode.stop().then(() => { html5QrCode = null; }); }
    }

    // --- 4. 核心：提交到 Google 試算表 (POST) ---
    async function submitToCloud(type) {
        const btn = document.getElementById('in-submit-btn');
        const payload = {
            action: "processTransaction",
            type: type,
            vCode: document.getElementById('in-vCode').value,
            braId: document.getElementById('in-braId').value,
            c: document.getElementById('in-color').value,
            bb: document.getElementById('in-bb').value,
            bc: document.getElementById('in-bc').value,
            bz: document.getElementById('in-bz').value,
            qty: document.getElementById('in-qty').value
        };

        if(!payload.vCode || !payload.braId) return alert("請完整填寫型號資訊");

        btn.disabled = true;
        btn.innerText = "雲端同步中...";

        try {
            await fetch(GAS_URL, {
                method: 'POST',
                mode: 'no-cors',
                body: JSON.stringify(payload)
            });
            alert("雲端同步指令已發送！");
            loadCloudData(); // 重新整理庫存
        } catch (err) {
            alert("同步失敗：" + err.message);
        } finally {
            btn.disabled = false;
            btn.innerText = "確認入庫並同步雲端";
        }
    }

    function playBeep() {
        const a = new (window.AudioContext || window.webkitAudioContext)();
        const o = a.createOscillator();
        o.connect(a.destination);
        o.start(); o.stop(a.currentTime + 0.1);
    }
</script>
<script>
    // --- 1. 出貨結帳頁面 (自動扣除雲端庫存) ---
    function initOutboundPage() {
        document.getElementById('tab-out').innerHTML = `
            <div class="card">
                <h3>出貨結帳 (雲端同步)</h3>
                <input type="text" id="out-v" placeholder="廠商代碼">
                <input type="text" id="out-m" placeholder="型號">
                <input type="number" id="out-q" placeholder="出貨數量" value="1">
                <button class="btn btn-primary" style="background:var(--danger);" onclick="processOutbound()">執行出貨扣庫存</button>
            </div>
            <div class="card">
                <p style="font-size:13px; color:#666;">※ 出貨後將自動於 Google 試算表 STOCK 分頁增加一筆 OUT 紀錄。</p>
            </div>
        `;
    }

    async function processOutbound() {
        const v = document.getElementById('out-v').value;
        const m = document.getElementById('out-m').value;
        const q = document.getElementById('out-q').value;
        if(!v || !m || !q) return alert("請輸入完整資訊");

        const data = { action: "processTransaction", type: 'OUT', vCode: v, braId: m, qty: q };
        
        try {
            await fetch(GAS_URL, { method: 'POST', mode: 'no-cors', body: JSON.stringify(data) });
            alert("出貨同步成功！");
            loadCloudData();
            switchTab('stock', document.querySelector('.tab'));
        } catch(e) { alert("出貨失敗"); }
    }

    // --- 2. 銷售紀錄渲染 ---
    function renderHistoryPage() {
        let h = `<h3>銷售歷史 (雲端數據)</h3><div class="card">`;
        if(salesHistory.length === 0) h += '<p style="text-align:center;">目前無銷售紀錄</p>';
        salesHistory.reverse().forEach(s => {
            h += `<div style="padding:10px 0; border-bottom:1px solid #eee; display:flex; justify-content:space-between;">
                    <span>${s.日期 ? s.日期.split('T')[0] : '無日期'} - ${s.品名 || '未命名'}</span>
                    <b>$${s.單價 || 0} x ${s.數量 || 1}</b>
                  </div>`;
        });
        document.getElementById('tab-history').innerHTML = h + `</div>`;
    }

    // --- 3. 系統設定 (同步雲端 Config) ---
    function initSettingsPage() {
        document.getElementById('tab-settings').innerHTML = `
            <div class="card">
                <h3>系統偏好設定</h3>
                <label>商店名稱</label>
                <input type="text" id="set-name" value="${compName}">
                <label>營業稅率 (%)</label>
                <input type="number" id="set-tax" value="${taxRate}">
                <hr>
                <button class="btn btn-primary" onclick="alert('設定已儲存於瀏覽器，雲端更動請直接修改試算表 CONFIG 分頁')">儲存本地設定</button>
                <button class="btn btn-danger" style="margin-top:10px;" onclick="sessionStorage.clear(); location.reload();">登出並清除暫存</button>
            </div>
        `;
    }

    // --- 4. 標籤列印預覽 (保留 0129-3 A4 列印邏輯) ---
    function printQuickLabel(v, m, c, z) {
        const area = document.getElementById('print-canvas-area');
        area.innerHTML = '';
        document.getElementById('print-preview-zone').style.display = 'block';
        
        const labelDiv = document.createElement('div');
        labelDiv.className = 'print-label';
        const canvas = document.createElement('canvas');
        const info = document.createElement('div');
        info.innerHTML = `<b style="font-size:14px;">${v} / ${m}</b><br>${c || ''} ${z || ''}`;
        
        labelDiv.appendChild(canvas);
        labelDiv.appendChild(info);
        area.appendChild(labelDiv);

        new QRious({
            element: canvas,
            value: `${v},${m},${c||''},${z||''}`,
            size: 100
        });
    }

    function printInboundLabel() {
        window.print();
    }

    // --- 5. 初始渲染執行 ---
    function render() {
        renderStockList();
        updateUIHeaders();
    }

    function updateUIHeaders() {
        document.getElementById('display-comp-name').innerText = compName;
        document.getElementById('display-user').innerText = currentUser ? `管理員: ${currentUser.u}` : '';
    }
</script>

<div id="print-preview-zone" class="no-print" style="display:none; position:fixed; top:0; left:0; width:100%; height:100%; background:white; z-index:10000; overflow-y:auto; padding:20px;">
    <div style="margin-bottom:20px; display:flex; gap:10px;">
        <button class="btn btn-primary" style="width:auto; padding:8px 20px;" onclick="window.print()">執行列印</button>
        <button class="btn btn-danger" style="width:auto; padding:8px 20px;" onclick="closePreview()">關閉</button>
    </div>
    <div id="print-canvas-area"></div>
</div>

<script>
    function closePreview() {
        document.getElementById('print-preview-zone').style.display = 'none';
    }
</script>

</body>
</html>
