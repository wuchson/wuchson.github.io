<!DOCTYPE html>
<html lang="zh-Hant">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Lingerie Pro - é›²ç«¯æ•´åˆç®¡ç†ç³»çµ±</title>
    <script src="https://unpkg.com/html5-qrcode"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/qrious/4.0.2/qrious.min.js"></script>
    <style>
        :root {
            --primary: #8da399; --accent: #d4a373; --bg: #f9f7f2; --card-bg: #ffffff; 
            --border: #e0dcd0; --danger: #e53e3e; --success: #48bb78;
            --a4-mt: 15.5mm; --a4-ml: 6.5mm; --a4-gx: 2.5mm; --a4-gy: 0mm;
            --s-mt: 0mm; --s-ml: 0mm;
        }
        body { font-family: -apple-system, "Noto Sans TC", sans-serif; background: var(--bg); margin: 0; padding: 10px; color: #444; }
        .container { max-width: 600px; margin: auto; }
        .card { background: var(--card-bg); border-radius: 12px; padding: 15px; margin-bottom: 15px; border: 1px solid var(--border); box-shadow: 0 2px 4px rgba(0,0,0,0.05); }
        h3 { color: #6b7e75; border-left: 4px solid var(--accent); padding-left: 10px; margin: 0 0 15px 0; font-size: 1rem; }
        
        /* æ¬Šé™æ§åˆ¶æ¨£å¼ [cite: 203, 206] */
        .admin-only, .staff-hidden { display: none; }
        body.is-admin .admin-only, body.is-admin .staff-hidden { display: block; }
        
        #login-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: var(--bg); z-index: 9999; display: flex; align-items: center; justify-content: center; }
        .login-card { width: 90%; max-width: 350px; background: white; padding: 30px; border-radius: 15px; box-shadow: 0 10px 25px rgba(0,0,0,0.1); }
        
        /* è¡¨å–®èˆ‡è¼¸å…¥æ¡†æ¨£å¼ [cite: 211, 218] */
        .row-inputs { display: flex; gap: 8px; margin-bottom: 10px; flex-wrap: wrap; }
        input, select { flex: 1; min-width: 80px; padding: 12px; font-size: 16px; border: 1px solid var(--border); border-radius: 8px; box-sizing: border-box; background: #fff; height: 48px; }
        button { width: 100%; padding: 14px; font-size: 16px; border: none; border-radius: 8px; background: var(--primary); color: white; font-weight: bold; cursor: pointer; }
        .btn-accent { background: var(--accent); }
        .btn-success { background: var(--success); }
        .btn-danger { background: var(--danger); }
        
        /* åˆ—å°ç›¸é—œ [cite: 237, 245, 250] */
        @media print {
            .no-print { display: none !important; }
            body.print-mode-a4 #print-label-page { display: grid !important; grid-template-columns: repeat(5, 38mm); padding-top: var(--a4-mt); padding-left: var(--a4-ml); column-gap: var(--a4-gx); row-gap: var(--a4-gy); }
            body.print-mode-single .label-item { width: 50mm; height: 30mm; display: flex; align-items: center; gap: 5mm; }
            #print-invoice-page { display: block !important; padding: 10mm; }
            .inv-table { width: 100%; border-collapse: collapse; }
            .inv-table th, .inv-table td { border: 1px solid black; padding: 8px; }
        }
        
        .tag { background: #f0f2f1; padding: 6px 10px; border-radius: 6px; font-size: 0.8rem; border: 1px solid #e0e5e3; display: flex; align-items: center; }
        .qty-btn { padding: 2px 8px; width: auto; background: #edf2f7; color: black; border: 1px solid #ccc; border-radius: 4px; cursor: pointer; }
    </style>
</head>
<body>
    <div id="login-overlay">
        <div class="login-card">
            <h2 style="text-align:center; color:var(--primary); margin:0 0 20px 0;">Lingerie Pro é›²ç«¯ç‰ˆ</h2>
            <input type="text" id="login-u" placeholder="å¸³è™Ÿ" style="margin-bottom:10px;">
            <input type="password" id="login-p" placeholder="å¯†ç¢¼" style="margin-bottom:20px;">
            <button onclick="login()">é€²å…¥ç³»çµ±</button>
            <p id="login-msg" style="color:var(--danger); text-align:center; font-size:0.85rem; margin-top:10px;"></p>
        </div>
    </div>

    <div class="container no-print">
        <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:15px;">
            <div>
                <strong id="display-compName" style="font-size:1.2rem; color:var(--primary);">è¼‰å…¥ä¸­...</strong>
                <div id="userStatus" style="font-size:0.75rem; color:#888;">åŒæ­¥ä¸­...</div>
            </div>
            <button class="btn-danger" style="width:auto; padding:5px 15px;" onclick="logout()">ç™»å‡ºç³»çµ±</button>
        </div>

        <div class="card">
            <div id="scan-feedback">æƒææˆåŠŸï¼</div>
            <div id="scanner-container">
                <div id="reader"></div>
                <button class="btn-danger" style="border-radius:0;" onclick="toggleScanner(false)">é—œé–‰ç›¸æ©Ÿ</button>
            </div>
            <button id="scan-btn" class="btn-accent" onclick="toggleScanner(true)" style="margin-bottom:15px;">ğŸ“· é–‹å•Ÿç›¸æ©Ÿæƒæ</button>

            <div class="row-inputs">
                <select id="vCode" onchange="updateBraOptions()"><option value="">é¸æ“‡å» å•†</option></select>
                <select id="braId"><option value="">é¸æ“‡å‹è™Ÿ</option></select>
                <select id="cCode"><option value="">é¡è‰²</option></select>
            </div>
            <div class="row-inputs">
                <select id="bb">
                    <option value="-">ä¸‹åœ</option><option value="70">70</option><option value="75">75</option>
                    <option value="80">80</option><option value="85">85</option><option value="90">90</option>
                </select>
                <select id="bc">
                    <option value="-">ç½©æ¯</option><option value="A">A</option><option value="B">B</option>
                    <option value="C">C</option><option value="D">D</option><option value="E">E</option>
                </select>
                <select id="bz">
                    <option value="-">å°ºç¢¼</option><option value="M">M</option><option value="L">L</option>
                    <option value="XL">XL</option><option value="Q">Q</option><option value="2Q">2Q</option>
                </select>
                <input type="number" id="bq" value="1" style="max-width:70px;">
            </div>
            <div style="display:flex; gap:10px;">
                <button class="btn-success" onclick="handleStock(1)">â• å…¥åº«åŒæ­¥</button>
                <button class="btn-danger" onclick="handleStock(-1)">â– å‡ºè²¨åŒæ­¥</button>
            </div>
        </div>

        <div class="admin-only">
            <div class="card" style="background:#fffaf0;">
                <h3>âš™ï¸ ç³»çµ±ç®¡ç†é¢æ¿</h3>
                
                <div class="config-card">
                    <p style="margin:0 0 10px 0; font-weight:bold;">åŸºç¤è³‡æ–™ç¶­è­·</p>
                    <div class="row-inputs">
                        <input type="text" id="newVCode" placeholder="å» å•†ä»£ç¢¼">
                        <input type="text" id="newVName" placeholder="åç¨±">
                        <button class="btn-accent" onclick="addVendor()" style="width:auto;">æ–°å¢å» å•†</button>
                    </div>
                    <hr>
                    <div class="row-inputs">
                        <input type="text" id="newModelId" placeholder="å‹è™Ÿåç¨±">
                        <input type="number" id="newCost" placeholder="æˆæœ¬">
                        <input type="number" id="newPrice" placeholder="å”®åƒ¹">
                        <button class="btn-accent" onclick="saveModel()" style="width:auto;">å­˜å‹è™Ÿ</button>
                    </div>
                </div>

                <div style="display:grid; grid-template-columns:1fr 1fr; gap:10px;">
                    <button class="btn-accent" onclick="showSales()">ğŸ“Š ç‡Ÿæ¥­çµ±è¨ˆ</button>
                    <button class="btn-accent" onclick="prepareLabelPrint()">ğŸ·ï¸ åˆ—å°æ¨™ç±¤</button>
                </div>
            </div>
        </div>

        <div class="card">
            <h3>ğŸ“¦ é›²ç«¯åº«å­˜æ¸…å–®</h3>
            <div style="overflow-x:auto;">
                <table id="inventoryTable">
                    <thead><tr><th>å•†å“</th><th>è¦æ ¼</th><th>åº«å­˜</th><th>ç®¡ç†</th></tr></thead>
                    <tbody></tbody>
                </table>
            </div>
        </div>
    </div>
<script>
    // --- æ ¸å¿ƒè®Šæ•¸èˆ‡é›²ç«¯è¨­å®š ---
    const GAS_URL = "https://script.google.com/macros/s/AKfycbzrMR013ODVk4bmvX3yXJxzp8hbEJGUzKj4eQjwTfirOY_mFEAzB7DIOSK86EZE7ciK/exec";
    
    let inventory = [], vendors = [], colors = [], models = [], salesHistory = [];
    let invoiceItems = []; // æš«å­˜å‡ºè²¨æ¸…å–®
    let currentUser = null, compName = "é›²ç«¯ç®¡ç†ç³»çµ±", taxRate = 0.05;

    // --- é›²ç«¯ POST é€šè¨Š (è™•ç†æ–°å¢è³‡æ–™) ---
    async function syncToCloud(payload) {
        try {
            await fetch(GAS_URL, {
                method: "POST",
                mode: "no-cors", 
                headers: { "Content-Type": "application/json" },
                body: JSON.stringify(payload)
            });
            console.log("åŒæ­¥è«‹æ±‚å·²é€å‡º:", payload.action);
        } catch (e) {
            console.error("é›²ç«¯åŒæ­¥å¤±æ•—:", e);
        }
    }

    // --- åŸºç¤è³‡æ–™æ–°å¢ (åŒæ­¥è‡³ GAS) ---
    async function addVendor() {
        const code = document.getElementById('newVCode').value.toUpperCase();
        const name = document.getElementById('newVName').value;
        if(!code || !name) return alert("è«‹å¡«å¯«å» å•†è³‡è¨Š");
        
        vendors.push({code, name});
        initSelectors();
        await syncToCloud({ action: "addVendor", code, name });
        alert("å» å•†å·²åŒæ­¥è‡³é›²ç«¯");
    }

    async function saveModel() {
        const vCode = document.getElementById('vCode').value;
        const braId = document.getElementById('newModelId').value.toUpperCase();
        const cost = Number(document.getElementById('newCost').value);
        const price = Number(document.getElementById('newPrice').value);
        
        if(!vCode || !braId) return alert("è«‹é¸æ“‡å» å•†ä¸¦è¼¸å…¥å‹è™Ÿ");
        
        models.push({vCode, braId, cost, price});
        updateBraOptions();
        await syncToCloud({ action: "saveModel", vCode, braId, type:"", cost, price });
        alert("å‹è™Ÿå·²åŒæ­¥è‡³é›²ç«¯");
    }

    // --- ç‡Ÿæ¥­çµ±è¨ˆåŠŸèƒ½ (é‚£ 80% çš„çµ±è¨ˆé‚è¼¯) ---
    function showSales() {
        if(salesHistory.length === 0) {
            alert("ç›®å‰å°šç„¡éŠ·å”®ç´€éŒ„ï¼ˆæˆ–é›²ç«¯è³‡æ–™è¼‰å…¥ä¸­ï¼‰");
            return;
        }
        let totalVal = 0, totalQty = 0;
        let report = "--- éŠ·å”®çµ±è¨ˆå ±å‘Š ---\n";
        salesHistory.forEach(s => {
            totalVal += (Number(s.p) * Number(s.q));
            totalQty += Number(s.q);
            report += `${s.date.split('T')[0]} | ${s.id} | $${s.p} x ${s.q}\n`;
        });
        report += `\nç¸½éŠ·é‡: ${totalQty}\nç¸½é‡‘é¡: $${totalVal}`;
        alert(report);
    }

    // --- æ¨™ç±¤åˆ—å°èˆ‡é è¦½é‚è¼¯ ---
    function prepareLabelPrint() {
        const vCode = document.getElementById('vCode').value;
        const braId = document.getElementById('braId').value;
        if(!vCode || !braId) return alert("è«‹å…ˆé¸æ“‡è¦åˆ—å°çš„å» å•†èˆ‡å‹è™Ÿ");
        
        const m = models.find(i => i.vCode === vCode && i.braId === braId);
        const c = document.getElementById('cCode').value;
        const bb = document.getElementById('bb').value;
        const bc = document.getElementById('bc').value;
        const bz = document.getElementById('bz').value;

        // é€™è£¡èª¿ç”¨å¦³åŸæœ¬çš„ QRious ç”¢ç”Ÿé‚è¼¯
        const printZone = document.getElementById('print-label-page');
        printZone.innerHTML = ''; 
        const label = createLabelElement(m, c, bb, bc, bz);
        printZone.appendChild(label);
        
        document.body.className = 'print-mode-single';
        window.print();
    }

    function createLabelElement(m, cCode, bb, bc, bz) {
        const div = document.createElement('div');
        div.className = 'label-item';
        const can = document.createElement('canvas');
        const txt = document.createElement('div');
        txt.style.fontSize = "12px";
        txt.innerHTML = `${m.vCode} / ${m.braId}<br>${getColorName(cCode)} ${bb==='-'?'':bb}${bc==='-'?'':bc} ${bz==='-'?'':bz}`;
        
        new QRious({
            element: can,
            value: `${m.vCode},${m.braId},,${cCode},${bb},${bc},${bz}`,
            size: 80
        });
        
        div.appendChild(can);
        div.appendChild(txt);
        return div;
    }
</script>
// --- ä»‹é¢æ¸²æŸ“ (æ¢å¾© 100% åŠŸèƒ½) ---
    function render() {
        const tbody = document.querySelector('#inventoryTable tbody');
        tbody.innerHTML = '';
        
        document.getElementById('display-compName').innerText = compName;

        inventory.forEach((item, idx) => {
            if (item.bq === 0) return;
            const row = tbody.insertRow();
            row.innerHTML = `
                <td><strong>${item.vCode} / ${item.braId}</strong></td>
                <td><span class="tag">${getColorName(item.c)} ${item.bb}${item.bc} ${item.bz}</span></td>
                <td><b style="color:${item.bq < 3 ? 'red' : 'inherit'}">${item.bq}</b></td>
                <td class="admin-only">
                    <button class="qty-btn" onclick="deleteItem(${idx})">ğŸ—‘ï¸</button>
                    <button class="qty-btn" onclick="addToInvoice(${idx})">ğŸ“‹</button>
                </td>
            `;
        });
    }

// --- ğŸ”‘ è£œå›ç¼ºå¤±çš„ç™»å…¥åŠŸèƒ½ ---
    async function login() {
        const u = document.getElementById('login-u').value;
        const p = document.getElementById('login-p').value;
        const msg = document.getElementById('login-msg');
        if(!u || !p) { msg.innerText = "è«‹è¼¸å…¥å¸³è™Ÿå¯†ç¢¼"; return; }

        msg.style.color = "blue";
        msg.innerText = "é›²ç«¯åŒæ­¥ä¸­...";

        try {
            const res = await fetch(`${GAS_URL}?action=loadAll`);
            const data = await res.json();
            const user = data.users.find(user => user.u === u && String(user.p) === p);
            
            if (user) {
                currentUser = user;
                if(user.r === 'admin') document.body.classList.add('is-admin');
                vendors = data.vendors || [];
                colors = data.colors || [];
                models = data.models || [];
                salesHistory = data.sales || [];
                inventory = (data.inventory || []).map(i => ({
                    vCode: i.vCode, braId: i.braId, c: i.c, bb: i.bb, bc: i.bc, bz: i.bz, bq: Number(i.qty)
                }));
                const cn = (data.config || []).find(c => c.key === "companyName");
                if(cn) compName = cn.value;

                document.getElementById('login-overlay').style.display = 'none';
                initSelectors();
                render();
            } else {
                msg.style.color = "red";
                msg.innerText = "å¸³è™Ÿæˆ–å¯†ç¢¼éŒ¯èª¤";
            }
        } catch (e) {
            msg.style.color = "red";
            msg.innerText = "é€£ç·šå¤±æ•—ï¼Œè«‹æª¢æŸ¥ GAS æ¬Šé™è¨­å®š";
        }
    }

    // --- ğŸ“‹ å‡ºè²¨å–®èˆ‡é è¦½åŠŸèƒ½ (æ¢å¾© 100% åŠŸèƒ½) ---
    function addToInvoice(idx) {
        const item = inventory[idx];
        const m = models.find(i => i.braId === item.braId);
        invoiceItems.push({
            id: `${item.vCode}-${item.braId}`,
            spec: `${getColorName(item.c)} ${item.bb}${item.bc}${item.bz}`,
            p: m ? m.price : 0,
            q: 1
        });
        showInvoicePreview();
    }

    function showInvoicePreview() {
        // è‡ªå‹•ç”Ÿæˆå¦³åŸæœ¬çš„å‡ºè²¨å–® HTML å…§å®¹
        let total = 0;
        let html = `<h3>${compName} - å‡ºè²¨å–®é è¦½</h3><table class="inv-table"><tr><th>å“é …</th><th>è¦æ ¼</th><th>å–®åƒ¹</th><th>æ•¸é‡</th></tr>`;
        invoiceItems.forEach(i => {
            html += `<tr><td>${i.id}</td><td>${i.spec}</td><td>${i.p}</td><td>${i.q}</td></tr>`;
            total += i.p * i.q;
        });
        html += `</table><p>ç¸½è¨ˆ: $${total} (å«ç¨…: $${Math.round(total * (1 + taxRate))})</p>`;
        html += `<button class="btn-success no-print" onclick="window.print()">ç¢ºèªåˆ—å°</button>`;
        html += `<button class="btn-danger no-print" onclick="clearInvoice()" style="margin-top:10px;">æ¸…ç©ºæ¸…å–®</button>`;
        
        const previewZone = document.getElementById('print-invoice-page');
        previewZone.innerHTML = html;
        previewZone.style.display = 'block';
        previewZone.scrollIntoView();
    }

    function clearInvoice() {
        invoiceItems = [];
        document.getElementById('print-invoice-page').style.display = 'none';
    }

    // --- ğŸ—‘ï¸ åˆªé™¤åŠŸèƒ½ (åŒæ­¥é›²ç«¯) ---
    async function deleteItem(idx) {
        if(!confirm("ç¢ºå®šè¦åˆªé™¤é€™ç­†é›²ç«¯åº«å­˜å—ï¼Ÿ")) return;
        const item = inventory[idx];
        inventory.splice(idx, 1);
        render();
        await syncToCloud({ action: "deleteItem", vCode: item.vCode, braId: item.braId });
    }

    // --- ğŸšª ç™»å‡º ---
    function logout() {
        currentUser = null;
        document.body.classList.remove('is-admin');
        document.getElementById('login-overlay').style.display = 'flex';
        inventory = [];
    }

    // --- ğŸ¨ ä¸‹æ‹‰é¸å–®è™•ç† ---
    function getColorName(code) {
        const c = colors.find(i => i.code === code);
        return c ? c.name : code;
    }

    function initSelectors() {
        const vSel = document.getElementById('vCode');
        const cSel = document.getElementById('cCode');
        if(!vSel || !cSel) return;
        vSel.innerHTML = '<option value="">é¸æ“‡å» å•†</option>';
        cSel.innerHTML = '<option value="">é¡è‰²</option>';
        vendors.forEach(v => vSel.add(new Option(v.name, v.code)));
        colors.forEach(c => cSel.add(new Option(c.name, c.code)));
    }

    function updateBraOptions() {
        const vCode = document.getElementById('vCode').value;
        const bSel = document.getElementById('braId');
        bSel.innerHTML = '<option value="">é¸æ“‡å‹è™Ÿ</option>';
        models.filter(m => m.vCode === vCode).forEach(m => bSel.add(new Option(m.braId, m.braId)));
    }

    window.onload = () => { console.log("ç³»çµ±å·²å°±ç·’ï¼Œè«‹ç™»å…¥ã€‚"); };
</script>

<div id="print-label-page" style="display:none;"></div>
<div id="print-invoice-page" class="card" style="display:none; margin-top:20px; background:#fff;"></div>

</body>
</html>
