<!DOCTYPE html>
<html lang="zh-Hant">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Lingerie Pro - é›²ç«¯æ——è‰¦å®Œæ•´ç‰ˆ</title>
    <script src="https://unpkg.com/html5-qrcode"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/qrious/4.0.2/qrious.min.js"></script>
    <style>
        /* å®Œå…¨ä¿ç•™ a0001.txt åŸå§‹æ¨£å¼ */
        :root {
            --primary: #8da399; --accent: #d4a373; --bg: #f9f7f2; --card-bg: #ffffff; --border: #e0dcd0; --danger: #e53e3e; --success: #48bb78;
            --a4-mt: 15.5mm; --a4-ml: 6.5mm; --a4-gx: 2.5mm; --a4-gy: 0mm; --s-mt: 0mm; --s-ml: 0mm;
        }
        body { font-family: -apple-system, "Noto Sans TC", sans-serif; background: var(--bg); margin: 0; padding: 10px; color: #444; }
        .container { max-width: 600px; margin: auto; }
        .card { background: var(--card-bg); border-radius: 12px; padding: 15px; margin-bottom: 15px; border: 1px solid var(--border); box-shadow: 0 2px 4px rgba(0,0,0,0.05); }
        h3 { color: #6b7e75; border-left: 4px solid var(--accent); padding-left: 10px; margin: 0 0 15px 0; font-size: 1rem; }
        input, select { width: 100%; padding: 12px; font-size: 16px; border: 1px solid var(--border); border-radius: 8px; box-sizing: border-box; background: #fff; height: 48px; margin-bottom: 10px; }
        button { width: 100%; padding: 14px; font-size: 16px; border: none; border-radius: 8px; background: var(--primary); color: white; font-weight: bold; cursor: pointer; margin-bottom: 5px; }
        #scanner-container { display: none; margin-bottom: 15px; background: #000; border-radius: 12px; overflow: hidden; }
        @media print {
            .no-print { display: none !important; }
            body.print-mode-a4 #print-label-page { display: grid !important; grid-template-columns: repeat(5, 38mm); padding-top: var(--a4-mt); padding-left: var(--a4-ml); column-gap: var(--a4-gx); row-gap: var(--a4-gy); }
            .label-item { width: 38mm; height: 38mm; display: flex; flex-direction: column; align-items: center; justify-content: center; border: 0.1mm solid #eee; overflow: hidden; }
            .label-item canvas { width: 22mm !important; height: 22mm !important; }
        }
    </style>
</head>
<body>
<div class="container no-print">
    <div id="login-section" class="card">
        <h3>ç³»çµ±ç™»å…¥</h3>
        <input type="text" id="loginUser" placeholder="å¸³è™Ÿ" value="admin">
        <input type="password" id="loginPass" placeholder="å¯†ç¢¼" value="admin123">
        <button onclick="login()">ç™»å…¥ä¸¦åŒæ­¥é›²ç«¯</button>
        <p id="sync-msg" style="text-align:center; font-size:12px; color:gray;">å°šæœªåŒæ­¥</p>
    </div>

    <div id="main-ui" style="display:none;">
        <div class="card">
            <h3>1. å» å•†èˆ‡é¡è‰²è¨­å®š</h3>
            <div style="display:flex; gap:5px;">
                <input type="text" id="vCodeInp" placeholder="å» å•†ä»£ç¢¼">
                <input type="text" id="vNameInp" placeholder="åç¨±">
            </div>
            <button onclick="addVendor()">æ–°å¢å» å•†</button>
            <div id="vendorTags" style="display:flex; flex-wrap:wrap; gap:5px; margin-top:10px;"></div>
        </div>

        <div class="card">
            <h3>2. åº«å­˜é€²å‡ºä½œæ¥­</h3>
            <div style="display:grid; grid-template-columns:1fr 1fr; gap:10px;">
                <button onclick="startScan('IN')" style="background:#4299e1;">ğŸ“¥ æƒæå…¥åº«</button>
                <button onclick="startScan('OUT')" style="background:var(--success);">ğŸ“¤ æƒæå‡ºè²¨</button>
            </div>
            <div id="scanner-container"><div id="reader"></div></div>
            <select id="selectVendor" onchange="updateModelSelect()"></select>
            <select id="selectModel"></select>
            <button onclick="prepareTags()" style="background:var(--accent);">ğŸ–¨ï¸ ç”Ÿæˆ A4 æ¨™ç±¤åˆ—å°</button>
        </div>

        <div class="card">
            <h3>3. åº«å­˜æ¸…å–®</h3>
            <input type="text" id="stockSearch" placeholder="æœå°‹å‹è™Ÿ..." oninput="render()">
            <table style="width:100%; border-collapse:collapse; margin-top:10px;">
                <thead><tr style="border-bottom:2px solid #eee;"><th>å‹è™Ÿ</th><th>è¦æ ¼</th><th>æ•¸é‡</th></tr></thead>
                <tbody id="stockTableBody"></tbody>
            </table>
        </div>
    </div>
</div>

<div id="print-label-page" style="display:none;"></div>

<script>
// ç¬¬ä¸‰éƒ¨åˆ† JS é‚è¼¯å°‡æ¥è‘—å‚³é€...
// --- æ ¸å¿ƒè®Šæ•¸èˆ‡é›²ç«¯è¨­å®š ---
    const API_URL = "https://script.google.com/macros/s/AKfycbwQgayCgBc5QWCo57osA4nXoneiDDDiobdprQXjTiItcTRbDc0SiZUn3wPGA_m0uohWBQ/exec"; // å‹™å¿…å¡«å…¥æ‚¨çš„ GAS ç¶²å€

    let vendors = [], models = [], inventory = [], colors = [], salesHistory = [], users = [];
    let compName = "Lingerie Pro", taxRate = 5, currentUser = null, invoiceItems = [];
    let pCfg = { a4mt: 15.5, a4ml: 6.5, a4gx: 2.5, a4gy: 0 };
    let html5QrCode = null, isProcessing = false;

    // --- é›²ç«¯é€šè¨Šæ ¸å¿ƒ ---
    async function cloud(action, sheet, payload = null) {
        try {
            const res = await fetch(API_URL, {
                method: 'POST',
                body: JSON.stringify({ action, sheet, payload })
            });
            const text = await res.text();
            return action === 'readAll' ? JSON.parse(text) : text;
        } catch (e) {
            console.error("é›²ç«¯åŒæ­¥éŒ¯èª¤:", e);
            return null;
        }
    }

    // --- åˆå§‹åŒ–èˆ‡ç™»å…¥ ---
    async function init() {
        document.getElementById('sync-msg').innerText = "æ­£åœ¨é€£ç·šé›²ç«¯...";
        const [v, m, i, c, s, cfg] = await Promise.all([
            cloud('readAll', 'VENDORS'), cloud('readAll', 'MODELS'),
            cloud('readAll', 'INVENTORY'), cloud('readAll', 'COLORS'),
            cloud('readAll', 'SALES'), cloud('readAll', 'CONFIG')
        ]);
        vendors = v || []; models = m || []; inventory = i || []; 
        colors = c || []; salesHistory = s || [];
        if(cfg && cfg.length > 0) {
            compName = cfg.find(x => x.k === 'compName')?.v || compName;
            pCfg = JSON.parse(cfg.find(x => x.k === 'pCfg')?.v || JSON.stringify(pCfg));
        }
        document.getElementById('sync-msg').innerText = "é›²ç«¯é€£ç·šå°±ç·’";
    }

    function login() {
        const u = document.getElementById('loginUser').value;
        const p = document.getElementById('loginPass').value;
        // é€™è£¡ç¶­æŒ a0001.txt çš„é è¨­ admin é‚è¼¯ï¼Œæ‚¨ä¹Ÿå¯æ”¹ç‚ºå¾é›²ç«¯ users è¡¨è®€å–
        if (u === 'admin' && p === 'admin123') {
            currentUser = { u, r: 'admin' };
            document.body.classList.add('is-admin');
            document.getElementById('login-section').style.display = 'none';
            document.getElementById('main-ui').style.display = 'block';
            render();
        } else { alert("å¸³è™Ÿå¯†ç¢¼éŒ¯èª¤"); }
    }

    // --- æ ¸å¿ƒæ¥­å‹™é‚è¼¯ (100% å°æ¨™ a0001.txt) ---
    async function save() {
        document.getElementById('sync-msg').innerText = "åŒæ­¥ä¸­...";
        await Promise.all([
            cloud('syncFull', 'VENDORS', vendors),
            cloud('syncFull', 'MODELS', models),
            cloud('syncFull', 'INVENTORY', inventory),
            cloud('syncFull', 'COLORS', colors),
            cloud('syncFull', 'SALES', salesHistory),
            cloud('syncFull', 'CONFIG', [{k:'compName', v:compName}, {k:'pCfg', v:JSON.stringify(pCfg)}])
        ]);
        document.getElementById('sync-msg').innerText = "åŒæ­¥å®Œæˆ";
        render();
    }

    function render() {
        // æ¸²æŸ“å» å•†æ¨™ç±¤èˆ‡ä¸‹æ‹‰é¸å–®
        document.getElementById('vendorTags').innerHTML = vendors.map(v => `<div class="tag">${v.code}</div>`).join('');
        document.getElementById('selectVendor').innerHTML = vendors.map(v => `<option value="${v.code}">${v.code}-${v.name}</option>`).join('');
        
        // æ¸²æŸ“åº«å­˜è¡¨æ ¼ (åŒ…å«æœå°‹åŠŸèƒ½)
        const q = document.getElementById('stockSearch').value.toLowerCase();
        const filtered = inventory.filter(i => (i.vCode + i.braId + i.c).toLowerCase().includes(q));
        document.getElementById('stockTableBody').innerHTML = filtered.map(i => `
            <tr>
                <td>${i.vCode}<br><small>${i.braId}</small></td>
                <td>${i.c} ${i.bb}${i.bc} ${i.bz}</td>
                <td style="font-weight:bold; color:${i.bq < 3 ? 'red' : 'black'}">${i.bq}</td>
            </tr>
        `).join('');
        updateModelSelect();
    }

    function updateStock(vCode, braId, c, bb, bc, bz, qty) {
        let item = inventory.find(i => i.vCode===vCode && i.braId===braId && i.c===c && i.bb===bb && i.bc===bc && i.bz===bz);
        if(item) { item.bq += qty; } 
        else { inventory.push({vCode, braId, c, bb, bc, bz, bq: qty}); }
        save();
    }

    // --- æ¨™ç±¤èˆ‡åˆ—å°é‚è¼¯ ---
    function prepareTags() {
        const vCode = document.getElementById('selectVendor').value;
        const mRaw = document.getElementById('selectModel').value;
        if(!mRaw) return;
        const m = JSON.parse(mRaw);
        const cCode = document.getElementById('selectColor').value;
        const bb = document.getElementById('braBand').value;
        const bc = document.getElementById('braCup').value;
        const bz = document.getElementById('braSize').value;

        const page = document.getElementById('print-label-page');
        page.innerHTML = '';
        page.style.display = 'grid';
        document.body.classList.add('print-mode-a4');

        // ç”¢ç”Ÿ A4 35 æ ¼æ¨™ç±¤
        for (let i = 0; i < 35; i++) {
            const div = document.createElement('div');
            div.className = 'label-item';
            const can = document.createElement('canvas');
            const txt = document.createElement('div');
            txt.style.fontSize = "9px";
            txt.innerHTML = `${m.braId}<br>${cCode} ${bb}${bc} ${bz}`;
            div.appendChild(can);
            div.appendChild(txt);
            page.appendChild(div);
            // ç”Ÿæˆ QR Code (å°æ¨™ a0001 æ ¼å¼: å» å•†,å‹è™Ÿ,æ¯,è‰²,åœ,æ¯,ç¢¼)
            new QRious({
                element: can,
                value: `${vCode},${m.braId},,${cCode},${bb},${bc},${bz}`,
                size: 100
            });
        }
        window.print();
        setTimeout(() => { 
            page.style.display = 'none'; 
            document.body.classList.remove('print-mode-a4');
        }, 1000);
    }

    // --- æƒæé‚è¼¯ ---
    async function startScan(mode) {
        document.getElementById('scanner-container').style.display = 'block';
        html5QrCode = new Html5Qrcode("reader");
        await html5QrCode.start({ facingMode: "environment" }, { fps: 10, qrbox: 250 }, (txt) => {
            if (isProcessing) return;
            isProcessing = true;
            const p = txt.split(',');
            if (p.length >= 6) {
                // æƒææˆåŠŸå¾Œçš„å‹•ä½œ (p[0]=vCode, p[1]=braId, p[3]=c, p[4]=bb, p[5]=bc, p[6]=bz)
                const qty = (mode === 'IN') ? 1 : -1;
                updateStock(p[0], p[1], p[3], p[4], p[5], p[6], qty);
                if(mode === 'OUT') alert("å·²å‡ºè²¨ 1 ä»¶: " + p[1]);
            }
            setTimeout(() => isProcessing = false, 1000);
        });
    }

    function stopScan() {
        if (html5QrCode) {
            html5QrCode.stop().then(() => {
                document.getElementById('scanner-container').style.display = 'none';
            });
        }
    }

    // --- è¼”åŠ©å‡½æ•¸ ---
    function addVendor() {
        const code = document.getElementById('vCodeInp').value;
        const name = document.getElementById('vNameInp').value;
        if(code) { vendors.push({code, name}); save(); }
    }

    function updateModelSelect() {
        const v = document.getElementById('selectVendor').value;
        const fil = models.filter(m => m.vCode === v);
        document.getElementById('selectModel').innerHTML = fil.map(m => `<option value='${JSON.stringify(m)}'>${m.braId} ($${m.price})</option>`).join('');
    }

    window.onload = init;
</script>
</body>
</html>
