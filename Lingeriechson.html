<!DOCTYPE html>
<html lang="zh-Hant">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Lingerie Pro - é›²ç«¯æ•´åˆç‰ˆ</title>
    <script src="https://unpkg.com/html5-qrcode"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/qrious/4.0.2/qrious.min.js"></script>
    <style>
        :root {
            --primary: #8da399; --accent: #d4a373; --bg: #f9f7f2; --card-bg: #ffffff; 
            --border: #e0dcd0; --danger: #e53e3e; --success: #48bb78;
            --a4-mt: 15.5mm; --a4-ml: 6.5mm; --a4-gx: 2.5mm; --a4-gy: 0mm;
        }
        body { font-family: -apple-system, "Noto Sans TC", sans-serif; background: var(--bg); margin: 0; padding: 10px; color: #444; }
        .container { max-width: 600px; margin: auto; }
        .card { background: var(--card-bg); border-radius: 12px; padding: 15px; margin-bottom: 15px; border: 1px solid var(--border); box-shadow: 0 2px 4px rgba(0,0,0,0.05); }
        h3 { color: #6b7e75; border-left: 4px solid var(--accent); padding-left: 10px; margin: 0 0 15px 0; font-size: 1rem; }
        
        #login-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: var(--bg); z-index: 9999; display: flex; align-items: center; justify-content: center; }
        .login-card { width: 90%; max-width: 350px; background: white; padding: 30px; border-radius: 15px; box-shadow: 0 10px 25px rgba(0,0,0,0.1); text-align: center; }
        
        .admin-only, .staff-hidden { display: none; }
        body.is-admin .admin-only, body.is-admin .staff-hidden { display: block; }
        
        .row-inputs { display: flex; gap: 8px; margin-bottom: 10px; flex-wrap: wrap; }
        input, select { flex: 1; min-width: 80px; padding: 12px; font-size: 16px; border: 1px solid var(--border); border-radius: 8px; box-sizing: border-box; background: #fff; height: 48px; }
        button { width: 100%; padding: 14px; font-size: 16px; border: none; border-radius: 8px; background: var(--primary); color: white; font-weight: bold; cursor: pointer; transition: 0.3s; }
        button:disabled { background: #ccc; }
        .btn-accent { background: var(--accent); }
        .btn-success { background: var(--success); }
        .btn-danger { background: var(--danger); }
        
        #scanner-container { display: none; margin-bottom: 15px; background: #000; border-radius: 12px; overflow: hidden; position: relative; }
        #scan-feedback { position: absolute; top: 10px; left: 50%; transform: translateX(-50%); background: rgba(72, 187, 120, 0.9); color: white; padding: 5px 25px; border-radius: 20px; font-weight: bold; z-index: 10; display: none; }
        
        table { width: 100%; border-collapse: collapse; background: #fff; font-size: 0.85rem; }
        th, td { padding: 10px; text-align: left; border-bottom: 1px solid #f9f9f9; }
        .tag { background: #f0f2f1; padding: 4px 8px; border-radius: 4px; font-size: 0.75rem; border: 1px solid #e0e5e3; }
        
        @media print {
            .no-print { display: none !important; }
            #print-invoice-page { display: block !important; }
        }
    </style>
</head>
<body>
    <div id="login-overlay">
        <div class="login-card">
            <h2 style="color:var(--primary); margin:0 0 10px 0;">Lingerie Pro</h2>
            <p style="font-size:0.8rem; color:#888; margin-bottom:20px;">é›²ç«¯åŒæ­¥ç®¡ç†ç³»çµ±</p>
            <input type="text" id="login-u" placeholder="è«‹è¼¸å…¥å¸³è™Ÿ" style="margin-bottom:10px;">
            <input type="password" id="login-p" placeholder="è«‹è¼¸å…¥å¯†ç¢¼" style="margin-bottom:20px;">
            <button id="login-btn" onclick="login()">é€²å…¥ç³»çµ±</button>
            <p id="login-msg" style="font-size:0.85rem; margin-top:15px;"></p>
        </div>
    </div>

    <div class="container no-print">
        <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:15px;">
            <div>
                <strong id="display-compName" style="font-size:1.1rem; color:var(--primary);">è¼‰å…¥ä¸­...</strong>
                <div id="userStatus" style="font-size:0.7rem; color:#888;">é›²ç«¯ç‹€æ…‹ï¼šç­‰å¾…ç™»å…¥</div>
            </div>
            <button class="btn-danger" style="width:auto; padding:5px 12px; font-size:14px;" onclick="logout()">ç™»å‡º</button>
        </div>

        <div class="card">
            <div id="scan-feedback">è®€å–æˆåŠŸ</div>
            <div id="scanner-container">
                <div id="reader"></div>
                <button class="btn-danger" style="border-radius:0;" onclick="toggleScanner(false)">é—œé–‰ç›¸æ©Ÿ</button>
            </div>
            <button id="scan-btn" class="btn-accent" onclick="toggleScanner(true)" style="margin-bottom:15px;">ğŸ“· é–‹å•Ÿç›¸æ©Ÿæƒæ</button>

            <div class="row-inputs">
                <select id="vCode" onchange="updateBraOptions()"><option value="">é¸æ“‡å» å•†</option></select>
                <select id="braId"><option value="">é¸æ“‡å‹è™Ÿ</option></select>
                <select id="cCode"><option value="">é¸æ“‡é¡è‰²</option></select>
            </div>
            <div class="row-inputs">
                <select id="bb">
                    <option value="-">ä¸‹åœ</option><option value="70">70</option><option value="75">75</option>
                    <option value="80">80</option><option value="85">85</option><option value="90">90</option>
                </select>
                <select id="bc">
                    <option value="-">ç½©æ¯</option><option value="A">A</option><option value="B">B</option>
                    <option value="C">C</option><option value="D">D</option><option value="E">E</option>
                </select>
                <select id="bz">
                    <option value="-">å°ºç¢¼</option><option value="M">M</option><option value="L">L</option>
                    <option value="XL">XL</option><option value="Q">Q</option><option value="2Q">2Q</option>
                </select>
                <input type="number" id="bq" value="1" style="max-width:70px;">
            </div>
            <div style="display:flex; gap:10px;">
                <button class="btn-success" onclick="handleStock(1)">â• å…¥åº«</button>
                <button class="btn-danger" onclick="handleStock(-1)">â– å‡ºè²¨</button>
            </div>
        </div>

        <div class="admin-only">
            <div class="card" style="background:#fffaf0; border: 1px dashed var(--accent);">
                <h3>âš™ï¸ å¾Œå°ç®¡ç†èˆ‡åˆ—å°</h3>
                <div style="display:grid; grid-template-columns:1fr 1fr; gap:10px;">
                    <button class="btn-accent" onclick="prepareLabelPrint()">ğŸ·ï¸ åˆ—å°æ¨™ç±¤</button>
                    <button class="btn-accent" onclick="showSales()">ğŸ“Š ç‡Ÿæ¥­çµ±è¨ˆ</button>
                </div>
                <div style="margin-top:10px; font-size:0.8rem; color:#666;">
                    * æ›´å¤šè¨­å®šè«‹ç›´æ¥ç·¨è¼¯ Google è©¦ç®—è¡¨
                </div>
            </div>
        </div>

        <div class="card">
            <h3>ğŸ“¦ é›²ç«¯å³æ™‚åº«å­˜</h3>
            <div style="overflow-x:auto;">
                <table id="inventoryTable">
                    <thead><tr><th>å“å</th><th>è¦æ ¼</th><th>æ•¸é‡</th><th>æ“ä½œ</th></tr></thead>
                    <tbody></tbody>
                </table>
            </div>
        </div>
    </div>

    <div id="print-label-page" style="display:none;"></div>
    <div id="print-invoice-page" class="card" style="display:none; margin-top:20px;"></div>
<script>
    // --- 1. æ ¸å¿ƒè®Šæ•¸èˆ‡è¨­å®š ---
    const GAS_URL = "https://script.google.com/macros/s/AKfycbzd7Er_INBVPum15y2VGOu9siQjmlFmiwKgaPifrj0MyQpu0yY9fao8fuH_XW6-vvyn/exec";
    
    let inventory = [], vendors = [], colors = [], models = [], salesHistory = [];
    let invoiceItems = [];
    let currentUser = null, compName = "é›²ç«¯ç®¡ç†ç³»çµ±", taxRate = 0.05;
    let html5QrCode = null;

    // --- 2. ğŸ”‘ ç™»å…¥èˆ‡è³‡æ–™åˆå§‹åŒ– (æ ¸å¿ƒåŠŸèƒ½) ---
    async function login() {
        const u = document.getElementById('login-u').value;
        const p = document.getElementById('login-p').value;
        const msg = document.getElementById('login-msg');
        const btn = document.getElementById('login-btn');
        
        if(!u || !p) { msg.innerText = "è«‹è¼¸å…¥å¸³è™Ÿå¯†ç¢¼"; return; }

        // UI ç‹€æ…‹æ›´æ–°
        btn.disabled = true;
        msg.style.color = "blue";
        msg.innerText = "æ­£åœ¨é€£ç·šé›²ç«¯è³‡æ–™åº«...";

        try {
            // æŠ“å–æ‰€æœ‰è³‡æ–™
            const res = await fetch(`${GAS_URL}?action=loadAll`);
            if (!res.ok) throw new Error("ç¶²è·¯é€£ç·šç•°å¸¸");
            const data = await res.json();
            
            // é©—è­‰ä½¿ç”¨è€… (å°æ‡‰ USERS å·¥ä½œè¡¨)
            const user = data.users.find(user => user.u === u && String(user.p) === p);
            
            if (user) {
                currentUser = user;
                if(user.r === 'admin') document.body.classList.add('is-admin');
                
                // è³‡æ–™è½‰æ›èˆ‡å¯«å…¥
                vendors = data.vendors || [];
                colors = data.colors || [];
                models = data.models || [];
                salesHistory = data.sales || [];
                inventory = (data.inventory || []).map(i => ({
                    vCode: i.vCode, braId: i.braId, c: i.c, bb: i.bb, bc: i.bc, bz: i.bz, bq: Number(i.qty)
                }));
                
                // è¨­å®šå…¬å¸è³‡è¨Š
                const cn = (data.config || []).find(c => c.key === "companyName");
                if(cn) compName = cn.value;
                
                // é€²å…¥ç³»çµ±
                document.getElementById('login-overlay').style.display = 'none';
                document.getElementById('userStatus').innerText = `é€£ç·šä½¿ç”¨è€…ï¼š${user.u}`;
                initSelectors();
                render();
            } else {
                msg.style.color = "red";
                msg.innerText = "å¸³è™Ÿæˆ–å¯†ç¢¼éŒ¯èª¤";
                btn.disabled = false;
            }
        } catch (e) {
            console.error(e);
            msg.style.color = "red";
            msg.innerText = "é€£ç·šå¤±æ•—ï¼è«‹ç¢ºèª GAS å·²éƒ¨ç½²ç‚ºã€Œæ‰€æœ‰äººã€";
            btn.disabled = false;
        }
    }

    // --- 3. â˜ï¸ é›²ç«¯åŒæ­¥è¼”åŠ©å‡½å¼ ---
    async function syncToCloud(payload) {
        try {
            await fetch(GAS_URL, {
                method: "POST",
                mode: "no-cors", // è§£æ±ºè·¨åŸŸå•é¡Œ
                headers: { "Content-Type": "application/json" },
                body: JSON.stringify(payload)
            });
            console.log("åŒæ­¥æŒ‡ä»¤å·²ç™¼é€:", payload.action);
        } catch (e) {
            console.error("é›²ç«¯åŒæ­¥å‡ºéŒ¯:", e);
        }
    }
</script>
// --- 4. ğŸ“¦ é€²å‡ºè²¨èˆ‡åº«å­˜è™•ç† ---
    async function handleStock(direction) {
        const vCode = document.getElementById('vCode').value;
        const braId = document.getElementById('braId').value;
        const c = document.getElementById('cCode').value;
        const bb = document.getElementById('bb').value;
        const bc = document.getElementById('bc').value;
        const bz = document.getElementById('bz').value;
        const qVal = Number(document.getElementById('bq').value);
        const qty = qVal * direction;

        if (!vCode || !braId || !c) return alert("è«‹å®Œæ•´é¸æ“‡å» å•†ã€å‹è™Ÿèˆ‡é¡è‰²");

        // æœ¬åœ°é å…ˆæ›´æ–° (UI åæ‡‰å¿«)
        let item = inventory.find(i => i.vCode===vCode && i.braId===braId && i.c===c && i.bb===bb && i.bc===bc && i.bz===bz);
        if (item) item.bq += qty;
        else inventory.push({ vCode, braId, c, bb, bc, bz, bq: qty });
        
        render();
        playBeep();

        // åŒæ­¥è‡³ GAS (action: processTransaction)
        const m = models.find(mod => mod.braId === braId) || {};
        await syncToCloud({
            action: "processTransaction",
            vCode, braId, c, bb, bc, bz,
            qty: Math.abs(qty),
            type: direction > 0 ? 'IN' : 'OUT',
            price: m.price || 0
        });
    }

    // --- 5. ğŸ·ï¸ æ¨™ç±¤åˆ—å°èˆ‡ ğŸ“Š çµ±è¨ˆé‚è¼¯ ---
    function prepareLabelPrint() {
        const v = document.getElementById('vCode').value;
        const b = document.getElementById('braId').value;
        const m = models.find(i => i.vCode === v && i.braId === b);
        if(!m) return alert("è«‹å…ˆé¸æ“‡æœ‰æ•ˆçš„å» å•†èˆ‡å‹è™Ÿ");

        const c = document.getElementById('cCode').value;
        const bb = document.getElementById('bb').value;
        const bc = document.getElementById('bc').value;
        const bz = document.getElementById('bz').value;

        const printZone = document.getElementById('print-label-page');
        printZone.innerHTML = ''; 
        
        const div = document.createElement('div');
        div.style.display = "inline-block";
        div.style.padding = "10px";
        const can = document.createElement('canvas');
        const txt = document.createElement('div');
        txt.style.fontSize = "12px";
        txt.innerHTML = `<b>${m.vCode} / ${m.braId}</b><br>${getColorName(c)} ${bb}${bc} ${bz}`;
        
        new QRious({
            element: can,
            value: `${m.vCode},${m.braId},,${c},${bb},${bc},${bz}`,
            size: 100
        });
        
        div.appendChild(can);
        div.appendChild(txt);
        printZone.appendChild(div);
        
        printZone.style.display = 'block';
        window.print();
        printZone.style.display = 'none';
    }

    function showSales() {
        if(salesHistory.length === 0) return alert("å°šç„¡éŠ·å”®ç´€éŒ„");
        let total = 0;
        let msg = "--- é›²ç«¯éŠ·å”®ç´€éŒ„ ---\n";
        salesHistory.forEach(s => {
            msg += `${s.date.split('T')[0]} | ${s.id} | $${s.p} x ${s.q}\n`;
            total += (s.p * s.q);
        });
        msg += `\nç¸½è¨ˆé‡‘é¡: $${total}`;
        alert(msg);
    }

    // --- 6. ğŸ¨ ä»‹é¢è¼”åŠ©åŠŸèƒ½ ---
    function render() {
        const tbody = document.querySelector('#inventoryTable tbody');
        tbody.innerHTML = '';
        document.getElementById('display-compName').innerText = compName;

        inventory.forEach((item, idx) => {
            if (item.bq === 0) return;
            const row = tbody.insertRow();
            row.innerHTML = `
                <td><strong>${item.vCode} / ${item.braId}</strong></td>
                <td><span class="tag">${getColorName(item.c)} ${item.bb}${item.bc} ${item.bz}</span></td>
                <td><b>${item.bq}</b></td>
                <td><button class="btn-danger" style="padding:4px 8px; width:auto; font-size:12px;" onclick="deleteLocal(${idx})">åˆªé™¤</button></td>
            `;
        });
    }

    function deleteLocal(idx) {
        if(confirm("ç¢ºå®šåˆªé™¤æ­¤ç­†é¡¯ç¤ºï¼Ÿ(é›²ç«¯è³‡æ–™ä¸æœƒåŒæ­¥åˆªé™¤)")) {
            inventory.splice(idx, 1);
            render();
        }
    }

    function initSelectors() {
        const vSel = document.getElementById('vCode'), cSel = document.getElementById('cCode');
        vSel.innerHTML = '<option value="">é¸æ“‡å» å•†</option>';
        cSel.innerHTML = '<option value="">é¸æ“‡é¡è‰²</option>';
        vendors.forEach(v => vSel.add(new Option(v.name, v.code)));
        colors.forEach(c => cSel.add(new Option(c.name, c.code)));
    }

    function updateBraOptions() {
        const v = document.getElementById('vCode').value;
        const bSel = document.getElementById('braId');
        bSel.innerHTML = '<option value="">é¸æ“‡å‹è™Ÿ</option>';
        models.filter(m => m.vCode === v).forEach(m => bSel.add(new Option(m.braId, m.braId)));
    }

    function getColorName(code) {
        const c = colors.find(i => i.code === code);
        return c ? c.name : code;
    }

    function playBeep() { 
        const a = new Audio('https://assets.mixkit.co/active_storage/sfx/766/766-preview.mp3');
        a.play().catch(()=>{});
    }

    function toggleScanner(show) {
        const container = document.getElementById('scanner-container');
        if (show) {
            container.style.display = 'block';
            html5QrCode = new Html5Qrcode("reader");
            html5QrCode.start({ facingMode: "environment" }, { fps: 10, qrbox: 250 }, (txt)=>{
                const p = txt.split(',');
                if(p.length>=7) {
                    document.getElementById('vCode').value = p[0]; updateBraOptions();
                    document.getElementById('braId').value = p[1];
                    document.getElementById('cCode').value = p[3];
                    document.getElementById('bb').value = p[4];
                    document.getElementById('bc').value = p[5];
                    document.getElementById('bz').value = p[6];
                    playBeep();
                }
            });
        } else if (html5QrCode) {
            html5QrCode.stop().then(() => { container.style.display = 'none'; });
        }
    }

    function logout() { location.reload(); }

    window.onload = () => { console.log("ç³»çµ±å°±ç·’ï¼Œè«‹ç™»å…¥"); };
</script>
</body>
</html>
