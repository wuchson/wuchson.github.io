<!DOCTYPE html>
<html lang="zh-Hant">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Lingerie Pro - 雲端整合版</title>
    <script src="https://unpkg.com/html5-qrcode"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/qrious/4.0.2/qrious.min.js"></script>
    <style>
        :root {
            --primary: #8da399; --accent: #d4a373; --bg: #f9f7f2; --card-bg: #ffffff; 
            --border: #e0dcd0; --danger: #e53e3e; --success: #48bb78;
            --a4-mt: 15.5mm; --a4-ml: 6.5mm; --a4-gx: 2.5mm; --a4-gy: 0mm;
            --s-mt: 0mm; --s-ml: 0mm;
        }
        body { font-family: -apple-system, "Noto Sans TC", sans-serif; background: var(--bg); margin: 0; padding: 10px; color: #444; }
        .container { max-width: 600px; margin: auto; padding-bottom: 80px; }
        .card { background: var(--card-bg); border-radius: 12px; padding: 15px; margin-bottom: 15px; box-shadow: 0 2px 8px rgba(0,0,0,0.03); border: 1px solid var(--border); }
        .nav-tabs { display: flex; overflow-x: auto; gap: 8px; margin-bottom: 15px; padding-bottom: 5px; scrollbar-width: none; }
        .nav-tabs::-webkit-scrollbar { display: none; }
        .tab { padding: 8px 16px; background: #e0dcd0; border-radius: 20px; white-space: nowrap; font-size: 14px; cursor: pointer; transition: 0.3s; }
        .tab.active { background: var(--primary); color: white; }
        input, select { width: 100%; padding: 12px; margin: 8px 0; border: 1px solid var(--border); border-radius: 8px; font-size: 16px; outline: none; }
        .btn { width: 100%; padding: 12px; border: none; border-radius: 8px; font-size: 16px; font-weight: bold; cursor: pointer; transition: 0.2s; }
        .btn-primary { background: var(--primary); color: white; }
        #login-overlay { position: fixed; top:0; left:0; width:100%; height:100%; background: var(--bg); z-index: 9999; display: flex; align-items: center; justify-content: center; }
        .print-label { display: inline-block; width: 40mm; height: 30mm; border: 0.1mm solid #ccc; padding: 2mm; text-align: center; page-break-inside: avoid; }
    </style>
    <script>
        // --- 雲端設定區 ---
        const GAS_URL = "https://script.google.com/macros/s/AKfycbx1IBTg28rNwdoZbAkKV48eDEc7ZQ5ZVMQWXrhEvxWg5WwLkZk0qqSpNJch5wESMrAqKg/exec";
        
        // --- 全域變數 (保留 0129-3.txt 的變數結構) ---
        let currentUser = JSON.parse(sessionStorage.getItem('L_USER')) || null;
        let vendors = [], models = [], inventory = [], colors = [], salesHistory = [];
        let compName = "雲端管理系統", taxRate = 5;
        let pCfg = { a4mt:15.5, a4ml:6.5, a4gx:2.5, a4gy:0, smt:0, sml:0 };

        // --- 初始化：雲端同步邏輯 ---
        async function loadAllData() {
            try {
                const response = await fetch(`${GAS_URL}?action=loadAll`);
                const data = await response.json();
                
                vendors = data.vendors || [];
                models = data.models || [];
                colors = data.colors || [];
                salesHistory = data.sales || [];
                
                // 核心：將 GAS 流水帳處理成 0129-3 所需的庫存格式
                processCloudInventory(data.inventory || []);
                
                if(data.config && data.config.length > 0) {
                    compName = data.config[0].compName || compName;
                    taxRate = data.config[0].taxRate || 5;
                }
                
                render(); // 後續部分定義渲染邏輯
            } catch (err) {
                console.error("雲端載入失敗:", err);
            }
        }

        function processCloudInventory(logs) {
            // 雲端是流水帳，這裡將其彙整為型號餘額
            const map = {};
            logs.forEach(log => {
                const key = `${log.vCode}|${log.braId}|${log.c}|${log.bb}|${log.bc}|${log.bz}`;
                if (!map[key]) map[key] = { ...log, bq: 0 };
                map[key].bq += (log.type === 'OUT' ? -parseInt(log.qty) : parseInt(log.qty));
            });
            inventory = Object.values(map);
        }

        function checkAuth() {
            if(!currentUser) { document.getElementById('login-overlay').style.display = 'flex'; return; }
            document.getElementById('login-overlay').style.display = 'none';
            loadAllData();
        }

        function login() {
            const u = document.getElementById('loginUser').value;
            const p = document.getElementById('loginPass').value;
            if(u === 'admin' && p === '1234') { // 可改為對接 GAS USERS
                currentUser = {u:u};
                sessionStorage.setItem('L_USER', JSON.stringify(currentUser));
                checkAuth();
            } else { alert("帳號或密碼錯誤"); }
        }
    </script>
</head>
<body onload="checkAuth()">
<div id="login-overlay">
    <div class="card" style="width: 85%; max-width: 350px; text-align: center;">
        <h2 style="color:var(--primary); margin-bottom: 20px;">Lingerie Pro Cloud</h2>
        <input type="text" id="loginUser" placeholder="管理員帳號">
        <input type="password" id="loginPass" placeholder="管理員密碼">
        <button class="btn btn-primary" onclick="login()">登入系統</button>
        <p style="font-size: 12px; color: #999; margin-top: 15px;">版本 2.0 (雲端同步已啟動)</p>
    </div>
</div>

<div class="container" id="app-content">
    <header style="display:flex; justify-content:space-between; align-items:center; margin-bottom: 10px;">
        <h2 id="comp-name-display" style="margin:0; font-size: 1.2em;">載入中...</h2>
        <span id="user-display" style="font-size:12px; background:#e0dcd0; padding:2px 10px; border-radius:15px;"></span>
    </header>

    <nav class="nav-tabs" id="main-nav">
        <div class="tab active" onclick="switchTab('stock', this)">庫存查詢</div>
        <div class="tab" onclick="switchTab('in', this)">入庫/標籤</div>
        <div class="tab" onclick="switchTab('out', this)">出貨結帳</div>
        <div class="tab" onclick="switchTab('history', this)">銷售紀錄</div>
        <div class="tab" onclick="switchTab('settings', this)">系統設定</div>
    </nav>

    <div id="tab-stock" class="tab-content">
        <div class="card">
            <input type="text" id="stockSearch" placeholder="搜尋型號、廠商或細節..." oninput="renderStockList()">
            <div id="stock-list">
                <p style="text-align:center; padding:20px; color:#999;">正在連線雲端資料庫...</p>
            </div>
        </div>
    </div>

    <div id="tab-in" class="tab-content" style="display:none;"></div>
    <div id="tab-out" class="tab-content" style="display:none;"></div>
    <div id="tab-history" class="tab-content" style="display:none;"></div>
    <div id="tab-settings" class="tab-content" style="display:none;"></div>

    <div id="print-preview-zone" style="display:none; position:fixed; top:0; left:0; width:100%; height:100%; background:white; z-index:10000; overflow-y:auto; padding:20px;">
        <div style="margin-bottom:20px; display:flex; gap:10px;" class="no-print">
            <button class="btn btn-primary" style="width:auto; padding:8px 20px;" onclick="window.print()">執行列印</button>
            <button class="btn btn-danger" style="width:auto; padding:8px 20px;" onclick="closePreview()">關閉預覽</button>
        </div>
        <div id="print-canvas-area"></div>
    </div>
</div>

<script>
    // --- UI 切換邏輯 ---
    function switchTab(tabId, el) {
        // 隱藏所有分頁內容
        document.querySelectorAll('.tab-content').forEach(c => c.style.display = 'none');
        // 移除所有 Tab 的選中狀態
        document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
        
        // 顯示目標分頁
        const target = document.getElementById('tab-' + tabId);
        if (target) {
            target.style.display = 'block';
            el.classList.add('active');
        }

        // 觸發對應分頁的渲染
        if(tabId === 'stock') renderStockList();
        if(tabId === 'in') initInboundUI();
        if(tabId === 'out') initOutboundUI();
        if(tabId === 'history') renderHistory();
        if(tabId === 'settings') initSettingsUI();
    }

    // 更新標頭資訊
    function updateUIHeaders() {
        document.getElementById('comp-name-display').innerText = compName;
        document.getElementById('user-display').innerText = currentUser ? `帳號: ${currentUser.u}` : '';
    }

    // 關閉列印預覽
    function closePreview() {
        document.getElementById('print-preview-zone').style.display = 'none';
    }
</script>
// --- 1. 初始化入庫頁面 UI ---
function initInboundUI() {
    const h = `
        <div class="card">
            <h3>掃描 / 手動入庫</h3>
            <div id="reader" style="width: 100%; background: #000; border-radius: 8px; overflow: hidden;"></div>
            <div style="display: flex; gap: 5px; margin-top: 10px;">
                <button class="btn btn-primary" onclick="startScanner()">開啟相機</button>
                <button class="btn btn-danger" onclick="stopScanner()">關閉相機</button>
            </div>
            <hr>
            <select id="in-vCode" onchange="updateModelOptions()"><option value="">選擇廠商</option></select>
            <select id="in-braId"><option value="">選擇型號</option></select>
            <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 5px;">
                <select id="in-color"><option value="">顏色</option></select>
                <input type="text" id="in-size" placeholder="尺寸 (如 34B / L)">
            </div>
            <input type="number" id="in-qty" placeholder="入庫數量" value="1">
            <button id="in-submit-btn" class="btn btn-primary" onclick="submitInbound()">確認入庫同步</button>
        </div>
    `;
    document.getElementById('tab-in').innerHTML = h;
    populateInboundDropdowns();
}

// --- 2. 下拉選單連動邏輯 ---
function populateInboundDropdowns() {
    const vSelect = document.getElementById('in-vCode');
    vendors.forEach(v => vSelect.add(new Option(v.vName || v.vCode, v.vCode)));
    
    const cSelect = document.getElementById('in-color');
    colors.forEach(c => cSelect.add(new Option(c.cName, c.cCode)));
}

function updateModelOptions() {
    const vCode = document.getElementById('in-vCode').value;
    const mSelect = document.getElementById('in-braId');
    mSelect.innerHTML = '<option value="">選擇型號</option>';
    models.filter(m => m.vCode === vCode).forEach(m => mSelect.add(new Option(m.braId, m.braId)));
}

// --- 3. 相機掃描控制 ---
function startScanner() {
    html5QrCode = new Html5Qrcode("reader");
    html5QrCode.start(
        { facingMode: "environment" }, 
        { fps: 10, qrbox: 250 },
        (txt) => {
            stopScanner();
            playBeep();
            handleScannedText(txt);
        }
    ).catch(err => alert("相機啟動失敗: " + err));
}

function stopScanner() {
    if (html5QrCode) {
        html5QrCode.stop().then(() => { html5QrCode = null; });
    }
}

function handleScannedText(txt) {
    const p = txt.split(',');
    if (p.length >= 2) {
        document.getElementById('in-vCode').value = p[0];
        updateModelOptions();
        document.getElementById('in-braId').value = p[1];
        if(p[2]) document.getElementById('in-color').value = p[2];
        if(p[3]) document.getElementById('in-size').value = p[3];
        alert("掃描成功：" + p[1]);
    }
}

// --- 4. 提交資料到雲端 (POST) ---
async function submitInbound() {
    const v = document.getElementById('in-vCode').value;
    const m = document.getElementById('in-braId').value;
    const q = document.getElementById('in-qty').value;
    
    if(!v || !m || !q) return alert("請填寫完整資訊");

    const btn = document.getElementById('in-submit-btn');
    btn.disabled = true;
    btn.innerText = "同步中...";

    try {
        await fetch(GAS_URL, {
            method: 'POST',
            mode: 'no-cors',
            body: JSON.stringify({
                action: "processTransaction",
                vCode: v,
                braId: m,
                c: document.getElementById('in-color').value,
                bz: document.getElementById('in-size').value,
                qty: q,
                type: 'IN'
            })
        });
        
        alert("同步成功！");
        await loadAllData(); 
        switchTab('stock', document.querySelector('.tab'));
    } catch (err) {
        alert("失敗: " + err.message);
    } finally {
        btn.disabled = false;
        btn.innerText = "確認入庫同步";
    }
}

function playBeep() {
    const actx = new (window.AudioContext || window.webkitAudioContext)();
    const osc = actx.createOscillator();
    osc.connect(actx.destination);
    osc.start();
    osc.stop(actx.currentTime + 0.1);
}
// --- 1. 庫存列表渲染 ---
function renderStockList() {
    const s = document.getElementById('stockSearch').value.toLowerCase();
    const list = document.getElementById('stock-list');
    let h = '';
    
    inventory.filter(i => (i.vCode + i.braId).toLowerCase().includes(s)).forEach(i => {
        h += `
            <div class="stock-item">
                <div class="stock-info">
                    <b>${i.braId}</b><br><small>${i.vCode} | ${i.c || 'N/A'}</small>
                </div>
                <div class="stock-qty" style="color:${i.bq <= 2 ? 'red' : 'var(--primary)'}">${i.bq}</div>
                <button class="btn" style="width:auto; padding:5px 10px; font-size:12px;" 
                    onclick="openLabelPreview('${i.vCode}','${i.braId}','${i.c}','${i.bz}')">標籤</button>
            </div>
        `;
    });
    list.innerHTML = h || '<p style="text-align:center; padding:20px;">無匹配資料</p>';
    updateUIHeaders();
}

// --- 2. 出貨結帳 ---
function initOutboundUI() {
    document.getElementById('tab-out').innerHTML = `
        <div class="card">
            <h3>出貨結帳 (自動扣庫存)</h3>
            <input type="text" id="out-v" placeholder="廠商">
            <input type="text" id="out-m" placeholder="型號">
            <input type="number" id="out-q" placeholder="數量" value="1">
            <button class="btn btn-primary" style="background:var(--success);" onclick="finalizeCloudSale()">確認結帳同步</button>
        </div>
    `;
}

async function finalizeCloudSale() {
    const v = document.getElementById('out-v').value;
    const m = document.getElementById('out-m').value;
    const q = document.getElementById('out-q').value;
    if(!v || !m) return alert("請填資料");

    try {
        await fetch(GAS_URL, {
            method: 'POST',
            mode: 'no-cors',
            body: JSON.stringify({ action: "processTransaction", vCode: v, braId: m, qty: q, type: 'OUT' })
        });
        alert("出貨已紀錄");
        await loadAllData();
        switchTab('stock', document.querySelector('.tab'));
    } catch(e) { alert("同步失敗"); }
}

// --- 3. 銷售紀錄渲染 ---
function renderHistory() {
    let h = `<h3>銷售紀錄 (雲端同步)</h3><div class="card">`;
    salesHistory.reverse().forEach(s => {
        h += `<div style="padding:8px 0; border-bottom:1px solid #eee; display:flex; justify-content:space-between;">
                <span>${s.日期.split('T')[0]} ${s.品名}</span>
                <b>$${s.單價 || 0} x ${s.數量}</b>
              </div>`;
    });
    document.getElementById('tab-history').innerHTML = h + `</div>`;
}

// --- 4. 系統設定與標籤 ---
function initSettingsUI() {
    document.getElementById('tab-settings').innerHTML = `
        <div class="card">
            <h3>系統設定</h3>
            <p>店名：${compName}</p>
            <button class="btn btn-danger" onclick="sessionStorage.clear(); location.reload();">登出系統</button>
        </div>
    `;
}

function openLabelPreview(v, m, c, z) {
    const area = document.getElementById('print-canvas-area');
    area.innerHTML = '';
    document.getElementById('print-preview-zone').style.display = 'block';
    const div = document.createElement('div');
    div.className = 'print-label';
    const can = document.createElement('canvas');
    const txt = document.createElement('div');
    txt.innerHTML = `<b>${v} / ${m}</b><br>${c} ${z}`;
    div.appendChild(can);
    div.appendChild(txt);
    area.appendChild(div);
    new QRious({ element: can, value: `${v},${m},${c},${z}`, size: 80 });
}

// 最後補上渲染啟動
function render() {
    renderStockList();
}
</script>
</body>
</html>
