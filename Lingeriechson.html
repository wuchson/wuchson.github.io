<!DOCTYPE html>
<html lang="zh-Hant">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Lingerie Pro - é›²ç«¯ç‰ˆ</title>
    <script src="https://unpkg.com/html5-qrcode"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/qrious/4.0.2/qrious.min.js"></script>
    <style>
        /* æ¨£å¼ä¿ç•™åŸå§‹è¨­è¨ˆ */
        :root { --primary: #8da399; --accent: #d4a373; --bg: #f9f7f2; --card-bg: #ffffff; --border: #e0dcd0; --danger: #e53e3e; --success: #48bb78; }
        body { font-family: -apple-system, "Noto Sans TC", sans-serif; background: var(--bg); margin: 0; padding: 10px; color: #444; }
        .container { max-width: 600px; margin: auto; }
        .card { background: var(--card-bg); border-radius: 12px; padding: 15px; margin-bottom: 15px; border: 1px solid var(--border); box-shadow: 0 2px 4px rgba(0,0,0,0.05); }
        h3 { color: #6b7e75; border-left: 4px solid var(--accent); padding-left: 10px; margin: 0 0 15px 0; font-size: 1rem; }
        input, select { width: 100%; padding: 12px; margin: 5px 0; border: 1px solid var(--border); border-radius: 8px; box-sizing: border-box; }
        button { width: 100%; padding: 12px; border-radius: 8px; border: none; background: var(--primary); color: white; font-weight: bold; cursor: pointer; margin: 5px 0; }
        .admin-only { display: none; }
        body.is-admin .admin-only { display: block; }
        #login-overlay { position: fixed; inset: 0; background: var(--bg); z-index: 9999; display: flex; align-items: center; justify-content: center; }
        .tag { background: #f0f2f1; padding: 5px 10px; border-radius: 6px; font-size: 0.8rem; border: 1px solid #e0e5e3; display: inline-block; margin: 2px; }
        table { width: 100%; border-collapse: collapse; font-size: 0.85rem; }
        th, td { padding: 8px; border-bottom: 1px solid #eee; text-align: left; }
    </style>
</head>
<body>

<div id="login-overlay">
    <div class="card" style="width: 300px;">
        <h2 style="text-align:center;">é›²ç«¯ç™»å…¥</h2>
        <input type="text" id="loginU" placeholder="å¸³è™Ÿ">
        <input type="password" id="loginP" placeholder="å¯†ç¢¼">
        <button onclick="login()" id="loginBtn">é€£ç·šä¸­...</button>
    </div>
</div>

<div class="container">
    <div style="text-align: right; font-size: 12px;" id="userStatus"></div>
    
    <div class="card admin-only">
        <h3>1. åŸºç¤è¨­å®š</h3>
        <input type="text" id="vCode" placeholder="å» å•†ä»£ç¢¼">
        <input type="text" id="vName" placeholder="å» å•†åç¨±">
        <button onclick="addVendor()">æ–°å¢å» å•†</button>
        <div id="vendorList"></div>
        <hr>
        <input type="text" id="colorCode" placeholder="é¡è‰²ä»£ç¢¼ (å¦‚ BLK)">
        <input type="text" id="colorName" placeholder="é¡è‰²åç¨± (å¦‚ é»‘è‰²)">
        <button onclick="addColor()" class="btn-accent">æ–°å¢é¡è‰²</button>
        <div id="colorList"></div>
    </div>

    <div class="card">
        <h3>2. é€²å‡ºè²¨æ“ä½œ</h3>
        <select id="selVendor" onchange="updateModelSel()"></select>
        <select id="selModel"></select>
        <select id="selColor"></select>
        <div style="display: flex; gap: 5px;">
            <select id="selSize"><option value="-">å°ºç¢¼-</option><option value="S">S</option><option value="M">M</option><option value="L">L</option><option value="XL">XL</option></select>
            <input type="number" id="inQty" value="1" style="width: 80px;">
        </div>
        <button onclick="handleStock(1)" style="background: var(--success);">ğŸ“¥ æ‰‹å‹•å…¥åº«</button>
    </div>

    <div class="card">
        <h3>3. åº«å­˜åˆ—è¡¨ (é›²ç«¯å³æ™‚)</h3>
        <table>
            <thead><tr><th>å‹è™Ÿ</th><th>è¦æ ¼</th><th>å­˜é‡</th><th>æ“ä½œ</th></tr></thead>
            <tbody id="stockTable"></tbody>
        </table>
    </div>
</div>

<script>
    // è«‹å¡«å…¥ä½ çš„ Google Apps Script ç¶²å€
    const API_URL = "https://script.google.com/macros/s/AKfycbw024HTgRh6mLXCl1FmG6mTelAY11vwqS74ko0QZR7bEh6w9FXUfe2rBgjrxXy_7o19/exec";

    let vendors = [], models = [], colors = [], inventory = [], users = [];
    let curUser = null;

    async function api(action, sheet, payload = null) {
        try {
            const res = await fetch(API_URL, {
                method: 'POST',
                body: JSON.stringify({ action, sheet, payload })
            });
            return action === 'readAll' ? await res.json() : true;
        } catch (e) { console.error(e); return null; }
    }

    async function init() {
        users = await api('readAll', 'USERS') || [{u:'admin', p:'1234', r:'admin'}];
        vendors = await api('readAll', 'VENDORS') || [];
        colors = await api('readAll', 'COLORS') || [];
        inventory = await api('readAll', 'INVENTORY') || [];
        document.getElementById('loginBtn').innerText = "ç™»å…¥";
    }

    function login() {
        const u = document.getElementById('loginU').value;
        const p = document.getElementById('loginP').value;
        const user = users.find(x => x.u === u && x.p === p);
        if (user) {
            curUser = user;
            document.getElementById('login-overlay').style.display = 'none';
            document.getElementById('userStatus').innerText = `ä½¿ç”¨è€…: ${u}`;
            if (user.r === 'admin') document.body.classList.add('is-admin');
            render();
        } else { alert("å¸³å¯†éŒ¯èª¤"); }
    }

    function render() {
        document.getElementById('vendorList').innerHTML = vendors.map(v => `<span class="tag">${v.code}</span>`).join('');
        document.getElementById('colorList').innerHTML = colors.map(c => `<span class="tag">${c.name}</span>`).join('');
        document.getElementById('selVendor').innerHTML = vendors.map(v => `<option value="${v.code}">${v.name}</option>`).join('');
        document.getElementById('selColor').innerHTML = colors.map(c => `<option value="${c.code}">${c.name}</option>`).join('');
        
        document.getElementById('stockTable').innerHTML = inventory.map((item, idx) => `
            <tr>
                <td>${item.braId}</td>
                <td>${item.c} / ${item.bz}</td>
                <td><b>${item.bq}</b></td>
                <td><button style="width:auto; padding:5px;" onclick="adjQty(${idx}, 1)">+</button></td>
            </tr>
        `).join('');
    }

    async function addVendor() {
        const code = document.getElementById('vCode').value;
        const name = document.getElementById('vName').value;
        if (!code || !name) return;
        vendors.push({code, name});
        await api('syncFull', 'VENDORS', vendors);
        render();
    }

    async function addColor() {
        const code = document.getElementById('colorCode').value;
        const name = document.getElementById('colorName').value;
        if (!code || !name) return;
        colors.push({code, name});
        await api('syncFull', 'COLORS', colors);
        render();
    }

    async function handleStock(q) {
        const vCode = document.getElementById('selVendor').value;
        const braId = "TEST-ID"; // ç°¡åŒ–é‚è¼¯
        const c = document.getElementById('selColor').value;
        const bz = document.getElementById('selSize').value;
        const bq = document.getElementById('inQty').value;
        
        let item = inventory.find(x => x.vCode === vCode && x.c === c && x.bz === bz);
        if (item) item.bq = parseInt(item.bq) + parseInt(bq);
        else inventory.push({vCode, braId, c, bb:'-', bc:'-', bz, bq});
        
        render();
        await api('syncFull', 'INVENTORY', inventory);
        alert("åŒæ­¥æˆåŠŸ");
    }

    async function adjQty(idx, d) {
        inventory[idx].bq = parseInt(inventory[idx].bq) + d;
        render();
        await api('syncFull', 'INVENTORY', inventory);
    }

    window.onload = init;
</script>
</body>
</html>
