<!DOCTYPE html>
<html lang="zh-Hant">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Lingerie Pro é›²ç«¯ç‰ˆ</title>
    <script src="https://unpkg.com/html5-qrcode"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/qrious/4.0.2/qrious.min.js"></script>
    <style>
        :root {
            --primary: #8da399; --accent: #d4a373; --bg: #f9f7f2; --card-bg: #ffffff; 
            --border: #e0dcd0; --danger: #e53e3e; --success: #48bb78;
            /* A4 æ¨™ç±¤åˆ—å°åƒæ•¸ */
            --a4-mt: 15.5mm; --a4-ml: 6.5mm; --a4-gx: 2.5mm; --a4-gy: 0mm;
        }
        body { font-family: -apple-system, "Noto Sans TC", sans-serif; background: var(--bg); margin: 0; padding: 10px; color: #444; }
        .container { max-width: 600px; margin: auto; }
        .card { background: var(--card-bg); border-radius: 12px; padding: 15px; margin-bottom: 15px; border: 1px solid var(--border); box-shadow: 0 2px 4px rgba(0,0,0,0.05); }
        
        /* æ¬Šé™æ§åˆ¶ */
        .admin-only { display: none; }
        body.is-admin .admin-only { display: block !important; }
        
        /* ç™»å…¥é®ç½© */
        #login-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: var(--bg); z-index: 9999; display: flex; align-items: center; justify-content: center; }
        .login-card { width: 90%; max-width: 350px; background: white; padding: 30px; border-radius: 15px; box-shadow: 0 10px 25px rgba(0,0,0,0.1); text-align: center; }
        
        /* è¼¸å…¥èˆ‡æŒ‰éˆ• */
        .row-inputs { display: flex; gap: 8px; margin-bottom: 10px; flex-wrap: wrap; }
        input, select { flex: 1; min-width: 80px; padding: 12px; font-size: 16px; border: 1px solid var(--border); border-radius: 8px; box-sizing: border-box; background: #fff; height: 48px; }
        button { width: 100%; padding: 14px; font-size: 16px; border: none; border-radius: 8px; background: var(--primary); color: white; font-weight: bold; cursor: pointer; }
        button:disabled { background: #ccc; cursor: not-allowed; }
        .btn-accent { background: var(--accent); }
        .btn-success { background: var(--success); }
        .btn-danger { background: var(--danger); }
        
        /* è¡¨æ ¼æ¨£å¼ */
        table { width: 100%; border-collapse: collapse; margin-top: 10px; }
        th, td { padding: 12px 8px; text-align: left; border-bottom: 1px solid #eee; }
        .tag { background: #f0f2f1; padding: 4px 8px; border-radius: 4px; font-size: 0.75rem; border: 1px solid #e0e5e3; }
        
        @media print { .no-print { display: none !important; } #print-area { display: block !important; } }
    </style>
</head>
<body>
    <div id="login-overlay">
        <div class="login-card">
            <h2 style="color:var(--primary); margin:0 0 10px 0;">Lingerie Pro</h2>
            <p style="font-size:0.85rem; color:#888; margin-bottom:20px;">é›²ç«¯åŒæ­¥ç®¡ç†ç³»çµ±</p>
            <input type="text" id="login-u" placeholder="å¸³è™Ÿ (u)" style="margin-bottom:10px;">
            <input type="password" id="login-p" placeholder="å¯†ç¢¼ (p)" style="margin-bottom:20px;">
            <button id="login-btn" onclick="login()">é€²å…¥ç³»çµ±</button>
            <p id="login-msg" style="font-size:0.85rem; margin-top:15px;"></p>
        </div>
    </div>

    <div class="container no-print">
        <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:15px;">
            <div>
                <strong id="display-compName" style="font-size:1.1rem; color:var(--primary);">æ­£åœ¨è¼‰å…¥é›²ç«¯è¨­å®š...</strong>
                <div id="userStatus" style="font-size:0.75rem; color:#888;">ç­‰å¾…ç™»å…¥ä¸­</div>
            </div>
            <button class="btn-danger" style="width:auto; padding:5px 12px; font-size:14px;" onclick="logout()">ç™»å‡º</button>
        </div>

        <div class="card">
            <div id="scanner-container" style="display:none; margin-bottom:15px; border-radius:12px; overflow:hidden;">
                <div id="reader"></div>
                <button class="btn-danger" style="border-radius:0;" onclick="toggleScanner(false)">é—œé–‰ç›¸æ©Ÿ</button>
            </div>
            <button id="scan-btn" class="btn-accent" onclick="toggleScanner(true)" style="margin-bottom:15px;">ğŸ“· é–‹å•Ÿæƒææ§</button>

            <div class="row-inputs">
                <select id="vCode" onchange="updateBraOptions()"><option value="">é¸æ“‡å» å•†</option></select>
                <select id="braId"><option value="">é¸æ“‡å‹è™Ÿ</option></select>
                <select id="cCode"><option value="">é¡è‰²</option></select>
            </div>
            <div class="row-inputs">
                <select id="bb">
                    <option value="-">ä¸‹åœ</option><option value="70">70</option><option value="75">75</option>
                    <option value="80">80</option><option value="85">85</option><option value="90">90</option>
                </select>
                <select id="bc">
                    <option value="-">ç½©æ¯</option><option value="A">A</option><option value="B">B</option>
                    <option value="C">C</option><option value="D">D</option><option value="E">E</option>
                </select>
                <select id="bz">
                    <option value="-">å°ºç¢¼</option><option value="M">M</option><option value="L">L</option>
                    <option value="XL">XL</option><option value="Q">Q</option><option value="2Q">2Q</option>
                </select>
                <input type="number" id="bq" value="1" style="max-width:70px;">
            </div>
            <div style="display:flex; gap:10px;">
                <button class="btn-success" onclick="handleStock(1)">â• å…¥åº«åŒæ­¥</button>
                <button class="btn-danger" onclick="handleStock(-1)">â– å‡ºè²¨åŒæ­¥</button>
            </div>
        </div>

        <div class="admin-only">
            <div class="card" style="background:#fffaf0; border: 1px dashed var(--accent);">
                <h3 style="font-size:14px; margin-bottom:10px; color:var(--accent);">âš™ï¸ ç®¡ç†å“¡æ§åˆ¶é¢æ¿</h3>
                <div style="display:grid; grid-template-columns:1fr 1fr; gap:10px;">
                    <button class="btn-accent" onclick="prepareLabelPrint()">ğŸ·ï¸ åˆ—å°æ¨™ç±¤</button>
                    <button class="btn-accent" onclick="showSales()">ğŸ“Š ç‡Ÿæ¥­çµ±è¨ˆ</button>
                </div>
            </div>
        </div>

        <div class="card">
            <h3 style="font-size:14px; margin-bottom:10px;">ğŸ“¦ ç›®å‰é›²ç«¯åº«å­˜</h3>
            <div style="overflow-x:auto;">
                <table id="inventoryTable">
                    <thead>
                        <tr><th>å•†å“</th><th>è¦æ ¼</th><th>æ•¸é‡</th><th>æ“ä½œ</th></tr>
                    </thead>
                    <tbody></tbody>
                </table>
            </div>
        </div>
    </div>

    <div id="print-area" style="display:none;"></div>
<script>
    // ==========================================
    // 1. æ ¸å¿ƒè¨­å®š (å·²åµŒå…¥å¦³æä¾›çš„æœ€æ–° GAS URL)
    // ==========================================
    const GAS_URL = "https://script.google.com/macros/s/AKfycbzd7Er_INBVPum15y2VGOu9siQjmlFmiwKgaPifrj0MyQpu0yY9fao8fuH_XW6-vvyn/exec";
    
    let inventory = [], vendors = [], colors = [], models = [], salesHistory = [];
    let invoiceItems = [];
    let currentUser = null, compName = "é›²ç«¯ç®¡ç†ç³»çµ±", taxRate = 0.05;
    let html5QrCode = null;

    // ==========================================
    // 2. ğŸ” ç™»å…¥åŠŸèƒ½ (ç¢ºä¿èˆ‡å¦³çš„ USERS åˆ†é  100% åŒ¹é…)
    // ==========================================
    async function login() {
        const u = document.getElementById('login-u').value.trim();
        const p = document.getElementById('login-p').value.trim();
        const msg = document.getElementById('login-msg');
        const btn = document.getElementById('login-btn');
        
        if(!u || !p) {
            msg.innerText = "è«‹è¼¸å…¥å¸³è™Ÿå¯†ç¢¼";
            return;
        }

        btn.disabled = true;
        msg.style.color = "blue";
        msg.innerText = "æ­£åœ¨å–šé†’é›²ç«¯è³‡æ–™åº«...";

        try {
            // è®€å–æ‰€æœ‰è³‡æ–™
            const res = await fetch(`${GAS_URL}?action=loadAll&t=${new Date().getTime()}`);
            if (!res.ok) throw new Error("ç¶²è·¯é€£ç·šå¤±æ•—");
            
            const data = await res.json();
            console.log("é›²ç«¯åŸå§‹è³‡æ–™:", data);

            // é©—è­‰é‚è¼¯ (å°æ‡‰å¦³æˆªåœ–çš„ u, p, r æ¬„ä½)
            const user = data.users.find(user => user.u === u && String(user.p) === p);
            
            if (user) {
                currentUser = user;
                // å¦‚æœæ¬Šé™ (r) æ˜¯ adminï¼Œé–‹å•Ÿéš±è—åŠŸèƒ½
                if(user.r === 'admin') document.body.classList.add('is-admin');
                
                // åˆ†é…è³‡æ–™
                vendors = data.vendors || [];
                colors = data.colors || [];
                models = data.models || [];
                salesHistory = data.sales || [];
                
                // è½‰æ›åº«å­˜æ ¼å¼ (å°‡ GAS çš„ qty è½‰ç‚ºç¶²é ç”¨çš„ bq)
                inventory = (data.inventory || []).map(i => ({
                    vCode: i.vCode, braId: i.braId, c: i.c, bb: i.bb, bc: i.bc, bz: i.bz, bq: Number(i.qty)
                }));
                
                // å…¬å¸åç¨±è¨­å®š
                const cn = (data.config || []).find(c => c.key === "companyName");
                if(cn) compName = cn.value;

                // é€²å…¥ç³»çµ±
                document.getElementById('login-overlay').style.display = 'none';
                document.getElementById('userStatus').innerText = `é€£ç·šèº«ä»½ï¼š${user.u} (${user.r})`;
                initSelectors();
                render();
            } else {
                msg.style.color = "red";
                msg.innerText = "å¸³è™Ÿæˆ–å¯†ç¢¼éŒ¯èª¤";
                btn.disabled = false;
            }
        } catch (e) {
            console.error("ç™»å…¥éŒ¯èª¤ç´°ç¯€:", e);
            msg.style.color = "red";
            msg.innerText = "é€£ç·šå¤±æ•—ï¼è«‹æª¢æŸ¥ GAS éƒ¨ç½²æ¬Šé™æˆ–ç¶²å€æ˜¯å¦æ­£ç¢º";
            btn.disabled = false;
        }
    }

    // ==========================================
    // 3. â˜ï¸ é›²ç«¯åŒæ­¥è¼”åŠ©å‡½å¼ (POST è«‹æ±‚)
    // ==========================================
    async function syncToCloud(payload) {
        try {
            await fetch(GAS_URL, {
                method: "POST",
                mode: "no-cors", 
                headers: { "Content-Type": "application/json" },
                body: JSON.stringify(payload)
            });
            console.log("é›²ç«¯æŒ‡ä»¤å·²é€å‡º:", payload.action);
        } catch (e) {
            console.error("é›²ç«¯åŒæ­¥å¤±æ•—:", e);
        }
    }
</script>
// ==========================================
    // 4. ğŸ“¦ é€²å‡ºè²¨è™•ç† (åŒæ­¥æ›´æ–°åº«å­˜)
    // ==========================================
    async function handleStock(direction) {
        const vCode = document.getElementById('vCode').value;
        const braId = document.getElementById('braId').value;
        const c = document.getElementById('cCode').value;
        const bb = document.getElementById('bb').value;
        const bc = document.getElementById('bc').value;
        const bz = document.getElementById('bz').value;
        const qVal = Number(document.getElementById('bq').value);
        const qty = qVal * direction;

        if (!vCode || !braId || !c) return alert("è«‹å®Œæ•´é¸æ“‡å» å•†ã€å‹è™Ÿèˆ‡é¡è‰²");

        // UI å³æ™‚æ›´æ–° (è®“å¦³ä¸ç”¨ç­‰é›²ç«¯è½‰åœˆåœˆ)
        let item = inventory.find(i => i.vCode===vCode && i.braId===braId && i.c===c && i.bb===bb && i.bc===bc && i.bz===bz);
        if (item) item.bq += qty;
        else inventory.push({ vCode, braId, c, bb, bc, bz, bq: qty });
        
        render();
        playBeep();

        // åŒæ­¥è‡³ Google è©¦ç®—è¡¨ (action: processTransaction)
        const m = models.find(mod => mod.braId === braId) || {};
        await syncToCloud({
            action: "processTransaction",
            vCode, braId, c, bb, bc, bz,
            qty: Math.abs(qty),
            type: direction > 0 ? 'IN' : 'OUT',
            price: m.price || 0
        });
    }

    // ==========================================
    // 5. ğŸ·ï¸ æ¨™ç±¤åˆ—å° (QR Code ç”¢ç”Ÿé‚è¼¯)
    // ==========================================
    function prepareLabelPrint() {
        const v = document.getElementById('vCode').value;
        const b = document.getElementById('braId').value;
        const m = models.find(i => i.vCode === v && i.braId === b);
        if(!m) return alert("è«‹å…ˆé¸æ“‡è¦åˆ—å°çš„å‹è™Ÿ");

        const c = document.getElementById('cCode').value;
        const bb = document.getElementById('bb').value;
        const bc = document.getElementById('bc').value;
        const bz = document.getElementById('bz').value;

        const printZone = document.getElementById('print-area');
        printZone.innerHTML = ''; 
        
        const div = document.createElement('div');
        div.style.padding = "10px";
        div.style.textAlign = "center";
        const can = document.createElement('canvas');
        const txt = document.createElement('div');
        txt.style.fontSize = "14px";
        txt.style.marginTop = "5px";
        txt.innerHTML = `<b>${m.vCode} / ${m.braId}</b><br>${getColorName(c)} ${bb}${bc} ${bz}`;
        
        new QRious({
            element: can,
            value: `${m.vCode},${m.braId},,${c},${bb},${bc},${bz}`,
            size: 120
        });
        
        div.appendChild(can);
        div.appendChild(txt);
        printZone.appendChild(div);
        
        printZone.style.display = 'block';
        window.print();
        printZone.style.display = 'none';
    }

    // ==========================================
    // 6. ğŸ“Š ç‡Ÿæ¥­çµ±è¨ˆ (æŠ“å–é›²ç«¯éŠ·å”®ç´€éŒ„)
    // ==========================================
    function showSales() {
        if(salesHistory.length === 0) return alert("ç›®å‰å°šç„¡éŠ·å”®ç´€éŒ„");
        let total = 0;
        let report = "--- é›²ç«¯ç‡Ÿæ¥­çµ±è¨ˆ ---\n\n";
        salesHistory.forEach(s => {
            const rowTotal = (Number(s.p) * Number(s.q));
            report += `${s.date.split('T')[0]} | ${s.id} | $${s.p} x ${s.q} = $${rowTotal}\n`;
            total += rowTotal;
        });
        report += `\nç¸½è¨ˆéŠ·è²¨é¡ï¼š$${total}`;
        alert(report);
    }

    // ==========================================
    // 7. ğŸ¨ ä»‹é¢è¼”åŠ©å‡½å¼ (Render & Initial)
    // ==========================================
    function render() {
        const tbody = document.querySelector('#inventoryTable tbody');
        tbody.innerHTML = '';
        document.getElementById('display-compName').innerText = compName;

        inventory.forEach((item, idx) => {
            if (item.bq === 0) return;
            const row = tbody.insertRow();
            row.innerHTML = `
                <td><strong>${item.vCode} / ${item.braId}</strong></td>
                <td><span class="tag">${getColorName(item.c)} ${item.bb}${item.bc} ${item.bz}</span></td>
                <td><b style="color:${item.bq < 3 ? 'red' : 'black'}">${item.bq}</b></td>
                <td><button class="btn-danger" style="padding:4px 8px; font-size:12px; width:auto;" onclick="inventory.splice(${idx},1);render();">ç§»é™¤é¡¯ç¤º</button></td>
            `;
        });
    }

    function initSelectors() {
        const vSel = document.getElementById('vCode'), cSel = document.getElementById('cCode');
        vSel.innerHTML = '<option value="">é¸æ“‡å» å•†</option>';
        cSel.innerHTML = '<option value="">é¡è‰²</option>';
        vendors.forEach(v => vSel.add(new Option(v.name, v.code)));
        colors.forEach(c => cSel.add(new Option(c.name, c.code)));
    }

    function updateBraOptions() {
        const v = document.getElementById('vCode').value;
        const bSel = document.getElementById('braId');
        bSel.innerHTML = '<option value="">é¸æ“‡å‹è™Ÿ</option>';
        models.filter(m => m.vCode === v).forEach(m => bSel.add(new Option(m.braId, m.braId)));
    }

    function getColorName(code) {
        const c = colors.find(i => i.code === code);
        return c ? c.name : code;
    }

    function playBeep() { 
        const a = new Audio('https://assets.mixkit.co/active_storage/sfx/766/766-preview.mp3');
        a.play().catch(()=>{});
    }

    function toggleScanner(show) {
        const container = document.getElementById('scanner-container');
        if (show) {
            container.style.display = 'block';
            html5QrCode = new Html5Qrcode("reader");
            html5QrCode.start({ facingMode: "environment" }, { fps: 10, qrbox: 250 }, (txt)=>{
                const p = txt.split(',');
                if(p.length>=7) {
                    document.getElementById('vCode').value = p[0]; updateBraOptions();
                    document.getElementById('braId').value = p[1];
                    document.getElementById('cCode').value = p[3];
                    document.getElementById('bb').value = p[4];
                    document.getElementById('bc').value = p[5];
                    document.getElementById('bz').value = p[6];
                    playBeep();
                    toggleScanner(false);
                }
            });
        } else if (html5QrCode) {
            html5QrCode.stop().then(() => { container.style.display = 'none'; });
        }
    }

    function logout() { location.reload(); }

    window.onload = () => { console.log("ç³»çµ±å·²å°±ç·’"); };
</script>
</body>
</html>
