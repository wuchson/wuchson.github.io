<!DOCTYPE html>
<html lang="zh-Hant">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Lingerie Pro Cloud - 雲端管理系統</title>
    <script src="https://unpkg.com/html5-qrcode"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/qrious/4.0.2/qrious.min.js"></script>
    <script>
        // --- 雲端設定區 ---
        // 請確保此網址與您部署的 GAS 網址一致
        const GAS_URL = "https://script.google.com/macros/s/AKfycbx1IBTg28rNwdoZbAkKV48eDEc7ZQ5ZVMQWXrhEvxWg5WwLkZk0qqSpNJch5wESMrAqKg/exec";
        
        // --- 全域變數 ---
        let currentUser = JSON.parse(sessionStorage.getItem('CUR_USER')) || null; [cite: 97]
        let users = [];
        let vendors = [];
        let models = [];
        let inventory = []; // 雲端抓回後會進行加總處理
        let colors = [];
        let salesHistory = [];
        let compName = "載入中..."; [cite: 110]
        let taxRate = 5; [cite: 110]
        let pCfg = { a4mt:15.5, a4ml:6.5, a4gx:2.5, a4gy:0, smt:0, sml:0 }; [cite: 112]

        // --- 初始化：從雲端載入所有資料 ---
        async function loadCloudData() {
            try {
                const response = await fetch(`${GAS_URL}?action=loadAll`);
                const data = await response.json();
                
                // 映射 GAS 分頁資料到前端變數 [cite: 191]
                users = data.users || [{u:'admin', p:'1234', r:'admin'}];
                vendors = data.vendors || [];
                colors = data.colors || [];
                models = data.models || [];
                salesHistory = data.sales || [];
                
                // 處理庫存加總：GAS 傳回的是流水帳，前端需加總 qty [cite: 157]
                inventory = processStockData(data.inventory || []);
                
                if(data.config && data.config.length > 0) {
                    compName = data.config[0].compName || "我的店舖";
                    taxRate = parseFloat(data.config[0].taxRate) || 5;
                }
                
                render(); // 呼叫第二部分的畫面渲染
            } catch (err) {
                console.error("雲端載入失敗:", err);
                alert("無法連線至雲端試算表，請檢查網路或 GAS 權限。");
            }
        }

        // 將流水帳轉換為目前庫存量 [cite: 157, 174]
        function processStockData(rawLogs) {
            const stockMap = {};
            rawLogs.forEach(log => {
                const key = `${log.vCode}|${log.braId}|${log.c}|${log.bb}|${log.bc}|${log.bz}`;
                const q = parseInt(log.qty) || 0;
                // 根據類型判斷加減 (IN 或 OUT) [cite: 160]
                if (!stockMap[key]) {
                    stockMap[key] = { ...log, bq: 0 };
                }
                stockMap[key].bq += (log.type === 'OUT' ? -q : q);
            });
            return Object.values(stockMap);
        }

        // --- 登入驗證 ---
        function checkAuth() {
            if(!currentUser) {
                document.getElementById('login-overlay').style.display = 'flex'; [cite: 101]
                return;
            }
            document.getElementById('login-overlay').style.display = 'none'; [cite: 102]
            loadCloudData(); // 登入成功後啟動雲端同步
        }

        function login() {
            const u = document.getElementById('loginUser').value;
            const p = document.getElementById('loginPass').value;
            const found = users.find(user => user.u === u && user.p === p); [cite: 98]
            if(found) {
                currentUser = found;
                sessionStorage.setItem('CUR_USER', JSON.stringify(found)); [cite: 99]
                checkAuth();
            } else { alert("帳號或密碼錯誤"); } [cite: 99]
        }
    </script>
<style>
        :root {
            --primary: #8da399; --accent: #d4a373; --bg: #f9f7f2; 
            --card-bg: #ffffff; --border: #e0dcd0; --danger: #e53e3e; --success: #48bb78;
        }
        * { box-sizing: border-box; -webkit-tap-highlight-color: transparent; }
        body { 
            font-family: -apple-system, "Noto Sans TC", sans-serif;
            background: var(--bg); margin: 0; padding: 10px; color: #444; 
            line-height: 1.5;
        }
        .container { max-width: 600px; margin: auto; padding-bottom: 80px; }
        
        /* 登入介面 */
        #login-overlay {
            position: fixed; top:0; left:0; width:100%; height:100%; 
            background: var(--bg); z-index: 9999; display: flex;
            flex-direction: column; align-items: center; justify-content: center;
        }
        .login-box { 
            background: var(--card-bg); padding: 30px; border-radius: 15px;
            box-shadow: 0 10px 25px rgba(0,0,0,0.05); width: 85%; max-width: 350px;
        }

        /* 導覽列 */
        .nav-tabs { 
            display: flex; overflow-x: auto; gap: 8px; margin-bottom: 15px;
            padding-bottom: 5px; scrollbar-width: none;
        }
        .nav-tabs::-webkit-scrollbar { display: none; }
        .tab { 
            padding: 8px 16px; background: #e0dcd0; border-radius: 20px;
            white-space: nowrap; font-size: 14px; cursor: pointer; transition: 0.3s;
        }
        .tab.active { background: var(--primary); color: white; }

        /* 卡片設計 */
        .card { 
            background: var(--card-bg); border-radius: 12px; padding: 15px;
            margin-bottom: 15px; box-shadow: 0 2px 8px rgba(0,0,0,0.03);
            border: 1px solid var(--border);
        }
        h3 { margin-top: 0; color: var(--primary); border-left: 4px solid var(--primary); padding-left: 10px; }

        /* 表單元素 */
        input, select { 
            width: 100%; padding: 12px; margin: 8px 0; border: 1px solid var(--border);
            border-radius: 8px; font-size: 16px; outline: none;
        }
        .btn { 
            width: 100%; padding: 12px; border: none; border-radius: 8px;
            font-size: 16px; font-weight: bold; cursor: pointer; transition: 0.2s;
        }
        .btn-primary { background: var(--primary); color: white; }
        .btn-accent { background: var(--accent); color: white; }
        .btn-danger { background: var(--danger); color: white; }

        /* 庫存表格 */
        .stock-item { 
            display: grid; grid-template-columns: 2fr 1fr 1fr auto;
            align-items: center; padding: 10px 0; border-bottom: 1px solid #eee;
        }
        .stock-info { font-size: 14px; }
        .stock-qty { font-weight: bold; color: var(--primary); text-align: center; }

        /* 列印預覽 */
        #print-preview-zone {
            display: none; position: fixed; top:0; left:0; width:100%; height:100%;
            background: white; z-index: 10000; overflow-y: auto; padding: 20px;
        }
    </style>
</head>
<body onload="checkAuth()">

<div id="login-overlay">
    <div class="login-box">
        <h2 style="text-align:center; color:var(--primary)">雲端庫存登入</h2>
        <input type="text" id="loginUser" placeholder="帳號">
        <input type="password" id="loginPass" placeholder="密碼">
        <button class="btn btn-primary" onclick="login()">登入系統</button>
        <p style="font-size:12px; color:#999; text-align:center; margin-top:15px;">v2.0 Cloud Sync Enabled</p>
    </div>
</div>

<div class="container">
    <header style="display:flex; justify-content:space-between; align-items:center;">
        <h2 id="store-name-display">載入中...</h2>
        <span id="user-tag" style="font-size:12px; background:#ddd; padding:2px 8px; border-radius:10px;"></span>
    </header>

    <div class="nav-tabs" id="main-nav">
        <div class="tab active" onclick="switchTab('stock')">庫存查詢</div>
        <div class="tab" onclick="switchTab('in')">入庫/掃描</div>
        <div class="tab" onclick="switchTab('out')">出貨結帳</div>
        <div class="tab" onclick="switchTab('history')">銷售紀錄</div>
        <div class="tab" onclick="switchTab('settings')">系統設定</div>
    </div>

    <div id="tab-stock" class="tab-content">
        <div class="card">
            <input type="text" id="stockSearch" placeholder="搜尋型號或廠商..." oninput="render()">
            <div id="stock-list">
                </div>
        </div>
    </div>

    <div id="tab-in" class="tab-content" style="display:none;"></div>
    <div id="tab-out" class="tab-content" style="display:none;"></div>
    <div id="tab-history" class="tab-content" style="display:none;"></div>
    <div id="tab-settings" class="tab-content" style="display:none;"></div>
</div>

<script>
    function switchTab(tabId) {
        document.querySelectorAll('.tab-content').forEach(c => c.style.display = 'none');
        document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
        document.getElementById('tab-' + tabId).style.display = 'block';
        event.currentTarget.classList.add('active');
    }

    // 更新介面標頭
    function updateUIHeaders() {
        document.getElementById('store-name-display').innerText = compName;
        document.getElementById('user-tag').innerText = currentUser ? currentUser.u : '';
    }
</script>
<script>
    let html5QrCode = null;

    // --- 初始化入庫頁面 UI ---
    function initInboundUI() {
        const h = `
            <div class="card">
                <h3>掃描入庫 / 手動輸入</h3>
                <div id="reader" style="width: 100%; background: #000; border-radius: 8px; overflow: hidden;"></div>
                <div style="display: flex; gap: 5px; margin-top: 10px;">
                    <button class="btn btn-accent" onclick="startScanner()">開啟相機</button>
                    <button class="btn btn-danger" onclick="stopScanner()">關閉相機</button>
                </div>
                <hr>
                <select id="in-vCode" onchange="updateModelSelect('in')"><option value="">選擇廠商</option></select>
                <select id="in-braId" onchange="updateDetailOptions('in')"><option value="">選擇型號</option></select>
                <div id="in-details" style="display: grid; grid-template-columns: 1fr 1fr; gap: 5px;">
                    <select id="in-color"><option value="">顏色</option></select>
                    <select id="in-size"><option value="">尺寸</option></select>
                </div>
                <input type="number" id="in-qty" placeholder="數量" value="1">
                <button class="btn btn-primary" onclick="submitTransaction('IN')">確認入庫</button>
            </div>
        `;
        document.getElementById('tab-in').innerHTML = h;
        populateDropdowns('in');
    }

    // --- 相機掃描邏輯 ---
    function startScanner() {
        html5QrCode = new Html5Qrcode("reader");
        html5QrCode.start(
            { facingMode: "environment" }, 
            { fps: 10, qrbox: { width: 250, height: 250 } },
            (decodedText) => {
                playBeep();
                handleScannedData(decodedText);
            }
        ).catch(err => alert("相機啟動失敗: " + err));
    }

    function stopScanner() {
        if (html5QrCode) {
            html5QrCode.stop().then(() => { html5QrCode = null; });
        }
    }

    // 處理掃描到的字串 (格式預設為: 廠商,型號,顏色,下圍,罩杯,尺碼)
    function handleScannedData(text) {
        const parts = text.split(',');
        if (parts.length >= 2) {
            document.getElementById('in-vCode').value = parts[0];
            updateModelSelect('in');
            document.getElementById('in-braId').value = parts[1];
            // 自動帶入其餘欄位...
            alert("掃描成功: " + parts[1]);
        }
    }

    // --- 核心：提交資料到 Google Sheets ---
    async function submitTransaction(type) {
        const v = document.getElementById('in-vCode').value;
        const b = document.getElementById('in-braId').value;
        const q = document.getElementById('in-qty').value;
        const c = document.getElementById('in-color').value;
        
        if(!v || !b || !q) return alert("請填寫完整資訊");

        const payload = {
            action: "processTransaction",
            vCode: v,
            braId: b,
            qty: parseInt(q),
            type: type, // "IN" 或 "OUT"
            c: c,
            bb: "", bc: "", bz: "" // 根據您的需求擴充
        };

        // 顯示載入中狀態
        const btn = event.target;
        const originalText = btn.innerText;
        btn.disabled = true;
        btn.innerText = "同步中...";

        try {
            // 使用 Google Apps Script 提供的網址
            await fetch(GAS_URL, {
                method: 'POST',
                mode: 'no-cors', // 解決跨域問題
                body: JSON.stringify(payload)
            });
            
            alert(type === 'IN' ? "入庫成功！" : "出貨成功！");
            loadCloudData(); // 重新抓取雲端最新庫存
        } catch (err) {
            alert("雲端儲存失敗: " + err.message);
        } finally {
            btn.disabled = false;
            btn.innerText = originalText;
        }
    }

    function playBeep() {
        const audioCtx = new (window.AudioContext || window.webkitAudioContext)();
        const osc = audioCtx.createOscillator();
        osc.connect(audioCtx.destination);
        osc.start();
        osc.stop(audioCtx.currentTime + 0.1);
    }

    // 初始化下拉選單邏輯 (省略細節，確保連動正確)
    function populateDropdowns(prefix) {
        const vs = document.getElementById(prefix + '-vCode');
        vendors.forEach(v => {
            let opt = document.createElement('option');
            opt.value = v.vCode; opt.text = v.vName;
            vs.add(opt);
        });
    }
</script>
<script>
    let invoiceItems = [];

    // --- 出貨結帳 UI ---
    function initOutboundUI() {
        const h = `
            <div class="card">
                <h3>出貨結帳 (自動扣庫存)</h3>
                <div id="out-scanner" style="width:100%; height:150px; background:#eee; border-radius:8px; display:flex; align-items:center; justify-content:center; cursor:pointer;" onclick="startScanner()">
                    點擊開啟相機掃描出貨
                </div>
                <div id="out-list" style="margin-top:10px;"></div>
                <div style="border-top:2px solid var(--primary); margin-top:10px; padding-top:10px;">
                    <div style="display:flex; justify-content:space-between; font-weight:bold;">
                        <span>總計金額</span><span id="out-total">$0</span>
                    </div>
                    <button class="btn btn-success" style="margin-top:10px;" onclick="finalizeSale()">確認結帳並扣庫存</button>
                </div>
            </div>
        `;
        document.getElementById('tab-out').innerHTML = h;
    }

    // --- 結帳邏輯 ---
    async function finalizeSale() {
        if (invoiceItems.length === 0) return alert("請先掃描商品");
        
        const btn = event.target;
        btn.disabled = true;
        btn.innerText = "雲端處理中...";

        try {
            // 逐筆發送出貨請求到 GAS
            for (let item of invoiceItems) {
                await fetch(GAS_URL, {
                    method: 'POST',
                    mode: 'no-cors',
                    body: JSON.stringify({
                        action: "processTransaction",
                        type: "OUT",
                        vCode: item.vCode,
                        braId: item.braId,
                        qty: item.qty,
                        price: item.price,
                        c: item.color
                    })
                });
            }
            alert("結帳完成，雲端庫存已更新");
            invoiceItems = [];
            loadCloudData(); // 重新同步
        } catch (err) {
            alert("結帳失敗：" + err.message);
        } finally {
            btn.disabled = false;
            btn.innerText = "確認結帳並扣庫存";
        }
    }

    // --- 銷售紀錄與統計 ---
    function renderHistory() {
        let h = `<h3>銷售紀錄 (雲端同步)</h3>`;
        let total = 0;
        salesHistory.forEach(s => {
            total += (s.qty * s.price);
            h += `
                <div class="stock-item">
                    <div class="stock-info">
                        <b>${s.品名 || '未命名'}</b><br>
                        <small>${new Date(s.日期).toLocaleString()}</small>
                    </div>
                    <div class="stock-qty">${s.qty} 件</div>
                    <div style="text-align:right;">$${s.price * s.qty}</div>
                </div>
            `;
        });
        h += `<div style="text-align:right; font-weight:bold; padding:10px;">累計營收：$${total}</div>`;
        document.getElementById('tab-history').innerHTML = `<div class="card">${h}</div>`;
    }

    // --- 標籤列印功能 (QR Code) ---
    function printLabel(vCode, braId) {
        const qrSize = 80;
        const canvas = document.createElement('canvas');
        new QRious({
            element: canvas,
            value: `${vCode},${braId}`, // 格式需與掃描端一致
            size: qrSize
        });
        
        const win = window.open('', 'Print', 'width=400,height=400');
        win.document.write(`
            <div style="text-align:center; font-family:sans-serif;">
                <img src="${canvas.toDataURL()}" /><br>
                <b style="font-size:12px;">${vCode} / ${braId}</b>
            </div>
        `);
        win.document.close();
        win.print();
    }

    // --- 主渲染邏輯 ---
    function render() {
        updateUIHeaders();
        renderStockList();
        renderHistory();
        initInboundUI();
        initOutboundUI();
    }

    function renderStockList() {
        const search = document.getElementById('stockSearch').value.toLowerCase();
        let h = '';
        inventory.filter(i => (i.vCode + i.braId).toLowerCase().includes(search)).forEach(i => {
            h += `
                <div class="stock-item">
                    <div class="stock-info">
                        <b>${i.braId}</b><br><small>${i.vCode} | ${i.c || '通用'}</small>
                    </div>
                    <div class="stock-qty" style="color:${i.bq < 5 ? 'red' : 'var(--primary)'}">${i.bq}</div>
                    <button onclick="printLabel('${i.vCode}','${i.braId}')" style="font-size:10px;">標籤</button>
                </div>
            `;
        });
        document.getElementById('stock-list').innerHTML = h;
    }
</script>

</body>
</html>
