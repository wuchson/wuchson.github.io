<!DOCTYPE html>
<html lang="zh-Hant">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Lingerie Pro - é›²ç«¯æ™ºæ…§åº«å­˜ç®¡ç†ç³»çµ±</title>
    <script src="https://unpkg.com/html5-qrcode"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/qrious/4.0.2/qrious.min.js"></script>
    <style>
        :root {
            --primary: #8da399; --accent: #d4a373; --bg: #f9f7f2; --card-bg: #ffffff; --border: #e0dcd0; --danger: #e53e3e; --success: #48bb78;
            --a4-mt: 15.5mm; --a4-ml: 6.5mm; --a4-gx: 2.5mm; --a4-gy: 0mm;
            --s-mt: 0mm; --s-ml: 0mm;
        }
        body { font-family: -apple-system, "Noto Sans TC", sans-serif; background: var(--bg); margin: 0; padding: 10px; color: #444; }
        .container { max-width: 600px; margin: auto; }
        .card { background: var(--card-bg); border-radius: 12px; padding: 15px; margin-bottom: 15px; border: 1px solid var(--border); box-shadow: 0 2px 4px rgba(0,0,0,0.05); }
        h3 { color: #6b7e75; border-left: 4px solid var(--accent); padding-left: 10px; margin: 0 0 15px 0; font-size: 1rem; }
        #login-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: var(--bg); z-index: 9999; display: flex; align-items: center; justify-content: center; }
        .login-card { width: 90%; max-width: 350px; background: white; padding: 30px; border-radius: 15px; box-shadow: 0 10px 25px rgba(0,0,0,0.1); }
        .admin-only { display: none; }
        body.is-admin .admin-only { display: block; }
        body.is-admin .admin-inline { display: inline-block; }
        .staff-hidden { display: none; }
        body.is-admin .staff-hidden { display: block; }
        .config-card { background: #f4f6f5; border: 1px solid #d1d5db; border-radius: 8px; padding: 12px; margin: 10px 0; }
        .config-group { margin-bottom: 12px; }
        .config-group label { display: block; font-size: 11px; font-weight: bold; color: #6b7e75; margin-bottom: 5px; }
        .config-input-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(120px, 1fr)); gap: 10px; }
        .config-input-grid input { height: 40px !important; border: 1px solid #ccc; border-radius: 6px; text-align: center; font-size: 14px !important; width: 100% !important; box-sizing: border-box !important; }
        .dir-hint { font-size: 10px; color: #888; text-align: center; margin-top: 3px; line-height: 1.2; }
        .field { display: flex; flex-direction: column; gap: 5px; margin-bottom: 12px; width: 100%; }
        .row-inputs { display: flex; gap: 8px; margin-bottom: 10px; flex-wrap: wrap; }
        input, select { flex: 1; min-width: 80px; padding: 12px; font-size: 16px; border: 1px solid var(--border); border-radius: 8px; box-sizing: border-box; background: #fff; height: 48px; }
        button { width: 100%; padding: 14px; font-size: 16px; border: none; border-radius: 8px; background: var(--primary); color: white; font-weight: bold; cursor: pointer; }
        .btn-accent { background: var(--accent); }
        .btn-success { background: var(--success); }
        .btn-danger { background: var(--danger); }
        #scanner-container { display: none; margin-bottom: 15px; background: #000; border-radius: 12px; overflow: hidden; position: relative; }
        #scan-feedback { position: absolute; top: 10px; left: 50%; transform: translateX(-50%); background: rgba(72, 187, 120, 0.9); color: white; padding: 5px 25px; border-radius: 20px; font-weight: bold; z-index: 10; display: none; }
        #print-preview-zone { margin-top: 15px; padding: 15px; border: 2px dashed var(--accent); border-radius: 8px; display: none; background: white; }
        .table-wrapper { overflow-x: auto; border-radius: 8px; border: 1px solid #eee; margin-top: 10px; }
        table { width: 100%; border-collapse: collapse; background: #fff; min-width: 450px; font-size: 0.85rem; }
        th, td { padding: 10px; text-align: left; border-bottom: 1px solid #f9f9f9; }
        .tag { background: #f0f2f1; padding: 6px 10px; border-radius: 6px; font-size: 0.8rem; border: 1px solid #e0e5e3; display: flex; align-items: center; }
        #print-label-page, #print-invoice-page { display: none; }
        .qty-btn { padding: 2px 8px; width: auto; background: #edf2f7; color: black; border: 1px solid #ccc; border-radius: 4px; cursor: pointer; font-weight: bold; }
        #loading-mask { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(255,255,255,0.8); z-index: 10000; display: none; align-items: center; justify-content: center; font-weight: bold; color: var(--primary); }

        @media print {
            .no-print { display: none !important; }
            body { background: white; margin: 0; padding: 0; }
            body.print-mode-a4 #print-label-page { display: grid !important; grid-template-columns: repeat(5, 38mm); grid-template-rows: repeat(7, 38mm); padding-top: var(--a4-mt) !important; padding-left: var(--a4-ml) !important; column-gap: var(--a4-gx) !important; row-gap: var(--a4-gy) !important; box-sizing: border-box; page-break-after: always; }
            body.print-mode-a4 .label-item { width: 38mm; height: 38mm; display: flex; flex-direction: column; align-items: center; justify-content: center; text-align: center; }
            body.print-mode-a4 .label-item canvas { width: 22mm !important; height: 22mm !important; }
            body.print-mode-a4 .label-item .txt { font-size: 7.5pt; font-weight: bold; margin-top: 1mm; }
            body.print-mode-single #print-label-page { display: flex !important; align-items: center; justify-content: center; width: 100vw; height: 100vh; padding-top: var(--s-mt) !important; padding-left: var(--s-ml) !important; }
            body.print-mode-single .label-item { width: 50mm; height: 30mm; display: flex; flex-direction: row; align-items: center; justify-content: center; gap: 5mm; }
            body.print-mode-single .label-item canvas { width: 25mm !important; height: 25mm !important; }
            body.print-mode-single .label-item .txt { font-size: 9pt; font-weight: bold; }
            #print-invoice-page { display: block !important; padding: 10mm; }
            .inv-table { width: 100%; border-collapse: collapse; margin-top: 10px; }
            .inv-table th, .inv-table td { border: 1px solid black; padding: 8px; font-size: 10pt; }
            .total-area { margin-top: 10px; text-align: right; font-size: 10pt; line-height: 1.6; }
            .total-area .grand-total { font-size: 13pt; font-weight: bold; border-top: 1px double #000; display: inline-block; padding-top: 5px; }
        }
    </style>
</head>
<body>
    <div id="loading-mask">è™•ç†ä¸­ï¼Œè«‹ç¨å€™...</div>
    <div id="login-overlay">
        <div class="login-card">
            <h2 style="text-align:center; color:var(--primary); margin-top:0;">Lingerie Pro</h2>
            <div class="field"><input type="text" id="login-id" placeholder="å¸³è™Ÿ"></div>
            <div class="field"><input type="password" id="login-pw" placeholder="å¯†ç¢¼"></div>
            <button onclick="login()">ç™»å…¥ç³»çµ±</button>
        </div>
    </div>

    <div class="container no-print">
        <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:15px;">
            <span id="user-info" style="font-size:0.9rem; font-weight:bold;"></span>
            <button onclick="location.reload()" style="width:auto; padding:5px 15px; background:#666;">ç™»å‡º</button>
        </div>

        <div class="card admin-only">
            <h3>0. ç³»çµ±ç’°å¢ƒè¨­å®š</h3>
            <div class="config-card">
                <div class="config-input-grid">
                    <div class="config-group">
                        <label>å…¬å¸åç¨±</label>
                        <input type="text" id="compNameInp" placeholder="æˆ‘çš„ç²¾å“åº—" onchange="updateSysConfig()">
                    </div>
                    <div class="config-group">
                        <label>ç¨…ç‡ (%)</label>
                        <input type="number" id="taxRateInp" value="5" onchange="updateSysConfig()">
                    </div>
                </div>
            </div>
            
            <div style="background:#edf2f7; padding:10px; border-radius:8px; margin-top:10px;">
                <p style="font-size:11px; font-weight:bold; margin:0 0 8px 0; color:#4a5568;">ğŸ‘¤ ä½¿ç”¨è€…å¸³è™Ÿç®¡ç†</p>
                <div class="row-inputs">
                    <input type="text" id="newUserId" placeholder="å¸³è™Ÿ">
                    <input type="text" id="newUserPw" placeholder="å¯†ç¢¼">
                    <select id="newUserRole"><option value="staff">å“¡å·¥</option><option value="admin">ç®¡ç†å“¡</option></select>
                </div>
                <button class="btn-success" onclick="addUser()">æ–°å¢ä½¿ç”¨è€…ä»£ç¢¼</button>
            </div>
        </div>

        <div id="scanner-container">
            <div id="scan-feedback">æƒææˆåŠŸï¼</div>
            <div id="reader" style="width:100%;"></div>
            <button class="btn-danger" onclick="stopScan()" style="border-radius:0;">é—œé–‰æƒæå™¨</button>
        </div>

        <div class="card admin-only">
            <h3>1. åŸºç¤è³‡æ–™ç¶­è­·</h3>
            <div class="row-inputs">
                <input type="text" id="vCode" placeholder="å» å•†ä»£ç¢¼">
                <input type="text" id="vName" placeholder="åç¨±">
                <button style="width:auto;" onclick="addVendor()">æ–°å¢å» å•†</button>
            </div>
            <div class="row-inputs">
                <input type="text" id="colorStr" placeholder="é¡è‰²åç¨±:ä»£ç¢¼ (å¦‚ é»‘è‰²:BK)">
                <button style="width:auto;" onclick="addColor()">æ–°å¢é¡è‰²</button>
            </div>
            <hr style="border:0; border-top:1px solid var(--border); margin:15px 0;">
            <div class="row-inputs">
                <select id="setVendorRel"></select>
                <input type="text" id="mBraId" placeholder="å‹è™Ÿ">
                <input type="text" id="mType" placeholder="é¡å‹">
            </div>
            <div class="row-inputs">
                <input type="number" id="mCost" placeholder="é€²åƒ¹">
                <input type="number" id="mPrice" placeholder="å”®åƒ¹">
                <button class="btn-accent" onclick="addModel()">æ–°å¢å‹è™Ÿæ¬¾å¼</button>
            </div>
        </div>

        <div class="card">
            <h3>2. åº«å­˜èˆ‡æ¨™ç±¤ä½œæ¥­</h3>
            <div class="row-inputs">
                <select id="selectVendor" onchange="filterModels()"></select>
                <select id="selectModel"></select>
                <select id="selectColor"></select>
            </div>
            <div class="row-inputs" style="display:grid; grid-template-columns:1fr 1fr 1fr; gap:8px;">
                <input type="text" id="sizeB" placeholder="ä¸‹èƒ¸åœ">
                <input type="text" id="sizeC" placeholder="ç½©æ¯">
                <input type="text" id="sizeZ" placeholder="å°ºå¯¸">
            </div>
            <div class="row-inputs">
                <input type="number" id="adjQty" placeholder="æ•¸é‡" value="1">
                <button class="btn-success" onclick="updateStock(1)">å…¥åº«</button>
                <button class="btn-danger admin-only" onclick="updateStock(-1)">æ‰£é™¤</button>
            </div>
            <div class="row-inputs">
                <button onclick="startScan('stock')">ğŸ“· æƒææ¢ç¢¼</button>
                <button class="btn-accent" onclick="preparePrint()">ğŸ·ï¸ ç”Ÿæˆæ¨™ç±¤</button>
            </div>

            <div id="print-preview-zone">
                <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:10px;">
                    <b id="preview-title">åˆ—å°é è¦½</b>
                    <div style="display:flex; gap:5px;">
                        <button onclick="doPrint('a4')" style="width:auto; padding:5px 10px; font-size:12px;">A4æ¨™ç±¤</button>
                        <button onclick="doPrint('single')" style="width:auto; padding:5px 10px; font-size:12px; background:var(--accent);">å–®å¼µ(50x30)</button>
                    </div>
                </div>
                <div class="admin-only" style="background:#f1f1f1; padding:8px; border-radius:5px; margin-bottom:10px; font-size:11px;">
                    <details>
                        <summary>å¾®èª¿ç‰ˆé¢é‚Šè· (mm)</summary>
                        <div style="display:grid; grid-template-columns:1fr 1fr 1fr; gap:5px; margin-top:5px;">
                            <div>A4ä¸Šè·<input type="number" id="cfg-a4-mt" step="0.1" value="15.5"></div>
                            <div>A4å·¦è·<input type="number" id="cfg-a4-ml" step="0.1" value="6.5"></div>
                            <div>A4æ°´å¹³é–“è·<input type="number" id="cfg-a4-gx" step="0.1" value="2.5"></div>
                            <div>A4å‚ç›´é–“è·<input type="number" id="cfg-a4-gy" step="0.1" value="0"></div>
                            <div>å–®å¼µä¸Šè·<input type="number" id="cfg-s-mt" step="0.1" value="0"></div>
                            <div>å–®å¼µå·¦è·<input type="number" id="cfg-s-ml" step="0.1" value="0"></div>
                        </div>
                        <button onclick="savePrintConfigs()" style="margin-top:5px; padding:3px; font-size:11px;">å„²å­˜ä¸¦å¥—ç”¨è¨­å®š</button>
                    </details>
                </div>
                <div id="preview-content" style="display:flex; flex-wrap:wrap; justify-content:center; gap:5px; background:#eee; padding:10px;"></div>
                <button onclick="document.getElementById('print-preview-zone').style.display='none'" style="margin-top:10px; background:#999;">å–æ¶ˆåˆ—å°</button>
            </div>
        </div>
<div class="card">
            <h3>3. éŠ·å”®å‡ºè²¨ç®¡ç†</h3>
            <div class="row-inputs">
                <button onclick="startScan('sale')">ğŸ“· æƒææ¢ç¢¼åŠ å…¥æ¸…å–®</button>
            </div>
            <div class="table-wrapper">
                <table id="cart-table">
                    <thead><tr><th>å•†å“/é¡è‰²/å°ºå¯¸</th><th>å–®åƒ¹</th><th>æ•¸é‡</th><th>æ“ä½œ</th></tr></thead>
                    <tbody id="cart-body"></tbody>
                </table>
            </div>
            <div style="margin-top:10px; text-align:right; font-weight:bold; font-size:1.1rem;">
                ç¸½è¨ˆ: $<span id="cart-total">0</span>
            </div>
            <button class="btn-success" style="margin-top:10px;" onclick="checkout()">ç¢ºèªå‡ºè²¨ä¸¦åˆ—å°ç™¼ç¥¨</button>
        </div>

        <div class="card">
            <h3>4. åº«å­˜èˆ‡ç´€éŒ„æŸ¥è©¢</h3>
            <div class="table-wrapper">
                <table id="data-table"><thead><tr><th>åˆ†é å…§å®¹</th></tr></thead><tbody id="data-body"></tbody></table>
            </div>
        </div>
    </div>

    <div id="print-label-page"></div>
    <div id="print-invoice-page"></div>

    <script>
        // --- æ ¸å¿ƒè®Šæ•¸ ---
        const API_URL = "https://script.google.com/macros/s/AKfycbzf4T2oGvY3F_mS8Lhsh9FkO6W_YmD06MhV1X_Yk6k_O7y9t0k8u7v0B5H6z3X9S0/exec"; // è«‹ç¢ºä¿èˆ‡æ‚¨çš„ Apps Script éƒ¨ç½²ç¶²å€ä¸€è‡´
        let vendors = [], models = [], colors = [], inventory = [], users = [], cart = [];
        let compName = "æˆ‘çš„ç²¾å“å…§è¡£åº—", taxRate = 5;
        let currentUser = null;
        let html5QrCode = null;

        // --- åˆå§‹åŒ– ---
        window.onload = async () => {
            loadPrintConfigs();
            const savedUser = localStorage.getItem('lingerieUser');
            if (savedUser) {
                currentUser = JSON.parse(savedUser);
                loginSuccess();
            }
        };

        function loginSuccess() {
            document.getElementById('login-overlay').style.display = 'none';
            document.getElementById('user-info').innerText = `ç›®å‰ä½¿ç”¨è€…ï¼š${currentUser.id} (${currentUser.role === 'admin' ? 'ç®¡ç†å“¡' : 'å“¡å·¥'})`;
            if (currentUser.role === 'admin') document.body.classList.add('is-admin');
            syncFromCloud();
        }

        async function syncFromCloud() {
            showLoading(true);
            try {
                const res = await fetch(`${API_URL}?action=getAll`);
                const data = await res.json();
                vendors = data.vendors || [];
                models = data.models || [];
                colors = data.colors || [];
                inventory = data.inventory || [];
                users = data.users || [];
                if (data.config) {
                    compName = data.config.compName || compName;
                    taxRate = data.config.taxRate || taxRate;
                }
                render();
            } catch (e) { alert("åŒæ­¥å¤±æ•—ï¼š" + e); }
            showLoading(false);
        }

        function render() {
            // --- ä¿®æ­£ï¼šåŒæ­¥é¡¯ç¤ºå…¬å¸åç¨±èˆ‡ç¨…ç‡åˆ°è¼¸å…¥æ¡† ---
            if(document.getElementById('compNameInp')) document.getElementById('compNameInp').value = compName;
            if(document.getElementById('taxRateInp')) document.getElementById('taxRateInp').value = taxRate;

            // æ›´æ–°å» å•†ä¸‹æ‹‰é¸å–®
            const vSels = [document.getElementById('setVendorRel'), document.getElementById('selectVendor')];
            vSels.forEach(s => {
                const oldVal = s.value;
                s.innerHTML = vendors.map(v => `<option value="${v.code}">${v.name} (${v.code})</option>`).join('');
                if (oldVal) s.value = oldVal;
            });
            
            // æ›´æ–°é¡è‰²ä¸‹æ‹‰é¸å–®
            document.getElementById('selectColor').innerHTML = colors.map(c => `<option value="${c.code}">${c.name}</option>`).join('');
            
            filterModels();
            updateInventoryTable();
        }

        function filterModels() {
            const v = document.getElementById('selectVendor').value;
            const mSel = document.getElementById('selectModel');
            const filtered = models.filter(m => m.vendor === v);
            mSel.innerHTML = filtered.map(m => `<option value="${m.braId}">${m.braId} (${m.type})</option>`).join('');
        }
// --- æ ¸å¿ƒæ“ä½œ ---
        async function pushToCloud(action, params) {
            showLoading(true);
            try {
                const response = await fetch(API_URL, {
                    method: 'POST',
                    body: JSON.stringify({ action, ...params })
                });
                const result = await response.json();
                if (result.status === 'success') {
                    await syncFromCloud();
                } else {
                    alert("æ›´æ–°å¤±æ•—ï¼š" + result.message);
                }
            } catch (e) { alert("ç¶²è·¯éŒ¯èª¤ï¼š" + e); }
            showLoading(false);
        }

        // --- ç³»çµ±è¨­å®šæ›´æ–° (ä¿®æ­£é») ---
        async function updateSysConfig() {
            const cn = document.getElementById('compNameInp').value;
            const tr = document.getElementById('taxRateInp').value;
            // å…ˆæ›´æ–°æœ¬åœ°è®Šæ•¸ï¼Œé¿å…ç•«é¢é–ƒçˆå›èˆŠè³‡æ–™
            compName = cn;
            taxRate = tr;
            await pushToCloud('updateConfig', { compName: cn, taxRate: tr });
        }

        async function login() {
            const id = document.getElementById('login-id').value;
            const pw = document.getElementById('login-pw').value;
            const user = users.find(u => u.id === id && u.pw === pw);
            if (user) {
                currentUser = user;
                localStorage.setItem('lingerieUser', JSON.stringify(user));
                loginSuccess();
            } else {
                alert("å¸³è™Ÿæˆ–å¯†ç¢¼éŒ¯èª¤");
            }
        }

        async function addVendor() {
            const code = document.getElementById('vCode').value;
            const name = document.getElementById('vName').value;
            if (!code || !name) return alert("è«‹å¡«å¯«å®Œæ•´");
            await pushToCloud('addVendor', { code, name });
        }

        async function addColor() {
            const str = document.getElementById('colorStr').value;
            if (!str.includes(':')) return alert("æ ¼å¼éŒ¯èª¤ï¼Œéœ€ç‚º é¡è‰²:ä»£ç¢¼");
            await pushToCloud('addColor', { colorStr: str });
        }

        async function addModel() {
            const vendor = document.getElementById('setVendorRel').value;
            const braId = document.getElementById('mBraId').value;
            const type = document.getElementById('mType').value;
            const cost = document.getElementById('mCost').value;
            const price = document.getElementById('mPrice').value;
            await pushToCloud('addModel', { vendor, braId, type, cost, price });
        }

        async function addUser() {
            const id = document.getElementById('newUserId').value;
            const pw = document.getElementById('newUserPw').value;
            const role = document.getElementById('newUserRole').value;
            await pushToCloud('addUser', { id, pw, role });
        }

        async function updateStock(amt) {
            const params = {
                m: document.getElementById('selectModel').value,
                c: document.getElementById('selectColor').value,
                bb: document.getElementById('sizeB').value,
                bc: document.getElementById('sizeC').value,
                bz: document.getElementById('sizeZ').value,
                qty: document.getElementById('adjQty').value * amt
            };
            await pushToCloud('updateInventory', params);
        }

        // --- æƒæèˆ‡è³¼ç‰©è»Šé‚è¼¯ ---
        function startScan(mode) {
            document.getElementById('scanner-container').style.display = 'block';
            html5QrCode = new Html5Qrcode("reader");
            html5QrCode.start({ facingMode: "environment" }, { fps: 10, qrbox: 250 }, (text) => {
                document.getElementById('scan-feedback').style.display = 'block';
                setTimeout(() => { document.getElementById('scan-feedback').style.display = 'none'; }, 1000);
                handleScanResult(text, mode);
            });
        }

        function stopScan() {
            if (html5QrCode) {
                html5QrCode.stop().then(() => {
                    document.getElementById('scanner-container').style.display = 'none';
                });
            }
        }

        function handleScanResult(text, mode) {
            const parts = text.split('-');
            if (parts.length < 5) return;
            const [m, c, bb, bc, bz] = parts;
            if (mode === 'stock') {
                document.getElementById('selectModel').value = m;
                document.getElementById('selectColor').value = c;
                document.getElementById('sizeB').value = bb;
                document.getElementById('sizeC').value = bc;
                document.getElementById('sizeZ').value = bz;
            } else {
                const modelData = models.find(i => i.braId === m);
                const price = modelData ? modelData.price : 0;
                cart.push({ m, c, bb, bc, bz, q: 1, p: price });
                updateCart();
            }
        }

        function updateCart() {
            const body = document.getElementById('cart-body');
            let total = 0;
            body.innerHTML = cart.map((item, index) => {
                total += item.p * item.q;
                return `<tr>
                    <td>${item.m}-${item.c}<br><small>${item.bb}${item.bc}${item.bz}</small></td>
                    <td>$${item.p}</td>
                    <td><button class="qty-btn" onclick="adjCart(${index},-1)">-</button> ${item.q} <button class="qty-btn" onclick="adjCart(${index},1)">+</button></td>
                    <td><button onclick="cart.splice(${index},1);updateCart()" style="padding:2px 5px; background:red;">X</button></td>
                </tr>`;
            }).join('');
            document.getElementById('cart-total').innerText = total;
        }

        function adjCart(i, v) {
            cart[i].q += v;
            if (cart[i].q <= 0) cart.splice(i, 1);
            updateCart();
        }

        async function checkout() {
            if (cart.length === 0) return alert("è³¼ç‰©è»Šæ˜¯ç©ºçš„");
            const total = document.getElementById('cart-total').innerText;
            if (confirm(`ç¢ºå®šå‡ºè²¨ï¼Ÿ ç¸½è¨ˆï¼š$${total}`)) {
                await pushToCloud('shipInvoice', { items: cart, total: total });
                printInvoice(total);
                cart = [];
                updateCart();
            }
        }

        // --- è¼”åŠ©åŠŸèƒ½ ---
        function showLoading(show) { document.getElementById('loading-mask').style.display = show ? 'flex' : 'none'; }

        function updateInventoryTable() {
            const body = document.getElementById('data-body');
            const head = document.querySelector('#data-table thead');
            head.innerHTML = `<tr><th>å‹è™Ÿ</th><th>é¡è‰²</th><th>å°ºå¯¸</th><th>åº«å­˜</th></tr>`;
            body.innerHTML = inventory.map(i => `<tr><td>${i.å‹è™Ÿ}</td><td>${i.é¡è‰²}</td><td>${i.ä¸‹èƒ¸åœ}${i.ç½©æ¯}${i.å°ºå¯¸}</td><td><b>${i.æ•¸é‡}</b></td></tr>`).join('');
        }

        function preparePrint() {
            const m = document.getElementById('selectModel').value;
            const c = document.getElementById('selectColor').value;
            const bb = document.getElementById('sizeB').value;
            const bc = document.getElementById('sizeC').value;
            const bz = document.getElementById('sizeZ').value;
            const qty = document.getElementById('adjQty').value;
            const code = `${m}-${c}-${bb}-${bc}-${bz}`;
            const zone = document.getElementById('preview-content');
            zone.innerHTML = "";
            for (let i = 0; i < qty; i++) {
                const div = document.createElement('div');
                div.className = "label-item";
                div.innerHTML = `<canvas class="qr"></canvas><div class="txt">${m}-${c}<br>${bb}${bc}${bz}</div>`;
                zone.appendChild(div);
                new QRious({ element: div.querySelector('.qr'), value: code, size: 100 });
            }
            document.getElementById('print-preview-zone').style.display = 'block';
        }

        function doPrint(mode) {
            document.body.classList.remove('print-mode-a4', 'print-mode-single');
            document.body.classList.add('print-mode-' + mode);
            document.getElementById('print-label-page').innerHTML = document.getElementById('preview-content').innerHTML;
            window.print();
        }

        function printInvoice(total) {
            const sub = Math.round(total / (1 + taxRate/100));
            const tax = total - sub;
            let html = `<h2 style="text-align:center;">${compName} - éŠ·å”®å–®</h2>`;
            html += `<p>æ—¥æœŸï¼š${new Date().toLocaleString()}<br>æ”¶éŠ€å“¡ï¼š${currentUser.id}</p>`;
            html += `<table class="inv-table"><tr><th>å“é …</th><th>æ•¸é‡</th><th>å°è¨ˆ</th></tr>`;
            cart.forEach(i => { html += `<tr><td>${i.m}-${i.c} (${i.bb}${i.bc}${i.bz})</td><td>${i.q}</td><td>$${i.p * i.q}</td></tr>`; });
            html += `</table><div class="total-area">æœªç¨…ï¼š$${sub}<br>ç¨…é¡(${taxRate}%)ï¼š$${tax}<br><span class="grand-total">ç¸½è¨ˆï¼š$${total}</span></div>`;
            document.getElementById('print-invoice-page').innerHTML = html;
            window.print();
        }

        function loadPrintConfigs() {
            const d = JSON.parse(localStorage.getItem('printConfigs'));
            if (d) {
                document.getElementById('cfg-a4-mt').value = d.a4mt;
                document.getElementById('cfg-a4-ml').value = d.a4ml;
                document.getElementById('cfg-a4-gx').value = d.a4gx;
                document.getElementById('cfg-a4-gy').value = d.a4gy;
                document.getElementById('cfg-s-mt').value = d.smt;
                document.getElementById('cfg-s-ml').value = d.sml;
                applyConfigsToCSS(d);
            }
        }

        function savePrintConfigs() {
            const d = {
                a4mt: document.getElementById('cfg-a4-mt').value,
                a4ml: document.getElementById('cfg-a4-ml').value,
                a4gx: document.getElementById('cfg-a4-gx').value,
                a4gy: document.getElementById('cfg-a4-gy').value,
                smt: document.getElementById('cfg-s-mt').value,
                sml: document.getElementById('cfg-s-ml').value
            };
            localStorage.setItem('printConfigs', JSON.stringify(d));
            applyConfigsToCSS(d);
            alert("ç‰ˆé¢è¨­å®šå·²å„²å­˜");
        }

        function applyConfigsToCSS(d) {
            const root = document.querySelector(':root');
            root.style.setProperty('--a4-mt', d.a4mt + 'mm');
            root.style.setProperty('--a4-ml', d.a4ml + 'mm');
            root.style.setProperty('--a4-gx', d.a4gx + 'mm');
            root.style.setProperty('--a4-gy', d.a4gy + 'mm');
            root.style.setProperty('--s-mt', d.smt + 'mm');
            root.style.setProperty('--s-ml', d.sml + 'mm');
        }
    </script>
</body>
</html>
