<!DOCTYPE html>
<html lang="zh-Hant">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Lingerie Pro - é›²ç«¯ç‰ˆ</title>
    <script src="https://unpkg.com/html5-qrcode"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/qrious/4.0.2/qrious.min.js"></script>
    <style>
        :root {
            --primary: #8da399; --accent: #d4a373; --bg: #f9f7f2;
            --card-bg: #ffffff; --border: #e0dcd0; --danger: #e53e3e; --success: #48bb78;
            --a4-mt: 15.5mm; --a4-ml: 6.5mm; --a4-gx: 2.5mm; --a4-gy: 0mm;
        }
        body { font-family: -apple-system, "Noto Sans TC", sans-serif; background: var(--bg); margin: 0; padding: 10px; color: #444; }
        .container { max-width: 600px; margin: auto; display: none; }
        .card { background: var(--card-bg); border-radius: 12px; padding: 15px; margin-bottom: 15px; border: 1px solid var(--border); box-shadow: 0 2px 4px rgba(0,0,0,0.05); }
        h3 { color: #6b7e75; border-left: 4px solid var(--accent); padding-left: 10px; margin: 0 0 15px 0; font-size: 1rem; }
        .admin-only { display: none; }
        body.is-admin .admin-only { display: block; }
        input, select { width: 100%; padding: 12px; font-size: 16px; border: 1px solid var(--border); border-radius: 8px; box-sizing: border-box; background: #fff; height: 48px; margin-bottom: 8px; }
        .row-inputs { display: flex; gap: 8px; margin-bottom: 8px; flex-wrap: wrap; }
        .row-inputs > * { flex: 1; min-width: 80px; }
        button { width: 100%; padding: 14px; font-size: 16px; border: none; border-radius: 8px; background: var(--primary); color: white; font-weight: bold; cursor: pointer; }
        .btn-success { background: var(--success); } .btn-danger { background: var(--danger); } .btn-accent { background: var(--accent); }
        #scanner-container { display: none; margin-bottom: 15px; background: #000; border-radius: 12px; overflow: hidden; position: relative; }
        #reader { width: 100%; }
        #scan-feedback { position: absolute; top: 10px; left: 50%; transform: translateX(-50%); background: rgba(72, 187, 120, 0.9); color: white; padding: 5px 20px; border-radius: 20px; z-index: 10; display: none; }
        .stat-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 10px; margin-bottom: 15px; }
        .stat-card { background: #fff; padding: 12px; border-radius: 10px; border: 1px solid var(--border); text-align: center; }
        .stat-val { font-size: 1.2rem; font-weight: bold; color: var(--primary); }
        .stat-label { font-size: 0.75rem; color: #888; }
        table { width: 100%; border-collapse: collapse; margin-top: 10px; }
        th, td { padding: 12px 8px; text-align: left; border-bottom: 1px solid #f0efeb; }
        #login-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: var(--bg); z-index: 9999; display: flex; align-items: center; justify-content: center; }
        @media print {
            .no-print { display: none !important; }
            body.print-mode-a4 #print-label-page { display: grid !important; grid-template-columns: repeat(5, 38mm); grid-template-rows: repeat(7, 38mm); padding-top: var(--a4-mt) !important; padding-left: var(--a4-ml) !important; column-gap: var(--a4-gx) !important; row-gap: var(--a4-gy) !important; }
            .label-item { width: 38mm; height: 38mm; display: flex; flex-direction: column; align-items: center; justify-content: center; }
            .label-item canvas { width: 22mm !important; height: 22mm !important; }
            .label-txt { font-size: 8px; text-align: center; line-height: 1.2; margin-top: 2px; }
        }
    </style>
</head>
<body>
<div id="login-overlay">
    <div class="card" style="width: 85%; max-width: 350px;">
        <h2 style="text-align:center; color:var(--primary);">Lingerie Pro Cloud</h2>
        <input type="text" id="loginUser" placeholder="å¸³è™Ÿ">
        <input type="password" id="loginPass" placeholder="å¯†ç¢¼">
        <button onclick="app.login()">é€²å…¥ç³»çµ±</button>
        <div id="init-status" style="text-align:center; font-size:12px; color:gray; margin-top:10px;">ğŸ”„ æ­£åœ¨é€£æ¥é›²ç«¯è³‡æ–™åº«...</div>
    </div>
</div>
<div id="main-ui" class="container no-print">
    <div style="display:flex; justify-content: space-between; align-items: center; margin-bottom: 10px;">
        <span id="display-user" style="font-size:14px; font-weight:bold; color:var(--primary);"></span>
        <button onclick="location.reload()" style="width:auto; padding:5px 15px; font-size:12px; background:#666;">ç™»å‡º</button>
    </div>

    <div class="stat-grid">
        <div class="stat-card"><div id="stat-stock" class="stat-val">0</div><div class="stat-label">ç•¶å‰ç¸½åº«å­˜</div></div>
        <div class="stat-card"><div id="stat-sales" class="stat-val">0</div><div class="stat-label">ä»Šæ—¥éŠ·å”®æ•¸</div></div>
    </div>

    <div class="card admin-only">
        <h3>ğŸ“„ A4 æ¨™ç±¤åˆ—å°å¾®èª¿ (mm)</h3>
        <div class="row-inputs">
            <div>ä¸Šï¼š<input type="number" step="0.1" id="p-a4mt" value="15.5"></div>
            <div>å·¦ï¼š<input type="number" step="0.1" id="p-a4ml" value="6.5"></div>
            <div>æ©«ï¼š<input type="number" step="0.1" id="p-a4gx" value="2.5"></div>
            <div>ç¸±ï¼š<input type="number" step="0.1" id="p-a4gy" value="0"></div>
        </div>
        <button class="btn-accent" onclick="app.savePrintCfg()">ğŸ’¾ å„²å­˜ä¸¦å¥—ç”¨ç‰ˆé¢è¨­å®š</button>
    </div>

    <div class="card">
        <h3>ğŸ“¥ é€²å‡ºè²¨èˆ‡æ“ä½œ</h3>
        <div class="row-inputs">
            <button onclick="app.ui.openScanner('IN_AUTO')" style="background:#4299e1;">é€£çºŒå…¥åº«</button>
            <button onclick="app.ui.openScanner('OUT_AUTO')" class="btn-success">æƒæå‡ºè²¨</button>
        </div>
        <div id="scanner-container">
            <div id="scan-feedback">OK!</div>
            <div id="reader"></div>
            <button class="btn-danger" style="border-radius:0;" onclick="app.ui.uiCloseScanner()">âŒ é—œé–‰ç›¸æ©Ÿ</button>
        </div>
        
        <select id="sel-vendor" onchange="app.ui.refreshModelSelect()"></select>
        <select id="sel-model"></select>
        <div class="row-inputs">
            <select id="sel-color"></select>
            <select id="sel-band"></select>
            <select id="sel-cup"></select>
            <select id="sel-size"></select>
        </div>
        <div class="row-inputs">
            <button onclick="app.handleManual('IN')">ğŸ“¥ æ‰‹å‹•å…¥åº«</button>
            <button class="btn-success" onclick="app.handleManual('OUT')">ğŸ“„ è¨˜éŒ„éŠ·å”®</button>
        </div>
        <button class="btn-accent admin-only" style="margin-top:10px;" onclick="app.printTags()">ğŸ–¨ï¸ ç”¢ç”Ÿ 35 æš A4 æ¨™ç±¤</button>
    </div>

    <div class="card">
        <h3>ğŸ“Š åº«å­˜çµ±è¨ˆèˆ‡æœå°‹</h3>
        <div id="rank-panel" style="background:#fffaf0; padding:10px; border-radius:8px; margin-bottom:10px; font-size:13px; color:#d4a373;"></div>
        <input type="text" id="search-stock" placeholder="ğŸ” æœå°‹å‹è™Ÿã€é¡è‰²ã€ä¸‹åœ..." oninput="app.ui.renderStock()">
        <div style="overflow-x:auto;">
            <table>
                <thead><tr><th>å“é …è¦æ ¼</th><th>å­˜é‡</th><th class="admin-only">æ“ä½œ</th></tr></thead>
                <tbody id="stock-body"></tbody>
            </table>
        </div>
    </div>
</div>
<div id="print-label-page" style="display:none;"></div>
<script>
const app = {
    CONFIG: { API_URL: "https://script.google.com/macros/s/AKfycbywN_36nh6hI9JSCXwf2ohcMI9MCFvEAQFPQfvIcSu75ZyKrR2sCgNzbwQE1UjAVXb8/exec" },
    data: { vendors: [], models: [], inventory: [], colors: [], salesHistory: [], users: [], sysConfig: {}, printCfg: {} },

    async init() {
        try {
            const sheets = ['VENDORS', 'MODELS', 'INVENTORY', 'COLORS', 'SALES', 'CONFIG', 'USERS'];
            const res = await Promise.all(sheets.map(s => this.cloud('readAll', s)));
            this.data.vendors = res[0]||[]; this.data.models = res[1]||[]; this.data.inventory = res[2]||[];
            this.data.colors = res[3]||[]; this.data.salesHistory = res[4]||[]; this.data.users = res[6]||[];
            const cfg = res[5]||[];
            if (cfg.length) {
                const sc = cfg.find(x => x.k === 'sysConfig'); if(sc) this.data.sysConfig = JSON.parse(sc.v);
                const pc = cfg.find(x => x.k === 'printCfg'); if(pc) this.data.printCfg = JSON.parse(pc.v);
            }
            this.ui.syncSettingsToFields(); this.ui.applyPrintCss();
            document.getElementById('init-status').innerText = "âœ… é›²ç«¯åŒæ­¥æˆåŠŸ";
        } catch (e) { document.getElementById('init-status').innerText = "âŒ é€£ç·šå¤±æ•—"; }
    },

    async cloud(action, sheet, payload = null) {
        const resp = await fetch(this.CONFIG.API_URL, { method: 'POST', body: JSON.stringify({ action, sheet, payload }) });
        const txt = await resp.text();
        try { return JSON.parse(txt); } catch(e) { return txt; }
    },

    login() {
        const u = document.getElementById('loginUser').value.trim(), p = document.getElementById('loginPass').value.trim();
        const user = this.data.users.find(x => String(x.u) === u && String(x.p) === p);
        if (user || (u === 'admin' && p === 'admin123')) {
            const role = user ? user.r : 'admin';
            if (role === 'admin') document.body.classList.add('is-admin');
            document.getElementById('login-overlay').style.display = 'none';
            document.getElementById('main-ui').style.display = 'block';
            document.getElementById('display-user').innerText = `ğŸ‘¤ æ¬Šé™: ${role === 'admin' ? 'ç®¡ç†å“¡' : 'å“¡å·¥'} (${u})`;
            this.ui.initDropdowns(); this.ui.renderStock();
        } else { alert("å¸³å¯†éŒ¯èª¤"); }
    },

    async saveAll() {
        await Promise.all([
            this.cloud('syncFull', 'INVENTORY', this.data.inventory),
            this.cloud('syncFull', 'SALES', this.data.salesHistory),
            this.cloud('syncFull', 'CONFIG', [{k:'sysConfig', v:JSON.stringify(this.data.sysConfig)}, {k:'printCfg', v:JSON.stringify(this.data.printCfg)}])
        ]);
    }
};

app.ui = {
    initDropdowns() {
        const b = document.getElementById('sel-band'), cp = document.getElementById('sel-cup'), sz = document.getElementById('sel-size'), cl = document.getElementById('sel-color');
        b.innerHTML = '<option value="-">ä¸‹åœ-</option>'; for(let i=32; i<=50; i+=2) b.innerHTML += `<option value="${i}">${i}</option>`;
        cp.innerHTML = '<option value="-">ç½©æ¯-</option>'; "ABCDEFGH".split("").forEach(x => cp.innerHTML += `<option value="${x}">${x}</option>`);
        sz.innerHTML = '<option value="-">å°ºå¯¸-</option>'; ["SS","S","M","L","XL","XXL","3XL","FREE"].forEach(x => sz.innerHTML += `<option value="${x}">${x}</option>`);
        cl.innerHTML = app.data.colors.map(x => `<option value="${x.code}">${x.name}</option>`).join('');
        this.refreshVendorSelect();
    },
    refreshVendorSelect() {
        document.getElementById('sel-vendor').innerHTML = app.data.vendors.map(v => `<option value="${v.code}">${v.code} ${v.name}</option>`).join('');
        this.refreshModelSelect();
    },
    refreshModelSelect() {
        const v = document.getElementById('sel-vendor').value;
        const f = app.data.models.filter(m => m.vCode === v);
        document.getElementById('sel-model').innerHTML = f.map(m => `<option value='${JSON.stringify(m)}'>${m.braId} ($${m.price})</option>`).join('');
    },
    renderStock() {
        const q = document.getElementById('search-stock').value.toLowerCase();
        const f = app.data.inventory.filter(i => (i.vCode + i.braId + (i.c||'')).toLowerCase().includes(q));
        document.getElementById('stock-body').innerHTML = f.map((i, idx) => `
            <tr>
                <td><strong>${i.braId}</strong><br><small>${i.c} ${i.bb}${i.bc} ${i.bz}</small></td>
                <td style="font-weight:bold; color:${i.bq < 3 ? 'var(--danger)':'var(--primary)'};">${i.bq}</td>
                <td class="admin-only"><button onclick="app.adjQty('${i.vCode}','${i.braId}','${i.c}','${i.bb}','${i.bc}','${i.bz}', 1)" style="padding:4px 8px;">+</button></td>
            </tr>
        `).join('');
        document.getElementById('stat-stock').innerText = app.data.inventory.reduce((a,b)=> a + parseInt(b.bq), 0);
        const today = new Date().toLocaleDateString();
        document.getElementById('stat-sales').innerText = app.data.salesHistory.filter(s => s.date.includes(today)).reduce((a,b)=> a + parseInt(b.q), 0);
        this.renderRank();
    },
    renderRank() {
        const counts = {}; app.data.salesHistory.forEach(s => { counts[s.id] = (counts[s.id] || 0) + parseInt(s.q); });
        const sorted = Object.entries(counts).sort((a,b) => b[1]-a[1]).slice(0, 5);
        document.getElementById('rank-panel').innerHTML = "ğŸ† æœ¬é€±ç†±éŠ·ï¼š " + sorted.map(([k,v]) => `${k}(${v})`).join(' | ');
    },
    openScanner(mode) {
        this.scanMode = mode; document.getElementById('scanner-container').style.display = 'block';
        if (!app.scanner) app.scanner = new Html5Qrcode("reader");
        app.scanner.start({ facingMode: "environment" }, { fps: 10, qrbox: 250 }, (t) => this.onScanSuccess(t));
    },
    uiCloseScanner() { if(app.scanner) app.scanner.stop().then(()=> document.getElementById('scanner-container').style.display='none'); },
    onScanSuccess(t) {
        const p = t.split(','); if(p.length < 6) return;
        const item = { vCode: p[0], braId: p[1], c: p[3], bb: p[4], bc: p[5], bz: p[6] };
        app.updateInventory(item, this.scanMode.includes('IN') ? 1 : -1);
        if(this.scanMode.includes('OUT')) app.recordSale(item, 1);
        const fb = document.getElementById('scan-feedback'); fb.style.display='block'; setTimeout(()=>fb.style.display='none', 500);
    },
    syncSettingsToFields() {
        const p = app.data.printCfg;
        if(p.a4mt) { document.getElementById('p-a4mt').value = p.a4mt; document.getElementById('p-a4ml').value = p.a4ml; document.getElementById('p-a4gx').value = p.a4gx; document.getElementById('p-a4gy').value = p.a4gy; }
    },
    applyPrintCss() {
        const r = document.documentElement; const p = app.data.printCfg;
        if(p.a4mt) { r.style.setProperty('--a4-mt', p.a4mt+'mm'); r.style.setProperty('--a4-ml', p.a4ml+'mm'); r.style.setProperty('--a4-gx', p.a4gx+'mm'); r.style.setProperty('--a4-gy', p.a4gy+'mm'); }
    }
};

app.updateInventory = function(item, qty) {
    let t = this.data.inventory.find(i => i.vCode===item.vCode && i.braId===item.braId && i.c===item.c && i.bb===item.bb && i.bc===item.bc && i.bz===item.bz);
    if(t) t.bq = parseInt(t.bq) + qty; else this.data.inventory.push({...item, bq: qty});
    this.saveAll(); this.ui.renderStock();
};

app.recordSale = function(item, qty) {
    const m = this.data.models.find(x => x.vCode===item.vCode && x.braId===item.braId);
    this.data.salesHistory.push({ date: new Date().toLocaleString(), id: item.braId, p: m?m.price:0, q: qty });
    this.saveAll();
};

app.handleManual = function(type) {
    const mStr = document.getElementById('sel-model').value; if(!mStr) return;
    const m = JSON.parse(mStr);
    const item = { vCode: document.getElementById('sel-vendor').value, braId: m.braId, c: document.getElementById('sel-color').value, bb: document.getElementById('sel-band').value, bc: document.getElementById('sel-cup').value, bz: document.getElementById('sel-size').value };
    this.updateInventory(item, type==='IN'?1:-1); if(type==='OUT') this.recordSale(item, 1);
};

app.printTags = function() {
    const mStr = document.getElementById('sel-model').value; if(!mStr) return;
    const m = JSON.parse(mStr); const p = document.getElementById('print-label-page');
    p.innerHTML = ''; p.style.display = 'grid'; document.body.classList.add('print-mode-a4');
    for (let i = 0; i < 35; i++) {
        const div = document.createElement('div'); div.className = 'label-item';
        const can = document.createElement('canvas'), txt = document.createElement('div');
        txt.className = 'label-txt'; txt.innerHTML = `${m.braId}<br>${document.getElementById('sel-color').value} ${document.getElementById('sel-band').value}${document.getElementById('sel-cup').value}`;
        div.appendChild(can); div.appendChild(txt); p.appendChild(div);
        new QRious({ element: can, value: `${m.vCode},${m.braId},,${document.getElementById('sel-color').value},${document.getElementById('sel-band').value},${document.getElementById('sel-cup').value},${document.getElementById('sel-size').value}`, size: 100 });
    }
    setTimeout(() => { window.print(); document.body.classList.remove('print-mode-a4'); p.style.display = 'none'; }, 500);
};

app.adjQty = function(v,b,c,bb,bc,bz, qty) {
    let t = this.data.inventory.find(i => i.vCode===v && i.braId===b && i.c===c && i.bb===bb && i.bc===bc && i.bz===bz);
    if(t) { t.bq = parseInt(t.bq) + qty; this.saveAll(); this.ui.renderStock(); }
};

app.savePrintCfg = function() {
    app.data.printCfg = { a4mt: document.getElementById('p-a4mt').value, a4ml: document.getElementById('p-a4ml').value, a4gx: document.getElementById('p-a4gx').value, a4gy: document.getElementById('p-a4gy').value };
    app.ui.applyPrintCss(); app.saveAll(); alert("ç‰ˆé¢è¨­å®šå·²å„²å­˜è‡³é›²ç«¯");
};

window.onload = () => app.init();
</script>
</body>
</html>
