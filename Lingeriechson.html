<!DOCTYPE html>
<html lang="zh-Hant">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Lingerie Pro - é›²ç«¯æ™ºæ…§åº«å­˜ç®¡ç†ç³»çµ±</title>
    <script src="https://unpkg.com/html5-qrcode"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/qrious/4.0.2/qrious.min.js"></script>
    <style>
        :root {
            --primary: #8da399; --accent: #d4a373; --bg: #f9f7f2; --card-bg: #ffffff; --border: #e0dcd0; --danger: #e53e3e; --success: #48bb78;
            --a4-mt: 15.5mm; --a4-ml: 6.5mm; --a4-gx: 2.5mm; --a4-gy: 0mm;
            --s-mt: 0mm; --s-ml: 0mm;
        }
        body { font-family: -apple-system, "Noto Sans TC", sans-serif; background: var(--bg); margin: 0; padding: 10px; color: #444; }
        .container { max-width: 600px; margin: auto; }
        .card { background: var(--card-bg); border-radius: 12px; padding: 15px; margin-bottom: 15px; border: 1px solid var(--border); box-shadow: 0 2px 4px rgba(0,0,0,0.05); }
        h3 { color: #6b7e75; border-left: 4px solid var(--accent); padding-left: 10px; margin: 0 0 15px 0; font-size: 1rem; }
        #login-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: var(--bg); z-index: 9999; display: flex; align-items: center; justify-content: center; }
        .login-card { width: 90%; max-width: 350px; background: white; padding: 30px; border-radius: 15px; box-shadow: 0 10px 25px rgba(0,0,0,0.1); }
        .admin-only { display: none; }
        body.is-admin .admin-only { display: block; }
        .config-card { background: #f4f6f5; border: 1px solid #d1d5db; border-radius: 8px; padding: 12px; margin: 10px 0; }
        .config-input-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(120px, 1fr)); gap: 10px; }
        .config-input-grid input { height: 40px !important; border: 1px solid #ccc; border-radius: 6px; text-align: center; font-size: 14px !important; width: 100% !important; box-sizing: border-box !important; }
        .field { display: flex; flex-direction: column; gap: 5px; margin-bottom: 12px; width: 100%; }
        .row-inputs { display: flex; gap: 8px; margin-bottom: 10px; flex-wrap: wrap; }
        input, select { flex: 1; min-width: 80px; padding: 12px; font-size: 16px; border: 1px solid var(--border); border-radius: 8px; box-sizing: border-box; background: #fff; height: 48px; }
        button { width: 100%; padding: 14px; font-size: 16px; border: none; border-radius: 8px; background: var(--primary); color: white; font-weight: bold; cursor: pointer; }
        .btn-success { background: var(--success); }
        .btn-danger { background: var(--danger); }
        .btn-accent { background: var(--accent); }
        #loading-mask { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(255,255,255,0.8); z-index: 10000; display: none; align-items: center; justify-content: center; font-weight: bold; color: var(--primary); }
        .table-wrapper { overflow-x: auto; border-radius: 8px; border: 1px solid #eee; margin-top: 10px; }
        table { width: 100%; border-collapse: collapse; background: #fff; min-width: 400px; font-size: 0.85rem; }
        th, td { padding: 10px; text-align: left; border-bottom: 1px solid #f9f9f9; }
        .tag { background: #f0f2f1; padding: 6px 10px; border-radius: 6px; font-size: 0.8rem; border: 1px solid #e0e5e3; display: flex; align-items: center; }
        @media print {
            .no-print { display: none !important; }
            #print-label-page { display: block !important; }
            /* ...å…¶é¤˜åˆ—å°æ¨£å¼ä¿æŒä¸è®Š... */
        }
    </style>
</head>
<body>
    <div id="loading-mask">è™•ç†ä¸­ï¼Œè«‹ç¨å€™...</div>
    
    <div id="login-overlay">
        <div class="login-card">
            <h2 style="text-align:center; color:var(--primary); margin-top:0;">Lingerie Pro</h2>
            <div class="field"><input type="text" id="login-id" placeholder="å¸³è™Ÿ"></div>
            <div class="field"><input type="password" id="login-pw" placeholder="å¯†ç¢¼"></div>
            <button onclick="login()">ç™»å…¥ç³»çµ±</button>
        </div>
    </div>

    <div class="container no-print">
        <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:15px;">
            <span id="user-info" style="font-size:0.9rem; font-weight:bold;"></span>
            <button onclick="location.reload()" style="width:auto; padding:5px 15px; background:#666;">ç™»å‡º</button>
        </div>

        <div class="card admin-only">
            <h3>0. ç³»çµ±ç’°å¢ƒè¨­å®š</h3>
            <div class="config-card">
                <div class="config-input-grid">
                    <div class="config-group">
                        <label>å…¬å¸åç¨± (å°æ‡‰è©¦ç®—è¡¨)</label>
                        <input type="text" id="compNameInp" placeholder="è«‹è¼¸å…¥å…¬å¸åç¨±" onchange="updateSysConfig()">
                    </div>
                    <div class="config-group">
                        <label>ç¨…ç‡ (%)</label>
                        <input type="number" id="taxRateInp" value="5" onchange="updateSysConfig()">
                    </div>
                </div>
                <p class="dir-hint">â€» è¼¸å…¥å®Œæˆå¾Œé›¢é–‹è¼¸å…¥æ¡†å³è‡ªå‹•åŒæ­¥è‡³é›²ç«¯</p>
            </div>
            
            <div style="background:#edf2f7; padding:10px; border-radius:8px; margin-top:10px;">
                <p style="font-size:11px; font-weight:bold; margin:0 0 8px 0; color:#4a5568;">ğŸ‘¤ ä½¿ç”¨è€…å¸³è™Ÿç®¡ç†</p>
                <div class="row-inputs">
                    <input type="text" id="newUserId" placeholder="å¸³è™Ÿ">
                    <input type="text" id="newUserPw" placeholder="å¯†ç¢¼">
                    <select id="newUserRole">
                        <option value="staff">å“¡å·¥ (Staff)</option>
                        <option value="admin">ç®¡ç†å“¡ (Admin)</option>
                    </select>
                </div>
                <button class="btn-success" onclick="addUser()">æ–°å¢ä½¿ç”¨è€…ä»£ç¢¼</button>
            </div>
        </div>

        <div id="scanner-container">
            <div id="scan-feedback">æƒææˆåŠŸï¼</div>
            <div id="reader" style="width:100%;"></div>
            <button class="btn-danger" onclick="stopScan()" style="border-radius:0;">é—œé–‰æƒæå™¨</button>
        </div>

        <div class="card admin-only">
            <h3>1. åŸºç¤è³‡æ–™ç¶­è­·</h3>
            <div class="row-inputs">
                <input type="text" id="vCode" placeholder="å» å•†ä»£ç¢¼">
                <input type="text" id="vName" placeholder="åç¨±">
                <button style="width:auto;" onclick="addVendor()">æ–°å¢å» å•†</button>
            </div>
            <div class="row-inputs">
                <input type="text" id="colorStr" placeholder="é¡è‰²åç¨±:ä»£ç¢¼ (å¦‚ é»‘è‰²:BK)">
                <button style="width:auto;" onclick="addColor()">æ–°å¢é¡è‰²</button>
            </div>
            <hr style="border:0; border-top:1px solid var(--border); margin:15px 0;">
            <div class="row-inputs">
                <select id="setVendorRel"></select>
                <input type="text" id="mBraId" placeholder="å‹è™Ÿ">
                <input type="text" id="mType" placeholder="é¡å‹">
            </div>
            <div class="row-inputs">
                <input type="number" id="mCost" placeholder="é€²åƒ¹">
                <input type="number" id="mPrice" placeholder="å”®åƒ¹">
                <button class="btn-accent" onclick="addModel()">æ–°å¢å‹è™Ÿæ¬¾å¼</button>
            </div>
        </div>
<div class="card">
            <h3>2. åº«å­˜èˆ‡æ¨™ç±¤ä½œæ¥­</h3>
            <div class="row-inputs">
                <select id="selectVendor" onchange="filterModels()"></select>
                <select id="selectModel"></select>
                <select id="selectColor"></select>
            </div>
            <div class="row-inputs" style="display:grid; grid-template-columns:1fr 1fr 1fr; gap:8px;">
                <input type="text" id="sizeB" placeholder="ä¸‹èƒ¸åœ">
                <input type="text" id="sizeC" placeholder="ç½©æ¯">
                <input type="text" id="sizeZ" placeholder="å°ºå¯¸">
            </div>
            <div class="row-inputs">
                <input type="number" id="adjQty" placeholder="æ•¸é‡" value="1">
                <button class="btn-success" onclick="updateStock(1)">å…¥åº«</button>
                <button class="btn-danger admin-only" onclick="updateStock(-1)">æ‰£é™¤</button>
            </div>
            <div class="row-inputs">
                <button onclick="startScan('stock')">ğŸ“· æƒææ¢ç¢¼</button>
                <button class="btn-accent" onclick="preparePrint()">ğŸ·ï¸ ç”Ÿæˆæ¨™ç±¤</button>
            </div>
            
            <div id="print-preview-zone" style="display:none; margin-top:15px; border:2px dashed var(--accent); padding:10px;">
                <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:10px;">
                    <b>åˆ—å°é è¦½</b>
                    <button onclick="doPrint('a4')" style="width:auto; padding:5px 10px;">åˆ—å° (A4)</button>
                </div>
                <div id="preview-content" style="display:flex; flex-wrap:wrap; gap:5px;"></div>
            </div>
        </div>

        <div class="card">
            <h3>3. éŠ·å”®å‡ºè²¨ç®¡ç†</h3>
            <div class="row-inputs">
                <button onclick="startScan('sale')">ğŸ“· æƒææ¢ç¢¼åŠ å…¥è³¼ç‰©è»Š</button>
            </div>
            <div class="table-wrapper">
                <table id="cart-table">
                    <thead><tr><th>å•†å“è³‡è¨Š</th><th>å–®åƒ¹</th><th>æ•¸é‡</th><th>æ“ä½œ</th></tr></thead>
                    <tbody id="cart-body"></tbody>
                </table>
            </div>
            <div style="text-align:right; font-weight:bold; margin-top:10px; font-size:1.1rem;">
                ç¸½è¨ˆ: $<span id="cart-total">0</span>
            </div>
            <button class="btn-success" style="margin-top:10px;" onclick="checkout()">ç¢ºèªå‡ºè²¨ä¸¦åˆ—å°ç™¼ç¥¨</button>
        </div>

        <div class="card">
            <h3>4. åº«å­˜ç´€éŒ„æŸ¥è©¢</h3>
            <div class="table-wrapper"><table id="data-table"><thead></thead><tbody id="data-body"></tbody></table></div>
        </div>
    </div>

    <script>
        // --- æ ¸å¿ƒè®Šæ•¸ ---
        const API_URL = "æ‚¨çš„éƒ¨ç½²ç¶²å€"; // è«‹åœ¨æ­¤è™•å¡«å…¥æ‚¨çš„ Apps Script éƒ¨ç½²ç¶²å€
        let vendors = [], models = [], colors = [], inventory = [], users = [], cart = [];
        let compName = "æˆ‘çš„ç²¾å“å…§è¡£åº—", taxRate = 5;
        let currentUser = null;

        // --- åˆå§‹åŒ–èˆ‡åŒæ­¥ ---
        window.onload = async () => {
            const savedUser = localStorage.getItem('lingerieUser');
            if (savedUser) {
                currentUser = JSON.parse(savedUser);
                loginSuccess();
            }
        };

        function loginSuccess() {
            document.getElementById('login-overlay').style.display = 'none';
            document.getElementById('user-info').innerText = `ç›®å‰ä½¿ç”¨è€…ï¼š${currentUser.id}`;
            if (currentUser.role === 'admin') document.body.classList.add('is-admin');
            syncFromCloud();
        }

        async function syncFromCloud() {
            showLoading(true);
            try {
                const res = await fetch(`${API_URL}?action=getAll`);
                const data = await res.json();
                vendors = data.vendors || [];
                models = data.models || [];
                colors = data.colors || [];
                inventory = data.inventory || [];
                users = data.users || [];
                if (data.config) {
                    compName = data.config.compName || compName;
                    taxRate = data.config.taxRate || taxRate;
                }
                render();
            } catch (e) { console.error("åŒæ­¥å¤±æ•—", e); }
            showLoading(false);
        }

        function render() {
            // ã€é—œéµä¿®æ­£é»ã€‘å°‡é›²ç«¯æŠ“å›ä¾†çš„å…¬å¸åç¨±åŒæ­¥é¡¯ç¤ºåˆ°å‰ç«¯è¼¸å…¥æ¡†
            const cnInp = document.getElementById('compNameInp');
            const trInp = document.getElementById('taxRateInp');
            if (cnInp) cnInp.value = compName;
            if (trInp) trInp.value = taxRate;

            // æ›´æ–°å» å•†ä¸‹æ‹‰é¸å–®
            const vSels = [document.getElementById('setVendorRel'), document.getElementById('selectVendor')];
            vSels.forEach(s => {
                if(s) s.innerHTML = vendors.map(v => `<option value="${v.code}">${v.name}</option>`).join('');
            });
            
            // æ›´æ–°é¡è‰²
            document.getElementById('selectColor').innerHTML = colors.map(c => `<option value="${c.code}">${c.name}</option>`).join('');
            
            filterModels();
            updateInventoryTable();
        }
// --- æ ¸å¿ƒè³‡æ–™æ¨é€åˆ°é›²ç«¯ ---
        async function pushToCloud(action, params) {
            showLoading(true);
            try {
                const response = await fetch(API_URL, {
                    method: 'POST',
                    body: JSON.stringify({ action, ...params })
                });
                const result = await response.json();
                if (result.status === 'success') {
                    await syncFromCloud(); // æˆåŠŸå¾Œé‡æ–°æ•´ç†å…¨åŸŸè³‡æ–™
                } else {
                    alert("æ›´æ–°å¤±æ•—ï¼š" + result.message);
                }
            } catch (e) { alert("ç¶²è·¯å‚³è¼¸éŒ¯èª¤ï¼Œè«‹æª¢æŸ¥ç¶²è·¯é€£ç·š"); }
            showLoading(false);
        }

        // --- ç³»çµ±ç’°å¢ƒè¨­å®šåŒæ­¥ (æ ¸å¿ƒä¿®æ­£é») ---
        async function updateSysConfig() {
            const cn = document.getElementById('compNameInp').value;
            const tr = document.getElementById('taxRateInp').value;
            
            // å…ˆåŒæ­¥æ›´æ–°æœ¬åœ°è®Šæ•¸ï¼Œé¿å…ç•«é¢é–ƒçˆ
            compName = cn;
            taxRate = Number(tr);
            
            await pushToCloud('updateConfig', { compName: cn, taxRate: tr });
        }

        async function updateStock(amt) {
            const params = {
                m: document.getElementById('selectModel').value,
                c: document.getElementById('selectColor').value,
                bb: document.getElementById('sizeB').value,
                bc: document.getElementById('sizeC').value,
                bz: document.getElementById('sizeZ').value,
                qty: document.getElementById('adjQty').value * amt
            };
            if(!params.m) return alert("è«‹å…ˆé¸å–å‹è™Ÿ");
            await pushToCloud('updateInventory', params);
        }

        // --- æ¨™ç±¤ç”Ÿæˆé‚è¼¯ ---
        function preparePrint() {
            const m = document.getElementById('selectModel').value;
            const c = document.getElementById('selectColor').value;
            const bb = document.getElementById('sizeB').value;
            const bc = document.getElementById('sizeC').value;
            const bz = document.getElementById('sizeZ').value;
            const qty = document.getElementById('adjQty').value;
            const code = `${m}-${c}-${bb}-${bc}-${bz}`;
            
            const zone = document.getElementById('preview-content');
            zone.innerHTML = "";
            for (let i = 0; i < qty; i++) {
                const div = document.createElement('div');
                div.className = "label-item";
                div.innerHTML = `<canvas class="qr"></canvas><div class="txt" style="font-size:10px; font-weight:bold;">${m}-${c}<br>${bb}${bc}${bz}</div>`;
                zone.appendChild(div);
                new QRious({ element: div.querySelector('.qr'), value: code, size: 80 });
            }
            document.getElementById('print-preview-zone').style.display = 'block';
        }

        function doPrint(mode) {
            window.print();
        }

        // --- éŠ·å”®ç´€éŒ„èˆ‡ç™¼ç¥¨ ---
        async function checkout() {
            if (cart.length === 0) return alert("è³¼ç‰©è»Šç›®å‰ç„¡å•†å“");
            const total = document.getElementById('cart-total').innerText;
            if (confirm(`ç¢ºå®šå®Œæˆå‡ºè²¨ï¼Ÿ ç¸½è¨ˆï¼š$${total}`)) {
                await pushToCloud('shipInvoice', { items: cart, total: total });
                printInvoice(total);
                cart = [];
                updateCart();
            }
        }

        function printInvoice(total) {
            const sub = Math.round(total / (1 + taxRate/100));
            const tax = total - sub;
            let html = `<div style="padding:20px; font-family:sans-serif;">`;
            html += `<h2 style="text-align:center; border-bottom:2px solid #000; padding-bottom:10px;">${compName}</h2>`;
            html += `<p>æ—¥æœŸï¼š${new Date().toLocaleString()}<br>äº¤æ˜“é¡å‹ï¼šä¸€èˆ¬éŠ·å”®</p>`;
            html += `<table style="width:100%; border-collapse:collapse; margin-top:10px;">`;
            html += `<tr><th style="border-bottom:1px solid #000; text-align:left;">å“é …</th><th style="border-bottom:1px solid #000;">æ•¸é‡</th><th style="border-bottom:1px solid #000; text-align:right;">å°è¨ˆ</th></tr>`;
            cart.forEach(i => {
                html += `<tr><td style="padding:5px 0;">${i.m}-${i.c}</td><td style="text-align:center;">${i.q}</td><td style="text-align:right;">$${i.p * i.q}</td></tr>`;
            });
            html += `</table><div style="text-align:right; margin-top:20px; line-height:1.6;">`;
            html += `æœªç¨…é‡‘é¡ï¼š$${sub}<br>ç‡Ÿæ¥­ç¨…(${taxRate}%)ï¼š$${tax}<br>`;
            html += `<span style="font-size:1.2rem; font-weight:bold;">æ‡‰æ”¶ç¸½è¨ˆï¼š$${total}</span></div></div>`;
            
            // é€™è£¡å¯ä»¥å°å‘éš±è—çš„åˆ—å° DIV ä¸¦åŸ·è¡Œåˆ—å°
            const win = window.open('', '_blank');
            win.document.write(html);
            win.document.close();
            win.print();
        }

        function updateInventoryTable() {
            const body = document.getElementById('data-body');
            body.innerHTML = inventory.map(i => `<tr><td>${i.å‹è™Ÿ}</td><td>${i.é¡è‰²}</td><td>${i.ä¸‹èƒ¸åœ}${i.ç½©æ¯}${i.å°ºå¯¸}</td><td><b>${i.æ•¸é‡}</b></td></tr>`).join('');
        }

        function showLoading(show) { document.getElementById('loading-mask').style.display = show ? 'flex' : 'none'; }

        // --- æƒæèˆ‡è³¼ç‰©è»ŠåŠŸèƒ½å·²åœ¨ Part 3 çµæ§‹ä¸­å®šç¾©ï¼Œæ­¤è™•ç‚ºè¼”åŠ©è¼”åŠ©é‚è¼¯ ---
        function updateCart() {
            const body = document.getElementById('cart-body');
            let total = 0;
            body.innerHTML = cart.map((item, index) => {
                total += item.p * item.q;
                return `<tr><td>${item.m}-${item.c}</td><td>$${item.p}</td><td>${item.q}</td><td><button onclick="cart.splice(${index},1);updateCart()" style="background:red; color:white; border:none; padding:2px 8px; border-radius:4px;">åˆª</button></td></tr>`;
            }).join('');
            document.getElementById('cart-total').innerText = total;
        }
    </script>
</body>
</html>
