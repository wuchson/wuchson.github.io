<!DOCTYPE html>
<html lang="zh-Hant">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Lingerie Pro - é›²ç«¯æ™ºæ…§åº«å­˜ç³»çµ±</title>
    <script src="https://unpkg.com/html5-qrcode"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/qrious/4.0.2/qrious.min.js"></script>
    <style>
        :root {
            --primary: #8da399; --accent: #d4a373; --bg: #f9f7f2; --card-bg: #ffffff;
            --border: #e0dcd0; --danger: #e53e3e; --success: #48bb78;
            --a4-mt: 15.5mm; --a4-ml: 6.5mm; --a4-gx: 2.5mm; --a4-gy: 0mm;
            --s-mt: 0mm; --s-ml: 0mm;
        }
        body { font-family: -apple-system, "Noto Sans TC", sans-serif; background: var(--bg); margin: 0; padding: 10px; color: #444; -webkit-tap-highlight-color: transparent; }
        .container { max-width: 600px; margin: 0 auto; background: var(--card-bg); padding: 15px; border-radius: 12px; box-shadow: 0 4px 15px rgba(0,0,0,0.05); }
        
        /* å°è¦½èˆ‡åˆ‡æ› */
        .tabs { display: flex; overflow-x: auto; gap: 8px; margin-bottom: 15px; padding-bottom: 5px; border-bottom: 2px solid var(--border); }
        .tab-btn { padding: 10px 18px; border: none; background: #eee; border-radius: 20px; cursor: pointer; white-space: nowrap; font-size: 14px; transition: 0.3s; flex-shrink: 0; }
        .tab-btn.active { background: var(--primary); color: white; }

        /* å¡ç‰‡å…ƒä»¶ */
        .card { border: 1px solid var(--border); border-radius: 10px; padding: 15px; margin-bottom: 15px; }
        h2 { font-size: 18px; margin-top: 0; color: var(--primary); display: flex; align-items: center; gap: 8px; }
        .form-group { margin-bottom: 12px; }
        label { display: block; font-size: 13px; margin-bottom: 4px; color: #666; font-weight: bold; }
        input, select { width: 100%; padding: 10px; border: 1px solid var(--border); border-radius: 6px; box-sizing: border-box; font-size: 15px; }
        
        /* æŒ‰éˆ•è¨­è¨ˆ */
        .btn { width: 100%; padding: 12px; border: none; border-radius: 6px; cursor: pointer; font-size: 15px; font-weight: 600; transition: 0.2s; margin-top: 5px; }
        .btn-primary { background: var(--primary); color: white; }
        .btn-accent { background: var(--accent); color: white; }
        .btn-outline { background: transparent; border: 1px solid var(--primary); color: var(--primary); }
        .btn:active { opacity: 0.7; transform: scale(0.98); }

        /* æ¸…å–®é …ç›® */
        .list-item { display: flex; justify-content: space-between; align-items: center; padding: 12px; border-bottom: 1px solid #eee; font-size: 14px; }
        .badge { padding: 2px 8px; border-radius: 10px; font-size: 11px; background: #f0f0f0; border: 1px solid var(--border); }

        /* è¼‰å…¥é®ç½© */
        #loadingOverlay { position: fixed; top:0; left:0; width:100%; height:100%; background:rgba(255,255,255,0.85); 
                          display:none; justify-content:center; align-items:center; z-index:9999; flex-direction:column; }
        .spinner { width: 40px; height: 40px; border: 4px solid #f3f3f3; border-top: 4px solid var(--primary); border-radius: 50%; animation: spin 1s linear infinite; }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }

        /* æƒæå€åŸŸ */
        #reader { width: 100%; border-radius: 8px; overflow: hidden; margin-bottom: 10px; display: none; background: #000; }
        .page { display: none; }
        .page.active { display: block; animation: fadeIn 0.3s ease; }
        @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }
    </style>
</head>
<div id="loadingOverlay">
        <div class="spinner"></div>
        <p style="margin-top:10px; color:var(--primary); font-weight:bold;">åŒæ­¥é›²ç«¯è³‡æ–™ä¸­...</p>
    </div>

    <div class="container">
        <div class="tabs">
            <button class="tab-btn active" onclick="showPage('shipPage')">å‡ºè²¨</button>
            <button class="tab-btn" onclick="showPage('stockPage')">åº«å­˜</button>
            <button class="tab-btn" onclick="showPage('printPage')">æ¨™ç±¤</button>
            <button class="tab-btn" onclick="showPage('vendorPage')">è³‡æ–™ç¶­è­·</button>
            <button class="tab-btn" onclick="showPage('settingPage')">è¨­å®š</button>
        </div>

        <div id="shipPage" class="page active">
            <div class="card">
                <h2><span>ğŸ“¦</span> å‡ºè²¨æƒæ</h2>
                <div id="reader"></div>
                <button class="btn btn-outline" id="scanBtn" onclick="toggleScanner()">é–‹å•Ÿç›¸æ©Ÿæƒæ</button>
                
                <div class="form-group" style="margin-top:15px;">
                    <label>æ‰‹å‹•è¼¸å…¥æˆ–æƒæ (æ ¼å¼: å» å•†-å‹è™Ÿ-é¡è‰²-å°ºå¯¸)</label>
                    <input type="text" id="shipCodeInp" placeholder="ä¾‹å¦‚: V01-B101-é»‘è‰²-BB" onkeypress="if(event.key==='Enter') handleManualInput()">
                </div>
            </div>

            <div class="card">
                <h2>å¾…å‡ºè²¨æ¸…å–®</h2>
                <div id="invoiceItems"></div>
                <div style="margin-top:10px; border-top:1px solid #eee; padding-top:10px;">
                    <div style="display:flex; justify-content:space-between; font-weight:bold;">
                        <span>æœ¬æ¬¡å‡ºè²¨ä»¶æ•¸:</span>
                        <span id="invoiceCount">0 ä»¶</span>
                    </div>
                </div>
                <button class="btn btn-primary" onclick="shipInvoice()">ç¢ºèªå‡ºè²¨ä¸¦åŒæ­¥é›²ç«¯</button>
            </div>
        </div>

        <div id="stockPage" class="page">
            <div class="card">
                <h2><span>ğŸ”</span> åº«å­˜æŸ¥è©¢ (æ–°æ¬„ä½ç‰ˆ)</h2>
                <input type="text" id="stockSearch" placeholder="æœå°‹å» å•†ã€å‹è™Ÿæˆ–é¡è‰²..." oninput="renderStock()">
                <div id="stockList" style="margin-top:15px; max-height:450px; overflow-y:auto;"></div>
            </div>
        </div>

        <div id="printPage" class="page">
            <div class="card">
                <h2><span>ğŸ·ï¸</span> ç”¢ç”Ÿæ¨™ç±¤</h2>
                <div class="form-group">
                    <label>é¸æ“‡å» å•† (vCode)</label>
                    <select id="prnVendor" onchange="updatePrnModels()"></select>
                </div>
                <div class="form-group">
                    <label>é¸æ“‡æ¬¾å¼ (braId)</label>
                    <select id="prnModel"></select>
                </div>
                <div class="form-group">
                    <label>é¸æ“‡é¡è‰² (c)</label>
                    <select id="prnColor"></select>
                </div>
                <div class="form-group">
                    <label>å°ºå¯¸èˆ‡æ•¸é‡ (bb / bc / bz)</label>
                    <div style="display:grid; grid-template-columns: 1fr 1fr 1fr; gap:8px;">
                        <input type="number" id="prnBB" placeholder="BB">
                        <input type="number" id="prnBC" placeholder="BC">
                        <input type="number" id="prnBZ" placeholder="é›¶ç¢¼">
                    </div>
                </div>
                <button class="btn btn-accent" onclick="addToPrintQueue()">åŠ å…¥åˆ—å°éšŠåˆ—</button>
            </div>
            
            <div class="card">
                <h2>åˆ—å°é è¦½èˆ‡ç™¼é€</h2>
                <div id="printQueue"></div>
                <div style="display:grid; grid-template-columns: 1fr 1fr; gap:10px; margin-top:10px;">
                    <button class="btn btn-outline" onclick="printLabels('A4')">åˆ—å° A4 ç‰ˆé¢</button>
                    <button class="btn btn-outline" onclick="printLabels('Single')">åˆ—å°å–®å¼µ</button>
                </div>
            </div>
        </div>

        <div id="vendorPage" class="page">
            <div class="card">
                <h2>æ–°å¢è³‡æ–™</h2>
                <label>æ–°å¢å» å•† (code & name)</label>
                <div style="display:flex; gap:5px; margin-bottom:12px;">
                    <input type="text" id="newVendorCode" placeholder="ä»£ç¢¼">
                    <input type="text" id="newVendorName" placeholder="åç¨±">
                    <button class="btn btn-primary" style="width:70px; margin:0;" onclick="addVendor()">+</button>
                </div>
                <label>æ–°å¢é¡è‰² (code & name)</label>
                <div style="display:flex; gap:5px;">
                    <input type="text" id="newColorCode" placeholder="ä»£ç¢¼">
                    <input type="text" id="newColorName" placeholder="é¡è‰²">
                    <button class="btn btn-accent" style="width:70px; margin:0;" onclick="addColor()">+</button>
                </div>
            </div>
            <div class="card">
                <h2>ç¾æœ‰æ¸…å–®</h2>
                <div id="vendorModelList" style="font-size: 13px;"></div>
            </div>
        </div>

        <div id="settingPage" class="page">
            <div class="card">
                <h2>ç³»çµ±èˆ‡ç‰ˆé¢è¨­å®š</h2>
                <div class="form-group">
                    <label>åº—é‹ªåç¨±</label>
                    <input type="text" id="compNameInp">
                </div>
                <div class="form-group">
                    <label>ç¨…ç‡ (%)</label>
                    <input type="number" id="taxRateInp">
                </div>
                <button class="btn btn-primary" onclick="updateSysConfig()">å„²å­˜é›²ç«¯è¨­å®š</button>
            </div>
        </div>
    </div> ```
<script>
        // --- é›²ç«¯è¨­å®š ---
        // è«‹å‹™å¿…ç¢ºä¿æ­¤è™•å¡«å¯«çš„æ˜¯æ‚¨æœ€æ–°ã€Œéƒ¨ç½²ã€å¾Œçš„ç¶²å€
        const GAS_URL = 'https://script.google.com/macros/s/AKfycby1N4MJ-Mn0Ctn_K7ZDKMShntspL24UkiRZN7f1DE0Fd6Dgydp_6YwS1DCsOhZ8Fpw8/exec'; 

        // å…¨åŸŸè®Šæ•¸ - é…åˆæ–°æ¬„ä½çµæ§‹
        let vendors = [], models = [], inventory = [], colors = [], users = [];
        let invoiceItems = [], printQueue = [];
        let compName = "æˆ‘çš„å…§è¡£ç²¾å“åº—", taxRate = 5;
        let html5QrCode = null;

        // 1. åˆå§‹åŒ–èˆ‡é›²ç«¯åŒæ­¥
        window.onload = async () => {
            loadPrintConfigs(); // è¼‰å…¥åˆ—å°ç‰ˆé¢è¨­å®š
            showLoading(true);
            
            // ä¿®æ­£ï¼šåªè¦ GAS_URL æœ‰åŒ…å«è…³æœ¬ç¶²å€ç‰¹å¾µï¼Œå°±åŸ·è¡ŒåŒæ­¥
            if (GAS_URL && GAS_URL.includes("script.google.com")) {
                console.log("æ­£åœ¨é€£æ¥é›²ç«¯è³‡æ–™åº«...");
                await syncFromCloud();
            } else {
                console.warn("GAS_URL æœªè¨­å®šæˆ–æ ¼å¼éŒ¯èª¤");
                alert("æœªè¨­å®šé›²ç«¯ç¶²å€ï¼Œè«‹å…ˆä¿®æ”¹ HTML ä¸­çš„ GAS_URL è®Šæ•¸");
            }
            
            showLoading(false);
            render(); 
        };

        // 2. å¾é›²ç«¯æŠ“å–æ‰€æœ‰è³‡æ–™ (GET)
        async function syncFromCloud() {
            try {
                const response = await fetch(`${GAS_URL}?action=getAll`);
                const data = await response.json();
                
                if (data.error) throw new Error(data.error);

                // æ›´æ–°å‰ç«¯è®Šæ•¸ (å°æ¥æ–°æ¬„ä½)
                vendors = data.vendors || [];
                models = data.models || [];
                inventory = data.inventory || []; // å…§å« vCode, braId, c, bb, bc, bz, bq
                colors = data.colors || [];
                users = data.users || [];
                
                if (data.config) {
                    compName = data.config.compName || compName;
                    taxRate = data.config.taxRate || taxRate;
                    document.getElementById('compNameInp').value = compName;
                    document.getElementById('taxRateInp').value = taxRate;
                }
                console.log("è³‡æ–™åŒæ­¥å®Œæˆ", data);
            } catch (err) {
                console.error("åŒæ­¥å¤±æ•—:", err);
                alert("æŠ“å–è³‡æ–™å¤±æ•—ï¼Œè«‹ç¢ºèª Apps Script éƒ¨ç½²ç‰ˆæœ¬èˆ‡æ¬Šé™æ˜¯å¦ç‚ºã€Œä»»ä½•äººã€");
            }
        }

        // 3. æ¨é€è³‡æ–™å›é›²ç«¯ (POST)
        async function pushToCloud(action, payload) {
            showLoading(true);
            try {
                const response = await fetch(GAS_URL, {
                    method: 'POST',
                    body: JSON.stringify({ action, ...payload })
                });
                const result = await response.json();
                
                if (result.status === 'success') {
                    // æˆåŠŸå¯«å…¥å¾Œï¼Œç«‹åˆ»åˆ·æ–°å‰ç«¯è³‡æ–™
                    await syncFromCloud();
                    render();
                } else {
                    alert("é›²ç«¯è™•ç†éŒ¯èª¤: " + result.message);
                }
            } catch (err) {
                console.error("å‚³é€å¤±æ•—:", err);
                alert("ç„¡æ³•é€£ç·šè‡³é›²ç«¯æœå‹™");
            } finally {
                showLoading(false);
            }
        }

        // 4. UI æ§åˆ¶
        function showPage(pageId) {
            document.querySelectorAll('.page').forEach(p => p.classList.remove('active'));
            document.querySelectorAll('.tab-btn').forEach(b => b.classList.remove('active'));
            document.getElementById(pageId).classList.add('active');
            
            // è™•ç†æ¨™ç±¤æŒ‰éˆ•é«˜äº®
            const btn = Array.from(document.querySelectorAll('.tab-btn')).find(b => b.textContent === event.target.textContent);
            if(btn) btn.classList.add('active');

            if (pageId !== 'shipPage' && html5QrCode) stopScanner();
        }

        function showLoading(show) {
            document.getElementById('loadingOverlay').style.display = show ? 'flex' : 'none';
        }

        function render() {
            renderStock();       // æ¸²æŸ“åº«å­˜åˆ—è¡¨
            updateDropdowns();   // æ›´æ–°ä¸‹æ‹‰é¸å–®
            renderVendorList();  // æ¸²æŸ“è³‡æ–™ç¶­è­·æ¸…å–®
        }
    </script>
// 5. å‡ºè²¨æƒæèˆ‡è™•ç† (å°æ¥ vCode, braId, c)
        function toggleScanner() {
            const readerEl = document.getElementById('reader');
            if (html5QrCode && html5QrCode.isScanning) {
                stopScanner();
            } else {
                readerEl.style.display = 'block';
                document.getElementById('scanBtn').innerText = 'åœæ­¢æƒæ';
                html5QrCode = new Html5Qrcode("reader");
                html5QrCode.start(
                    { facingMode: "environment" },
                    { fps: 10, qrbox: 250 },
                    (text) => {
                        handleBarcode(text);
                        stopScanner();
                    }
                );
            }
        }

        function stopScanner() {
            if (html5QrCode) {
                html5QrCode.stop().then(() => {
                    document.getElementById('reader').style.display = 'none';
                    document.getElementById('scanBtn').innerText = 'é–‹å•Ÿç›¸æ©Ÿæƒæ';
                });
            }
        }

        function handleManualInput() {
            const inp = document.getElementById('shipCodeInp');
            if (inp.value) {
                handleBarcode(inp.value);
                inp.value = '';
            }
        }

        function handleBarcode(text) {
            // é æœŸæ ¼å¼: å» å•†ä»£ç¢¼-å‹è™Ÿ-é¡è‰²-å°ºå¯¸ (ä¾‹å¦‚: V01-B101-Black-BB)
            const parts = text.split('-');
            if (parts.length < 4) return alert("æ¢ç¢¼æ ¼å¼ä¸ç¬¦ (éœ€ç‚º: å» å•†-å‹è™Ÿ-é¡è‰²-å°ºå¯¸)");
            
            const item = {
                vCode: parts[0],
                braId: parts[1],
                c: parts[2],
                size: parts[3],
                bb: parts[3].toUpperCase() === 'BB' ? 1 : 0,
                bc: parts[3].toUpperCase() === 'BC' ? 1 : 0,
                bz: parts[3].toUpperCase() === 'BZ' ? 1 : 0,
                q: 1
            };
            invoiceItems.push(item);
            renderInvoice();
        }

        function renderInvoice() {
            const container = document.getElementById('invoiceItems');
            container.innerHTML = invoiceItems.map((item, idx) => `
                <div class="list-item">
                    <div><b>${item.braId}</b> (${item.c}) <span class="badge">${item.size}</span></div>
                    <button onclick="invoiceItems.splice(${idx},1);renderInvoice()" style="color:var(--danger); border:none; background:none; cursor:pointer;">âœ•</button>
                </div>
            `).join('');
            document.getElementById('invoiceCount').innerText = `${invoiceItems.length} ä»¶`;
        }

        async function shipInvoice() {
            if (invoiceItems.length === 0) return alert("å¾…å‡ºè²¨æ¸…å–®æ˜¯ç©ºçš„");
            if (!confirm(`ç¢ºå®šè¦å‡ºè²¨é€™ ${invoiceItems.length} ä»¶å•†å“å—ï¼Ÿ`)) return;

            // é€å‡ºè‡³é›²ç«¯ï¼Œaction ç‚º shipInvoice
            await pushToCloud('shipInvoice', { 
                items: invoiceItems, 
                count: invoiceItems.length,
                id: "admin" // é è¨­æ“ä½œè€…
            });
            
            invoiceItems = [];
            renderInvoice();
            alert("å‡ºè²¨ç´€éŒ„å·²å„²å­˜ï¼Œåº«å­˜å·²æ‰£é™¤");
        }

        // 6. åº«å­˜æ¸²æŸ“ (å°æ¥ vCode, braId, c, bq)
        function renderStock() {
            const keyword = document.getElementById('stockSearch').value.toLowerCase();
            const container = document.getElementById('stockList');
            
            const filtered = inventory.filter(i => 
                (i.braId && i.braId.toLowerCase().includes(keyword)) || 
                (i.vCode && i.vCode.toLowerCase().includes(keyword)) ||
                (i.c && i.c.toLowerCase().includes(keyword))
            );

            container.innerHTML = filtered.map(i => `
                <div class="card" style="padding:12px; margin-bottom:10px;">
                    <div style="display:flex; justify-content:space-between; align-items:start;">
                        <div>
                            <span class="badge" style="background:var(--accent); color:white;">${i.vCode}</span>
                            <b style="font-size:16px; margin-left:5px;">${i.braId}</b>
                        </div>
                        <span class="badge">${i.c}</span>
                    </div>
                    <div style="font-size:12px; color:#888; margin:8px 0;">
                        BB: ${i.bb || 0} | BC: ${i.bc || 0} | é›¶ç¢¼: ${i.bz || 0}
                    </div>
                    <div style="display:flex; justify-content:space-between; align-items:center; border-top:1px dashed #eee; padding-top:8px;">
                        <span style="color:var(--primary); font-weight:bold; font-size:15px;">ç¸½åº«å­˜: ${i.bq || 0}</span>
                        <div>
                            <button onclick="adjustQty('${i.vCode}','${i.braId}','${i.c}',${i.bb},${i.bc},${i.bz},-1)" class="btn-outline" style="padding:4px 10px; border-radius:4px; width:auto;">-1</button>
                            <button onclick="adjustQty('${i.vCode}','${i.braId}','${i.c}',${i.bb},${i.bc},${i.bz},1)" class="btn-outline" style="padding:4px 10px; border-radius:4px; width:auto;">+1</button>
                        </div>
                    </div>
                </div>
            `).join('');
        }

        async function adjustQty(vCode, braId, c, bb, bc, bz, amt) {
            await pushToCloud('adjustQty', { vCode, braId, c, bb, bc, bz, amt });
        }

        // 7. è³‡æ–™ç¶­è­·èˆ‡ä¸‹æ‹‰é¸å–®
        async function addVendor() {
            const code = document.getElementById('newVendorCode').value;
            const name = document.getElementById('newVendorName').value;
            if (!code || !name) return alert("è«‹è¼¸å…¥å®Œæ•´å» å•†è³‡è¨Š");
            await pushToCloud('addVendor', { code, name });
        }

        async function addColor() {
            const code = document.getElementById('newColorCode').value;
            const name = document.getElementById('newColorName').value;
            if (!code || !name) return alert("è«‹è¼¸å…¥å®Œæ•´é¡è‰²è³‡è¨Š");
            await pushToCloud('addColor', { code, name });
        }

        function renderVendorList() {
            const container = document.getElementById('vendorModelList');
            let html = "<b>ç¾æœ‰å» å•†:</b><br>";
            html += vendors.map(v => `${v.code} (${v.name})`).join(', ') || "æš«ç„¡è³‡æ–™";
            html += "<br><br><b>ç¾æœ‰é¡è‰²:</b><br>";
            html += colors.map(c => `${c.name}`).join(', ') || "æš«ç„¡è³‡æ–™";
            container.innerHTML = html;
        }

        function updateDropdowns() {
            const vSel = document.getElementById('prnVendor');
            const cSel = document.getElementById('prnColor');
            if(vSel) vSel.innerHTML = vendors.map(v => `<option value="${v.code}">${v.name}</option>`).join('');
            if(cSel) cSel.innerHTML = colors.map(c => `<option value="${c.name}">${c.name}</option>`).join('');
        }

        async function updateSysConfig() {
            const compName = document.getElementById('compNameInp').value;
            const taxRate = document.getElementById('taxRateInp').value;
            await pushToCloud('updateConfig', { compName, taxRate });
            alert("è¨­å®šå·²åŒæ­¥è‡³é›²ç«¯");
        }

        function loadPrintConfigs() {
            const cfg = JSON.parse(localStorage.getItem('printConfigs')) || { a4mt:15.5, a4ml:6.5, a4gx:2.5, a4gy:0 };
            const root = document.querySelector(':root');
            root.style.setProperty('--a4-mt', cfg.a4mt + 'mm');
            root.style.setProperty('--a4-ml', cfg.a4ml + 'mm');
        }
    </script>
</body>
</html>
