<!DOCTYPE html>
<html lang="zh-Hant">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Lingerie Pro - é›²ç«¯æ™ºæ…§ç®¡ç†ç³»çµ±</title>
    <script src="https://unpkg.com/html5-qrcode"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/qrious/4.0.2/qrious.min.js"></script>
    <style>
        :root {
            --primary: #8da399; --accent: #d4a373; --bg: #f9f7f2; --card-bg: #ffffff; 
            --border: #e0dcd0; --danger: #e53e3e; --success: #48bb78;
            --a4-mt: 15.5mm; --a4-ml: 6.5mm; --a4-gx: 2.5mm; --a4-gy: 0mm;
            --s-mt: 0mm; --s-ml: 0mm;
        }
        body { font-family: -apple-system, "Noto Sans TC", sans-serif; background: var(--bg); margin: 0; padding: 10px; color: #444; }
        .container { max-width: 600px; margin: auto; }
        .card { background: var(--card-bg); border-radius: 12px; padding: 15px; margin-bottom: 15px; border: 1px solid var(--border); box-shadow: 0 2px 4px rgba(0,0,0,0.05); }
        h3 { color: #6b7e75; border-left: 4px solid var(--accent); padding-left: 10px; margin: 0 0 15px 0; font-size: 1rem; }
        
        #login-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: var(--bg); z-index: 9999; display: flex; align-items: center; justify-content: center; }
        .login-card { width: 90%; max-width: 350px; background: white; padding: 30px; border-radius: 15px; box-shadow: 0 10px 25px rgba(0,0,0,0.1); }
        
        .admin-only, .staff-hidden { display: none; }
        body.is-admin .admin-only, body.is-admin .staff-hidden { display: block; }
        
        .config-card { background: #f4f6f5; border: 1px solid #d1d5db; border-radius: 8px; padding: 12px; margin: 10px 0; }
        .field { display: flex; flex-direction: column; gap: 5px; margin-bottom: 12px; width: 100%; }
        .row-inputs { display: flex; gap: 8px; margin-bottom: 10px; flex-wrap: wrap; }
        input, select { flex: 1; min-width: 80px; padding: 12px; font-size: 16px; border: 1px solid var(--border); border-radius: 8px; box-sizing: border-box; background: #fff; height: 48px; }
        button { width: 100%; padding: 14px; font-size: 16px; border: none; border-radius: 8px; background: var(--primary); color: white; font-weight: bold; cursor: pointer; }
        .btn-accent { background: var(--accent); }
        .btn-success { background: var(--success); }
        .btn-danger { background: var(--danger); }
        
        #scanner-container { display: none; margin-bottom: 15px; background: #000; border-radius: 12px; overflow: hidden; position: relative; }
        #scan-feedback { position: absolute; top: 10px; left: 50%; transform: translateX(-50%); background: rgba(72, 187, 120, 0.9); color: white; padding: 5px 25px; border-radius: 20px; font-weight: bold; z-index: 10; display: none; }
        
        .table-wrapper { overflow-x: auto; border-radius: 8px; border: 1px solid #eee; margin-top: 10px; }
        table { width: 100%; border-collapse: collapse; background: #fff; min-width: 450px; font-size: 0.85rem; }
        th, td { padding: 10px; text-align: left; border-bottom: 1px solid #f9f9f9; }
        .tag { background: #f0f2f1; padding: 6px 10px; border-radius: 6px; font-size: 0.8rem; border: 1px solid #e0e5e3; display: flex; align-items: center; }
        
        @media print {
            .no-print { display: none !important; }
            body.print-mode-a4 #print-label-page { display: grid !important; grid-template-columns: repeat(5, 38mm); padding-top: var(--a4-mt); padding-left: var(--a4-ml); column-gap: var(--a4-gx); row-gap: var(--a4-gy); }
            body.print-mode-single .label-item { width: 50mm; height: 30mm; display: flex; align-items: center; gap: 5mm; }
        }
    </style>
</head>
<body>
    <div id="login-overlay">
        <div class="login-card">
            <h2 style="text-align:center; color:var(--primary); margin-top:0;">Lingerie Pro</h2>
            <p style="text-align:center; color:#888; font-size:0.9rem;">è«‹è¼¸å…¥å¸³è™Ÿå¯†ç¢¼ä»¥é€£æ¥é›²ç«¯</p>
            <div class="field">
                <input type="text" id="login-u" placeholder="å¸³è™Ÿ">
            </div>
            <div class="field">
                <input type="password" id="login-p" placeholder="å¯†ç¢¼">
            </div>
            <button onclick="login()">ç™»å…¥ç³»çµ±</button>
            <p id="login-msg" style="color:var(--danger); text-align:center; font-size:0.85rem; margin-top:10px;"></p>
        </div>
    </div>

    <div class="container no-print">
        <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:15px;">
            <div>
                <strong id="display-compName" style="font-size:1.2rem; color:var(--primary);">è¼‰å…¥ä¸­...</strong>
                <div id="userStatus" style="font-size:0.75rem; color:#888;">æ­£åœ¨åŒæ­¥é›²ç«¯è³‡æ–™...</div>
            </div>
            <button class="btn-danger" style="width:auto; padding:5px 15px;" onclick="logout()">ç™»å‡º</button>
        </div>

        <div class="card">
            <div id="scan-feedback">æƒææˆåŠŸï¼</div>
            <div id="scanner-container">
                <div id="reader" style="width:100%;"></div>
                <button class="btn-danger" style="border-radius:0;" onclick="toggleScanner(false)">é—œé–‰ç›¸æ©Ÿ</button>
            </div>
            <button id="scan-btn" class="btn-accent" onclick="toggleScanner(true)" style="margin-bottom:15px;">ğŸ“· é–‹å•Ÿæƒææ§</button>

            <div class="row-inputs">
                <select id="vCode" onchange="updateBraOptions()">
                    <option value="">å» å•†</option>
                </select>
                <select id="braId">
                    <option value="">å‹è™Ÿ</option>
                </select>
                <select id="cCode">
                    <option value="">é¡è‰²</option>
                </select>
            </div>
            <div class="row-inputs">
                <select id="bb">
                    <option value="-">ä¸‹åœ</option>
                    <option value="70">70</option><option value="75">75</option><option value="80">80</option>
                    <option value="85">85</option><option value="90">90</option><option value="95">95</option>
                    <option value="100">100</option>
                </select>
                <select id="bc">
                    <option value="-">ç½©æ¯</option>
                    <option value="A">A</option><option value="B">B</option><option value="C">C</option>
                    <option value="D">D</option><option value="E">E</option><option value="F">F</option>
                    <option value="G">G</option><option value="H">H</option>
                </select>
                <select id="bz">
                    <option value="-">å°ºç¢¼</option>
                    <option value="M">M</option><option value="L">L</option><option value="XL">XL</option>
                    <option value="Q">Q</option><option value="2Q">2Q</option><option value="3Q">3Q</option>
                </select>
                <input type="number" id="bq" value="1" style="max-width:70px;">
            </div>
            <div style="display:flex; gap:10px;">
                <button class="btn-success" onclick="handleStock(1)">â• å…¥åº«</button>
                <button class="btn-danger" onclick="handleStock(-1)">â– å‡ºè²¨</button>
            </div>
        </div>

        <div class="card">
            <h3>ğŸ“¦ ç›®å‰é›²ç«¯åº«å­˜</h3>
            <div class="table-wrapper">
                <table id="inventoryTable">
                    <thead>
                        <tr>
                            <th>å•†å“</th>
                            <th>è¦æ ¼</th>
                            <th>æ•¸é‡</th>
                            <th class="admin-only">æ“ä½œ</th>
                        </tr>
                    </thead>
                    <tbody></tbody>
                </table>
            </div>
        </div>
<script>
    // --- æ ¸å¿ƒè®Šæ•¸èˆ‡é›²ç«¯è¨­å®š ---
    const GAS_URL = "https://script.google.com/macros/s/AKfycbzrMR013ODVk4bmvX3yXJxzp8hbEJGUzKj4eQjwTfirOY_mFEAzB7DIOSK86EZE7ciK/exec";
    
    let inventory = [], vendors = [], colors = [], models = [], salesHistory = [];
    let currentUser = null, compName = "é›²ç«¯ç®¡ç†ç³»çµ±", taxRate = 0.05;
    let html5QrCode = null;

    // --- é›²ç«¯é€šè¨Šå‡½å¼ (POST) ---
    async function callGAS(payload) {
        try {
            // ä½¿ç”¨ no-cors æ¨¡å¼é›–ç„¶ç„¡æ³•è®€å–å›å‚³å€¼ï¼Œä½†å¯ä»¥é¿å…ç€è¦½å™¨è·¨åŸŸæ””æˆª
            // ç‚ºäº†è®€å–å›å‚³ç‹€æ…‹ï¼Œå»ºè­° GAS ç«¯è™•ç†å¥½ CORSï¼Œæˆ–å‰ç«¯é€éå¾Œç«¯è½‰ç™¼
            const response = await fetch(GAS_URL, {
                method: "POST",
                mode: "no-cors", 
                headers: { "Content-Type": "application/json" },
                body: JSON.stringify(payload)
            });
            return { status: "pending" }; // å› ç‚º no-cors ç„¡æ³•ç²å–çœŸå¯¦ JSON å›å‚³
        } catch (e) {
            console.error("é›²ç«¯åŒæ­¥å¤±æ•—:", e);
            return { status: "error" };
        }
    }

    // --- ç™»å…¥èˆ‡è³‡æ–™åˆå§‹åŒ– (GET) ---
    async function login() {
        const u = document.getElementById('login-u').value;
        const p = document.getElementById('login-p').value;
        const msg = document.getElementById('login-msg');
        
        msg.innerText = "é©—è­‰ä¸­...";
        
        try {
            // å¾é›²ç«¯æŠ“å–æ‰€æœ‰åŸºç¤è³‡æ–™
            const res = await fetch(`${GAS_URL}?action=loadAll`);
            const data = await res.json();
            
            // é©—è­‰ä½¿ç”¨è€… (æ¯”å°å¾ GAS USERS åˆ†é æŠ“åˆ°çš„è³‡æ–™)
            const user = data.users.find(user => user.u === u && String(user.p) === p);
            
            if (user) {
                currentUser = user;
                if(user.r === 'admin') document.body.classList.add('is-admin');
                
                // åŒæ­¥é›²ç«¯è³‡æ–™åˆ°æœ¬åœ°è®Šæ•¸
                vendors = data.vendors || [];
                colors = data.colors || [];
                models = data.models || [];
                inventory = (data.inventory || []).map(i => ({
                    vCode: i.vCode, braId: i.braId, c: i.c, bb: i.bb, bc: i.bc, bz: i.bz, bq: Number(i.qty)
                }));
                
                // è¨­å®šå…¬å¸åç¨±èˆ‡ç¨…ç‡
                const cn = (data.config || []).find(c => c.key === "companyName");
                if(cn) compName = cn.value;
                
                document.getElementById('login-overlay').style.display = 'none';
                initSelectors();
                render();
            } else {
                msg.innerText = "å¸³è™Ÿæˆ–å¯†ç¢¼éŒ¯èª¤";
            }
        } catch (e) {
            msg.innerText = "é€£ç·šå¤±æ•—ï¼Œè«‹æª¢æŸ¥ç¶²è·¯æˆ– GAS æ¬Šé™";
            console.error(e);
        }
    }

    // --- é€²å‡ºè²¨æ ¸å¿ƒé‚è¼¯ ---
    async function handleStock(direction) {
        const vCode = document.getElementById('vCode').value;
        const braId = document.getElementById('braId').value;
        const c = document.getElementById('cCode').value;
        const bb = document.getElementById('bb').value;
        const bc = document.getElementById('bc').value;
        const bz = document.getElementById('bz').value;
        const qInput = document.getElementById('bq');
        const qty = Number(qInput.value) * direction;

        if (!vCode || !braId || !c) return alert("è«‹å®Œæ•´é¸æ“‡å» å•†ã€å‹è™Ÿèˆ‡é¡è‰²");

        // 1. å…ˆæ›´æ–°æœ¬åœ° UI (å³æ™‚å›é¥‹)
        let item = inventory.find(i => i.vCode===vCode && i.braId===braId && i.c===c && i.bb===bb && i.bc===bc && i.bz===bz);
        if (item) item.bq += qty;
        else inventory.push({ vCode, braId, c, bb, bc, bz, bq: qty });
        
        render();
        playBeep();
        showFeedback(qty > 0 ? "å…¥åº«æˆåŠŸ" : "å‡ºè²¨æˆåŠŸ");

        // 2. éåŒæ­¥å‚³é€åˆ°é›²ç«¯ GAS
        const price = (models.find(m => m.braId === braId) || {}).price || 0;
        await callGAS({
            action: "processTransaction",
            type: direction > 0 ? "IN" : "OUT",
            vCode, braId, c, bb, bc, bz,
            qty: Math.abs(qty),
            price: price
        });
    }

    function playBeep() { 
        const audio = new Audio('https://assets.mixkit.co/active_storage/sfx/766/766-preview.mp3');
        audio.play().catch(()=>{});
    }

    function showFeedback(text) {
        const fb = document.getElementById('scan-feedback');
        fb.innerText = text;
        fb.style.display = 'block';
        setTimeout(() => fb.style.display = 'none', 2000);
    }
// --- ä»‹é¢æ¸²æŸ“èˆ‡æ§åˆ¶ ---
    function render() {
        const tbody = document.querySelector('#inventoryTable tbody');
        tbody.innerHTML = '';
        
        // é¡¯ç¤ºå…¬å¸åç¨±
        document.getElementById('display-compName').innerText = compName;

        // åº«å­˜éæ¿¾ï¼šåªé¡¯ç¤ºæœ‰æ•¸é‡çš„å•†å“
        inventory.forEach((item, idx) => {
            if (item.bq === 0) return;
            const row = tbody.insertRow();
            row.innerHTML = `
                <td><strong>${item.vCode} / ${item.braId}</strong></td>
                <td><span class="tag">${getColorName(item.c)} ${item.bb}${item.bc} ${item.bz}</span></td>
                <td><b style="color:${item.bq < 3 ? 'red' : 'inherit'}">${item.bq}</b></td>
                <td class="admin-only">
                    <button class="btn-danger" style="padding:2px 8px; font-size:12px; width:auto;" onclick="deleteInventoryItem(${idx})">åˆªé™¤</button>
                </td>
            `;
        });
    }

    function initSelectors() {
        const vSel = document.getElementById('vCode');
        const cSel = document.getElementById('cCode');
        vSel.innerHTML = '<option value="">å» å•†</option>';
        cSel.innerHTML = '<option value="">é¡è‰²</option>';
        
        vendors.forEach(v => vSel.add(new Option(v.name, v.code)));
        colors.forEach(c => cSel.add(new Option(c.name, c.code)));
    }

    function updateBraOptions() {
        const vCode = document.getElementById('vCode').value;
        const bSel = document.getElementById('braId');
        bSel.innerHTML = '<option value="">å‹è™Ÿ</option>';
        models.filter(m => m.vCode === vCode).forEach(m => bSel.add(new Option(m.braId, m.braId)));
    }

    function getColorName(code) {
        const c = colors.find(i => i.code === code);
        return c ? c.name : code;
    }

    // --- æƒææ§æ§åˆ¶ ---
    function toggleScanner(show) {
        const container = document.getElementById('scanner-container');
        if (show) {
            container.style.display = 'block';
            html5QrCode = new Html5Qrcode("reader");
            html5QrCode.start({ facingMode: "environment" }, { fps: 10, qrbox: 250 }, onScanSuccess);
        } else {
            if (html5QrCode) html5QrCode.stop().then(() => { container.style.display = 'none'; });
        }
    }

    function onScanSuccess(decodedText) {
        const parts = decodedText.split(',');
        if (parts.length >= 7) {
            document.getElementById('vCode').value = parts[0];
            updateBraOptions();
            document.getElementById('braId').value = parts[1];
            document.getElementById('cCode').value = parts[3];
            document.getElementById('bb').value = parts[4];
            document.getElementById('bc').value = parts[5];
            document.getElementById('bz').value = parts[6];
            showFeedback("å·²è®€å–æ¨™ç±¤");
            playBeep();
        }
    }

    async function deleteInventoryItem(idx) {
        if (!confirm("ç¢ºå®šè¦å¾é›²ç«¯åˆªé™¤é€™ç­†åº«å­˜ç´€éŒ„å—ï¼Ÿ")) return;
        // é€™è£¡å¯ä»¥æ ¹æ“šéœ€æ±‚æ“´å…… GAS çš„åˆªé™¤é‚è¼¯
        inventory.splice(idx, 1);
        render();
    }

    function logout() {
        currentUser = null;
        document.body.classList.remove('is-admin');
        document.getElementById('login-overlay').style.display = 'flex';
    }

    // åˆå§‹åŒ–é é¢ (åŸæœ¬çš„ window.onload)
    window.onload = () => {
        // ç­‰å¾…ä½¿ç”¨è€…é»æ“Šç™»å…¥æŒ‰éˆ•è§¸ç™¼ login()
    };
</script>

<div id="print-label-page" style="display:none;"></div>
</body>
</html>
