<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>é›²ç«¯å…§è¡£é€²éŠ·å­˜ç³»çµ±</title>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <style>
        :root {
            [cite_start]--primary: #6a8d92; [cite: 1]
            [cite_start]--secondary: #c0966b; [cite: 2]
            [cite_start]--bg: #f9f7f2; [cite: 2]
            [cite_start]--card: #ffffff; [cite: 2]
        }
        body { font-family: 'PingFang TC', sans-serif; background: var(--bg); margin: 0; padding: 20px; color: #444; [cite_start]} [cite: 3]
        .container { max-width: 900px; margin: 0 auto; [cite_start]} [cite: 3, 4]
        .section-card { 
            background: var(--card); border-radius: 15px; padding: 25px; 
            margin-bottom: 25px; box-shadow: 0 4px 15px rgba(0,0,0,0.05); 
            [cite_start]border-left: 5px solid var(--secondary); [cite: 4, 5]
        }
        h2 { font-size: 1.3rem; margin-top: 0; display: flex; align-items: center; [cite_start]} [cite: 6]
        h2 i { margin-right: 10px; color: var(--secondary); [cite_start]} [cite: 7, 8]
        input, select { padding: 12px; border: 1px solid #ddd; border-radius: 8px; width: 100%; box-sizing: border-box; margin-bottom: 10px; font-size: 1rem; [cite_start]} [cite: 8, 9]
        .btn { cursor: pointer; border: none; border-radius: 8px; padding: 12px; transition: 0.3s; width: 100%; font-size: 1rem; [cite_start]} [cite: 9, 10]
        .btn-primary { background: var(--primary); color: white; [cite_start]} [cite: 11]
        .btn-secondary { background: var(--secondary); color: white; [cite_start]} [cite: 12]
        .tag-container { display: flex; flex-wrap: wrap; gap: 8px; margin-top: 10px; [cite_start]} [cite: 13]
        .tag { background: #f1f1f1; padding: 5px 12px; border-radius: 20px; font-size: 0.9rem; display: flex; align-items: center; [cite_start]} [cite: 14, 15]
        #loader { 
            position: fixed; top: 0; left: 0; width: 100%; height: 100%; 
            background: rgba(255,255,255,0.8); display: none; 
            [cite_start]justify-content: center; align-items: center; z-index: 1000; [cite: 16, 17]
        }
        table { width: 100%; border-collapse: collapse; margin-top: 10px; [cite_start]} [cite: 18]
        th { background: #eee; padding: 10px; text-align: left; [cite_start]} [cite: 19]
        td { padding: 10px; border-bottom: 1px solid #eee; [cite_start]} [cite: 20]
    </style>
</head>
<body>

<div id="loader"><i class="fas fa-spinner fa-spin fa-3x" style="color:var(--primary)"></i></div>

<div class="container">
    <div class="section-card">
        <h2><i class="fas fa-cog"></i> 0. ç³»çµ±ç’°å¢ƒè¨­å®š</h2>
        <div style="display: flex; gap: 10px;">
            [cite_start]<input type="text" id="cfgName" placeholder="å…¬å¸åç¨±"> [cite: 21]
            [cite_start]<input type="number" id="cfgTax" placeholder="ç¨…ç‡%"> [cite: 21]
        </div>
        [cite_start]<button class="btn btn-primary" onclick="updateConfig()">åŒæ­¥é›²ç«¯è¨­å®š</button> [cite: 21]
        [cite_start]<div id="userList" class="tag-container"></div> [cite: 21]
    </div>
<div class="section-card">
        <h2><i class="fas fa-database"></i> 1. åŸºç¤è¨­å®š</h2>
        
        <div style="background: #fdfaf5; padding: 15px; border-radius: 10px;">
            <p style="margin-top:0;"><strong>å» å•†èˆ‡é¡è‰²ç®¡ç†</strong></p>
            <div style="display: flex; gap: 10px;">
                <input type="text" id="vCode" placeholder="å» å•†ä»£ç¢¼">
                <input type="text" id="vName" placeholder="å» å•†åç¨±">
                <button class="btn btn-secondary" style="width:120px" onclick="addVendor()">æ–°å¢</button>
            </div>
            <div id="vList" class="tag-container" style="margin-bottom:15px;"></div>

            <div style="display: flex; gap: 10px;">
                <input type="text" id="cIn" placeholder="ä»£ç¢¼:åç¨± (å¦‚ BLK:é»‘è‰²)">
                <button class="btn btn-secondary" style="width:120px" onclick="addColor()">æ–°å¢</button>
            </div>
            <div id="cList" class="tag-container"></div>
        </div>

        <hr style="border:0; border-top:1px solid #eee; margin:20px 0;">

        <p><strong>æ¬¾å¼ç®¡ç† (MODELS)</strong></p>
        <select id="selV"></select>
      
        <div style="display: flex; gap: 10px;">
            <input type="text" id="mId" placeholder="å‹è™Ÿ (å¦‚ A001)">
            <select id="mCat">
                <option value="å…§è¡£å…§è¤²å¥—çµ„">å…§è¡£å…§è¤²å¥—çµ„</option>
                <option value="å–®ä»¶å…§è¡£">å–®ä»¶å…§è¡£</option>
                <option value="å–®ä»¶å…§è¤²">å–®ä»¶å…§è¤²</option>
            </select>
        </div>
        <div style="display: flex; gap: 10px;">
            <input type="number" id="mCst" placeholder="é€²åƒ¹">
            <input type="number" id="mPri" placeholder="å”®åƒ¹">
        </div>
        <button class="btn btn-secondary" onclick="saveModel()">å„²å­˜æ¬¾å¼è‡³é›²ç«¯</button>
        <div id="mList" class="tag-container"></div>
    </div>
<div class="section-card" style="border-left-color: var(--primary);">
        <h2><i class="fas fa-exchange-alt"></i> 2. é€²å‡ºè²¨èˆ‡æ“ä½œ</h2>
        
        <div style="display: flex; gap: 10px; margin-bottom: 15px;">
            <button class="btn btn-primary" style="flex:1" onclick="setMode('IN')">ğŸ“¥ å…¥åº«æ¨¡å¼</button>
            <button class="btn btn-primary" style="flex:1; background:#4caf50;" onclick="setMode('OUT')">ğŸ“¤ å‡ºè²¨æ¨¡å¼</button>
        </div>

        <p id="modeStatus" style="font-weight:bold; color:var(--primary);">ç›®å‰æ¨¡å¼ï¼šå…¥åº«</p>

        <select id="selMOp" onchange="onModelOpChange()"></select>
        <select id="selCOp"></select>
        
        <div style="display: flex; gap: 10px;">
            <select id="selBB"><option value="">ä¸‹åœ</option></select>
            <select id="selBC"><option value="">ç½©æ¯</option></select>
            <select id="selBZ"><option value="">å°ºç¢¼</option></select>
        </div>

        <label>æ•¸é‡</label>
        <input type="number" id="opQty" value="1">

        <button id="btnSubmit" class="btn btn-secondary" style="background:#8ca09a;" onclick="handleOp()">ç¢ºèªåŸ·è¡Œ</button>

        <hr style="border:0; border-top:1px solid #eee; margin:20px 0;">

        <div style="background: #fdfaf5; padding: 15px; border-radius: 10px;">
            <p style="margin-top:0;"><i class="fas fa-print"></i> æ¨™ç±¤åˆ—å°å¾®èª¿ (mm)</p>
            <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 10px;">
                <input type="number" id="mTop" placeholder="ä¸Šé‚Šè·" value="15.5">
                <input type="number" id="mLeft" placeholder="å·¦é‚Šè·" value="5">
            </div>
            <button class="btn btn-secondary" style="margin-top:10px; background:#c0966b;" onclick="alert('æ¨™ç±¤ç”¢ç”ŸåŠŸèƒ½å·²å°±ç·’')">ç”¢ç”Ÿ PDF æ¨™ç±¤</button>
        </div>
    </div>

    <div class="section-card" style="border-left-color: #9e9e9e;">
        <h2><i class="fas fa-chart-line"></i> 3. ç›®å‰åº«å­˜èˆ‡ç‡Ÿæ¥­çµ±è¨ˆ</h2>
        
        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 10px; margin-bottom: 20px;">
            <div style="background:#fff3e0; padding:15px; border-radius:10px; text-align:center;">
                <small>ä»Šæ—¥ç‡Ÿæ¥­é¡</small><br><strong id="statToday" style="font-size:1.2rem; color:#e65100;">$0</strong>
            </div>
            <div style="background:#e8f5e9; padding:15px; border-radius:10px; text-align:center;">
                <small>æœ¬æœˆéŠ·å”®é¡</small><br><strong id="statMonth" style="font-size:1.2rem; color:#2e7d32;">$0</strong>
            </div>
        </div>

        <div style="position: relative; margin-bottom: 15px;">
            <i class="fas fa-search" style="position:absolute; left:12px; top:14px; color:#aaa;"></i>
            <input type="text" id="invSearch" placeholder="æœå°‹å‹è™Ÿã€é¡è‰²..." style="padding-left:35px;" oninput="renderPart4()">
        </div>

        <div style="overflow-x: auto;">
            <table>
                <thead>
                    <tr>
                        <th>å‹è™Ÿ/å» å•†</th>
                        <th>è¦æ ¼/é¡è‰²</th>
                        <th>æ•¸é‡</th>
                        <th>æ“ä½œ</th>
                    </tr>
                </thead>
                <tbody id="invBody"></tbody>
            </table>
        </div>
    </div>
</div> <p style="text-align:center; color:#999; font-size:0.8rem; margin-top:30px;">
    é›²ç«¯ç³»çµ±å·²é€£ç·š | æ•¸æ“šä¾†æºï¼šGoogle Sheets API
</p>
<script>
    // ã€é‡è¦ã€‘è«‹å¡«å…¥ä½ çš„ GAS éƒ¨ç½²ç¶²å€
    const GAS_URL = "ä½ çš„_GAS_ç¶²å€";
    let CLOUD_DATA = { users:[], config:[], vendors:[], colors:[], models:[], inventory:[], sales:[] };

    // é€šç”¨ API å‘¼å«å‡½å¼ [cite: 24, 25]
    async function callAPI(method, payload = {}) {
        document.getElementById('loader').style.display = 'flex';
        const url = method === "GET" ? `${GAS_URL}?action=${payload.action}` : GAS_URL;
        try {
            const res = await fetch(url, {
                method: method,
                body: method === "POST" ? JSON.stringify(payload) : null
            });
            const json = await res.json();
            document.getElementById('loader').style.display = 'none';
            return json;
        } catch (e) {
            document.getElementById('loader').style.display = 'none';
            console.error("API Error:", e);
            return null;
        }
    }

    // 0. ç³»çµ±ç’°å¢ƒè¨­å®š [cite: 29]
    async function updateConfig() {
        const res = await callAPI("POST", {
            action: "updateConfig",
            companyName: document.getElementById('cfgName').value,
            taxRate: document.getElementById('cfgTax').value
        });
        if(res) alert("è¨­å®šå·²åŒæ­¥è‡³é›²ç«¯");
    }

    // 1. åŸºç¤è¨­å®šé‚è¼¯ (å» å•†ã€é¡è‰²ã€æ¬¾å¼) [cite: 33, 34, 36]
    async function addVendor() {
        const code = document.getElementById('vCode').value;
        const name = document.getElementById('vName').value;
        if (!code || !name) return alert("è«‹è¼¸å…¥å®Œæ•´å» å•†è³‡è¨Š");
        const res = await callAPI("POST", { action: "addVendor", code, name });
        if (res?.status === "success") {
            document.getElementById('vCode').value = '';
            document.getElementById('vName').value = '';
            await initApp();
        }
    }

    async function addColor() {
        const raw = document.getElementById('cIn').value;
        if (!raw.includes(':')) return alert("æ ¼å¼: ä»£ç¢¼:åç¨±");
        const [code, name] = raw.split(':');
        const res = await callAPI("POST", { action: "addColor", code, name });
        if (res?.status === "success") {
            document.getElementById('cIn').value = '';
            await initApp();
        }
    }

    async function saveModel() {
        const payload = {
            action: "saveModel",
            vCode: document.getElementById('selV').value,
            braId: document.getElementById('mId').value,
            type: document.getElementById('mCat').value,
            cost: document.getElementById('mCst').value,
            price: document.getElementById('mPri').value
        };
        if (!payload.vCode || !payload.braId) return alert("å» å•†èˆ‡å‹è™Ÿç‚ºå¿…å¡«");
        const res = await callAPI("POST", payload);
        if (res?.status === "success") { alert("æ¬¾å¼å·²åŒæ­¥"); await initApp(); }
    }

    // 2. é€²å‡ºè²¨æ“ä½œé‚è¼¯ [cite: 49, 56, 58]
    let currentMode = 'IN';
    function setMode(mode) {
        currentMode = mode;
        const status = document.getElementById('modeStatus');
        const btn = document.getElementById('btnSubmit');
        status.innerText = mode === 'IN' ? "ç›®å‰æ¨¡å¼ï¼šå…¥åº«" : "ç›®å‰æ¨¡å¼ï¼šå‡ºè²¨";
        status.style.color = mode === 'IN' ? "var(--primary)" : "#4caf50";
        btn.innerText = mode === 'IN' ? "ç¢ºèªåŸ·è¡Œå…¥åº«" : "ç¢ºèªåŠ å…¥å‡ºè²¨å–®";
    }

    function initSizeOptions() {
        const bb = document.getElementById('selBB'), bc = document.getElementById('selBC'), bz = document.getElementById('selBZ');
        if(bb.options.length <= 1) {
            ['32','34','36','38','40','42'].forEach(v => bb.innerHTML += `<option value="${v}">${v}</option>`);
            ['A','B','C','D','E','F','G'].forEach(v => bc.innerHTML += `<option value="${v}">${v}</option>`);
            ['S','M','L','XL','XXL','Free'].forEach(v => bz.innerHTML += `<option value="${v}">${v}</option>`);
        }
    }

    async function handleOp() {
        const mVal = document.getElementById('selMOp').value;
        if (!mVal) return alert("è«‹é¸æ“‡å‹è™Ÿ");
        const [vCode, braId] = mVal.split('-');
        const res = await callAPI("POST", {
            action: "processTransaction",
            type: currentMode,
            vCode, braId,
            c: document.getElementById('selCOp').value,
            bb: document.getElementById('selBB').value,
            bc: document.getElementById('selBC').value,
            bz: document.getElementById('selBZ').value,
            qty: document.getElementById('opQty').value,
            price: CLOUD_DATA.models.find(m => m.braId === braId)?.price || 0
        });
        if (res?.status === "success") { alert(currentMode === 'IN' ? "å…¥åº«æˆåŠŸ" : "å‡ºè²¨æˆåŠŸ"); await initApp(); }
    }

    // 3. æ¸²æŸ“èˆ‡çµ±è¨ˆé‚è¼¯ [cite: 67, 71, 72]
    function renderPart2() {
        const vL = document.getElementById('vList'), vS = document.getElementById('selV');
        vL.innerHTML = ''; vS.innerHTML = '<option value="">é¸æ“‡å» å•†</option>';
        CLOUD_DATA.vendors.forEach(v => {
            vL.innerHTML += `<span class="tag">${v.code}</span>`;
            vS.innerHTML += `<option value="${v.code}">${v.code}</option>`;
        });
        const cL = document.getElementById('cList'); cL.innerHTML = '';
        CLOUD_DATA.colors.forEach(c => cL.innerHTML += `<span class="tag">${c.code}:${c.name}</span>`);
        const mL = document.getElementById('mList'); mL.innerHTML = '';
        CLOUD_DATA.models.forEach(m => mL.innerHTML += `<span class="tag" style="background:#e8d8c3">${m.vCode}-${m.braId}</span>`);
    }

    function renderPart3() {
        const mS = document.getElementById('selMOp'), cS = document.getElementById('selCOp');
        mS.innerHTML = '<option value="">é¸æ“‡å‹è™Ÿ</option>';
        cS.innerHTML = '<option value="">é¸æ“‡é¡è‰²</option>';
        CLOUD_DATA.models.forEach(m => mS.innerHTML += `<option value="${m.vCode}-${m.braId}">${m.vCode}-${m.braId}</option>`);
        CLOUD_DATA.colors.forEach(c => cS.innerHTML += `<option value="${c.code}">${c.name}</option>`);
        initSizeOptions();
    }

    function renderPart4() {
        const tbody = document.getElementById('invBody'), search = document.getElementById('invSearch').value.toLowerCase();
        tbody.innerHTML = ''; calculateStats();
        CLOUD_DATA.inventory.forEach((item, index) => {
            if (search && !`${item.vCode} ${item.braId} ${item.c}`.toLowerCase().includes(search)) return;
            const tr = document.createElement('tr');
            tr.innerHTML = `<td><strong>${item.vCode}</strong><br><small>${item.braId}</small></td>
                <td>${item.c}<br><small>${item.bb}${item.bc} ${item.bz}</small></td>
                <td><div style="display:flex; align-items:center; gap:5px;">
                    <button class="btn" style="padding:2px 8px; width:auto; background:#eee;" onclick="adjustQty(${index},-1)">-</button>
                    <strong>${item.qty}</strong>
                    <button class="btn" style="padding:2px 8px; width:auto; background:#eee;" onclick="adjustQty(${index},1)">+</button>
                </div></td><td><i class="fas fa-history"></i></td>`;
            tbody.appendChild(tr);
        });
    }

    function calculateStats() {
        const today = new Date().toLocaleDateString('zh-TW'), thisMonth = today.substring(0, 7);
        let tTotal = 0, mTotal = 0;
        CLOUD_DATA.sales.forEach(s => {
            const sDate = new Date(s.Timestamp).toLocaleDateString('zh-TW');
            const total = (Number(s.p) || 0) * (Number(s.q) || 0);
            if (sDate === today) tTotal += total;
            if (sDate.startsWith(thisMonth)) mTotal += total;
        });
        document.getElementById('statToday').innerText = `$${tTotal.toLocaleString()}`;
        document.getElementById('statMonth').innerText = `$${mTotal.toLocaleString()}`;
    }

    async function adjustQty(idx, diff) {
        const item = CLOUD_DATA.inventory[idx];
        await callAPI("POST", {
            action: "processTransaction", type: diff > 0 ? "IN" : "OUT",
            vCode: item.vCode, braId: item.braId, c: item.c, bb: item.bb, bc: item.bc, bz: item.bz, qty: Math.abs(diff), price: 0
        });
        await initApp();
    }

    async function initApp() {
        const data = await callAPI("GET", { action: "loadAll" });
        if (data) {
            CLOUD_DATA = data;
            document.getElementById('cfgName').value = data.config.find(c => c.Property === "companyName")?.Value || "";
            document.getElementById('cfgTax').value = data.config.find(c => c.Property === "taxRate")?.Value || "";
            renderPart2(); renderPart3(); renderPart4();
        }
    }

    window.onload = initApp;
</script>
</body>
</html>
