// 1-3. 儲存款式 (MODELS)
    async function saveModel() {
        const payload = {
            action: "saveModel",
            vCode: document.getElementById('selV').value,
            braId: document.getElementById('mId').value,
            type: document.getElementById('mCat').value,
            cost: document.getElementById('mCst').value,
            price: document.getElementById('mPri').value
        };
        if (!payload.vCode || !payload.braId) return alert("廠商與型號為必填");
        const res = await callAPI("POST", payload);
        if (res?.status === "success") {
            alert("款式已同步至雲端");
            await initApp();
        }
    }

    // 2. 進出貨模式與規格設定
    let currentMode = 'IN';
    function setMode(mode) {
        currentMode = mode;
        const status = document.getElementById('modeStatus');
        const btn = document.getElementById('btnSubmit');
        status.innerText = mode === 'IN' ? "目前模式：入庫" : "目前模式：出貨";
        status.style.color = mode === 'IN' ? "var(--primary)" : "#4caf50";
        btn.innerText = mode === 'IN' ? "確認執行入庫" : "確認執行出貨";
    }

    function onModelOpChange() {
        // 當選擇型號時，確保規格下拉選單已初始化
        initSizeOptions();
    }

    function initSizeOptions() {
        const bb = document.getElementById('selBB'), bc = document.getElementById('selBC'), bz = document.getElementById('selBZ');
        if(bb.options.length <= 1) { // 避免重複加入
            ['32','34','36','38','40','42'].forEach(v => bb.innerHTML += `<option value="${v}">${v}</option>`);
            ['A','B','C','D','E','F','G'].forEach(v => bc.innerHTML += `<option value="${v}">${v}</option>`);
            ['S','M','L','XL','XXL','Free'].forEach(v => bz.innerHTML += `<option value="${v}">${v}</option>`);
        }
    }

    async function handleOp() {
        const mVal = document.getElementById('selMOp').value;
        if (!mVal) return alert("請選擇型號");
        const [vCode, braId] = mVal.split('-');
        const res = await callAPI("POST", {
            action: "processTransaction",
            type: currentMode,
            vCode, braId,
            c: document.getElementById('selCOp').value,
            bb: document.getElementById('selBB').value,
            bc: document.getElementById('selBC').value,
            bz: document.getElementById('selBZ').value,
            qty: document.getElementById('opQty').value,
            price: CLOUD_DATA.models.find(m => m.braId === braId)?.price || 0
        });
        if (res?.status === "success") {
            alert(currentMode === 'IN' ? "入庫完成" : "出貨完成");
            await initApp();
        }
    }

    // 3. 畫面渲染 (Render) 邏輯
    function renderPart2() {
        const vL = document.getElementById('vList'), vS = document.getElementById('selV');
        vL.innerHTML = ''; vS.innerHTML = '<option value="">選擇廠商</option>';
        CLOUD_DATA.vendors.forEach(v => {
            vL.innerHTML += `<span class="tag">${v.code}</span>`;
            vS.innerHTML += `<option value="${v.code}">${v.code}</option>`;
        });
        const cL = document.getElementById('cList'); cL.innerHTML = '';
        CLOUD_DATA.colors.forEach(c => cL.innerHTML += `<span class="tag">${c.code}:${c.name}</span>`);
        const mL = document.getElementById('mList'); mL.innerHTML = '';
        CLOUD_DATA.models.forEach(m => mL.innerHTML += `<span class="tag" style="background:#e8d8c3">${m.vCode}-${m.braId}</span>`);
    }

    function renderPart3() {
        const mS = document.getElementById('selMOp'), cS = document.getElementById('selCOp');
        mS.innerHTML = '<option value="">選擇型號</option>';
        cS.innerHTML = '<option value="">選擇顏色</option>';
        CLOUD_DATA.models.forEach(m => mS.innerHTML += `<option value="${m.vCode}-${m.braId}">${m.vCode}-${m.braId}</option>`);
        CLOUD_DATA.colors.forEach(c => cS.innerHTML += `<option value="${c.code}">${c.name}</option>`);
        initSizeOptions();
    }

    function renderPart4() {
        const tbody = document.getElementById('invBody'), search = document.getElementById('invSearch').value.toLowerCase();
        tbody.innerHTML = ''; 
        calculateStats();
        CLOUD_DATA.inventory.forEach((item, index) => {
            if (search && !`${item.vCode} ${item.braId} ${item.c}`.toLowerCase().includes(search)) return;
            const tr = document.createElement('tr');
            tr.innerHTML = `<td><strong>${item.vCode}</strong><br><small>${item.braId}</small></td>
                <td>${item.c}<br><small>${item.bb}${item.bc} ${item.bz}</small></td>
                <td><div style="display:flex; align-items:center; gap:5px;">
                    <button class="btn" style="padding:2px 8px; width:auto; background:#eee;" onclick="adjustQty(${index},-1)">-</button>
                    <strong>${item.qty}</strong>
                    <button class="btn" style="padding:2px 8px; width:auto; background:#eee;" onclick="adjustQty(${index},1)">+</button>
                </div></td>
                <td><i class="fas fa-history" title="紀錄"></i></td>`;
            tbody.appendChild(tr);
        });
    }

    function calculateStats() {
        const today = new Date().toLocaleDateString('zh-TW'), thisMonth = today.substring(0, 7);
        let tTotal = 0, mTotal = 0;
        CLOUD_DATA.sales.forEach(s => {
            const sDate = new Date(s.Timestamp).toLocaleDateString('zh-TW');
            const total = (Number(s.p) || 0) * (Number(s.q) || 0);
            if (sDate === today) tTotal += total;
            if (sDate.includes(thisMonth)) mTotal += total;
        });
        document.getElementById('statToday').innerText = `$${tTotal.toLocaleString()}`;
        document.getElementById('statMonth').innerText = `$${mTotal.toLocaleString()}`;
    }

    async function adjustQty(idx, diff) {
        const item = CLOUD_DATA.inventory[idx];
        const res = await callAPI("POST", {
            action: "processTransaction", type: diff > 0 ? "IN" : "OUT",
            vCode: item.vCode, braId: item.braId, c: item.c, bb: item.bb, bc: item.bc, bz: item.bz, qty: Math.abs(diff), price: 0
        });
        if (res?.status === "success") await initApp();
    }

    // 【全系統初始化】
    async function initApp() {
        const data = await callAPI("GET", { action: "loadAll" });
        if (data) {
            CLOUD_DATA = data;
            document.getElementById('cfgName').value = data.config.find(c => c.Property === "companyName")?.Value || "";
            document.getElementById('cfgTax').value = data.config.find(c => c.Property === "taxRate")?.Value || "";
            renderPart2(); renderPart3(); renderPart4();
        }
    }

    window.onload = initApp;
</script>
</body>
</html>
