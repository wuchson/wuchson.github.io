<!DOCTYPE html>
<html lang="zh-Hant">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=1">
    <title>Lingerie Pro - 雲端智慧庫存系統</title>

    <script src="https://unpkg.com/html5-qrcode"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/qrious/4.0.2/qrious.min.js"></script>

    <style>
        :root {
            --primary: #8da399;
            --accent: #d4a373; 
            --bg: #f9f7f2; 
            --card-bg: #ffffff; 
            --border: #e0dcd0; 
            --danger: #e53e3e; 
            --success: #48bb78;
            /* A4 標籤列印微調參數 */
            --a4-mt: 15.5mm; --a4-ml: 6.5mm; --a4-gx: 2.5mm; --a4-gy: 0mm;
        }

        * { box-sizing: border-box; -webkit-tap-highlight-color: transparent; }
        body { 
            font-family: -apple-system, "Noto Sans TC", sans-serif;
            background: var(--bg); margin: 0; padding: 10px; color: #444; 
            line-height: 1.6;
        }

        .container { max-width: 800px; margin: 0 auto; }
        
        /* 卡片式設計 */
        .card { 
            background: var(--card-bg); border-radius: 12px; padding: 20px;
            box-shadow: 0 4px 6px rgba(0,0,0,0.05); margin-bottom: 20px;
            border: 1px solid var(--border);
        }

        h2, h3 { color: var(--primary); margin-top: 0; border-bottom: 2px solid var(--bg); padding-bottom: 8px; }

        /* 表單元素 */
        input, select, button { 
            width: 100%; padding: 12px; margin: 8px 0; 
            border: 1px solid var(--border); border-radius: 8px; font-size: 16px;
        }
        
        button { 
            background: var(--primary); color: white; border: none; 
            cursor: pointer; font-weight: bold; transition: opacity 0.2s;
        }
        button:active { opacity: 0.8; }
        button.secondary { background: var(--accent); }
        button.danger { background: var(--danger); }

        /* 表格響應式 */
        .table-container { overflow-x: auto; margin-top: 10px; }
        table { width: 100%; border-collapse: collapse; min-width: 500px; }
        th, td { border: 1px solid var(--border); padding: 10px; text-align: left; font-size: 14px; }
        th { background: #f4f1ea; color: var(--primary); }

        /* 導覽列 */
        .nav-grid { 
            display: grid; grid-template-columns: repeat(auto-fit, minmax(100px, 1fr)); 
            gap: 8px; margin-bottom: 20px; 
        }
        .nav-item { 
            padding: 10px; text-align: center; background: #eee; 
            border-radius: 8px; cursor: pointer; font-size: 14px;
        }
        .nav-item.active { background: var(--primary); color: white; }

        /* 隱藏區塊 */
        .page { display: none; }
        .page.active { display: block; }

        /* 載入中動畫 */
        #loadingOverlay {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(255,255,255,0.8); display: none;
            justify-content: center; align-items: center; z-index: 9999;
        }

        /* 列印預覽專用樣式 */
        @media print {
            body * { visibility: hidden; }
            #printPreview, #printPreview * { visibility: visible; }
            #printPreview { position: absolute; left: 0; top: 0; width: 100%; }
            .no-print { display: none !important; }
        }
    </style>
</head>
<body>
    <div id="loadingOverlay"><div>系統連線中，請稍候...</div></div>

    <div class="container">
        <div id="loginPage" class="card">
            <h2>系統登入</h2>
            <input type="text" id="loginUser" placeholder="帳號">
            <input type="password" id="loginPass" placeholder="密碼">
            <button onclick="handleLogin()">登入</button>
        </div>

        <div id="mainSystem" style="display:none;">
            <div class="card">
                <div style="display:flex; justify-content:space-between; align-items:center;">
                    <h3 id="displayUserName">歡迎使用</h3>
                    <button onclick="handleLogout()" style="width:auto; padding:5px 15px;" class="danger">登出</button>
                </div>
                <div class="nav-grid">
                    <div class="nav-item active" onclick="showPage('scanPage')">掃描進出</div>
                    <div class="nav-item" onclick="showPage('inventoryPage')">庫存查詢</div>
                    <div class="nav-item" onclick="showPage('salesPage')">營業統計</div>
                    <div class="nav-item admin-only" onclick="showPage('setupPage')">基礎設定</div>
                    <div class="nav-item admin-only" onclick="showPage('configPage')">系統環境</div>
                </div>
            </div>

            <div id="configPage" class="page card">
                <h3>系統環境設定</h3>
                <label>公司名稱</label>
                <input type="text" id="cfgCompName">
                <label>稅率 (%)</label>
                <input type="number" id="cfgTaxRate" step="0.01">
                <button onclick="saveSystemConfig()">儲存設定</button>
                <hr>
                <h3>帳號管理</h3>
                <div class="table-container">
                    <table id="userTable">
                        <thead><tr><th>帳號</th><th>密碼</th><th>姓名</th><th>操作</th></tr></thead>
                        <tbody></tbody>
                    </table>
                </div>
                <button class="secondary" onclick="addUser()">新增帳號</button>
            </div>

            <div id="setupPage" class="page card">
                <h3>廠商管理</h3>
                <div class="table-container">
                    <table id="vendorTable">
                        <thead><tr><th>代碼</th><th>名稱</th><th>操作</th></tr></thead>
                        <tbody></tbody>
                    </table>
                </div>
                <button class="secondary" onclick="addVendor()">新增廠商</button>

                <hr>
                <h3>胸罩型號管理</h3>
                <div class="table-container">
                    <table id="modelTable">
                        <thead><tr><th>廠商</th><th>型號</th><th>類別</th><th>成本</th><th>售價</th><th>操作</th></tr></thead>
                        <tbody></tbody>
                    </table>
                </div>
                <button class="secondary" onclick="addModel()">新增型號</button>
            </div>
<div id="scanPage" class="page active card">
                <h3>掃描 / 手動輸入</h3>
                <div id="reader" style="width: 100%; background: #eee; border-radius: 8px;"></div>
                <div style="margin-top: 10px; display: flex; gap: 5px;">
                    <button onclick="startScanner()" style="flex:1;">啟動相機</button>
                    <button onclick="stopScanner()" style="flex:1;" class="danger">停止相機</button>
                </div>

                <hr>
                <label>選擇廠商</label>
                <select id="braVendor" onchange="updateModelSelect()"></select>
                
                <label>選擇型號</label>
                <select id="braModel"></select>

                <div style="display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 5px;">
                    <div>
                        <label>下胸圍</label>
                        <select id="braBand">
                            <option value="70">70</option><option value="75">75</option>
                            <option value="80">80</option><option value="85">85</option>
                            <option value="90">90</option><option value="95">95</option>
                        </select>
                    </div>
                    <div>
                        <label>罩杯</label>
                        <select id="braCup">
                            <option value="A">A</option><option value="B">B</option>
                            <option value="C">C</option><option value="D">D</option>
                            <option value="E">E</option><option value="F">F</option>
                            <option value="G">G</option>
                        </select>
                    </div>
                    <div>
                        <label>顏色</label>
                        <select id="braColor"></select>
                    </div>
                </div>

                <label>數量</label>
                <input type="number" id="braQty" value="1" min="1">

                <div style="display: flex; gap: 10px;">
                    <button onclick="processStock('IN')" style="background: var(--success);">進貨 (+)</button>
                    <button onclick="processStock('OUT')" class="danger">出貨 (-)</button>
                </div>
            </div>

            <div id="printSetupPage" class="page card">
                <h3>標籤列印設定 (A4 標籤紙)</h3>
                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 10px;">
                    <div><label>上邊距 (mm)</label><input type="number" id="p_mt" step="0.1" value="15.5"></div>
                    <div><label>左邊距 (mm)</label><input type="number" id="p_ml" step="0.1" value="6.5"></div>
                    <div><label>水平間距 (mm)</label><input type="number" id="p_gx" step="0.1" value="2.5"></div>
                    <div><label>垂直間距 (mm)</label><input type="number" id="p_gy" step="0.1" value="0"></div>
                </div>
                <button onclick="savePrintConfig()">儲存列印參數</button>
                
                <hr>
                <h4>列印預覽</h4>
                <div id="printPreviewContainer" style="background: white; border: 1px solid #ccc; padding: 10px; min-height: 200px;">
                    </div>
                <button onclick="window.print()" style="margin-top: 10px;">執行列印 (Ctrl+P)</button>
            </div>
<div id="inventoryPage" class="page card">
                <h3>庫存查詢</h3>
                <input type="text" id="invSearch" placeholder="搜尋型號或廠商..." oninput="renderInventory()">
                <div class="table-container">
                    <table id="inventoryTable">
                        <thead>
                            <tr>
                                <th>廠商/型號</th>
                                <th>顏色/規格</th>
                                <th>庫存</th>
                                <th>操作</th>
                            </tr>
                        </thead>
                        <tbody></tbody>
                    </table>
                </div>
            </div>

            <div id="salesPage" class="page card">
                <h3>今日營業概況</h3>
                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 10px; margin-bottom: 15px;">
                    <div style="background: #f4f1ea; padding: 10px; border-radius: 8px; text-align: center;">
                        <small>銷售總額</small>
                        <div id="statRevenue" style="font-size: 20px; font-weight: bold; color: var(--primary);">$0</div>
                    </div>
                    <div style="background: #f4f1ea; padding: 10px; border-radius: 8px; text-align: center;">
                        <small>售出件數</small>
                        <div id="statQty" style="font-size: 20px; font-weight: bold; color: var(--primary);">0</div>
                    </div>
                </div>
                
                <h4>今日出貨明細</h4>
                <div class="table-container">
                    <table id="salesHistoryTable">
                        <thead>
                            <tr>
                                <th>時間</th>
                                <th>型號</th>
                                <th>金額</th>
                                <th>操作</th>
                            </tr>
                        </thead>
                        <tbody></tbody>
                    </table>
                </div>
                <button onclick="exportDailyReport()" style="margin-top: 10px;" class="secondary">產生本日報表</button>
            </div>

            <div id="printPreview" class="no-screen">
                </div>

        </div> </div> <div id="qrcode-hidden" style="display:none;"></div>
<script>
const API_URL = "https://script.google.com/macros/s/AKfycbwKljH08lC3P_P0hrey_qrAL2iXnljuXYQwfN1FgmUNfop1PXWNqTfe9GiuHkYOaWceCA/exec"; // <--- 請務必替換成您的 Web App 網址

// 系統全局變數
let users = [], vendors = [], models = [], inventory = [], colors = [], itemTypes = [], salesHistory = [];
let sysConfig = { compName: "", taxRate: 0.05 }, printConfig = {};
let currentUser = null;

// --- 1. 核心：初始化與資料同步 ---

async function init() {
    showLoading(true);
    try {
        const response = await fetch(`${API_URL}?action=getAll`);
        const data = await response.json();
        
        // 轉換二維陣列為 JSON 物件
        users = arrayToObj(data.users, ["u", "p", "r"]);
        vendors = arrayToObj(data.vendors, ["code", "name"]);
        models = arrayToObj(data.models, ["vCode", "braId", "type", "cost", "price"]);
        inventory = arrayToObj(data.inventory, ["vCode", "braId", "c", "bb", "bc", "bz", "bq"]);
        colors = arrayToObj(data.colors, ["code", "name"]);
        itemTypes = data.itemTypes.map(r => r[0]);
        salesHistory = arrayToObj(data.salesHistory, ["date", "id", "p", "q"]);
        
        renderAll(); // 渲染所有介面
        showLoading(false);
    } catch (e) {
        alert("連線失敗，請檢查 API 網址或網路狀態");
        showLoading(false);
    }
}

// 核心同步函數：將所有變數寫回試算表
async function syncAll() {
    showLoading(true);
    const payload = {
        action: "saveAll",
        payload: {
            users: objToArray(users, ["u", "p", "r"]),
            vendors: objToArray(vendors, ["code", "name"]),
            models: objToArray(models, ["vCode", "braId", "type", "cost", "price"]),
            inventory: objToArray(inventory, ["vCode", "braId", "c", "bb", "bc", "bz", "bq"]),
            colors: objToArray(colors, ["code", "name"]),
            itemTypes: itemTypes.map(t => [t]),
            salesHistory: objToArray(salesHistory, ["date", "id", "p", "q"]),
            sysConfig: [[sysConfig.compName, sysConfig.taxRate]],
            printConfig: [[printConfig.mt, printConfig.ml]] // 依此類推
        }
    };

    await fetch(API_URL, {
        method: "POST",
        body: JSON.stringify(payload)
    });
    showLoading(false);
    init(); // 儲存後重新讀取
}

// --- 2. 登入邏輯 ---

function handleLogin() {
    const u = document.getElementById('loginUser').value;
    const p = document.getElementById('loginPass').value;
    const found = users.find(user => user.u === u && user.p === p);
    
    if (found) {
        currentUser = found;
        document.getElementById('loginPage').style.display = 'none';
        document.getElementById('mainSystem').style.display = 'block';
        document.getElementById('displayUserName').innerText = `你好, ${found.r}`;
        if (found.r !== "Admin") {
            document.querySelectorAll('.admin-only').forEach(el => el.style.display = 'none');
        }
    } else {
        alert("帳號或密碼錯誤");
    }
}

// --- 3. 新增與刪除範例 (以帳號管理為例) ---

function addUser() {
    const u = prompt("輸入新帳號:");
    const p = prompt("輸入新密碼:");
    const r = prompt("輸入權限 (Admin/User):");
    if (u && p) {
        users.push({ u, p, r });
        syncAll(); // 立即同步至雲端
    }
}

function deleteUser(index) {
    if (confirm("確定刪除此帳號？")) {
        users.splice(index, 1);
        syncAll();
    }
}

// --- 工具函數 ---

function arrayToObj(arr, fields) {
    if (!arr || arr.length <= 1) return [];
    return arr.slice(1).map(row => {
        let obj = {};
        fields.forEach((f, i) => obj[f] = row[i]);
        return obj;
    });
}

function objToArray(objs, fields) {
    const header = fields;
    const rows = objs.map(o => fields.map(f => o[f]));
    return [header, ...rows];
}

function showPage(pageId) {
    document.querySelectorAll('.page').forEach(p => p.classList.remove('active'));
    document.getElementById(pageId).classList.add('active');
    document.querySelectorAll('.nav-item').forEach(n => n.classList.remove('active'));
}

function showLoading(show) {
    document.getElementById('loadingOverlay').style.display = show ? 'flex' : 'none';
}

window.onload = init;
</script>
</body>
</html>
