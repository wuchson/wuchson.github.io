<!DOCTYPE html>
<html lang="zh-Hant">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0">
<title>Lingerie Pro é›²ç«¯ç‰ˆ</title>

<script src="https://unpkg.com/html5-qrcode"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/qrious/4.0.2/qrious.min.js"></script>

<style>
:root{
--primary:#8da399;
--accent:#d4a373;
--bg:#f9f7f2;
--card:#ffffff;
--border:#e0dcd0;
--danger:#e53e3e;
--success:#48bb78;
}

body{
font-family:-apple-system,"Noto Sans TC",sans-serif;
background:var(--bg);
margin:0;
padding:10px;
color:#444;
}

.container{max-width:700px;margin:auto}

.card{
background:var(--card);
border-radius:12px;
padding:15px;
margin-bottom:15px;
border:1px solid var(--border);
box-shadow:0 2px 6px rgba(0,0,0,.05);
}

h3{
margin:0 0 12px 0;
border-left:4px solid var(--accent);
padding-left:10px;
color:#6b7e75;
font-size:1rem;
}

input,select{
width:100%;
padding:10px;
border-radius:8px;
border:1px solid var(--border);
margin-bottom:8px;
box-sizing:border-box;
}

button{
padding:10px;
border:none;
border-radius:8px;
background:var(--primary);
color:#fff;
font-weight:bold;
cursor:pointer;
}

.btn-danger{background:var(--danger)}
.btn-success{background:var(--success)}
.btn-accent{background:var(--accent)}

.row{display:flex;gap:8px;flex-wrap:wrap}
.row > *{flex:1}

.table-wrap{overflow-x:auto}

table{
width:100%;
border-collapse:collapse;
font-size:.85rem;
background:#fff;
}

th,td{
padding:8px;
border-bottom:1px solid #eee;
text-align:left;
}

#login-overlay{
position:fixed;
inset:0;
background:var(--bg);
display:flex;
align-items:center;
justify-content:center;
z-index:999;
}

.login-card{
width:300px;
background:#fff;
padding:25px;
border-radius:12px;
box-shadow:0 10px 30px rgba(0,0,0,.1);
}

#scanner-container{
display:none;
margin-bottom:15px;
background:#000;
border-radius:12px;
overflow:hidden;
}

#scan-feedback{
position:absolute;
top:10px;
left:50%;
transform:translateX(-50%);
background:rgba(72,187,120,.9);
color:#fff;
padding:5px 20px;
border-radius:20px;
display:none;
}

.admin-only{display:none}
body.is-admin .admin-only{display:block}

</style>
</head>
<body>

<div id="login-overlay">
<div class="login-card">
<h2 style="text-align:center;margin-top:0;color:var(--primary)">ç³»çµ±ç™»å…¥</h2>
<input id="loginUser" placeholder="å¸³è™Ÿ">
<input id="loginPass" type="password" placeholder="å¯†ç¢¼">
<button onclick="login()">ç™»å…¥ç³»çµ±</button>
</div>
</div>

<div class="container">

<div style="display:flex;justify-content:space-between;margin-bottom:10px">
<span id="userStatus"></span>
<button onclick="logout()" style="background:#666;padding:5px 12px">ç™»å‡º</button>
</div>
<!-- ===== 0. ç³»çµ±è¨­å®š ===== -->
<div class="card admin-only">
<h3>0. ç³»çµ±è¨­å®š</h3>

<div class="row">
<div>
<label>å…¬å¸åç¨±</label>
<input id="compNameInp">
</div>
<div>
<label>ç¨…ç‡ (%)</label>
<input id="taxRateInp" type="number">
</div>
</div>

<button onclick="updateSysConfig()">å„²å­˜è¨­å®š</button>

<hr>

<h4>ä½¿ç”¨è€…ç®¡ç†</h4>
<div class="row">
<input id="newUName" placeholder="å¸³è™Ÿ">
<input id="newUPass" placeholder="å¯†ç¢¼">
<select id="newURole">
<option value="staff">å“¡å·¥</option>
<option value="admin">ç®¡ç†å“¡</option>
</select>
</div>
<button class="btn-success" onclick="addUser()">æ–°å¢ä½¿ç”¨è€…</button>
<div id="userList" style="margin-top:10px"></div>
</div>


<!-- ===== 1. åŸºç¤è³‡æ–™ ===== -->
<div class="card admin-only">
<h3>1. åŸºç¤è³‡æ–™è¨­å®š</h3>

<h4>å» å•†</h4>
<div class="row">
<input id="vCodeInp" placeholder="å» å•†ä»£ç¢¼">
<input id="vNameInp" placeholder="å» å•†åç¨±">
</div>
<button onclick="addVendor()">æ–°å¢å» å•†</button>
<div id="vendorTags"></div>

<hr>

<h4>é¡è‰²</h4>
<div class="row">
<input id="colorInp" placeholder="æ ¼å¼: BLK:é»‘è‰²">
<button class="btn-accent" onclick="addColor()">æ–°å¢é¡è‰²</button>
</div>
<div id="colorTags"></div>

<hr>

<h4>å•†å“é¡åˆ¥</h4>
<div class="row">
<input id="typeInp" placeholder="æ–°å¢é¡åˆ¥">
<button class="btn-accent" onclick="addItemType()">æ–°å¢é¡åˆ¥</button>
</div>
<div id="typeTags"></div>

<hr>

<h4>æ¬¾å¼è¨­å®š</h4>
<select id="setVendorRel"></select>
<input id="setBraId" placeholder="å‹è™Ÿ">
<select id="itemTypeSelect"></select>

<div class="row">
<input id="setCost" type="number" placeholder="é€²åƒ¹">
<input id="setPrice" type="number" placeholder="å”®åƒ¹">
</div>

<button onclick="addModel()">å„²å­˜æ¬¾å¼</button>
<div id="modelTags"></div>

</div>


<!-- ===== 2. é€²å‡ºè²¨ ===== -->
<div class="card">
<h3>2. é€²å‡ºè²¨æ“ä½œ</h3>

<div class="row">
<button style="background:#4299e1" onclick="startScan('IN_AUTO')">é€£çºŒå…¥1</button>
<button style="background:#3182ce" onclick="startScan('IN_MANUAL')">å…¥åº«(å¡«é‡)</button>
<button style="background:#48bb78" onclick="startScan('OUT_AUTO')">å‡ºè²¨æƒæ</button>
</div>

<div id="scanner-container">
<div id="scan-feedback">æƒææˆåŠŸ</div>
<div id="reader"></div>
<button class="btn-danger" onclick="stopScan()">é—œé–‰ç›¸æ©Ÿ</button>
</div>

<hr>

<select id="selectVendor" onchange="updateModelSelect()"></select>
<select id="selectModel"></select>

<div class="row">
<select id="selectColor"></select>
<input id="braBand" placeholder="ä¸‹åœ">
<input id="braCup" placeholder="ç½©æ¯">
<input id="braSize" placeholder="å°ºç¢¼">
</div>

<input id="braQty" type="number" value="1">

<div class="row">
<button onclick="handleManual('IN')">æ‰‹å‹•å…¥åº«</button>
<button class="btn-success" onclick="generateInvoiceManual()">åŠ å…¥å‡ºè²¨å–®</button>
</div>

</div>


<!-- ===== å‡ºè²¨å–®ç•«é¢ ===== -->
<div class="card" id="invoice-area" style="display:none">
<h3>å‡ºè²¨æ˜ç´°å–®</h3>

<table>
<thead>
<tr>
<th>å“é …</th>
<th>æ•¸é‡</th>
<th>å–®åƒ¹</th>
<th>å°è¨ˆ</th>
<th></th>
</tr>
</thead>
<tbody id="inv-body"></tbody>
</table>

<div style="text-align:right;margin-top:10px">
æœªç¨…ï¼š$ <span id="inv-subtotal">0</span><br>
ç¨…é¡ï¼š$ <span id="inv-tax">0</span><br>
<b>ç¸½è¨ˆï¼š$ <span id="inv-total">0</span></b>
</div>

<div class="row" style="margin-top:10px">
<button class="btn-success" onclick="confirmAndShip()">ç¢ºèªå‡ºè²¨</button>
<button class="btn-danger" onclick="clearInvoice()">æ¸…ç©º</button>
</div>

</div>
<!-- ===== 3. åº«å­˜èˆ‡çµ±è¨ˆ ===== -->
<div class="card">
<h3>3. ç›®å‰åº«å­˜èˆ‡ç‡Ÿæ¥­çµ±è¨ˆ</h3>

<!-- ç‡Ÿæ¥­çµ±è¨ˆ -->
<div id="sales-stats" class="admin-only" style="
background:#fffaf0;
border:1px solid #feebc8;
padding:12px;
border-radius:8px;
margin-bottom:15px;
font-size:13px;
display:none;
">
</div>

<!-- æœå°‹ -->
<input id="stockSearch" placeholder="ğŸ” æœå°‹å‹è™Ÿã€é¡è‰²ã€å°ºå¯¸..." oninput="render()">

<!-- åº«å­˜è¡¨æ ¼ -->
<div class="table-wrap">
<table>
<thead>
<tr>
<th>å‹è™Ÿ</th>
<th>è¦æ ¼</th>
<th>å­˜é‡</th>
<th class="admin-only">æ“ä½œ</th>
</tr>
</thead>
<tbody id="stockTableBody"></tbody>
</table>
</div>

<div class="row admin-only" style="margin-top:15px">
<button style="background:#666" onclick="exportData()">å‚™ä»½è³‡æ–™</button>
<button style="background:#718096" onclick="triggerImport()">åŒ¯å…¥è³‡æ–™</button>
</div>

<input type="file" id="importFile" style="display:none" accept=".json" onchange="importData(event)">

</div>

</div> <!-- container çµæŸ -->

<!-- QR æ¨™ç±¤åˆ—å°é  -->
<div id="print-label-page" style="display:none"></div>

<!-- ç™¼ç¥¨åˆ—å°é  -->
<div id="print-invoice-page" style="display:none;padding:20px"></div>
<script>

/* ===============================
   ğŸ”µ æ”¹æˆä½ çš„ Apps Script ç¶²å€
================================ */
const API_URL = "https://script.google.com/macros/s/AKfycbwKljH08lC3P_P0hrey_qrAL2iXnljuXYQwfN1FgmUNfop1PXWNqTfe9GiuHkYOaWceCA/exec";

/* ===============================
   ğŸ”µ å…¨åŸŸè³‡æ–™
================================ */
let users=[],vendors=[],models=[],inventory=[],colors=[],itemTypes=[];
let salesHistory=[];
let compName="æˆ‘çš„å…§è¡£å°èˆ–";
let taxRate=5;
let invoiceItems=[];
let currentUser=null;
let html5QrCode=null;
let isProcessing=false;

/* ===============================
   ğŸ”µ å·¥å…·è½‰æ›
================================ */
function arrayToObj(arr,keys){
if(!arr||arr.length<=1)return[];
return arr.slice(1).map(r=>{
let o={};keys.forEach((k,i)=>o[k]=r[i]);return o;
});
}
function objToArray(list,keys){
return [keys,...list.map(o=>keys.map(k=>o[k]))];
}

/* ===============================
   ğŸ”µ é›²ç«¯è®€å–
================================ */
async function loadCloud(){
const res=await fetch(API_URL+"?action=getAll");
const data=await res.json();

users=arrayToObj(data.users,["u","p","r"]);
vendors=arrayToObj(data.vendors,["code","name"]);
models=arrayToObj(data.models,["vCode","braId","type","cost","price"]);
inventory=arrayToObj(data.inventory,["vCode","braId","c","bb","bc","bz","bq"]);
colors=arrayToObj(data.colors,["code","name"]);
itemTypes=data.itemTypes.slice(1).map(r=>r[0]);
salesHistory=arrayToObj(data.salesHistory,["date","id","p","q"]);

if(data.sysConfig.length>1){
compName=data.sysConfig[1][0];
taxRate=parseFloat(data.sysConfig[1][1]);
}

checkAuth();
}

/* ===============================
   ğŸ”µ é›²ç«¯å„²å­˜
================================ */
async function saveCloud(){
const payload={
users:objToArray(users,["u","p","r"]),
vendors:objToArray(vendors,["code","name"]),
models:objToArray(models,["vCode","braId","type","cost","price"]),
inventory:objToArray(inventory,["vCode","braId","c","bb","bc","bz","bq"]),
colors:objToArray(colors,["code","name"]),
itemTypes:[["type"],...itemTypes.map(t=>[t])],
salesHistory:objToArray(salesHistory,["date","id","p","q"]),
sysConfig:[["compName","taxRate"],[compName,taxRate]]
};

await fetch(API_URL,{
method:"POST",
body:JSON.stringify({action:"saveAll",payload})
});
}

/* ===============================
   ğŸ”µ ç™»å…¥ / æ¬Šé™
================================ */
function login(){
const u=document.getElementById("loginUser").value;
const p=document.getElementById("loginPass").value;
const found=users.find(x=>x.u===u&&x.p===p);
if(!found)return alert("å¸³è™Ÿæˆ–å¯†ç¢¼éŒ¯èª¤");

currentUser=found;
document.getElementById("login-overlay").style.display="none";

if(found.r==="admin"){
document.body.classList.add("is-admin");
}else{
document.body.classList.remove("is-admin");
}

document.getElementById("userStatus").innerText=
`ç›®å‰ä½¿ç”¨è€…: ${found.u} (${found.r==="admin"?"ç®¡ç†å“¡":"å“¡å·¥"})`;

render();
}

function logout(){
location.reload();
}

function checkAuth(){
document.getElementById("login-overlay").style.display="flex";
}

/* ===============================
   ğŸ”µ ä¸»ç•«é¢æ›´æ–°
================================ */
function render(){

/* ä¸‹æ‹‰é¸å–® */
document.getElementById("setVendorRel").innerHTML=
vendors.map(v=>`<option value="${v.code}">${v.code}-${v.name}</option>`).join("");

document.getElementById("selectVendor").innerHTML=
vendors.map(v=>`<option value="${v.code}">${v.code}-${v.name}</option>`).join("");

document.getElementById("selectColor").innerHTML=
colors.map(c=>`<option value="${c.code}">${c.name}</option>`).join("");

document.getElementById("itemTypeSelect").innerHTML=
itemTypes.map(t=>`<option>${t}</option>`).join("");

/* åº«å­˜è¡¨ */
const search=document.getElementById("stockSearch").value?.toLowerCase()||"";

const filtered=inventory.filter(i=>{
const text=`${i.vCode} ${i.braId} ${i.c} ${i.bb||""} ${i.bc||""} ${i.bz||""}`.toLowerCase();
return text.includes(search);
});

document.getElementById("stockTableBody").innerHTML=
filtered.map((i,idx)=>`
<tr>
<td>${i.vCode}<br><small>${i.braId}</small></td>
<td>${i.c} ${i.bb||""}${i.bc||""} ${i.bz||""}</td>
<td>${i.bq}</td>
<td class="admin-only">
<button onclick="adjStock(${idx},-1)">-</button>
<button onclick="adjStock(${idx},1)">+</button>
</td>
</tr>
`).join("");

updateStats();
}

/* ===============================
   ğŸ”µ çµ±è¨ˆ
================================ */
function updateStats(){

if(!salesHistory.length)return;

const now=new Date();
const todayStr=now.toLocaleDateString();

const today=salesHistory.filter(s=>
new Date(s.date).toLocaleDateString()===todayStr
);

const month=salesHistory.filter(s=>{
const d=new Date(s.date);
return d.getMonth()===now.getMonth()&&
d.getFullYear()===now.getFullYear();
});

const revToday=today.reduce((sum,s)=>sum+(s.p*s.q),0);
const revMonth=month.reduce((sum,s)=>sum+(s.p*s.q),0);

const box=document.getElementById("sales-stats");
box.style.display="block";
box.innerHTML=`
ğŸ’° ä»Šæ—¥ï¼š<b>$${revToday.toLocaleString()}</b><br>
ğŸ“… æœ¬æœˆï¼š<b>$${revMonth.toLocaleString()}</b>
`;
}

/* ===============================
   ğŸ”µ åº«å­˜èª¿æ•´
================================ */
async function adjStock(idx,delta){
inventory[idx].bq=parseInt(inventory[idx].bq)+delta;
await saveCloud();
render();
}

/* ===============================
   ğŸ”µ å‡ºè²¨å–®
================================ */
function generateInvoiceManual(){
const mStr=document.getElementById("selectModel").value;
if(!mStr)return;
const m=JSON.parse(mStr);

invoiceItems.push({
vCode:m.vCode,
braId:m.braId,
qty:parseInt(document.getElementById("braQty").value),
price:m.price
});

refreshInvoiceUI();
}

function refreshInvoiceUI(){
if(!invoiceItems.length){
document.getElementById("invoice-area").style.display="none";
return;
}

document.getElementById("invoice-area").style.display="block";

let subtotal=0;

document.getElementById("inv-body").innerHTML=
invoiceItems.map((i,idx)=>{
const t=i.qty*i.price;
subtotal+=t;
return `
<tr>
<td>${i.vCode}-${i.braId}</td>
<td>${i.qty}</td>
<td>${i.price}</td>
<td>${t}</td>
<td><button onclick="remInv(${idx})">åˆª</button></td>
</tr>`;
}).join("");

const tax=Math.round(subtotal*(taxRate/100));
const total=subtotal+tax;

document.getElementById("inv-subtotal").innerText=subtotal;
document.getElementById("inv-tax").innerText=tax;
document.getElementById("inv-total").innerText=total;
}

function remInv(idx){
invoiceItems.splice(idx,1);
refreshInvoiceUI();
}

async function confirmAndShip(){
if(!confirm("ç¢ºå®šå‡ºè²¨?"))return;

const now=new Date().toISOString();

for(let item of invoiceItems){

let stock=inventory.find(i=>
i.vCode===item.vCode&&
i.braId===item.braId
);

if(stock)stock.bq-=item.qty;

salesHistory.push({
date:now,
id:item.braId,
p:item.price,
q:item.qty
});
}

invoiceItems=[];
await saveCloud();
render();
refreshInvoiceUI();
alert("å‡ºè²¨å®Œæˆ");
}

/* ===============================
   ğŸ”µ åˆå§‹åŒ–
================================ */
window.onload=loadCloud;

</script>
<script>

/* ===============================
   ğŸ”µ æ›´æ–°æ¬¾å¼ä¸‹æ‹‰
================================ */
function updateModelSelect(){
const v=document.getElementById("selectVendor").value;
const list=models.filter(m=>m.vCode===v);
document.getElementById("selectModel").innerHTML=
list.map(m=>`<option value='${JSON.stringify(m)}'>${m.braId}</option>`).join("");
}

/* ===============================
   ğŸ”µ æ‰‹å‹•å…¥åº«
================================ */
async function handleManual(type){

const v=document.getElementById("selectVendor").value;
const m=JSON.parse(document.getElementById("selectModel").value);
const c=document.getElementById("selectColor").value;
const bb=document.getElementById("braBand").value;
const bc=document.getElementById("braCup").value;
const bz=document.getElementById("braSize").value;
const qty=parseInt(document.getElementById("braQty").value);

let stock=inventory.find(i=>
i.vCode===v&&
i.braId===m.braId&&
i.c===c&&
i.bb===bb&&
i.bc===bc&&
i.bz===bz
);

if(!stock){
stock={vCode:v,braId:m.braId,c,bb,bc,bz,bq:0};
inventory.push(stock);
}

if(type==="IN"){
stock.bq+=qty;
await saveCloud();
render();
alert("å…¥åº«å®Œæˆ");
}
}

/* ===============================
   ğŸ”µ æƒææ§åˆ¶ï¼ˆåŸºç¤ç‰ˆï¼‰
================================ */
function startScan(){
alert("é›²ç«¯ç‰ˆæƒæéœ€æ•´åˆé›²ç«¯QRè³‡æ–™ï¼ˆå¯å¾ŒçºŒæ“´å……ï¼‰");
}
function stopScan(){}

/* ===============================
   ğŸ”µ å» å•†
================================ */
async function addVendor(){
vendors.push({
code:document.getElementById("vCodeInp").value,
name:document.getElementById("vNameInp").value
});
await saveCloud();
render();
}

/* ===============================
   ğŸ”µ é¡è‰²
================================ */
async function addColor(){
const val=document.getElementById("colorInp").value.split(":");
colors.push({code:val[0],name:val[1]});
await saveCloud();
render();
}

/* ===============================
   ğŸ”µ é¡åˆ¥
================================ */
async function addItemType(){
itemTypes.push(document.getElementById("typeInp").value);
await saveCloud();
render();
}

/* ===============================
   ğŸ”µ æ¬¾å¼
================================ */
async function addModel(){
models.push({
vCode:document.getElementById("setVendorRel").value,
braId:document.getElementById("setBraId").value,
type:document.getElementById("itemTypeSelect").value,
cost:document.getElementById("setCost").value,
price:document.getElementById("setPrice").value
});
await saveCloud();
render();
}

/* ===============================
   ğŸ”µ ä½¿ç”¨è€…
================================ */
async function addUser(){
users.push({
u:document.getElementById("newUName").value,
p:document.getElementById("newUPass").value,
r:document.getElementById("newURole").value
});
await saveCloud();
render();
}

/* ===============================
   ğŸ”µ ç³»çµ±è¨­å®š
================================ */
async function updateSysConfig(){
compName=document.getElementById("compNameInp").value;
taxRate=parseFloat(document.getElementById("taxRateInp").value);
await saveCloud();
render();
}

/* ===============================
   ğŸ”µ å‚™ä»½
================================ */
function exportData(){
const data={
users,vendors,models,inventory,colors,itemTypes,salesHistory,compName,taxRate
};
const blob=new Blob([JSON.stringify(data)],{type:"application/json"});
const a=document.createElement("a");
a.href=URL.createObjectURL(blob);
a.download="backup.json";
a.click();
}

/* ===============================
   ğŸ”µ åŒ¯å…¥
================================ */
function triggerImport(){
document.getElementById("importFile").click();
}

function importData(e){
const reader=new FileReader();
reader.onload=async function(evt){
const data=JSON.parse(evt.target.result);
users=data.users;
vendors=data.vendors;
models=data.models;
inventory=data.inventory;
colors=data.colors;
itemTypes=data.itemTypes;
salesHistory=data.salesHistory;
compName=data.compName;
taxRate=data.taxRate;
await saveCloud();
render();
};
reader.readAsText(e.target.files[0]);
}

</script>

</body>
</html>
