<!DOCTYPE html>
<html lang="zh-Hant">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Lingerie Pro å•†ç”¨ç©©å®šç‰ˆ</title>

<script src="https://unpkg.com/html5-qrcode"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/qrious/4.0.2/qrious.min.js"></script>

<style>
:root{
--primary:#8da399;
--accent:#d4a373;
--bg:#f9f7f2;
--card:#ffffff;
--border:#e0dcd0;
--danger:#e53e3e;
--success:#48bb78;
}

body{
font-family:-apple-system,"Noto Sans TC",sans-serif;
background:var(--bg);
margin:0;
padding:10px;
color:#444;
}

.container{
max-width:600px;
margin:auto;
}

.card{
background:var(--card);
border-radius:12px;
padding:15px;
margin-bottom:15px;
border:1px solid var(--border);
box-shadow:0 2px 4px rgba(0,0,0,0.05);
}

h3{
color:#6b7e75;
border-left:4px solid var(--accent);
padding-left:10px;
margin:0 0 15px 0;
font-size:1rem;
}

input,select{
padding:10px;
border-radius:8px;
border:1px solid var(--border);
width:100%;
box-sizing:border-box;
margin-bottom:8px;
}

button{
background:var(--primary);
color:#fff;
border:none;
border-radius:8px;
padding:10px;
cursor:pointer;
width:100%;
font-weight:bold;
}

.btn-danger{background:var(--danger);}
.btn-success{background:var(--success);}
.btn-accent{background:var(--accent);}

#login-overlay{
position:fixed;
top:0;
left:0;
width:100%;
height:100%;
background:var(--bg);
display:flex;
align-items:center;
justify-content:center;
z-index:9999;
}

.login-card{
width:90%;
max-width:350px;
background:#fff;
padding:30px;
border-radius:15px;
box-shadow:0 10px 25px rgba(0,0,0,0.1);
}
</style>
</head>
<body>

<!-- ===============================
   ç™»å…¥ç•«é¢
================================ -->
<div id="login-overlay">
    <div class="login-card">
        <h2 style="text-align:center;color:var(--primary);margin-top:0;">
            ç³»çµ±ç™»å…¥
        </h2>

        <input type="text" id="loginUser" placeholder="å¸³è™Ÿ">
        <input type="password" id="loginPass" placeholder="å¯†ç¢¼">

        <button onclick="login()">ç™»å…¥ç³»çµ±</button>
    </div>
</div>

<!-- ===============================
   ä¸»å®¹å™¨
================================ -->
<div class="container">

    <!-- ä½¿ç”¨è€…è³‡è¨Šåˆ— -->
    <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:10px;">
        <span id="userStatus" style="font-size:14px;color:#666;"></span>
        <button onclick="logout()" style="width:auto;padding:5px 15px;font-size:12px;background:#666;">
            ç™»å‡º
        </button>
    </div>

    <!-- ç³»çµ±è¨­å®š -->
    <div class="card admin-only">
        <h3>ç³»çµ±è¨­å®š</h3>

        <input type="text" id="compNameInp" placeholder="å…¬å¸åç¨±">
        <input type="number" id="taxRateInp" placeholder="ç¨…ç‡ (%)">

        <button class="btn-success" onclick="updateSysConfig()">
            å„²å­˜ç³»çµ±è¨­å®š
        </button>
    </div>

    <!-- å» å•†ç®¡ç† -->
    <div class="card admin-only">
        <h3>å» å•†ç®¡ç†</h3>

        <input type="text" id="vCodeInp" placeholder="å» å•†ä»£ç¢¼">
        <input type="text" id="vNameInp" placeholder="å» å•†åç¨±">

        <button onclick="addVendor()">æ–°å¢å» å•†</button>

        <div id="vendorList"></div>
    </div>

    <!-- æ¬¾å¼ç®¡ç† -->
    <div class="card admin-only">
        <h3>æ¬¾å¼ç®¡ç†</h3>

        <select id="setVendorRel"></select>
        <input type="text" id="setBraId" placeholder="å‹è™Ÿ">
        <input type="number" id="setCost" placeholder="é€²åƒ¹">
        <input type="number" id="setPrice" placeholder="å”®åƒ¹">

        <button class="btn-accent" onclick="addModel()">
            æ–°å¢æ¬¾å¼
        </button>

        <div id="modelList"></div>
    </div>

    <!-- åº«å­˜æ“ä½œ -->
    <div class="card">
        <h3>åº«å­˜æ“ä½œ</h3>

        <select id="selectVendor"></select>
        <select id="selectModel"></select>

        <input type="number" id="braQty" value="1" placeholder="æ•¸é‡">

        <button onclick="handleManual('IN')">
            æ‰‹å‹•å…¥åº«
        </button>

        <button class="btn-success" onclick="handleManual('OUT')">
            æ‰‹å‹•å‡ºåº«
        </button>
    </div>

    <!-- åº«å­˜åˆ—è¡¨ -->
    <div class="card">
        <h3>ç›®å‰åº«å­˜</h3>
        <div id="stockList"></div>
    </div>

</div>
<script>

/* ===============================
   ğŸ”´ æ”¹æˆä½ çš„ Apps Script ç¶²å€
================================ */
const API_URL = "https://script.google.com/macros/s/AKfycbwKljH08lC3P_P0hrey_qrAL2iXnljuXYQwfN1FgmUNfop1PXWNqTfe9GiuHkYOaWceCA/exec";

/* ===============================
   å…¨åŸŸè®Šæ•¸ï¼ˆå®Œå…¨é›²ç«¯ç‰ˆï¼‰
================================ */
let currentUser = null;

let users = [];
let vendors = [];
let models = [];
let inventory = [];
let colors = [];
let itemTypes = [];
let salesHistory = [];

let compName = "";
let taxRate = 5;

/* ===============================
   ç™»å…¥ï¼ˆé›²ç«¯ç‰ˆï¼‰
================================ */
async function login(){

    const u = document.getElementById("loginUser").value;
    const p = document.getElementById("loginPass").value;

    const res = await fetch(API_URL,{
        method:"POST",
        body:JSON.stringify({
            action:"login",
            payload:{ username:u, password:p }
        })
    });

    const data = await res.json();

    if(data.success){
        currentUser = data.user;
        sessionStorage.setItem("CUR_USER",JSON.stringify(data.user));

        await loadAllData();
        checkAuth();
    }else{
        alert(data.message);
    }
}

/* ===============================
   ç™»å‡º
================================ */
function logout(){
    sessionStorage.removeItem("CUR_USER");
    location.reload();
}

/* ===============================
   æ¬Šé™æª¢æŸ¥
================================ */
function checkAuth(){

    if(!currentUser){
        document.getElementById("login-overlay").style.display="flex";
        return;
    }

    document.getElementById("login-overlay").style.display="none";

    document.getElementById("userStatus").innerText =
        `ç›®å‰ä½¿ç”¨è€…ï¼š${currentUser.u} (${currentUser.r})`;

    if(currentUser.r === "admin"){
        document.querySelectorAll(".admin-only")
            .forEach(el=>el.style.display="block");
    }else{
        document.querySelectorAll(".admin-only")
            .forEach(el=>el.style.display="none");
    }
}

/* ===============================
   é›²ç«¯è®€å–å…¨éƒ¨è³‡æ–™
================================ */
async function loadAllData(){

    const res = await fetch(API_URL + "?action=getAll");
    const data = await res.json();

    users = data.users.slice(1).map(r=>({u:r[0],p:r[1],r:r[2]}));

    vendors = data.vendors.slice(1)
        .map(r=>({code:r[0],name:r[1]}));

    models = data.models.slice(1)
        .map(r=>({
            vCode:r[0],
            braId:r[1],
            type:r[2],
            cost:r[3],
            price:r[4]
        }));

    inventory = data.inventory.slice(1)
        .map(r=>({
            vCode:r[0],
            braId:r[1],
            c:r[2],
            bb:r[3],
            bc:r[4],
            bz:r[5],
            bq:r[6]
        }));

    salesHistory = data.salesHistory.slice(1)
        .map(r=>({
            date:r[0],
            id:r[1],
            p:r[2],
            q:r[3]
        }));

    if(data.sysConfig.length > 1){
        compName = data.sysConfig[1][0];
        taxRate = parseFloat(data.sysConfig[1][1]);
    }

    render();
}

/* ===============================
   é›²ç«¯å„²å­˜ï¼ˆå•†ç”¨ç©©å®šç‰ˆï¼‰
================================ */
async function save(){

    const payload = {

        users:[["u","p","r"],
            ...users.map(x=>[x.u,x.p,x.r])
        ],

        vendors:[["code","name"],
            ...vendors.map(x=>[x.code,x.name])
        ],

        models:[["vCode","braId","type","cost","price"],
            ...models.map(x=>[
                x.vCode,x.braId,x.type,x.cost,x.price
            ])
        ],

        inventory:[["vCode","braId","c","bb","bc","bz","bq"],
            ...inventory.map(x=>[
                x.vCode,x.braId,x.c,x.bb,x.bc,x.bz,x.bq
            ])
        ],

        salesHistory:[["date","id","p","q"],
            ...salesHistory.map(x=>[
                x.date,x.id,x.p,x.q
            ])
        ],

        sysConfig:[["compName","taxRate"],
            [compName,taxRate]
        ]
    };

    await fetch(API_URL,{
        method:"POST",
        body:JSON.stringify({
            action:"saveAll",
            payload
        })
    });

    await loadAllData();
}
/* ===============================
   ç³»çµ±è¨­å®š
================================ */
function updateSysConfig(){
    compName = document.getElementById("compNameInp").value;
    taxRate = parseFloat(document.getElementById("taxRateInp").value) || 0;
    save();
}

/* ===============================
   å» å•†ç®¡ç†
================================ */
function addVendor(){

    const code = document.getElementById("vCodeInp").value;
    const name = document.getElementById("vNameInp").value;

    if(!code || !name) return alert("è«‹è¼¸å…¥å®Œæ•´è³‡æ–™");

    vendors.push({code,name});
    save();

    document.getElementById("vCodeInp").value="";
    document.getElementById("vNameInp").value="";
}

function deleteVendor(index){
    if(confirm("ç¢ºå®šåˆªé™¤å» å•†ï¼Ÿ")){
        vendors.splice(index,1);
        save();
    }
}

/* ===============================
   æ¬¾å¼ç®¡ç†
================================ */
function addModel(){

    const vCode = document.getElementById("setVendorRel").value;
    const braId = document.getElementById("setBraId").value;
    const cost = parseFloat(document.getElementById("setCost").value) || 0;
    const price = parseFloat(document.getElementById("setPrice").value) || 0;

    if(!vCode || !braId) return alert("è³‡æ–™ä¸å®Œæ•´");

    models.push({vCode,braId,type:"",cost,price});
    save();

    document.getElementById("setBraId").value="";
    document.getElementById("setCost").value="";
    document.getElementById("setPrice").value="";
}

function deleteModel(index){
    if(confirm("ç¢ºå®šåˆªé™¤æ¬¾å¼ï¼Ÿ")){
        models.splice(index,1);
        save();
    }
}

/* ===============================
   åº«å­˜è™•ç†
================================ */
function handleManual(type){

    const modelStr = document.getElementById("selectModel").value;
    const qty = parseInt(document.getElementById("braQty").value);

    if(!modelStr || qty<=0)
        return alert("è³‡æ–™ä¸å®Œæ•´");

    const model = JSON.parse(modelStr);
    const finalQty = type==="OUT" ? -qty : qty;

    let item = inventory.find(i=>
        i.vCode===model.vCode &&
        i.braId===model.braId
    );

    if(item){
        item.bq += finalQty;
    }else{
        inventory.push({
            vCode:model.vCode,
            braId:model.braId,
            c:"",
            bb:"",
            bc:"",
            bz:"",
            bq:finalQty
        });
    }

    inventory = inventory.filter(i=>i.bq>0);

    save();
}

/* ===============================
   ç•«é¢æ¸²æŸ“
================================ */
function render(){

    // å…¬å¸åç¨±
    document.getElementById("compNameInp").value = compName;
    document.getElementById("taxRateInp").value = taxRate;

    // å» å•†ä¸‹æ‹‰
    const vendorOptions = vendors.map(v=>
        `<option value="${v.code}">
            ${v.code}-${v.name}
         </option>`
    ).join("");

    document.getElementById("setVendorRel").innerHTML = vendorOptions;
    document.getElementById("selectVendor").innerHTML = vendorOptions;

    // æ¬¾å¼ä¸‹æ‹‰
    const selectedVendor = document.getElementById("selectVendor").value;

    const filteredModels = models.filter(m=>
        m.vCode===selectedVendor
    );

    document.getElementById("selectModel").innerHTML =
        filteredModels.map(m=>
            `<option value='${JSON.stringify(m)}'>
                ${m.braId}
             </option>`
        ).join("");

    // å» å•†åˆ—è¡¨
    document.getElementById("vendorList").innerHTML =
        vendors.map((v,i)=>
            `<div>
                ${v.code}-${v.name}
                <button onclick="deleteVendor(${i})"
                    style="width:auto;background:red">
                    åˆª
                </button>
             </div>`
        ).join("");

    // æ¬¾å¼åˆ—è¡¨
    document.getElementById("modelList").innerHTML =
        models.map((m,i)=>
            `<div>
                ${m.vCode}-${m.braId}
                <button onclick="deleteModel(${i})"
                    style="width:auto;background:red">
                    åˆª
                </button>
             </div>`
        ).join("");

    // åº«å­˜åˆ—è¡¨
    document.getElementById("stockList").innerHTML =
        inventory.map(i=>
            `<div>
                ${i.vCode}-${i.braId}
                åº«å­˜:${i.bq}
             </div>`
        ).join("");
}
/* ===============================
   é é¢åˆå§‹åŒ–
================================ */
window.onload = async function(){

    // è®€å–å·²ç™»å…¥ä½¿ç”¨è€…
    const savedUser = sessionStorage.getItem("CUR_USER");

    if(savedUser){
        currentUser = JSON.parse(savedUser);
        await loadAllData();
        checkAuth();
    }else{
        document.getElementById("login-overlay").style.display="flex";
    }

    // ç•¶å» å•†æ”¹è®Šæ™‚è‡ªå‹•æ›´æ–°æ¬¾å¼
    document.getElementById("selectVendor")
        .addEventListener("change",render);
};

</script>

</body>
</html>
